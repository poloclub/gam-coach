<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 12.1.0"/>
    <title>gamcoach.gamcoach API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent }nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--code);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style><script>
    window.MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        }
    };
</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
    /* Re-invoke MathJax when DOM content changes, for example during search. */
    document.addEventListener("DOMContentLoaded", () => {
        new MutationObserver(() => MathJax.typeset()).observe(
            document.querySelector("main.pdoc").parentNode,
            {childList: true}
        );
    })
</script></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>            <a class="pdoc-button module-list-button" href="../gamcoach.html">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-in-left" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M10 3.5a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-2a.5.5 0 0 1 1 0v2A1.5 1.5 0 0 1 9.5 14h-8A1.5 1.5 0 0 1 0 12.5v-9A1.5 1.5 0 0 1 1.5 2h8A1.5 1.5 0 0 1 11 3.5v2a.5.5 0 0 1-1 0v-2z"/>
  <path fill-rule="evenodd" d="M4.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L5.707 7.5H14.5a.5.5 0 0 1 0 1H5.707l2.147 2.146a.5.5 0 0 1-.708.708l-3-3z"/>
</svg>                &nbsp;gamcoach</a>

            <img src="https://gist.githubusercontent.com/aneurips/eeb6cc703b4c8556224f5f4deb651553/raw/75b98f177cb535886d3337860e64802e6b7dc345/gamcoach-logo.svg" class="logo" alt="project logo"/>

            <input type="search" placeholder="Search..." role="searchbox" aria-label="search"
                   pattern=".+" required>



        <h2>API Documentation</h2>
            <ul class="memberlist">
            <li>
                    <a class="class" href="#GAMCoach">GAMCoach</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#GAMCoach.__init__">GAMCoach</a>
                        </li>
                        <li>
                                <a class="variable" href="#GAMCoach.ebm">ebm</a>
                        </li>
                        <li>
                                <a class="variable" href="#GAMCoach.cont_mads">cont_mads</a>
                        </li>
                        <li>
                                <a class="variable" href="#GAMCoach.cat_distances">cat_distances</a>
                        </li>
                        <li>
                                <a class="variable" href="#GAMCoach.is_classifier">is_classifier</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.generate_cfs">generate_cfs</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.generate_cont_options">generate_cont_options</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.generate_cat_options">generate_cat_options</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.generate_inter_options">generate_inter_options</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.create_milp">create_milp</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.print_solution">print_solution</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.compute_mad">compute_mad</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.compute_frequency_distance">compute_frequency_distance</a>
                        </li>
                        <li>
                                <a class="function" href="#GAMCoach.compute_naive_cat_distance">compute_naive_cat_distance</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#search_sorted_lower_index">search_sorted_lower_index</a>
            </li>
            <li>
                    <a class="function" href="#sigmoid">sigmoid</a>
            </li>
            <li>
                    <a class="function" href="#get_model_data">get_model_data</a>
            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
<a href="./../gamcoach.html">gamcoach</a><wbr>.gamcoach    </h1>

                        <div class="docstring"><p>Main module for GAM Coach.</p>

<p>GAM Coach implements a simple and flexible method to generate counterfactual
explanations for generalized additive models (GAMs).</p>
</div>

                        <input id="gamcoach-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="gamcoach-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">   1</span></a><span class="sd">&quot;&quot;&quot;Main module for GAM Coach.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">   2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">   3</span></a><span class="sd">GAM Coach implements a simple and flexible method to generate counterfactual</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">   4</span></a><span class="sd">explanations for generalized additive models (GAMs).</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">   5</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">   6</span></a>
</span><span id="L-7"><a href="#L-7"><span class="linenos">   7</span></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">   8</span></a><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">   9</span></a><span class="kn">import</span> <span class="nn">re</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos">  10</span></a><span class="kn">import</span> <span class="nn">pulp</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos">  11</span></a><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos">  12</span></a><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">gaussian_kde</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos">  13</span></a><span class="kn">from</span> <span class="nn">interpret.glassbox</span> <span class="kn">import</span> <span class="p">(</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos">  14</span></a>    <span class="n">ExplainableBoostingClassifier</span><span class="p">,</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos">  15</span></a>    <span class="n">ExplainableBoostingRegressor</span><span class="p">,</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos">  16</span></a><span class="p">)</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos">  17</span></a><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos">  18</span></a><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
</span><span id="L-19"><a href="#L-19"><span class="linenos">  19</span></a>
</span><span id="L-20"><a href="#L-20"><span class="linenos">  20</span></a><span class="kn">from</span> <span class="nn">.counterfactuals</span> <span class="kn">import</span> <span class="n">Counterfactuals</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos">  21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos">  22</span></a><span class="n">SEED</span> <span class="o">=</span> <span class="mi">922</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos">  23</span></a>
</span><span id="L-24"><a href="#L-24"><span class="linenos">  24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos">  25</span></a><span class="k">class</span> <span class="nc">GAMCoach</span><span class="p">:</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos">  26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main class for GAM Coach.&quot;&quot;&quot;</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos">  27</span></a>
</span><span id="L-28"><a href="#L-28"><span class="linenos">  28</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos">  29</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos">  30</span></a>        <span class="n">ebm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ExplainableBoostingClassifier</span><span class="p">,</span> <span class="n">ExplainableBoostingRegressor</span><span class="p">],</span>
</span><span id="L-31"><a href="#L-31"><span class="linenos">  31</span></a>        <span class="n">x_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos">  32</span></a>        <span class="n">cont_mads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos">  33</span></a>        <span class="n">cat_distances</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos">  34</span></a>        <span class="n">adjust_cat_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos">  35</span></a>    <span class="p">):</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos">  36</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a GAMCoach object.</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos">  37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos">  38</span></a><span class="sd">        Args:</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos">  39</span></a><span class="sd">            ebm (Union[ExplainableBoostingClassifier, ExplainableBoostingRegressor]):</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos">  40</span></a><span class="sd">                The trained EBM model. It can be either a classifier or a regressor.</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos">  41</span></a><span class="sd">            x_train (np.ndarray): The training data. It is used to compute the</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos">  42</span></a><span class="sd">                distance for different features.</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos">  43</span></a><span class="sd">            cont_mads (dict, optional): `feature_name` -&gt; `median absolute</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos">  44</span></a><span class="sd">                deviation score`. If it is provided, it is used to overwrite the</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos">  45</span></a><span class="sd">                computed MADs for continuous variables. It is useful when you</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos">  46</span></a><span class="sd">                want to provide a custom normalization function to compute the</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos">  47</span></a><span class="sd">                distance between continuous features.</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos">  48</span></a><span class="sd">            cat_distances (dict, optional): `feature_name` -&gt; {`level_name` -&gt; `distance`}.</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos">  49</span></a><span class="sd">                Level distance of categorical variables. By default, the distance</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos">  50</span></a><span class="sd">                is computed by (1 - frequency(level)) for each level. It imples</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos">  51</span></a><span class="sd">                that it is easier to move to a more frequent. If `cat_distances`</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos">  52</span></a><span class="sd">                is provided, it will overwrite the default distance for</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos">  53</span></a><span class="sd">                categorical variables.</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos">  54</span></a><span class="sd">            adjust_cat_distance (bool, optional): If true, we use (1 -</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos">  55</span></a><span class="sd">                frequency(level)) for each level. Otherwise, we give distance = 1</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos">  56</span></a><span class="sd">                for different levels and 0 for the same level.</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos">  57</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos">  58</span></a>
</span><span id="L-59"><a href="#L-59"><span class="linenos">  59</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos">  60</span></a>            <span class="n">ExplainableBoostingClassifier</span><span class="p">,</span> <span class="n">ExplainableBoostingRegressor</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos">  61</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos">  62</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The trained EBM model.&quot;&quot;&quot;</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos">  63</span></a>
</span><span id="L-64"><a href="#L-64"><span class="linenos">  64</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">x_train</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos">  65</span></a>
</span><span id="L-66"><a href="#L-66"><span class="linenos">  66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">cont_mads</span>
</span><span id="L-67"><a href="#L-67"><span class="linenos">  67</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Median absolute deviation (MAD) of continuous variables.&quot;&quot;&quot;</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos">  68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos">  69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">cat_distances</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos">  70</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Level distance of categorical variables. By default, the distance is</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos">  71</span></a><span class="sd">        computed by $(1 - \\frac{\\text{count of} L_i}{\\text{count of all L}})$</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos">  72</span></a><span class="sd">        for one level $L_i$. It implies that it is easier to move to a more</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos">  73</span></a><span class="sd">        frequent level.</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos">  74</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-75"><a href="#L-75"><span class="linenos">  75</span></a>
</span><span id="L-76"><a href="#L-76"><span class="linenos">  76</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_cat_distance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">adjust_cat_distance</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos">  77</span></a>
</span><span id="L-78"><a href="#L-78"><span class="linenos">  78</span></a>        <span class="c1"># If cont_mads is not given, we compute it from the training data</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos">  79</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos">  80</span></a>            <span class="n">ebm_cont_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos">  81</span></a>                <span class="p">[</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos">  82</span></a>                    <span class="n">i</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos">  83</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">))</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos">  84</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos">  85</span></a>                <span class="p">]</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos">  86</span></a>            <span class="p">)</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos">  87</span></a>
</span><span id="L-88"><a href="#L-88"><span class="linenos">  88</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos">  89</span></a>
</span><span id="L-90"><a href="#L-90"><span class="linenos">  90</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cont_indexes</span><span class="p">:</span>
</span><span id="L-91"><a href="#L-91"><span class="linenos">  91</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">[</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mad</span><span class="p">(</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos">  92</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos">  93</span></a>                <span class="p">)</span>
</span><span id="L-94"><a href="#L-94"><span class="linenos">  94</span></a>
</span><span id="L-95"><a href="#L-95"><span class="linenos">  95</span></a>        <span class="c1"># If cat_distance is not given, we compute it from the training data</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos">  96</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos">  97</span></a>            <span class="n">ebm_cat_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos">  98</span></a>                <span class="p">[</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos">  99</span></a>                    <span class="n">i</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos"> 100</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">))</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos"> 101</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos"> 102</span></a>                <span class="p">]</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos"> 103</span></a>            <span class="p">)</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos"> 104</span></a>
</span><span id="L-105"><a href="#L-105"><span class="linenos"> 105</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-106"><a href="#L-106"><span class="linenos"> 106</span></a>
</span><span id="L-107"><a href="#L-107"><span class="linenos"> 107</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_cat_distance</span><span class="p">:</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos"> 108</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cat_indexes</span><span class="p">:</span>
</span><span id="L-109"><a href="#L-109"><span class="linenos"> 109</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos"> 110</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos"> 111</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_frequency_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos"> 112</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos"> 113</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cat_indexes</span><span class="p">:</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos"> 114</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos"> 115</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos"> 116</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_naive_cat_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos"> 117</span></a>
</span><span id="L-118"><a href="#L-118"><span class="linenos"> 118</span></a>        <span class="c1"># Determine if the ebm is a classifier or a regressor</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos"> 119</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="L-120"><a href="#L-120"><span class="linenos"> 120</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the ebm model is a classifier, false if it is a regressor.&quot;&quot;&quot;</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos"> 121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos"> 122</span></a>    <span class="k">def</span> <span class="nf">generate_cfs</span><span class="p">(</span>
</span><span id="L-123"><a href="#L-123"><span class="linenos"> 123</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos"> 124</span></a>        <span class="n">cur_example</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos"> 125</span></a>        <span class="n">total_cfs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos"> 126</span></a>        <span class="n">target_range</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos"> 127</span></a>        <span class="n">sim_threshold_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span>
</span><span id="L-128"><a href="#L-128"><span class="linenos"> 128</span></a>        <span class="n">sim_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos"> 129</span></a>        <span class="n">categorical_weight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos"> 130</span></a>        <span class="n">features_to_vary</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos"> 131</span></a>        <span class="n">max_num_features_to_vary</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-132"><a href="#L-132"><span class="linenos"> 132</span></a>        <span class="n">feature_ranges</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos"> 133</span></a>        <span class="n">continuous_integer_features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos"> 134</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos"> 135</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Counterfactuals</span><span class="p">:</span>
</span><span id="L-136"><a href="#L-136"><span class="linenos"> 136</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate counterfactual examples.</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos"> 137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos"> 138</span></a><span class="sd">        Use mixed-integer linear programming to generate optimal counterfactual</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos"> 139</span></a><span class="sd">        examples for the given data point.</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos"> 140</span></a>
</span><span id="L-141"><a href="#L-141"><span class="linenos"> 141</span></a><span class="sd">        Args:</span>
</span><span id="L-142"><a href="#L-142"><span class="linenos"> 142</span></a><span class="sd">            cur_example (np.ndarray): The data point of interest. This function</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos"> 143</span></a><span class="sd">                aims to find similar examples that the model gives different</span>
</span><span id="L-144"><a href="#L-144"><span class="linenos"> 144</span></a><span class="sd">                predictions.</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos"> 145</span></a><span class="sd">            total_cfs (int, optional): The total number of counterfactuals to,</span>
</span><span id="L-146"><a href="#L-146"><span class="linenos"> 146</span></a><span class="sd">                generate. Default to 1.</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos"> 147</span></a><span class="sd">            target_range (tuple, optional): The targetted prediction range. This</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos"> 148</span></a><span class="sd">                parameter is required if the EBM is a regressor.</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos"> 149</span></a><span class="sd">            sim_threshold_factor (float, optional): A positive float to automatically</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos"> 150</span></a><span class="sd">                generate a similarity threshold. This parameter has no effect if</span>
</span><span id="L-151"><a href="#L-151"><span class="linenos"> 151</span></a><span class="sd">                `sim_threshold` is provided. If `sim_threshold` is</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos"> 152</span></a><span class="sd">                not provided, we compute `sim_threshold` as `sim_threshold_factor`</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos"> 153</span></a><span class="sd">                * average additive score range of all continuous features. If</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos"> 154</span></a><span class="sd">                `sim_threshold_factor` is too small, it takes longer time to</span>
</span><span id="L-155"><a href="#L-155"><span class="linenos"> 155</span></a><span class="sd">                generate CFs. If `sim_threshold_factor` is too large, the</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos"> 156</span></a><span class="sd">                algorithm might miss some optimal CFs.</span>
</span><span id="L-157"><a href="#L-157"><span class="linenos"> 157</span></a><span class="sd">            sim_threshold (float, optional): A positive float to determine how we</span>
</span><span id="L-158"><a href="#L-158"><span class="linenos"> 158</span></a><span class="sd">                decide if two bins of a continuous feature have similar scores.</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos"> 159</span></a><span class="sd">                Two bins $b_1$ and $b_2$ are similar (the distant one will be</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos"> 160</span></a><span class="sd">                removed) if $|b_1 - b_2| \\leq$ `sim_threshold`.</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos"> 161</span></a><span class="sd">            categorical_weight (Union[float, str], optional): A positive float</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos"> 162</span></a><span class="sd">                to scale the distances of options for categorical variables. Since</span>
</span><span id="L-163"><a href="#L-163"><span class="linenos"> 163</span></a><span class="sd">                we have very different distance functions for continuous and</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos"> 164</span></a><span class="sd">                categorical features, we need to scale them so they are at a</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos"> 165</span></a><span class="sd">                comparable range. To do that, we multiply the categorical feature&#39;s</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos"> 166</span></a><span class="sd">                distances by `categorical_weight`. By default (&#39;auto&#39;), we scale</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos"> 167</span></a><span class="sd">                the distances of categorical features so that they have the mean</span>
</span><span id="L-168"><a href="#L-168"><span class="linenos"> 168</span></a><span class="sd">                distance as continuous features.</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos"> 169</span></a><span class="sd">            features_to_vary ([str], optional): A list of feature names that</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos"> 170</span></a><span class="sd">                the CFs can change. If it is `None`, this function will use all</span>
</span><span id="L-171"><a href="#L-171"><span class="linenos"> 171</span></a><span class="sd">                features.</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos"> 172</span></a><span class="sd">            max_num_features_to_vary (int, optional): The max number of features</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos"> 173</span></a><span class="sd">                that the CF can vary. Default is no maximum.</span>
</span><span id="L-174"><a href="#L-174"><span class="linenos"> 174</span></a><span class="sd">            feature_ranges (dict, optional): A dictionary to control the permitted</span>
</span><span id="L-175"><a href="#L-175"><span class="linenos"> 175</span></a><span class="sd">                ranges/values for continuous/categorical features. It maps</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos"> 176</span></a><span class="sd">                `feature_name` -&gt; [`min_value`, `max_value`] for continuous features,</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos"> 177</span></a><span class="sd">                `feature_name` -&gt; [`level1`, `level2`, ...] for categorical features.</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos"> 178</span></a><span class="sd">            continuous_integer_features (list, optional): A list of names of</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos"> 179</span></a><span class="sd">                continuous features that need to be integers (e.g., age, FICO score)</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos"> 180</span></a><span class="sd">            verbose (int): 0: no any output, 1: show progress bar, 2: show internal</span>
</span><span id="L-181"><a href="#L-181"><span class="linenos"> 181</span></a><span class="sd">                optimization details</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos"> 182</span></a>
</span><span id="L-183"><a href="#L-183"><span class="linenos"> 183</span></a><span class="sd">        Returns:</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos"> 184</span></a><span class="sd">            Counterfactuals: The generated counterfactual examples with their</span>
</span><span id="L-185"><a href="#L-185"><span class="linenos"> 185</span></a><span class="sd">                associated distances and change information.</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos"> 186</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos"> 187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos"> 188</span></a>        <span class="c1"># Transforming some parameters</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos"> 189</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_example</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos"> 190</span></a>            <span class="n">cur_example</span> <span class="o">=</span> <span class="n">cur_example</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-191"><a href="#L-191"><span class="linenos"> 191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos"> 192</span></a>        <span class="k">if</span> <span class="n">features_to_vary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos"> 193</span></a>            <span class="n">features_to_vary</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos"> 194</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos"> 195</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">))</span>
</span><span id="L-196"><a href="#L-196"><span class="linenos"> 196</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;interaction&quot;</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos"> 197</span></a>            <span class="p">]</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos"> 198</span></a>
</span><span id="L-199"><a href="#L-199"><span class="linenos"> 199</span></a>        <span class="c1"># Step 1: Find the current score for each feature</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos"> 200</span></a>        <span class="c1"># This is done by ebm.explain_local()</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos"> 201</span></a>        <span class="n">cur_scores</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-202"><a href="#L-202"><span class="linenos"> 202</span></a>
</span><span id="L-203"><a href="#L-203"><span class="linenos"> 203</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span><span class="p">:</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos"> 204</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos"> 205</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-206"><a href="#L-206"><span class="linenos"> 206</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos"> 207</span></a>
</span><span id="L-208"><a href="#L-208"><span class="linenos"> 208</span></a>        <span class="n">local_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">explain_local</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)</span><span class="o">.</span><span class="n">_internal_obj</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos"> 209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos"> 210</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos"> 211</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-212"><a href="#L-212"><span class="linenos"> 212</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos"> 213</span></a>
</span><span id="L-214"><a href="#L-214"><span class="linenos"> 214</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_data</span><span class="p">[</span><span class="s2">&quot;specific&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;scores&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos"> 215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos"> 216</span></a>        <span class="c1"># Find the CF direction</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos"> 217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos"> 218</span></a>        <span class="c1"># Binary classification</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos"> 219</span></a>        <span class="c1"># Predicted 0 =&gt; +1</span>
</span><span id="L-220"><a href="#L-220"><span class="linenos"> 220</span></a>        <span class="c1"># Predicted 1 =&gt; -1</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos"> 221</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span><span class="p">:</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos"> 222</span></a>            <span class="n">cf_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos"> 223</span></a>            <span class="n">total_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cur_scores</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_scores</span><span class="p">])</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos"> 224</span></a>            <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="o">-</span><span class="n">total_score</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos"> 225</span></a>            <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos"> 226</span></a>
</span><span id="L-227"><a href="#L-227"><span class="linenos"> 227</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-228"><a href="#L-228"><span class="linenos"> 228</span></a>            <span class="c1"># Regression</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos"> 229</span></a>            <span class="c1"># Increase +1</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos"> 230</span></a>            <span class="c1"># Decrease -1</span>
</span><span id="L-231"><a href="#L-231"><span class="linenos"> 231</span></a>            <span class="k">if</span> <span class="n">target_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos"> 232</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos"> 233</span></a>                    <span class="s2">&quot;target_range cannot be None when the model is a regressor&quot;</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos"> 234</span></a>                <span class="p">)</span>
</span><span id="L-235"><a href="#L-235"><span class="linenos"> 235</span></a>
</span><span id="L-236"><a href="#L-236"><span class="linenos"> 236</span></a>            <span class="n">predicted_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos"> 237</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="L-238"><a href="#L-238"><span class="linenos"> 238</span></a>                <span class="n">predicted_value</span> <span class="o">&gt;=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos"> 239</span></a>                <span class="ow">and</span> <span class="n">predicted_value</span> <span class="o">&lt;=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-240"><a href="#L-240"><span class="linenos"> 240</span></a>            <span class="p">):</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos"> 241</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The target_range cannot cover the current prediction&quot;</span><span class="p">)</span>
</span><span id="L-242"><a href="#L-242"><span class="linenos"> 242</span></a>
</span><span id="L-243"><a href="#L-243"><span class="linenos"> 243</span></a>            <span class="k">elif</span> <span class="n">predicted_value</span> <span class="o">&lt;</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-244"><a href="#L-244"><span class="linenos"> 244</span></a>                <span class="n">cf_direction</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos"> 245</span></a>                <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="L-246"><a href="#L-246"><span class="linenos"> 246</span></a>                <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos"> 247</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-248"><a href="#L-248"><span class="linenos"> 248</span></a>                <span class="n">cf_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos"> 249</span></a>                <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos"> 250</span></a>                <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="L-251"><a href="#L-251"><span class="linenos"> 251</span></a>
</span><span id="L-252"><a href="#L-252"><span class="linenos"> 252</span></a>        <span class="c1"># Step 2: Generate continuous and categorical options</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos"> 253</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-254"><a href="#L-254"><span class="linenos"> 254</span></a>
</span><span id="L-255"><a href="#L-255"><span class="linenos"> 255</span></a>        <span class="c1"># Generate a similarity threshold if it is not provided</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos"> 256</span></a>        <span class="k">if</span> <span class="n">sim_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-257"><a href="#L-257"><span class="linenos"> 257</span></a>            <span class="n">additive_ranges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos"> 258</span></a>
</span><span id="L-259"><a href="#L-259"><span class="linenos"> 259</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-260"><a href="#L-260"><span class="linenos"> 260</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos"> 261</span></a>                    <span class="n">cur_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-262"><a href="#L-262"><span class="linenos"> 262</span></a>                    <span class="n">additive_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cur_values</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cur_values</span><span class="p">))</span>
</span><span id="L-263"><a href="#L-263"><span class="linenos"> 263</span></a>
</span><span id="L-264"><a href="#L-264"><span class="linenos"> 264</span></a>            <span class="n">sim_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">additive_ranges</span><span class="p">)</span> <span class="o">*</span> <span class="n">sim_threshold_factor</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos"> 265</span></a>
</span><span id="L-266"><a href="#L-266"><span class="linenos"> 266</span></a>        <span class="c1"># To make it faster to solve the MILP problem, we can decrease the</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos"> 267</span></a>        <span class="c1"># number of variables by filtering out unhelpful and redundant options</span>
</span><span id="L-268"><a href="#L-268"><span class="linenos"> 268</span></a>        <span class="c1">#</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos"> 269</span></a>        <span class="c1"># (1) Unhelpful options: options that move the score to an undesirable</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos"> 270</span></a>        <span class="c1"># direction. For example, if we want to flip 0 to 1, options that decrease</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos"> 271</span></a>        <span class="c1"># the score are unhelpful.</span>
</span><span id="L-272"><a href="#L-272"><span class="linenos"> 272</span></a>        <span class="c1">#</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos"> 273</span></a>        <span class="c1"># (2) Redundant options: for a set of options that give similar score</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos"> 274</span></a>        <span class="c1"># gains (bounded by a parameter epsilon), we only need to incldue one</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos"> 275</span></a>        <span class="c1"># option that has the lowest distance. This is only relevant for</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos"> 276</span></a>        <span class="c1"># continuous variables. Users can set the parameter epsilon. The default</span>
</span><span id="L-277"><a href="#L-277"><span class="linenos"> 277</span></a>        <span class="c1"># should be relatively small, otherwise we might miss the optimal solution.</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos"> 278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos"> 279</span></a>        <span class="c1"># Step 2.1: Find all good options from continuous and categorical features</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos"> 280</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos"> 281</span></a>
</span><span id="L-282"><a href="#L-282"><span class="linenos"> 282</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos"> 283</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos"> 284</span></a>            <span class="n">cur_feature_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-285"><a href="#L-285"><span class="linenos"> 285</span></a>
</span><span id="L-286"><a href="#L-286"><span class="linenos"> 286</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos"> 287</span></a>                <span class="k">continue</span>
</span><span id="L-288"><a href="#L-288"><span class="linenos"> 288</span></a>
</span><span id="L-289"><a href="#L-289"><span class="linenos"> 289</span></a>            <span class="k">elif</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-290"><a href="#L-290"><span class="linenos"> 290</span></a>                <span class="c1"># The parameter epsilon controls the threshold of how we determine</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos"> 291</span></a>                <span class="c1"># &quot;similar&quot; options for continuous variables</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos"> 292</span></a>                <span class="n">epsilon</span> <span class="o">=</span> <span class="n">sim_threshold</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos"> 293</span></a>
</span><span id="L-294"><a href="#L-294"><span class="linenos"> 294</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="L-295"><a href="#L-295"><span class="linenos"> 295</span></a>                <span class="n">cur_feature_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cur_feature_id</span><span class="p">])</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos"> 296</span></a>
</span><span id="L-297"><a href="#L-297"><span class="linenos"> 297</span></a>                <span class="c1"># Users can require the continuous feature to have integer values</span>
</span><span id="L-298"><a href="#L-298"><span class="linenos"> 298</span></a>                <span class="c1"># For example, age, FICO score, and number of accounts</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos"> 299</span></a>                <span class="n">need_to_be_int</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos"> 300</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos"> 301</span></a>                    <span class="n">continuous_integer_features</span>
</span><span id="L-302"><a href="#L-302"><span class="linenos"> 302</span></a>                    <span class="ow">and</span> <span class="n">cur_feature_name</span> <span class="ow">in</span> <span class="n">continuous_integer_features</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos"> 303</span></a>                <span class="p">):</span>
</span><span id="L-304"><a href="#L-304"><span class="linenos"> 304</span></a>                    <span class="n">need_to_be_int</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos"> 305</span></a>
</span><span id="L-306"><a href="#L-306"><span class="linenos"> 306</span></a>                <span class="n">cur_cont_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cont_options</span><span class="p">(</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos"> 307</span></a>                    <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos"> 308</span></a>                    <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="L-309"><a href="#L-309"><span class="linenos"> 309</span></a>                    <span class="n">cur_feature_name</span><span class="p">,</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos"> 310</span></a>                    <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos"> 311</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="L-312"><a href="#L-312"><span class="linenos"> 312</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">,</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos"> 313</span></a>                    <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos"> 314</span></a>                    <span class="n">score_gain_bound</span><span class="p">,</span>
</span><span id="L-315"><a href="#L-315"><span class="linenos"> 315</span></a>                    <span class="n">epsilon</span><span class="p">,</span>
</span><span id="L-316"><a href="#L-316"><span class="linenos"> 316</span></a>                    <span class="n">need_to_be_int</span><span class="p">,</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos"> 317</span></a>                <span class="p">)</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos"> 318</span></a>
</span><span id="L-319"><a href="#L-319"><span class="linenos"> 319</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_cont_options</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos"> 320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos"> 321</span></a>            <span class="k">elif</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos"> 322</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos"> 323</span></a>                <span class="n">cur_feature_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cur_feature_id</span><span class="p">])</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos"> 324</span></a>                <span class="n">cur_cat_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="L-325"><a href="#L-325"><span class="linenos"> 325</span></a>
</span><span id="L-326"><a href="#L-326"><span class="linenos"> 326</span></a>                <span class="n">cur_cat_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cat_options</span><span class="p">(</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos"> 327</span></a>                    <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos"> 328</span></a>                    <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="L-329"><a href="#L-329"><span class="linenos"> 329</span></a>                    <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos"> 330</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="L-331"><a href="#L-331"><span class="linenos"> 331</span></a>                    <span class="n">cur_cat_distance</span><span class="p">,</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos"> 332</span></a>                    <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-333"><a href="#L-333"><span class="linenos"> 333</span></a>                    <span class="n">score_gain_bound</span><span class="p">,</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos"> 334</span></a>                <span class="p">)</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos"> 335</span></a>
</span><span id="L-336"><a href="#L-336"><span class="linenos"> 336</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_cat_options</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos"> 337</span></a>
</span><span id="L-338"><a href="#L-338"><span class="linenos"> 338</span></a>        <span class="c1"># Step 2.2: Filter out undesired options (based on the feature_range)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos"> 339</span></a>        <span class="k">if</span> <span class="n">feature_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-340"><a href="#L-340"><span class="linenos"> 340</span></a>            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">feature_ranges</span><span class="p">:</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos"> 341</span></a>                <span class="n">cur_range</span> <span class="o">=</span> <span class="n">feature_ranges</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span>
</span><span id="L-342"><a href="#L-342"><span class="linenos"> 342</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos"> 343</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="L-344"><a href="#L-344"><span class="linenos"> 344</span></a>
</span><span id="L-345"><a href="#L-345"><span class="linenos"> 345</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos"> 346</span></a>                    <span class="c1"># Delete options that use out-of-range options</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos"> 347</span></a>                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos"> 348</span></a>                        <span class="n">cur_target</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos"> 349</span></a>                        <span class="k">if</span> <span class="n">cur_target</span> <span class="o">&lt;</span> <span class="n">cur_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cur_target</span> <span class="o">&gt;</span> <span class="n">cur_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos"> 350</span></a>                            <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos"> 351</span></a>                <span class="k">elif</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos"> 352</span></a>                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-353"><a href="#L-353"><span class="linenos"> 353</span></a>                        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cur_range</span><span class="p">:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos"> 354</span></a>                            <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos"> 355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos"> 356</span></a>        <span class="c1"># Step 2.3: Compute the interaction offsets for all possible options</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos"> 357</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos"> 358</span></a>
</span><span id="L-359"><a href="#L-359"><span class="linenos"> 359</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="L-360"><a href="#L-360"><span class="linenos"> 360</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos"> 361</span></a>
</span><span id="L-362"><a href="#L-362"><span class="linenos"> 362</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="L-363"><a href="#L-363"><span class="linenos"> 363</span></a>
</span><span id="L-364"><a href="#L-364"><span class="linenos"> 364</span></a>                <span class="n">cur_feature_index_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos"> 365</span></a>                <span class="n">cur_feature_index_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-366"><a href="#L-366"><span class="linenos"> 366</span></a>
</span><span id="L-367"><a href="#L-367"><span class="linenos"> 367</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos"> 368</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_inter_options</span><span class="p">(</span>
</span><span id="L-369"><a href="#L-369"><span class="linenos"> 369</span></a>                    <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos"> 370</span></a>                    <span class="n">cur_feature_index_1</span><span class="p">,</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos"> 371</span></a>                    <span class="n">cur_feature_index_2</span><span class="p">,</span>
</span><span id="L-372"><a href="#L-372"><span class="linenos"> 372</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos"> 373</span></a>                    <span class="n">options</span><span class="p">,</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos"> 374</span></a>                <span class="p">)</span>
</span><span id="L-375"><a href="#L-375"><span class="linenos"> 375</span></a>
</span><span id="L-376"><a href="#L-376"><span class="linenos"> 376</span></a>        <span class="c1"># Step 2.4: Rescale categorical distances so that they have the same mean</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos"> 377</span></a>        <span class="c1"># as continuous variables (default)</span>
</span><span id="L-378"><a href="#L-378"><span class="linenos"> 378</span></a>        <span class="k">if</span> <span class="n">categorical_weight</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos"> 379</span></a>            <span class="n">cont_distances</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos"> 380</span></a>            <span class="n">cat_distances</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-381"><a href="#L-381"><span class="linenos"> 381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos"> 382</span></a>            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos"> 383</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos"> 384</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos"> 385</span></a>
</span><span id="L-386"><a href="#L-386"><span class="linenos"> 386</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-387"><a href="#L-387"><span class="linenos"> 387</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos"> 388</span></a>                        <span class="n">cont_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos"> 389</span></a>                <span class="k">elif</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos"> 390</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="L-391"><a href="#L-391"><span class="linenos"> 391</span></a>                        <span class="n">cat_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos"> 392</span></a>
</span><span id="L-393"><a href="#L-393"><span class="linenos"> 393</span></a>            <span class="n">categorical_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cont_distances</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cat_distances</span><span class="p">)</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos"> 394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos"> 395</span></a>        <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos"> 396</span></a>            <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="L-397"><a href="#L-397"><span class="linenos"> 397</span></a>            <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos"> 398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos"> 399</span></a>            <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos"> 400</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos"> 401</span></a>                    <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">categorical_weight</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos"> 402</span></a>
</span><span id="L-403"><a href="#L-403"><span class="linenos"> 403</span></a>        <span class="c1"># Step 3. Formulate the MILP model and solve it</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos"> 404</span></a>
</span><span id="L-405"><a href="#L-405"><span class="linenos"> 405</span></a>        <span class="c1"># Find diverse solutions by accumulatively muting the optimal solutions</span>
</span><span id="L-406"><a href="#L-406"><span class="linenos"> 406</span></a>        <span class="n">solutions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos"> 407</span></a>        <span class="n">muted_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-408"><a href="#L-408"><span class="linenos"> 408</span></a>        <span class="n">is_successful</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos"> 409</span></a>
</span><span id="L-410"><a href="#L-410"><span class="linenos"> 410</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">total_cfs</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="L-411"><a href="#L-411"><span class="linenos"> 411</span></a>            <span class="n">model</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_milp</span><span class="p">(</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos"> 412</span></a>                <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos"> 413</span></a>                <span class="n">needed_score_gain</span><span class="p">,</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos"> 414</span></a>                <span class="n">features_to_vary</span><span class="p">,</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos"> 415</span></a>                <span class="n">options</span><span class="p">,</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos"> 416</span></a>                <span class="n">max_num_features_to_vary</span><span class="p">,</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos"> 417</span></a>                <span class="n">muted_variables</span><span class="o">=</span><span class="n">muted_variables</span><span class="p">,</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos"> 418</span></a>            <span class="p">)</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos"> 419</span></a>
</span><span id="L-420"><a href="#L-420"><span class="linenos"> 420</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pulp</span><span class="o">.</span><span class="n">apis</span><span class="o">.</span><span class="n">PULP_CBC_CMD</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">warmStart</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos"> 421</span></a>
</span><span id="L-422"><a href="#L-422"><span class="linenos"> 422</span></a>            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-423"><a href="#L-423"><span class="linenos"> 423</span></a>                <span class="n">is_successful</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos"> 424</span></a>
</span><span id="L-425"><a href="#L-425"><span class="linenos"> 425</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-426"><a href="#L-426"><span class="linenos"> 426</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solver runs for </span><span class="si">{:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">solutionTime</span><span class="p">))</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos"> 427</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;status: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pulp</span><span class="o">.</span><span class="n">LpStatus</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">status</span><span class="p">]))</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos"> 428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos"> 429</span></a>            <span class="n">active_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos"> 430</span></a>
</span><span id="L-431"><a href="#L-431"><span class="linenos"> 431</span></a>            <span class="c1"># Print the optimal solution</span>
</span><span id="L-432"><a href="#L-432"><span class="linenos"> 432</span></a>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos"> 433</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos"> 434</span></a>                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">varValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-435"><a href="#L-435"><span class="linenos"> 435</span></a>                        <span class="n">active_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos"> 436</span></a>
</span><span id="L-437"><a href="#L-437"><span class="linenos"> 437</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-438"><a href="#L-438"><span class="linenos"> 438</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found solutions:&quot;</span><span class="p">)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos"> 439</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">print_solution</span><span class="p">(</span><span class="n">cur_example</span><span class="p">,</span> <span class="n">active_variables</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos"> 440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos"> 441</span></a>            <span class="c1"># Collect the current solution and mute the associated variables</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos"> 442</span></a>            <span class="n">solutions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">active_variables</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">objective</span><span class="p">)])</span>
</span><span id="L-443"><a href="#L-443"><span class="linenos"> 443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos"> 444</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">active_variables</span><span class="p">:</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos"> 445</span></a>                <span class="k">if</span> <span class="s2">&quot; x &quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos"> 446</span></a>                    <span class="n">muted_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos"> 447</span></a>
</span><span id="L-448"><a href="#L-448"><span class="linenos"> 448</span></a>        <span class="n">cfs</span> <span class="o">=</span> <span class="n">Counterfactuals</span><span class="p">(</span>
</span><span id="L-449"><a href="#L-449"><span class="linenos"> 449</span></a>            <span class="n">solutions</span><span class="p">,</span> <span class="n">is_successful</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="p">,</span> <span class="n">cur_example</span><span class="p">,</span> <span class="n">options</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos"> 450</span></a>        <span class="p">)</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos"> 451</span></a>
</span><span id="L-452"><a href="#L-452"><span class="linenos"> 452</span></a>        <span class="k">return</span> <span class="n">cfs</span>
</span><span id="L-453"><a href="#L-453"><span class="linenos"> 453</span></a>
</span><span id="L-454"><a href="#L-454"><span class="linenos"> 454</span></a>    <span class="k">def</span> <span class="nf">generate_cont_options</span><span class="p">(</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos"> 455</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos"> 456</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="L-457"><a href="#L-457"><span class="linenos"> 457</span></a>        <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos"> 458</span></a>        <span class="n">cur_feature_name</span><span class="p">,</span>
</span><span id="L-459"><a href="#L-459"><span class="linenos"> 459</span></a>        <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos"> 460</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="L-461"><a href="#L-461"><span class="linenos"> 461</span></a>        <span class="n">cont_mads</span><span class="p">,</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos"> 462</span></a>        <span class="n">cur_example</span><span class="p">,</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos"> 463</span></a>        <span class="n">score_gain_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos"> 464</span></a>        <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos"> 465</span></a>        <span class="n">need_to_be_int</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-466"><a href="#L-466"><span class="linenos"> 466</span></a>        <span class="n">skip_unhelpful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos"> 467</span></a>    <span class="p">):</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos"> 468</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-469"><a href="#L-469"><span class="linenos"> 469</span></a><span class="sd">        Generate all alternative options for this continuous variable. This function</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos"> 470</span></a><span class="sd">        would filter out all options that are:</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos"> 471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos"> 472</span></a><span class="sd">        1. Not helpful for the counterfactual generation.</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos"> 473</span></a><span class="sd">        2. Give similar score gain but requires larger distance.</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos"> 474</span></a>
</span><span id="L-475"><a href="#L-475"><span class="linenos"> 475</span></a><span class="sd">        Args:</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos"> 476</span></a><span class="sd">            cf_direction (int): Integer `+1` if 0 =&gt; 1, `-1` if 1 =&gt; 0</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos"> 477</span></a><span class="sd">                (classification); `+1` if we need to increase the prediction,</span>
</span><span id="L-478"><a href="#L-478"><span class="linenos"> 478</span></a><span class="sd">                `-1` if decrease (regression).</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos"> 479</span></a><span class="sd">            cur_feature_index (int): The index of the current continuous feature.</span>
</span><span id="L-480"><a href="#L-480"><span class="linenos"> 480</span></a><span class="sd">            cur_feature_name (str): Name of the current feature.</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos"> 481</span></a><span class="sd">            cur_feature_value (float): The current feature value.</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos"> 482</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos"> 483</span></a><span class="sd">            cont_mads (dict): A map of feature_name =&gt; MAD score.</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos"> 484</span></a><span class="sd">            cur_example (list): Current sample values</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos"> 485</span></a><span class="sd">            score_gain_bound (float): Bound of the score gain. We do not collect</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos"> 486</span></a><span class="sd">                options that give `score_gain` &gt; `score_gain_bound` (when</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos"> 487</span></a><span class="sd">                `cf_direction=1`), or `score_gain` &lt; `score_gain_bound` (when</span>
</span><span id="L-488"><a href="#L-488"><span class="linenos"> 488</span></a><span class="sd">                `cf_direction=-1`)</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos"> 489</span></a><span class="sd">            epsilon (float): The threshold to determine if two options give similar</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos"> 490</span></a><span class="sd">                score gains. Score gains $s_1$ and $s_2$ are similar if</span>
</span><span id="L-491"><a href="#L-491"><span class="linenos"> 491</span></a><span class="sd">                $|s_1 - s_2| &lt;$ epsilon. Smaller epsilon significantly increases</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos"> 492</span></a><span class="sd">                the time to solve the MILP. Large epsilon might filter out the</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos"> 493</span></a><span class="sd">                optimal CF. Defaults to 0.005.</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos"> 494</span></a><span class="sd">            need_to_be_int (bool): True if the target values for this continuous</span>
</span><span id="L-495"><a href="#L-495"><span class="linenos"> 495</span></a><span class="sd">                variable need to have integer values.</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos"> 496</span></a><span class="sd">            skip_unhelpful (bool): True if to skip options from main</span>
</span><span id="L-497"><a href="#L-497"><span class="linenos"> 497</span></a><span class="sd">                effects that give opposite score gain. It is rare that there is a</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos"> 498</span></a><span class="sd">                positive score gain from pair-interaction that outweigh negative</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos"> 499</span></a><span class="sd">                score gain from two main effects, and adjusting the distance penalty.</span>
</span><span id="L-500"><a href="#L-500"><span class="linenos"> 500</span></a>
</span><span id="L-501"><a href="#L-501"><span class="linenos"> 501</span></a><span class="sd">        Returns:</span>
</span><span id="L-502"><a href="#L-502"><span class="linenos"> 502</span></a><span class="sd">            list: List of option tuples (target, score gain, distance, bin_index)</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos"> 503</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos"> 504</span></a>
</span><span id="L-505"><a href="#L-505"><span class="linenos"> 505</span></a>        <span class="c1"># For each continuous feature, each bin is a variable</span>
</span><span id="L-506"><a href="#L-506"><span class="linenos"> 506</span></a>        <span class="c1"># For each bin, we need to compute (1) score gain, (2) distance</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos"> 507</span></a>        <span class="c1"># (1) score gain is the difference between new bin and current bin</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos"> 508</span></a>        <span class="c1"># (2) distance is L1 distance divided by median absolute deviation (MAD)</span>
</span><span id="L-509"><a href="#L-509"><span class="linenos"> 509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos"> 510</span></a>        <span class="c1"># Get the additive scores of this feature</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos"> 511</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_index</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos"> 512</span></a>
</span><span id="L-513"><a href="#L-513"><span class="linenos"> 513</span></a>        <span class="c1"># Get the bin edges of this feature</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos"> 514</span></a>        <span class="n">bin_starts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_feature_index</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-515"><a href="#L-515"><span class="linenos"> 515</span></a>
</span><span id="L-516"><a href="#L-516"><span class="linenos"> 516</span></a>        <span class="c1"># Create &quot;options&quot;, each option is a tuple (target, score_gain, distance,</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos"> 517</span></a>        <span class="c1"># bin_index)</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos"> 518</span></a>        <span class="n">cont_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-519"><a href="#L-519"><span class="linenos"> 519</span></a>
</span><span id="L-520"><a href="#L-520"><span class="linenos"> 520</span></a>        <span class="c1"># Identify which bin this value falls into</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos"> 521</span></a>        <span class="n">cur_bin_id</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">,</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos"> 522</span></a>        <span class="k">assert</span> <span class="n">additives</span><span class="p">[</span><span class="n">cur_bin_id</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_score</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos"> 523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos"> 524</span></a>        <span class="c1"># Identify interaction terms that we need to consider</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos"> 525</span></a>        <span class="n">associated_interactions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos"> 526</span></a>
</span><span id="L-527"><a href="#L-527"><span class="linenos"> 527</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos"> 528</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos"> 529</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos"> 530</span></a>
</span><span id="L-531"><a href="#L-531"><span class="linenos"> 531</span></a>                <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos"> 532</span></a>
</span><span id="L-533"><a href="#L-533"><span class="linenos"> 533</span></a>                <span class="k">if</span> <span class="n">cur_feature_index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
</span><span id="L-534"><a href="#L-534"><span class="linenos"> 534</span></a>                    <span class="n">feature_position</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_index</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos"> 535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos"> 536</span></a>                    <span class="n">other_position</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">feature_position</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos"> 537</span></a>                    <span class="n">other_index</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">other_position</span><span class="p">]</span>
</span><span id="L-538"><a href="#L-538"><span class="linenos"> 538</span></a>                    <span class="n">other_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos"> 539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos"> 540</span></a>                    <span class="c1"># Get the current additive scores and bin edges</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos"> 541</span></a>                    <span class="n">inter_additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos"> 542</span></a>
</span><span id="L-543"><a href="#L-543"><span class="linenos"> 543</span></a>                    <span class="c1"># Have to skip the max edge if it is continuous</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos"> 544</span></a>                    <span class="n">bin_starts_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos"> 545</span></a>                        <span class="n">cur_feature_index</span>
</span><span id="L-546"><a href="#L-546"><span class="linenos"> 546</span></a>                    <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos"> 547</span></a>
</span><span id="L-548"><a href="#L-548"><span class="linenos"> 548</span></a>                    <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos"> 549</span></a>                        <span class="n">other_index</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos"> 550</span></a>                    <span class="p">)</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos"> 551</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos"> 552</span></a>                        <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos"> 553</span></a>
</span><span id="L-554"><a href="#L-554"><span class="linenos"> 554</span></a>                    <span class="c1"># Get the current interaction term score</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos"> 555</span></a>                    <span class="n">other_bin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos"> 556</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-557"><a href="#L-557"><span class="linenos"> 557</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos"> 558</span></a>                            <span class="n">bin_starts_other</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="L-559"><a href="#L-559"><span class="linenos"> 559</span></a>                        <span class="p">)</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos"> 560</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos"> 561</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos"> 562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos"> 563</span></a>                    <span class="n">feature_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos"> 564</span></a>                        <span class="n">bin_starts_feature</span><span class="p">,</span> <span class="n">cur_feature_value</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos"> 565</span></a>                    <span class="p">)</span>
</span><span id="L-566"><a href="#L-566"><span class="linenos"> 566</span></a>
</span><span id="L-567"><a href="#L-567"><span class="linenos"> 567</span></a>                    <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos"> 568</span></a>
</span><span id="L-569"><a href="#L-569"><span class="linenos"> 569</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-570"><a href="#L-570"><span class="linenos"> 570</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">feature_bin</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos"> 571</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-572"><a href="#L-572"><span class="linenos"> 572</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">feature_bin</span><span class="p">]</span>
</span><span id="L-573"><a href="#L-573"><span class="linenos"> 573</span></a>
</span><span id="L-574"><a href="#L-574"><span class="linenos"> 574</span></a>                    <span class="c1"># Extract the row or column where we fix the other feature and</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos"> 575</span></a>                    <span class="c1"># vary the current feature</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos"> 576</span></a>                    <span class="n">feature_inter_bin_starts</span> <span class="o">=</span> <span class="n">bin_starts_feature</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos"> 577</span></a>                    <span class="n">feature_inter_additives</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos"> 578</span></a>
</span><span id="L-579"><a href="#L-579"><span class="linenos"> 579</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos"> 580</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">)):</span>
</span><span id="L-581"><a href="#L-581"><span class="linenos"> 581</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos"> 582</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos"> 583</span></a>                            <span class="p">)</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos"> 584</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos"> 585</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos"> 586</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos"> 587</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos"> 588</span></a>                            <span class="p">)</span>
</span><span id="L-589"><a href="#L-589"><span class="linenos"> 589</span></a>
</span><span id="L-590"><a href="#L-590"><span class="linenos"> 590</span></a>                    <span class="c1"># Register this interaction term</span>
</span><span id="L-591"><a href="#L-591"><span class="linenos"> 591</span></a>                    <span class="n">associated_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos"> 592</span></a>                        <span class="p">{</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos"> 593</span></a>                            <span class="s2">&quot;inter_index&quot;</span><span class="p">:</span> <span class="n">indexes</span><span class="p">,</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos"> 594</span></a>                            <span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">:</span> <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="L-595"><a href="#L-595"><span class="linenos"> 595</span></a>                            <span class="s2">&quot;feature_inter_score&quot;</span><span class="p">:</span> <span class="n">feature_inter_score</span><span class="p">,</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos"> 596</span></a>                            <span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">:</span> <span class="n">feature_inter_bin_starts</span><span class="p">,</span>
</span><span id="L-597"><a href="#L-597"><span class="linenos"> 597</span></a>                            <span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">:</span> <span class="n">feature_inter_additives</span><span class="p">,</span>
</span><span id="L-598"><a href="#L-598"><span class="linenos"> 598</span></a>                        <span class="p">}</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos"> 599</span></a>                    <span class="p">)</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos"> 600</span></a>
</span><span id="L-601"><a href="#L-601"><span class="linenos"> 601</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)):</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos"> 602</span></a>            <span class="c1"># Because of the special binning structure of EBM, the distance of</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos"> 603</span></a>            <span class="c1"># bins on the left to the current value is different from the bins</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos"> 604</span></a>            <span class="c1"># that are on the right</span>
</span><span id="L-605"><a href="#L-605"><span class="linenos"> 605</span></a>            <span class="c1">#</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos"> 606</span></a>            <span class="c1"># For bins on the left, the raw distance is abs(bin_start[i + 1] - x)</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos"> 607</span></a>            <span class="c1"># For bins on the right, the raw distance is abs(bin_start[i] - x)</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos"> 608</span></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">cur_feature_value</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos"> 609</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos"> 610</span></a>
</span><span id="L-611"><a href="#L-611"><span class="linenos"> 611</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cur_bin_id</span><span class="p">:</span>
</span><span id="L-612"><a href="#L-612"><span class="linenos"> 612</span></a>                <span class="c1"># First need to consider if it is need to be an integer</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos"> 613</span></a>                <span class="c1"># If so, it would be the closest integer to the right point</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos"> 614</span></a>                <span class="k">if</span> <span class="n">need_to_be_int</span><span class="p">:</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos"> 615</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="L-616"><a href="#L-616"><span class="linenos"> 616</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos"> 617</span></a>                        <span class="n">target</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos"> 618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos"> 619</span></a>                    <span class="c1"># Skip this option if it is not possible to find an int value</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos"> 620</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-621"><a href="#L-621"><span class="linenos"> 621</span></a>                        <span class="k">continue</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos"> 622</span></a>
</span><span id="L-623"><a href="#L-623"><span class="linenos"> 623</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos"> 624</span></a>
</span><span id="L-625"><a href="#L-625"><span class="linenos"> 625</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-626"><a href="#L-626"><span class="linenos"> 626</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos"> 627</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos"> 628</span></a>
</span><span id="L-629"><a href="#L-629"><span class="linenos"> 629</span></a>                    <span class="c1"># Subtract a very smaller value to make the target</span>
</span><span id="L-630"><a href="#L-630"><span class="linenos"> 630</span></a>                    <span class="c1"># technically fall into the left bin</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos"> 631</span></a>                    <span class="n">target</span> <span class="o">-=</span> <span class="mf">1e-4</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos"> 632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos"> 633</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">cur_bin_id</span><span class="p">:</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos"> 634</span></a>                <span class="c1"># First need to consider if it should be an integer value</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos"> 635</span></a>                <span class="c1"># If so, it would be the closest integer to the left point</span>
</span><span id="L-636"><a href="#L-636"><span class="linenos"> 636</span></a>                <span class="k">if</span> <span class="n">need_to_be_int</span><span class="p">:</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos"> 637</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="L-638"><a href="#L-638"><span class="linenos"> 638</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos"> 639</span></a>                        <span class="n">target</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos"> 640</span></a>
</span><span id="L-641"><a href="#L-641"><span class="linenos"> 641</span></a>                    <span class="c1"># Skip this option if it is not possible to find an int value</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos"> 642</span></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="L-643"><a href="#L-643"><span class="linenos"> 643</span></a>                        <span class="k">continue</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos"> 644</span></a>
</span><span id="L-645"><a href="#L-645"><span class="linenos"> 645</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos"> 646</span></a>
</span><span id="L-647"><a href="#L-647"><span class="linenos"> 647</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos"> 648</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-649"><a href="#L-649"><span class="linenos"> 649</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="L-650"><a href="#L-650"><span class="linenos"> 650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos"> 651</span></a>            <span class="c1"># Scale the distance based on the deviation of the feature (how changeable it is)</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos"> 652</span></a>            <span class="k">if</span> <span class="n">cont_mads</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos"> 653</span></a>                <span class="n">distance</span> <span class="o">/=</span> <span class="n">cont_mads</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="L-654"><a href="#L-654"><span class="linenos"> 654</span></a>
</span><span id="L-655"><a href="#L-655"><span class="linenos"> 655</span></a>            <span class="c1"># Compute score gain which has two parts:</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos"> 656</span></a>            <span class="c1"># (1) gain from the change of main effect</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos"> 657</span></a>            <span class="c1"># (2) gain from the change of interaction effect</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos"> 658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos"> 659</span></a>            <span class="c1"># Main effect</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos"> 660</span></a>            <span class="n">main_score_gain</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="L-661"><a href="#L-661"><span class="linenos"> 661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos"> 662</span></a>            <span class="c1"># Interaction terms</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos"> 663</span></a>            <span class="c1"># A list to track all interaction score gain offsets</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos"> 664</span></a>            <span class="c1"># [[interaction id, interaction score gain]]</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos"> 665</span></a>            <span class="n">inter_score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos"> 666</span></a>            <span class="n">inter_score_gains</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos"> 667</span></a>
</span><span id="L-668"><a href="#L-668"><span class="linenos"> 668</span></a>            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">associated_interactions</span><span class="p">:</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos"> 669</span></a>                <span class="n">inter_bin_id</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos"> 670</span></a>                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">],</span> <span class="n">target</span>
</span><span id="L-671"><a href="#L-671"><span class="linenos"> 671</span></a>                <span class="p">)</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos"> 672</span></a>                <span class="n">inter_score_gain</span> <span class="o">+=</span> <span class="p">(</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos"> 673</span></a>                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="L-674"><a href="#L-674"><span class="linenos"> 674</span></a>                    <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">]</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos"> 675</span></a>                <span class="p">)</span>
</span><span id="L-676"><a href="#L-676"><span class="linenos"> 676</span></a>                <span class="n">inter_score_gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos"> 677</span></a>                    <span class="p">[</span>
</span><span id="L-678"><a href="#L-678"><span class="linenos"> 678</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">],</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos"> 679</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos"> 680</span></a>                        <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">],</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos"> 681</span></a>                    <span class="p">]</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos"> 682</span></a>                <span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos"> 683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos"> 684</span></a>            <span class="n">score_gain</span> <span class="o">=</span> <span class="n">main_score_gain</span> <span class="o">+</span> <span class="n">inter_score_gain</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos"> 685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos"> 686</span></a>            <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">*</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos"> 687</span></a>                <span class="k">continue</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos"> 688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos"> 689</span></a>            <span class="c1"># Filter out of bound options</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos"> 690</span></a>            <span class="k">if</span> <span class="n">score_gain_bound</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos"> 691</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&gt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="L-692"><a href="#L-692"><span class="linenos"> 692</span></a>                    <span class="k">continue</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos"> 693</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&lt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="L-694"><a href="#L-694"><span class="linenos"> 694</span></a>                    <span class="k">continue</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos"> 695</span></a>
</span><span id="L-696"><a href="#L-696"><span class="linenos"> 696</span></a>            <span class="n">cont_options</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">score_gain</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inter_score_gains</span><span class="p">])</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos"> 697</span></a>
</span><span id="L-698"><a href="#L-698"><span class="linenos"> 698</span></a>        <span class="c1"># Now we can apply the second round of filtering to remove redundant options</span>
</span><span id="L-699"><a href="#L-699"><span class="linenos"> 699</span></a>        <span class="c1"># Redundant options refer to bins that give similar score gain with larger distance</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos"> 700</span></a>        <span class="n">cont_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cont_options</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos"> 701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos"> 702</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos"> 703</span></a>        <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont_options</span><span class="p">):</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos"> 704</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cont_options</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos"> 705</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cont_options</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cont_options</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos"> 706</span></a>                    <span class="n">cont_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="L-707"><a href="#L-707"><span class="linenos"> 707</span></a>
</span><span id="L-708"><a href="#L-708"><span class="linenos"> 708</span></a>            <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-709"><a href="#L-709"><span class="linenos"> 709</span></a>
</span><span id="L-710"><a href="#L-710"><span class="linenos"> 710</span></a>        <span class="k">return</span> <span class="n">cont_options</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos"> 711</span></a>
</span><span id="L-712"><a href="#L-712"><span class="linenos"> 712</span></a>    <span class="k">def</span> <span class="nf">generate_cat_options</span><span class="p">(</span>
</span><span id="L-713"><a href="#L-713"><span class="linenos"> 713</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos"> 714</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos"> 715</span></a>        <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="L-716"><a href="#L-716"><span class="linenos"> 716</span></a>        <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos"> 717</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="L-718"><a href="#L-718"><span class="linenos"> 718</span></a>        <span class="n">cur_cat_distance</span><span class="p">,</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos"> 719</span></a>        <span class="n">cur_example</span><span class="p">,</span>
</span><span id="L-720"><a href="#L-720"><span class="linenos"> 720</span></a>        <span class="n">score_gain_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos"> 721</span></a>        <span class="n">skip_unhelpful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos"> 722</span></a>    <span class="p">):</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos"> 723</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos"> 724</span></a><span class="sd">        Generate all alternative options for this categorical variable. This function</span>
</span><span id="L-725"><a href="#L-725"><span class="linenos"> 725</span></a><span class="sd">        would filter out all options that are not helpful for the counterfactual</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos"> 726</span></a><span class="sd">        generation.</span>
</span><span id="L-727"><a href="#L-727"><span class="linenos"> 727</span></a>
</span><span id="L-728"><a href="#L-728"><span class="linenos"> 728</span></a><span class="sd">        Args:</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos"> 729</span></a><span class="sd">            cf_direction (int): Integer `+1` if 0 =&gt; 1, `-1` if 1 =&gt; 0</span>
</span><span id="L-730"><a href="#L-730"><span class="linenos"> 730</span></a><span class="sd">                (classification); `+1` if we need to increase the prediction,</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos"> 731</span></a><span class="sd">                `-1` if decrease (regression).</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos"> 732</span></a><span class="sd">            cur_feature_index (int): The index of the current continuous feature.</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos"> 733</span></a><span class="sd">            cur_feature_value (float): The current feature value.</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos"> 734</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="L-735"><a href="#L-735"><span class="linenos"> 735</span></a><span class="sd">            cur_cat_distance (dict): A map of feature_level =&gt; 1 - frequency.</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos"> 736</span></a><span class="sd">            cur_example (list): Current sample values.</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos"> 737</span></a><span class="sd">            score_gain_bound (float): Bound of the score gain. We do not collect</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos"> 738</span></a><span class="sd">                options that give `score_gain` &gt; `score_gain_bound` (when</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos"> 739</span></a><span class="sd">                `cf_direction=1`), or `score_gain` &lt; `score_gain_bound` (when</span>
</span><span id="L-740"><a href="#L-740"><span class="linenos"> 740</span></a><span class="sd">                `cf_direction=-1`)</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos"> 741</span></a><span class="sd">            skip_unhelpful (bool): True if to skip options from main</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos"> 742</span></a><span class="sd">                effects that give opposite score gain. It is rare that there is a</span>
</span><span id="L-743"><a href="#L-743"><span class="linenos"> 743</span></a><span class="sd">                positive score gain from pair-interaction that outweigh negative</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos"> 744</span></a><span class="sd">                score gain from two main effects, and adjusting the distance penalty.</span>
</span><span id="L-745"><a href="#L-745"><span class="linenos"> 745</span></a>
</span><span id="L-746"><a href="#L-746"><span class="linenos"> 746</span></a><span class="sd">        Returns:</span>
</span><span id="L-747"><a href="#L-747"><span class="linenos"> 747</span></a><span class="sd">            list: List of option tuples (target, score_gain, distance, bin_index).</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos"> 748</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos"> 749</span></a>
</span><span id="L-750"><a href="#L-750"><span class="linenos"> 750</span></a>        <span class="c1"># Find other options for this categorical variable</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos"> 751</span></a>        <span class="c1"># For each option, we compute the (1) score gain, and (2) distance</span>
</span><span id="L-752"><a href="#L-752"><span class="linenos"> 752</span></a>        <span class="c1">#</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos"> 753</span></a>        <span class="c1"># (1) Score gain is the same as continuous variables</span>
</span><span id="L-754"><a href="#L-754"><span class="linenos"> 754</span></a>        <span class="c1"># (2) The distance is determined by 1 - the level frequency in the</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos"> 755</span></a>        <span class="c1"># training data. It implies that levels with high frequency are easier</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos"> 756</span></a>        <span class="c1"># to &quot;move to&quot;</span>
</span><span id="L-757"><a href="#L-757"><span class="linenos"> 757</span></a>
</span><span id="L-758"><a href="#L-758"><span class="linenos"> 758</span></a>        <span class="c1"># Get the additive scores of this feature</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos"> 759</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_index</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-760"><a href="#L-760"><span class="linenos"> 760</span></a>
</span><span id="L-761"><a href="#L-761"><span class="linenos"> 761</span></a>        <span class="c1"># Get the bin edges of this feature</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos"> 762</span></a>        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_feature_index</span><span class="p">)</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos"> 763</span></a>
</span><span id="L-764"><a href="#L-764"><span class="linenos"> 764</span></a>        <span class="c1"># Create &quot;options&quot;, each option is a tuple (target, score_gain, distance, bin_index)</span>
</span><span id="L-765"><a href="#L-765"><span class="linenos"> 765</span></a>        <span class="n">cat_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos"> 766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos"> 767</span></a>        <span class="c1"># Identify interaction terms that we need to consider</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos"> 768</span></a>        <span class="n">associated_interactions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos"> 769</span></a>
</span><span id="L-770"><a href="#L-770"><span class="linenos"> 770</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-771"><a href="#L-771"><span class="linenos"> 771</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos"> 772</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos"> 773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos"> 774</span></a>                <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos"> 775</span></a>
</span><span id="L-776"><a href="#L-776"><span class="linenos"> 776</span></a>                <span class="k">if</span> <span class="n">cur_feature_index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos"> 777</span></a>                    <span class="n">feature_position</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_index</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos"> 778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos"> 779</span></a>                    <span class="n">other_position</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">feature_position</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos"> 780</span></a>                    <span class="n">other_index</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">other_position</span><span class="p">]</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos"> 781</span></a>                    <span class="n">other_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos"> 782</span></a>                    <span class="n">other_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="L-783"><a href="#L-783"><span class="linenos"> 783</span></a>
</span><span id="L-784"><a href="#L-784"><span class="linenos"> 784</span></a>                    <span class="c1"># Get the current additive scores and bin edges</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos"> 785</span></a>                    <span class="n">inter_additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos"> 786</span></a>
</span><span id="L-787"><a href="#L-787"><span class="linenos"> 787</span></a>                    <span class="n">bin_starts_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="L-788"><a href="#L-788"><span class="linenos"> 788</span></a>                        <span class="n">cur_feature_index</span>
</span><span id="L-789"><a href="#L-789"><span class="linenos"> 789</span></a>                    <span class="p">)</span>
</span><span id="L-790"><a href="#L-790"><span class="linenos"> 790</span></a>                    <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="L-791"><a href="#L-791"><span class="linenos"> 791</span></a>                        <span class="n">other_index</span>
</span><span id="L-792"><a href="#L-792"><span class="linenos"> 792</span></a>                    <span class="p">)</span>
</span><span id="L-793"><a href="#L-793"><span class="linenos"> 793</span></a>
</span><span id="L-794"><a href="#L-794"><span class="linenos"> 794</span></a>                    <span class="c1"># Have to skip the max edge if it is continuous</span>
</span><span id="L-795"><a href="#L-795"><span class="linenos"> 795</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-796"><a href="#L-796"><span class="linenos"> 796</span></a>                        <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-797"><a href="#L-797"><span class="linenos"> 797</span></a>
</span><span id="L-798"><a href="#L-798"><span class="linenos"> 798</span></a>                    <span class="c1"># Get the current interaction term score</span>
</span><span id="L-799"><a href="#L-799"><span class="linenos"> 799</span></a>                    <span class="n">other_bin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-800"><a href="#L-800"><span class="linenos"> 800</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-801"><a href="#L-801"><span class="linenos"> 801</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="L-802"><a href="#L-802"><span class="linenos"> 802</span></a>                            <span class="n">bin_starts_other</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="L-803"><a href="#L-803"><span class="linenos"> 803</span></a>                        <span class="p">)</span>
</span><span id="L-804"><a href="#L-804"><span class="linenos"> 804</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-805"><a href="#L-805"><span class="linenos"> 805</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="L-806"><a href="#L-806"><span class="linenos"> 806</span></a>
</span><span id="L-807"><a href="#L-807"><span class="linenos"> 807</span></a>                    <span class="n">feature_bin</span> <span class="o">=</span> <span class="n">bin_starts_feature</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="L-808"><a href="#L-808"><span class="linenos"> 808</span></a>
</span><span id="L-809"><a href="#L-809"><span class="linenos"> 809</span></a>                    <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-810"><a href="#L-810"><span class="linenos"> 810</span></a>
</span><span id="L-811"><a href="#L-811"><span class="linenos"> 811</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-812"><a href="#L-812"><span class="linenos"> 812</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">feature_bin</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="L-813"><a href="#L-813"><span class="linenos"> 813</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-814"><a href="#L-814"><span class="linenos"> 814</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">feature_bin</span><span class="p">]</span>
</span><span id="L-815"><a href="#L-815"><span class="linenos"> 815</span></a>
</span><span id="L-816"><a href="#L-816"><span class="linenos"> 816</span></a>                    <span class="c1"># Extract the row or column where we fix the other features and</span>
</span><span id="L-817"><a href="#L-817"><span class="linenos"> 817</span></a>                    <span class="c1"># vary the current feature</span>
</span><span id="L-818"><a href="#L-818"><span class="linenos"> 818</span></a>                    <span class="n">feature_inter_bin_starts</span> <span class="o">=</span> <span class="n">bin_starts_feature</span>
</span><span id="L-819"><a href="#L-819"><span class="linenos"> 819</span></a>                    <span class="n">feature_inter_additives</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-820"><a href="#L-820"><span class="linenos"> 820</span></a>
</span><span id="L-821"><a href="#L-821"><span class="linenos"> 821</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="L-822"><a href="#L-822"><span class="linenos"> 822</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">)):</span>
</span><span id="L-823"><a href="#L-823"><span class="linenos"> 823</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-824"><a href="#L-824"><span class="linenos"> 824</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="L-825"><a href="#L-825"><span class="linenos"> 825</span></a>                            <span class="p">)</span>
</span><span id="L-826"><a href="#L-826"><span class="linenos"> 826</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-827"><a href="#L-827"><span class="linenos"> 827</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span><span id="L-828"><a href="#L-828"><span class="linenos"> 828</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-829"><a href="#L-829"><span class="linenos"> 829</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-830"><a href="#L-830"><span class="linenos"> 830</span></a>                            <span class="p">)</span>
</span><span id="L-831"><a href="#L-831"><span class="linenos"> 831</span></a>
</span><span id="L-832"><a href="#L-832"><span class="linenos"> 832</span></a>                    <span class="c1"># Register this interaction term</span>
</span><span id="L-833"><a href="#L-833"><span class="linenos"> 833</span></a>                    <span class="n">associated_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-834"><a href="#L-834"><span class="linenos"> 834</span></a>                        <span class="p">{</span>
</span><span id="L-835"><a href="#L-835"><span class="linenos"> 835</span></a>                            <span class="s2">&quot;inter_index&quot;</span><span class="p">:</span> <span class="n">indexes</span><span class="p">,</span>
</span><span id="L-836"><a href="#L-836"><span class="linenos"> 836</span></a>                            <span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">:</span> <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="L-837"><a href="#L-837"><span class="linenos"> 837</span></a>                            <span class="s2">&quot;feature_inter_score&quot;</span><span class="p">:</span> <span class="n">feature_inter_score</span><span class="p">,</span>
</span><span id="L-838"><a href="#L-838"><span class="linenos"> 838</span></a>                            <span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">:</span> <span class="n">feature_inter_bin_starts</span><span class="p">,</span>
</span><span id="L-839"><a href="#L-839"><span class="linenos"> 839</span></a>                            <span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">:</span> <span class="n">feature_inter_additives</span><span class="p">,</span>
</span><span id="L-840"><a href="#L-840"><span class="linenos"> 840</span></a>                        <span class="p">}</span>
</span><span id="L-841"><a href="#L-841"><span class="linenos"> 841</span></a>                    <span class="p">)</span>
</span><span id="L-842"><a href="#L-842"><span class="linenos"> 842</span></a>
</span><span id="L-843"><a href="#L-843"><span class="linenos"> 843</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)):</span>
</span><span id="L-844"><a href="#L-844"><span class="linenos"> 844</span></a>            <span class="k">if</span> <span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cur_feature_value</span><span class="p">:</span>
</span><span id="L-845"><a href="#L-845"><span class="linenos"> 845</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-846"><a href="#L-846"><span class="linenos"> 846</span></a>                <span class="n">distance</span> <span class="o">=</span> <span class="n">cur_cat_distance</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
</span><span id="L-847"><a href="#L-847"><span class="linenos"> 847</span></a>
</span><span id="L-848"><a href="#L-848"><span class="linenos"> 848</span></a>                <span class="c1"># Compute score gain which has two parts:</span>
</span><span id="L-849"><a href="#L-849"><span class="linenos"> 849</span></a>                <span class="c1"># (1) gain from the change of main effect</span>
</span><span id="L-850"><a href="#L-850"><span class="linenos"> 850</span></a>                <span class="c1"># (2) gain from the change of interaction effect</span>
</span><span id="L-851"><a href="#L-851"><span class="linenos"> 851</span></a>
</span><span id="L-852"><a href="#L-852"><span class="linenos"> 852</span></a>                <span class="c1"># Main effect</span>
</span><span id="L-853"><a href="#L-853"><span class="linenos"> 853</span></a>                <span class="n">main_score_gain</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="L-854"><a href="#L-854"><span class="linenos"> 854</span></a>
</span><span id="L-855"><a href="#L-855"><span class="linenos"> 855</span></a>                <span class="c1"># Interaction terms</span>
</span><span id="L-856"><a href="#L-856"><span class="linenos"> 856</span></a>                <span class="c1"># A list to track all interaction score gain offsets</span>
</span><span id="L-857"><a href="#L-857"><span class="linenos"> 857</span></a>                <span class="c1"># [[interaction id, interaction score gain]]</span>
</span><span id="L-858"><a href="#L-858"><span class="linenos"> 858</span></a>                <span class="n">inter_score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-859"><a href="#L-859"><span class="linenos"> 859</span></a>                <span class="n">inter_score_gains</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-860"><a href="#L-860"><span class="linenos"> 860</span></a>
</span><span id="L-861"><a href="#L-861"><span class="linenos"> 861</span></a>                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">associated_interactions</span><span class="p">:</span>
</span><span id="L-862"><a href="#L-862"><span class="linenos"> 862</span></a>                    <span class="n">inter_bin_id</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="L-863"><a href="#L-863"><span class="linenos"> 863</span></a>                    <span class="n">inter_score_gain</span> <span class="o">+=</span> <span class="p">(</span>
</span><span id="L-864"><a href="#L-864"><span class="linenos"> 864</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="L-865"><a href="#L-865"><span class="linenos"> 865</span></a>                        <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">]</span>
</span><span id="L-866"><a href="#L-866"><span class="linenos"> 866</span></a>                    <span class="p">)</span>
</span><span id="L-867"><a href="#L-867"><span class="linenos"> 867</span></a>                    <span class="n">inter_score_gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-868"><a href="#L-868"><span class="linenos"> 868</span></a>                        <span class="p">[</span>
</span><span id="L-869"><a href="#L-869"><span class="linenos"> 869</span></a>                            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">],</span>
</span><span id="L-870"><a href="#L-870"><span class="linenos"> 870</span></a>                            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="L-871"><a href="#L-871"><span class="linenos"> 871</span></a>                            <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">],</span>
</span><span id="L-872"><a href="#L-872"><span class="linenos"> 872</span></a>                        <span class="p">]</span>
</span><span id="L-873"><a href="#L-873"><span class="linenos"> 873</span></a>                    <span class="p">)</span>
</span><span id="L-874"><a href="#L-874"><span class="linenos"> 874</span></a>
</span><span id="L-875"><a href="#L-875"><span class="linenos"> 875</span></a>                <span class="n">score_gain</span> <span class="o">=</span> <span class="n">main_score_gain</span> <span class="o">+</span> <span class="n">inter_score_gain</span>
</span><span id="L-876"><a href="#L-876"><span class="linenos"> 876</span></a>
</span><span id="L-877"><a href="#L-877"><span class="linenos"> 877</span></a>                <span class="c1"># Skip unhelpful options</span>
</span><span id="L-878"><a href="#L-878"><span class="linenos"> 878</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">*</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="L-879"><a href="#L-879"><span class="linenos"> 879</span></a>                    <span class="k">continue</span>
</span><span id="L-880"><a href="#L-880"><span class="linenos"> 880</span></a>
</span><span id="L-881"><a href="#L-881"><span class="linenos"> 881</span></a>                <span class="c1"># Filter out of bound options</span>
</span><span id="L-882"><a href="#L-882"><span class="linenos"> 882</span></a>                <span class="k">if</span> <span class="n">score_gain_bound</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="L-883"><a href="#L-883"><span class="linenos"> 883</span></a>                    <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&gt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="L-884"><a href="#L-884"><span class="linenos"> 884</span></a>                        <span class="k">continue</span>
</span><span id="L-885"><a href="#L-885"><span class="linenos"> 885</span></a>                    <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&lt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="L-886"><a href="#L-886"><span class="linenos"> 886</span></a>                        <span class="k">continue</span>
</span><span id="L-887"><a href="#L-887"><span class="linenos"> 887</span></a>
</span><span id="L-888"><a href="#L-888"><span class="linenos"> 888</span></a>                <span class="n">cat_options</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">score_gain</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inter_score_gains</span><span class="p">])</span>
</span><span id="L-889"><a href="#L-889"><span class="linenos"> 889</span></a>
</span><span id="L-890"><a href="#L-890"><span class="linenos"> 890</span></a>        <span class="k">return</span> <span class="n">cat_options</span>
</span><span id="L-891"><a href="#L-891"><span class="linenos"> 891</span></a>
</span><span id="L-892"><a href="#L-892"><span class="linenos"> 892</span></a>    <span class="k">def</span> <span class="nf">generate_inter_options</span><span class="p">(</span>
</span><span id="L-893"><a href="#L-893"><span class="linenos"> 893</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-894"><a href="#L-894"><span class="linenos"> 894</span></a>        <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="L-895"><a href="#L-895"><span class="linenos"> 895</span></a>        <span class="n">cur_feature_index_1</span><span class="p">,</span>
</span><span id="L-896"><a href="#L-896"><span class="linenos"> 896</span></a>        <span class="n">cur_feature_index_2</span><span class="p">,</span>
</span><span id="L-897"><a href="#L-897"><span class="linenos"> 897</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="L-898"><a href="#L-898"><span class="linenos"> 898</span></a>        <span class="n">options</span><span class="p">,</span>
</span><span id="L-899"><a href="#L-899"><span class="linenos"> 899</span></a>    <span class="p">):</span>
</span><span id="L-900"><a href="#L-900"><span class="linenos"> 900</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-901"><a href="#L-901"><span class="linenos"> 901</span></a><span class="sd">        Generate all possible options for this interaction variable.</span>
</span><span id="L-902"><a href="#L-902"><span class="linenos"> 902</span></a>
</span><span id="L-903"><a href="#L-903"><span class="linenos"> 903</span></a><span class="sd">        Interaction terms are interesting in this MILP. Each option counts as a</span>
</span><span id="L-904"><a href="#L-904"><span class="linenos"> 904</span></a><span class="sd">        variable, but each variable only affects the score gain, not the distance.</span>
</span><span id="L-905"><a href="#L-905"><span class="linenos"> 905</span></a>
</span><span id="L-906"><a href="#L-906"><span class="linenos"> 906</span></a><span class="sd">        Note that in EBM, the bin definitions for interaction terms can be different</span>
</span><span id="L-907"><a href="#L-907"><span class="linenos"> 907</span></a><span class="sd">        from their definitions for individual continuous variables.</span>
</span><span id="L-908"><a href="#L-908"><span class="linenos"> 908</span></a>
</span><span id="L-909"><a href="#L-909"><span class="linenos"> 909</span></a><span class="sd">        To model interaction terms, we can think it as a binary variable. The</span>
</span><span id="L-910"><a href="#L-910"><span class="linenos"> 910</span></a><span class="sd">        value is determined by the multiplication of two main effect variables.</span>
</span><span id="L-911"><a href="#L-911"><span class="linenos"> 911</span></a><span class="sd">        Each interaction variable describes a combination of two main effect</span>
</span><span id="L-912"><a href="#L-912"><span class="linenos"> 912</span></a><span class="sd">        variables. Therefore, say continuous variable A has $x$ probable options,</span>
</span><span id="L-913"><a href="#L-913"><span class="linenos"> 913</span></a><span class="sd">        and another continuous variable B has $y$ probable options, then we should</span>
</span><span id="L-914"><a href="#L-914"><span class="linenos"> 914</span></a><span class="sd">        add $x \\times y$ binary variables to offset their probable interaction</span>
</span><span id="L-915"><a href="#L-915"><span class="linenos"> 915</span></a><span class="sd">        effects.</span>
</span><span id="L-916"><a href="#L-916"><span class="linenos"> 916</span></a>
</span><span id="L-917"><a href="#L-917"><span class="linenos"> 917</span></a><span class="sd">        Args:</span>
</span><span id="L-918"><a href="#L-918"><span class="linenos"> 918</span></a><span class="sd">            cur_feature_id (int): The id of this interaction effect.</span>
</span><span id="L-919"><a href="#L-919"><span class="linenos"> 919</span></a><span class="sd">            cur_feature_index_1 (int): The index of the first main effect.</span>
</span><span id="L-920"><a href="#L-920"><span class="linenos"> 920</span></a><span class="sd">            cur_feature_index_2 (int): The index of the second main effect.</span>
</span><span id="L-921"><a href="#L-921"><span class="linenos"> 921</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="L-922"><a href="#L-922"><span class="linenos"> 922</span></a><span class="sd">            options (dict): The current option list, feature_name -&gt;</span>
</span><span id="L-923"><a href="#L-923"><span class="linenos"> 923</span></a><span class="sd">                [`target`, `score_gain`, `distance`, `bin_id`].</span>
</span><span id="L-924"><a href="#L-924"><span class="linenos"> 924</span></a>
</span><span id="L-925"><a href="#L-925"><span class="linenos"> 925</span></a><span class="sd">        Returns:</span>
</span><span id="L-926"><a href="#L-926"><span class="linenos"> 926</span></a><span class="sd">            List of option tuples (target, score_gain, distance, bin_index)</span>
</span><span id="L-927"><a href="#L-927"><span class="linenos"> 927</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-928"><a href="#L-928"><span class="linenos"> 928</span></a>
</span><span id="L-929"><a href="#L-929"><span class="linenos"> 929</span></a>        <span class="c1"># Get the sub-types for this interaction term</span>
</span><span id="L-930"><a href="#L-930"><span class="linenos"> 930</span></a>        <span class="n">cur_feature_type_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_index_1</span><span class="p">]</span>
</span><span id="L-931"><a href="#L-931"><span class="linenos"> 931</span></a>        <span class="n">cur_feature_type_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_index_2</span><span class="p">]</span>
</span><span id="L-932"><a href="#L-932"><span class="linenos"> 932</span></a>
</span><span id="L-933"><a href="#L-933"><span class="linenos"> 933</span></a>        <span class="c1"># Get the sub-names for this interaction term</span>
</span><span id="L-934"><a href="#L-934"><span class="linenos"> 934</span></a>        <span class="n">cur_feature_name_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_index_1</span><span class="p">]</span>
</span><span id="L-935"><a href="#L-935"><span class="linenos"> 935</span></a>        <span class="n">cur_feature_name_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_index_2</span><span class="p">]</span>
</span><span id="L-936"><a href="#L-936"><span class="linenos"> 936</span></a>
</span><span id="L-937"><a href="#L-937"><span class="linenos"> 937</span></a>        <span class="c1"># The first column and row are reserved for missing values (even with</span>
</span><span id="L-938"><a href="#L-938"><span class="linenos"> 938</span></a>        <span class="c1"># categorical features)</span>
</span><span id="L-939"><a href="#L-939"><span class="linenos"> 939</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="L-940"><a href="#L-940"><span class="linenos"> 940</span></a>
</span><span id="L-941"><a href="#L-941"><span class="linenos"> 941</span></a>        <span class="c1"># Four possibilities here: cont x cont, cont x cat, cat x cont, cat x cat.</span>
</span><span id="L-942"><a href="#L-942"><span class="linenos"> 942</span></a>        <span class="c1"># Each has a different way to lookup the bin table.</span>
</span><span id="L-943"><a href="#L-943"><span class="linenos"> 943</span></a>        <span class="n">inter_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-944"><a href="#L-944"><span class="linenos"> 944</span></a>
</span><span id="L-945"><a href="#L-945"><span class="linenos"> 945</span></a>        <span class="c1"># Iterate through all possible combinations of options from these two</span>
</span><span id="L-946"><a href="#L-946"><span class="linenos"> 946</span></a>        <span class="c1"># variables</span>
</span><span id="L-947"><a href="#L-947"><span class="linenos"> 947</span></a>        <span class="k">for</span> <span class="n">opt_1</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name_1</span><span class="p">]:</span>
</span><span id="L-948"><a href="#L-948"><span class="linenos"> 948</span></a>            <span class="k">for</span> <span class="n">opt_2</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name_2</span><span class="p">]:</span>
</span><span id="L-949"><a href="#L-949"><span class="linenos"> 949</span></a>
</span><span id="L-950"><a href="#L-950"><span class="linenos"> 950</span></a>                <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="L-951"><a href="#L-951"><span class="linenos"> 951</span></a>                    <span class="n">cur_feature_index_1</span>
</span><span id="L-952"><a href="#L-952"><span class="linenos"> 952</span></a>                <span class="p">)</span>
</span><span id="L-953"><a href="#L-953"><span class="linenos"> 953</span></a>                <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="L-954"><a href="#L-954"><span class="linenos"> 954</span></a>                    <span class="n">cur_feature_index_2</span>
</span><span id="L-955"><a href="#L-955"><span class="linenos"> 955</span></a>                <span class="p">)</span>
</span><span id="L-956"><a href="#L-956"><span class="linenos"> 956</span></a>
</span><span id="L-957"><a href="#L-957"><span class="linenos"> 957</span></a>                <span class="n">bin_1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-958"><a href="#L-958"><span class="linenos"> 958</span></a>                <span class="n">bin_2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-959"><a href="#L-959"><span class="linenos"> 959</span></a>
</span><span id="L-960"><a href="#L-960"><span class="linenos"> 960</span></a>                <span class="k">if</span> <span class="n">cur_feature_type_1</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-961"><a href="#L-961"><span class="linenos"> 961</span></a>                    <span class="k">if</span> <span class="n">cur_feature_type_2</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-962"><a href="#L-962"><span class="linenos"> 962</span></a>                        <span class="c1"># cont x cont</span>
</span><span id="L-963"><a href="#L-963"><span class="linenos"> 963</span></a>                        <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-964"><a href="#L-964"><span class="linenos"> 964</span></a>                        <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-965"><a href="#L-965"><span class="linenos"> 965</span></a>
</span><span id="L-966"><a href="#L-966"><span class="linenos"> 966</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="L-967"><a href="#L-967"><span class="linenos"> 967</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_1</span><span class="p">,</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-968"><a href="#L-968"><span class="linenos"> 968</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_2</span><span class="p">,</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-969"><a href="#L-969"><span class="linenos"> 969</span></a>
</span><span id="L-970"><a href="#L-970"><span class="linenos"> 970</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-971"><a href="#L-971"><span class="linenos"> 971</span></a>                        <span class="c1"># cont x cat</span>
</span><span id="L-972"><a href="#L-972"><span class="linenos"> 972</span></a>                        <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-973"><a href="#L-973"><span class="linenos"> 973</span></a>
</span><span id="L-974"><a href="#L-974"><span class="linenos"> 974</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="L-975"><a href="#L-975"><span class="linenos"> 975</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_1</span><span class="p">,</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-976"><a href="#L-976"><span class="linenos"> 976</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-977"><a href="#L-977"><span class="linenos"> 977</span></a>
</span><span id="L-978"><a href="#L-978"><span class="linenos"> 978</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-979"><a href="#L-979"><span class="linenos"> 979</span></a>                    <span class="k">if</span> <span class="n">cur_feature_type_2</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-980"><a href="#L-980"><span class="linenos"> 980</span></a>                        <span class="c1"># cat x cont</span>
</span><span id="L-981"><a href="#L-981"><span class="linenos"> 981</span></a>                        <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-982"><a href="#L-982"><span class="linenos"> 982</span></a>
</span><span id="L-983"><a href="#L-983"><span class="linenos"> 983</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="L-984"><a href="#L-984"><span class="linenos"> 984</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-985"><a href="#L-985"><span class="linenos"> 985</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_2</span><span class="p">,</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-986"><a href="#L-986"><span class="linenos"> 986</span></a>
</span><span id="L-987"><a href="#L-987"><span class="linenos"> 987</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-988"><a href="#L-988"><span class="linenos"> 988</span></a>                        <span class="c1"># cat x cat</span>
</span><span id="L-989"><a href="#L-989"><span class="linenos"> 989</span></a>
</span><span id="L-990"><a href="#L-990"><span class="linenos"> 990</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="L-991"><a href="#L-991"><span class="linenos"> 991</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-992"><a href="#L-992"><span class="linenos"> 992</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-993"><a href="#L-993"><span class="linenos"> 993</span></a>
</span><span id="L-994"><a href="#L-994"><span class="linenos"> 994</span></a>                <span class="n">new_score</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">bin_1</span><span class="p">,</span> <span class="n">bin_2</span><span class="p">]</span>
</span><span id="L-995"><a href="#L-995"><span class="linenos"> 995</span></a>                <span class="n">score_gain</span> <span class="o">=</span> <span class="n">new_score</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="L-996"><a href="#L-996"><span class="linenos"> 996</span></a>
</span><span id="L-997"><a href="#L-997"><span class="linenos"> 997</span></a>                <span class="c1"># The score gain on the interaction term need to offset the interaction</span>
</span><span id="L-998"><a href="#L-998"><span class="linenos"> 998</span></a>                <span class="c1"># score gain we have already counted on the main effect options. That</span>
</span><span id="L-999"><a href="#L-999"><span class="linenos"> 999</span></a>                <span class="c1"># score is saved in the option tuple.</span>
</span><span id="L-1000"><a href="#L-1000"><span class="linenos">1000</span></a>
</span><span id="L-1001"><a href="#L-1001"><span class="linenos">1001</span></a>                <span class="c1"># We first need to find the common interaction id</span>
</span><span id="L-1002"><a href="#L-1002"><span class="linenos">1002</span></a>                <span class="n">common_index</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1003"><a href="#L-1003"><span class="linenos">1003</span></a>                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="L-1004"><a href="#L-1004"><span class="linenos">1004</span></a>                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="L-1005"><a href="#L-1005"><span class="linenos">1005</span></a>                        <span class="k">if</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="L-1006"><a href="#L-1006"><span class="linenos">1006</span></a>                            <span class="n">common_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
</span><span id="L-1007"><a href="#L-1007"><span class="linenos">1007</span></a>                            <span class="k">break</span>
</span><span id="L-1008"><a href="#L-1008"><span class="linenos">1008</span></a>
</span><span id="L-1009"><a href="#L-1009"><span class="linenos">1009</span></a>                    <span class="k">if</span> <span class="n">common_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">common_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="L-1010"><a href="#L-1010"><span class="linenos">1010</span></a>                        <span class="k">break</span>
</span><span id="L-1011"><a href="#L-1011"><span class="linenos">1011</span></a>
</span><span id="L-1012"><a href="#L-1012"><span class="linenos">1012</span></a>                <span class="n">score_gain</span> <span class="o">-=</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">common_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1013"><a href="#L-1013"><span class="linenos">1013</span></a>                <span class="n">score_gain</span> <span class="o">-=</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">common_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1014"><a href="#L-1014"><span class="linenos">1014</span></a>
</span><span id="L-1015"><a href="#L-1015"><span class="linenos">1015</span></a>                <span class="n">inter_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-1016"><a href="#L-1016"><span class="linenos">1016</span></a>                    <span class="p">[[</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">score_gain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="L-1017"><a href="#L-1017"><span class="linenos">1017</span></a>                <span class="p">)</span>
</span><span id="L-1018"><a href="#L-1018"><span class="linenos">1018</span></a>
</span><span id="L-1019"><a href="#L-1019"><span class="linenos">1019</span></a>        <span class="k">return</span> <span class="n">inter_options</span>
</span><span id="L-1020"><a href="#L-1020"><span class="linenos">1020</span></a>
</span><span id="L-1021"><a href="#L-1021"><span class="linenos">1021</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-1022"><a href="#L-1022"><span class="linenos">1022</span></a>    <span class="k">def</span> <span class="nf">create_milp</span><span class="p">(</span>
</span><span id="L-1023"><a href="#L-1023"><span class="linenos">1023</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="L-1024"><a href="#L-1024"><span class="linenos">1024</span></a>        <span class="n">needed_score_gain</span><span class="p">,</span>
</span><span id="L-1025"><a href="#L-1025"><span class="linenos">1025</span></a>        <span class="n">features_to_vary</span><span class="p">,</span>
</span><span id="L-1026"><a href="#L-1026"><span class="linenos">1026</span></a>        <span class="n">options</span><span class="p">,</span>
</span><span id="L-1027"><a href="#L-1027"><span class="linenos">1027</span></a>        <span class="n">max_num_features_to_vary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1028"><a href="#L-1028"><span class="linenos">1028</span></a>        <span class="n">muted_variables</span><span class="o">=</span><span class="p">[],</span>
</span><span id="L-1029"><a href="#L-1029"><span class="linenos">1029</span></a>    <span class="p">):</span>
</span><span id="L-1030"><a href="#L-1030"><span class="linenos">1030</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1031"><a href="#L-1031"><span class="linenos">1031</span></a><span class="sd">        Create a MILP to find counterfactuals (CF) using PuLP.</span>
</span><span id="L-1032"><a href="#L-1032"><span class="linenos">1032</span></a>
</span><span id="L-1033"><a href="#L-1033"><span class="linenos">1033</span></a><span class="sd">        Args:</span>
</span><span id="L-1034"><a href="#L-1034"><span class="linenos">1034</span></a><span class="sd">            cf_direction (int): Integer +1 if 0 =&gt; 1, -1 if 1 =&gt; 0 (classification),</span>
</span><span id="L-1035"><a href="#L-1035"><span class="linenos">1035</span></a><span class="sd">                +1 if we need to incrase the prediction, -1 if decrease (regression).</span>
</span><span id="L-1036"><a href="#L-1036"><span class="linenos">1036</span></a><span class="sd">            needed_score_gain (float): The score gain needed to achieve the CF goal.</span>
</span><span id="L-1037"><a href="#L-1037"><span class="linenos">1037</span></a><span class="sd">            features_to_vary (list[str]): Feature names of features that the</span>
</span><span id="L-1038"><a href="#L-1038"><span class="linenos">1038</span></a><span class="sd">                generated CF can change.</span>
</span><span id="L-1039"><a href="#L-1039"><span class="linenos">1039</span></a><span class="sd">            options (dict): Possible options for each variable. Each option is a</span>
</span><span id="L-1040"><a href="#L-1040"><span class="linenos">1040</span></a><span class="sd">                list [target, score_gain, distance, bin_index].</span>
</span><span id="L-1041"><a href="#L-1041"><span class="linenos">1041</span></a><span class="sd">            max_num_features_to_vary (int, optional): Max number of features that the</span>
</span><span id="L-1042"><a href="#L-1042"><span class="linenos">1042</span></a><span class="sd">                generated CF can change. If the value is `None`, the CFs can</span>
</span><span id="L-1043"><a href="#L-1043"><span class="linenos">1043</span></a><span class="sd">                change any number of features.</span>
</span><span id="L-1044"><a href="#L-1044"><span class="linenos">1044</span></a><span class="sd">            muted_variables (list[str], optional): Variables that this MILP should</span>
</span><span id="L-1045"><a href="#L-1045"><span class="linenos">1045</span></a><span class="sd">                not use. This is useful to mute optimal variables so we can explore</span>
</span><span id="L-1046"><a href="#L-1046"><span class="linenos">1046</span></a><span class="sd">                diverse solutions. This list should not include interaction variables.</span>
</span><span id="L-1047"><a href="#L-1047"><span class="linenos">1047</span></a>
</span><span id="L-1048"><a href="#L-1048"><span class="linenos">1048</span></a><span class="sd">        Returns:</span>
</span><span id="L-1049"><a href="#L-1049"><span class="linenos">1049</span></a><span class="sd">            A tuple (`model`, `variables`), where `model` is a pulp.LpProblem</span>
</span><span id="L-1050"><a href="#L-1050"><span class="linenos">1050</span></a><span class="sd">            model that encodes the MILP problem, and `variables` is a dict of</span>
</span><span id="L-1051"><a href="#L-1051"><span class="linenos">1051</span></a><span class="sd">            variables used in the `model`: `feature_name` =&gt; [`variables`].</span>
</span><span id="L-1052"><a href="#L-1052"><span class="linenos">1052</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1053"><a href="#L-1053"><span class="linenos">1053</span></a>
</span><span id="L-1054"><a href="#L-1054"><span class="linenos">1054</span></a>        <span class="c1"># Create a model (minimizing the distance)</span>
</span><span id="L-1055"><a href="#L-1055"><span class="linenos">1055</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">(</span><span class="s2">&quot;ebmCounterfactual&quot;</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpMinimize</span><span class="p">)</span>
</span><span id="L-1056"><a href="#L-1056"><span class="linenos">1056</span></a>
</span><span id="L-1057"><a href="#L-1057"><span class="linenos">1057</span></a>        <span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1058"><a href="#L-1058"><span class="linenos">1058</span></a>        <span class="n">score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1059"><a href="#L-1059"><span class="linenos">1059</span></a>
</span><span id="L-1060"><a href="#L-1060"><span class="linenos">1060</span></a>        <span class="n">muted_variables_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">muted_variables</span><span class="p">)</span>
</span><span id="L-1061"><a href="#L-1061"><span class="linenos">1061</span></a>
</span><span id="L-1062"><a href="#L-1062"><span class="linenos">1062</span></a>        <span class="c1"># Create variables</span>
</span><span id="L-1063"><a href="#L-1063"><span class="linenos">1063</span></a>        <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1064"><a href="#L-1064"><span class="linenos">1064</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_to_vary</span><span class="p">:</span>
</span><span id="L-1065"><a href="#L-1065"><span class="linenos">1065</span></a>            <span class="c1"># Each variable encodes an option (0: not use this option,</span>
</span><span id="L-1066"><a href="#L-1066"><span class="linenos">1066</span></a>            <span class="c1"># 1: use this option)</span>
</span><span id="L-1067"><a href="#L-1067"><span class="linenos">1067</span></a>            <span class="n">cur_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1068"><a href="#L-1068"><span class="linenos">1068</span></a>
</span><span id="L-1069"><a href="#L-1069"><span class="linenos">1069</span></a>            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
</span><span id="L-1070"><a href="#L-1070"><span class="linenos">1070</span></a>                <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="L-1071"><a href="#L-1071"><span class="linenos">1071</span></a>
</span><span id="L-1072"><a href="#L-1072"><span class="linenos">1072</span></a>                <span class="c1"># Skip the muted variables</span>
</span><span id="L-1073"><a href="#L-1073"><span class="linenos">1073</span></a>                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span><span class="p">:</span>
</span><span id="L-1074"><a href="#L-1074"><span class="linenos">1074</span></a>                    <span class="k">continue</span>
</span><span id="L-1075"><a href="#L-1075"><span class="linenos">1075</span></a>
</span><span id="L-1076"><a href="#L-1076"><span class="linenos">1076</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upBound</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Binary&quot;</span><span class="p">)</span>
</span><span id="L-1077"><a href="#L-1077"><span class="linenos">1077</span></a>                <span class="n">x</span><span class="o">.</span><span class="n">setInitialValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1078"><a href="#L-1078"><span class="linenos">1078</span></a>
</span><span id="L-1079"><a href="#L-1079"><span class="linenos">1079</span></a>                <span class="n">score_gain</span> <span class="o">+=</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
</span><span id="L-1080"><a href="#L-1080"><span class="linenos">1080</span></a>                <span class="n">distance</span> <span class="o">+=</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
</span><span id="L-1081"><a href="#L-1081"><span class="linenos">1081</span></a>
</span><span id="L-1082"><a href="#L-1082"><span class="linenos">1082</span></a>                <span class="n">cur_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="L-1083"><a href="#L-1083"><span class="linenos">1083</span></a>
</span><span id="L-1084"><a href="#L-1084"><span class="linenos">1084</span></a>            <span class="n">variables</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_variables</span>
</span><span id="L-1085"><a href="#L-1085"><span class="linenos">1085</span></a>
</span><span id="L-1086"><a href="#L-1086"><span class="linenos">1086</span></a>            <span class="c1"># A local constraint is that we can only at most selection one option from</span>
</span><span id="L-1087"><a href="#L-1087"><span class="linenos">1087</span></a>            <span class="c1"># one feature</span>
</span><span id="L-1088"><a href="#L-1088"><span class="linenos">1088</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">lpSum</span><span class="p">(</span><span class="n">cur_variables</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
</span><span id="L-1089"><a href="#L-1089"><span class="linenos">1089</span></a>
</span><span id="L-1090"><a href="#L-1090"><span class="linenos">1090</span></a>        <span class="c1"># Users can also set `max_num_features_to_vary` to control the total</span>
</span><span id="L-1091"><a href="#L-1091"><span class="linenos">1091</span></a>        <span class="c1"># number of features to vary</span>
</span><span id="L-1092"><a href="#L-1092"><span class="linenos">1092</span></a>        <span class="k">if</span> <span class="n">max_num_features_to_vary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="L-1093"><a href="#L-1093"><span class="linenos">1093</span></a>            <span class="n">main_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1094"><a href="#L-1094"><span class="linenos">1094</span></a>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
</span><span id="L-1095"><a href="#L-1095"><span class="linenos">1095</span></a>                <span class="n">main_variables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
</span><span id="L-1096"><a href="#L-1096"><span class="linenos">1096</span></a>
</span><span id="L-1097"><a href="#L-1097"><span class="linenos">1097</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">lpSum</span><span class="p">(</span><span class="n">main_variables</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_num_features_to_vary</span>
</span><span id="L-1098"><a href="#L-1098"><span class="linenos">1098</span></a>
</span><span id="L-1099"><a href="#L-1099"><span class="linenos">1099</span></a>        <span class="c1"># Create variables for interaction effects</span>
</span><span id="L-1100"><a href="#L-1100"><span class="linenos">1100</span></a>        <span class="k">for</span> <span class="n">opt_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="L-1101"><a href="#L-1101"><span class="linenos">1101</span></a>            <span class="k">if</span> <span class="s2">&quot; x &quot;</span> <span class="ow">in</span> <span class="n">opt_name</span><span class="p">:</span>
</span><span id="L-1102"><a href="#L-1102"><span class="linenos">1102</span></a>                <span class="n">f1_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+)\sx\s.+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">opt_name</span><span class="p">)</span>
</span><span id="L-1103"><a href="#L-1103"><span class="linenos">1103</span></a>                <span class="n">f2_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+\sx\s(.+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">opt_name</span><span class="p">)</span>
</span><span id="L-1104"><a href="#L-1104"><span class="linenos">1104</span></a>
</span><span id="L-1105"><a href="#L-1105"><span class="linenos">1105</span></a>                <span class="k">if</span> <span class="n">f1_name</span> <span class="ow">in</span> <span class="n">features_to_vary</span> <span class="ow">and</span> <span class="n">f2_name</span> <span class="ow">in</span> <span class="n">features_to_vary</span><span class="p">:</span>
</span><span id="L-1106"><a href="#L-1106"><span class="linenos">1106</span></a>
</span><span id="L-1107"><a href="#L-1107"><span class="linenos">1107</span></a>                    <span class="c1"># We need to include this interaction effect</span>
</span><span id="L-1108"><a href="#L-1108"><span class="linenos">1108</span></a>                    <span class="n">cur_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1109"><a href="#L-1109"><span class="linenos">1109</span></a>
</span><span id="L-1110"><a href="#L-1110"><span class="linenos">1110</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">opt_name</span><span class="p">]:</span>
</span><span id="L-1111"><a href="#L-1111"><span class="linenos">1111</span></a>                        <span class="n">z</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">(</span>
</span><span id="L-1112"><a href="#L-1112"><span class="linenos">1112</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="L-1113"><a href="#L-1113"><span class="linenos">1113</span></a>                            <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="L-1114"><a href="#L-1114"><span class="linenos">1114</span></a>                            <span class="n">upBound</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-1115"><a href="#L-1115"><span class="linenos">1115</span></a>                            <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Continuous&quot;</span><span class="p">,</span>
</span><span id="L-1116"><a href="#L-1116"><span class="linenos">1116</span></a>                        <span class="p">)</span>
</span><span id="L-1117"><a href="#L-1117"><span class="linenos">1117</span></a>                        <span class="n">z</span><span class="o">.</span><span class="n">setInitialValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-1118"><a href="#L-1118"><span class="linenos">1118</span></a>
</span><span id="L-1119"><a href="#L-1119"><span class="linenos">1119</span></a>                        <span class="c1"># Need to iterate through existing variables for f1 and f2 to find</span>
</span><span id="L-1120"><a href="#L-1120"><span class="linenos">1120</span></a>                        <span class="c1"># the corresponding variables</span>
</span><span id="L-1121"><a href="#L-1121"><span class="linenos">1121</span></a>                        <span class="n">x_f1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1122"><a href="#L-1122"><span class="linenos">1122</span></a>                        <span class="n">x_f2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="L-1123"><a href="#L-1123"><span class="linenos">1123</span></a>
</span><span id="L-1124"><a href="#L-1124"><span class="linenos">1124</span></a>                        <span class="c1"># Skp if this interaction variable involves muted main variable</span>
</span><span id="L-1125"><a href="#L-1125"><span class="linenos">1125</span></a>                        <span class="n">x_f1_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f1_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1126"><a href="#L-1126"><span class="linenos">1126</span></a>                        <span class="n">x_f2_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f2_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1127"><a href="#L-1127"><span class="linenos">1127</span></a>
</span><span id="L-1128"><a href="#L-1128"><span class="linenos">1128</span></a>                        <span class="k">if</span> <span class="p">(</span>
</span><span id="L-1129"><a href="#L-1129"><span class="linenos">1129</span></a>                            <span class="n">x_f1_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span>
</span><span id="L-1130"><a href="#L-1130"><span class="linenos">1130</span></a>                            <span class="ow">or</span> <span class="n">x_f2_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span>
</span><span id="L-1131"><a href="#L-1131"><span class="linenos">1131</span></a>                        <span class="p">):</span>
</span><span id="L-1132"><a href="#L-1132"><span class="linenos">1132</span></a>                            <span class="k">continue</span>
</span><span id="L-1133"><a href="#L-1133"><span class="linenos">1133</span></a>
</span><span id="L-1134"><a href="#L-1134"><span class="linenos">1134</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">f1_name</span><span class="p">]:</span>
</span><span id="L-1135"><a href="#L-1135"><span class="linenos">1135</span></a>                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">x_f1_name</span><span class="p">:</span>
</span><span id="L-1136"><a href="#L-1136"><span class="linenos">1136</span></a>                                <span class="n">x_f1</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="L-1137"><a href="#L-1137"><span class="linenos">1137</span></a>                                <span class="k">break</span>
</span><span id="L-1138"><a href="#L-1138"><span class="linenos">1138</span></a>
</span><span id="L-1139"><a href="#L-1139"><span class="linenos">1139</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">f2_name</span><span class="p">]:</span>
</span><span id="L-1140"><a href="#L-1140"><span class="linenos">1140</span></a>                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">x_f2_name</span><span class="p">:</span>
</span><span id="L-1141"><a href="#L-1141"><span class="linenos">1141</span></a>                                <span class="n">x_f2</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="L-1142"><a href="#L-1142"><span class="linenos">1142</span></a>                                <span class="k">break</span>
</span><span id="L-1143"><a href="#L-1143"><span class="linenos">1143</span></a>
</span><span id="L-1144"><a href="#L-1144"><span class="linenos">1144</span></a>                        <span class="k">assert</span> <span class="n">x_f1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x_f2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="L-1145"><a href="#L-1145"><span class="linenos">1145</span></a>
</span><span id="L-1146"><a href="#L-1146"><span class="linenos">1146</span></a>                        <span class="c1"># variable z is actually the product of x_f1 and x_f2</span>
</span><span id="L-1147"><a href="#L-1147"><span class="linenos">1147</span></a>                        <span class="c1"># We can linearize it by 3 constraints</span>
</span><span id="L-1148"><a href="#L-1148"><span class="linenos">1148</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">x_f1</span>
</span><span id="L-1149"><a href="#L-1149"><span class="linenos">1149</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">x_f2</span>
</span><span id="L-1150"><a href="#L-1150"><span class="linenos">1150</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">x_f1</span> <span class="o">+</span> <span class="n">x_f2</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1151"><a href="#L-1151"><span class="linenos">1151</span></a>
</span><span id="L-1152"><a href="#L-1152"><span class="linenos">1152</span></a>                        <span class="n">cur_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="L-1153"><a href="#L-1153"><span class="linenos">1153</span></a>
</span><span id="L-1154"><a href="#L-1154"><span class="linenos">1154</span></a>                    <span class="n">variables</span><span class="p">[</span><span class="n">opt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_variables</span>
</span><span id="L-1155"><a href="#L-1155"><span class="linenos">1155</span></a>
</span><span id="L-1156"><a href="#L-1156"><span class="linenos">1156</span></a>        <span class="c1"># Use constraint to express counterfactual</span>
</span><span id="L-1157"><a href="#L-1157"><span class="linenos">1157</span></a>        <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1158"><a href="#L-1158"><span class="linenos">1158</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">score_gain</span> <span class="o">&gt;=</span> <span class="n">needed_score_gain</span>
</span><span id="L-1159"><a href="#L-1159"><span class="linenos">1159</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1160"><a href="#L-1160"><span class="linenos">1160</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="n">needed_score_gain</span>
</span><span id="L-1161"><a href="#L-1161"><span class="linenos">1161</span></a>
</span><span id="L-1162"><a href="#L-1162"><span class="linenos">1162</span></a>        <span class="c1"># We want to minimize the distance</span>
</span><span id="L-1163"><a href="#L-1163"><span class="linenos">1163</span></a>        <span class="n">model</span> <span class="o">+=</span> <span class="n">distance</span>
</span><span id="L-1164"><a href="#L-1164"><span class="linenos">1164</span></a>
</span><span id="L-1165"><a href="#L-1165"><span class="linenos">1165</span></a>        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">variables</span>
</span><span id="L-1166"><a href="#L-1166"><span class="linenos">1166</span></a>
</span><span id="L-1167"><a href="#L-1167"><span class="linenos">1167</span></a>    <span class="k">def</span> <span class="nf">print_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cur_example</span><span class="p">,</span> <span class="n">active_variables</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
</span><span id="L-1168"><a href="#L-1168"><span class="linenos">1168</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1169"><a href="#L-1169"><span class="linenos">1169</span></a><span class="sd">        Print the optimal solution.</span>
</span><span id="L-1170"><a href="#L-1170"><span class="linenos">1170</span></a>
</span><span id="L-1171"><a href="#L-1171"><span class="linenos">1171</span></a><span class="sd">        Args:</span>
</span><span id="L-1172"><a href="#L-1172"><span class="linenos">1172</span></a><span class="sd">            cur_example (np.ndarray): the original data point.</span>
</span><span id="L-1173"><a href="#L-1173"><span class="linenos">1173</span></a><span class="sd">            active_variables (list[variable]): binary variables with value 1.</span>
</span><span id="L-1174"><a href="#L-1174"><span class="linenos">1174</span></a><span class="sd">            options (dict): all the possible options for all features.</span>
</span><span id="L-1175"><a href="#L-1175"><span class="linenos">1175</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1176"><a href="#L-1176"><span class="linenos">1176</span></a>
</span><span id="L-1177"><a href="#L-1177"><span class="linenos">1177</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">active_variables</span><span class="p">:</span>
</span><span id="L-1178"><a href="#L-1178"><span class="linenos">1178</span></a>            <span class="c1"># Skip interaction vars (included)</span>
</span><span id="L-1179"><a href="#L-1179"><span class="linenos">1179</span></a>            <span class="k">if</span> <span class="s2">&quot;_x_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="L-1180"><a href="#L-1180"><span class="linenos">1180</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+):\d+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-1181"><a href="#L-1181"><span class="linenos">1181</span></a>                <span class="n">bin_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:(\d+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="L-1182"><a href="#L-1182"><span class="linenos">1182</span></a>
</span><span id="L-1183"><a href="#L-1183"><span class="linenos">1183</span></a>                <span class="c1"># Find the original value</span>
</span><span id="L-1184"><a href="#L-1184"><span class="linenos">1184</span></a>                <span class="n">org_value</span> <span class="o">=</span> <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)]</span>
</span><span id="L-1185"><a href="#L-1185"><span class="linenos">1185</span></a>
</span><span id="L-1186"><a href="#L-1186"><span class="linenos">1186</span></a>                <span class="c1"># Find the target bin</span>
</span><span id="L-1187"><a href="#L-1187"><span class="linenos">1187</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="L-1188"><a href="#L-1188"><span class="linenos">1188</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="L-1189"><a href="#L-1189"><span class="linenos">1189</span></a>
</span><span id="L-1190"><a href="#L-1190"><span class="linenos">1190</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-1191"><a href="#L-1191"><span class="linenos">1191</span></a>                    <span class="n">bin_starts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">f_index</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1192"><a href="#L-1192"><span class="linenos">1192</span></a>
</span><span id="L-1193"><a href="#L-1193"><span class="linenos">1193</span></a>                    <span class="n">target_bin</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">bin_i</span><span class="p">])</span>
</span><span id="L-1194"><a href="#L-1194"><span class="linenos">1194</span></a>
</span><span id="L-1195"><a href="#L-1195"><span class="linenos">1195</span></a>                    <span class="k">if</span> <span class="n">bin_i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">):</span>
</span><span id="L-1196"><a href="#L-1196"><span class="linenos">1196</span></a>                        <span class="n">target_bin</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">bin_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="L-1197"><a href="#L-1197"><span class="linenos">1197</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1198"><a href="#L-1198"><span class="linenos">1198</span></a>                        <span class="n">target_bin</span> <span class="o">+=</span> <span class="s2">&quot; inf)&quot;</span>
</span><span id="L-1199"><a href="#L-1199"><span class="linenos">1199</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="L-1200"><a href="#L-1200"><span class="linenos">1200</span></a>                    <span class="n">target_bin</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="L-1201"><a href="#L-1201"><span class="linenos">1201</span></a>                    <span class="n">org_value</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">org_value</span><span class="p">)</span>
</span><span id="L-1202"><a href="#L-1202"><span class="linenos">1202</span></a>
</span><span id="L-1203"><a href="#L-1203"><span class="linenos">1203</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="L-1204"><a href="#L-1204"><span class="linenos">1204</span></a>                    <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_i</span><span class="p">:</span>
</span><span id="L-1205"><a href="#L-1205"><span class="linenos">1205</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1206"><a href="#L-1206"><span class="linenos">1206</span></a>                            <span class="s2">&quot;Change &lt;</span><span class="si">{}</span><span class="s2">&gt; from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1207"><a href="#L-1207"><span class="linenos">1207</span></a>                                <span class="n">f_name</span><span class="p">,</span> <span class="n">org_value</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_bin</span>
</span><span id="L-1208"><a href="#L-1208"><span class="linenos">1208</span></a>                            <span class="p">)</span>
</span><span id="L-1209"><a href="#L-1209"><span class="linenos">1209</span></a>                        <span class="p">)</span>
</span><span id="L-1210"><a href="#L-1210"><span class="linenos">1210</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1211"><a href="#L-1211"><span class="linenos">1211</span></a>                            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">* score gain: </span><span class="si">{:.4f}</span><span class="se">\n\t</span><span class="s2">* distance cost: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1212"><a href="#L-1212"><span class="linenos">1212</span></a>                                <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="L-1213"><a href="#L-1213"><span class="linenos">1213</span></a>                            <span class="p">)</span>
</span><span id="L-1214"><a href="#L-1214"><span class="linenos">1214</span></a>                        <span class="p">)</span>
</span><span id="L-1215"><a href="#L-1215"><span class="linenos">1215</span></a>                        <span class="k">break</span>
</span><span id="L-1216"><a href="#L-1216"><span class="linenos">1216</span></a>
</span><span id="L-1217"><a href="#L-1217"><span class="linenos">1217</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1218"><a href="#L-1218"><span class="linenos">1218</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+):.+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="L-1219"><a href="#L-1219"><span class="linenos">1219</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">f_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_x_&quot;</span><span class="p">,</span> <span class="s2">&quot; x &quot;</span><span class="p">)</span>
</span><span id="L-1220"><a href="#L-1220"><span class="linenos">1220</span></a>                <span class="n">bin_0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:(\d+),\d+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="L-1221"><a href="#L-1221"><span class="linenos">1221</span></a>                <span class="n">bin_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:\d+,(\d+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="L-1222"><a href="#L-1222"><span class="linenos">1222</span></a>
</span><span id="L-1223"><a href="#L-1223"><span class="linenos">1223</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="L-1224"><a href="#L-1224"><span class="linenos">1224</span></a>                    <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_0</span> <span class="ow">and</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_1</span><span class="p">:</span>
</span><span id="L-1225"><a href="#L-1225"><span class="linenos">1225</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trigger interaction term: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_name</span><span class="p">))</span>
</span><span id="L-1226"><a href="#L-1226"><span class="linenos">1226</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="L-1227"><a href="#L-1227"><span class="linenos">1227</span></a>                            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">* score gain: </span><span class="si">{:.4f}</span><span class="se">\n\t</span><span class="s2">* distance cost: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="L-1228"><a href="#L-1228"><span class="linenos">1228</span></a>                                <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span>
</span><span id="L-1229"><a href="#L-1229"><span class="linenos">1229</span></a>                            <span class="p">)</span>
</span><span id="L-1230"><a href="#L-1230"><span class="linenos">1230</span></a>                        <span class="p">)</span>
</span><span id="L-1231"><a href="#L-1231"><span class="linenos">1231</span></a>                        <span class="k">break</span>
</span><span id="L-1232"><a href="#L-1232"><span class="linenos">1232</span></a>        <span class="nb">print</span><span class="p">()</span>
</span><span id="L-1233"><a href="#L-1233"><span class="linenos">1233</span></a>
</span><span id="L-1234"><a href="#L-1234"><span class="linenos">1234</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-1235"><a href="#L-1235"><span class="linenos">1235</span></a>    <span class="k">def</span> <span class="nf">compute_mad</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="L-1236"><a href="#L-1236"><span class="linenos">1236</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1237"><a href="#L-1237"><span class="linenos">1237</span></a><span class="sd">        Compute the median absolute deviation of a continuous feature.</span>
</span><span id="L-1238"><a href="#L-1238"><span class="linenos">1238</span></a>
</span><span id="L-1239"><a href="#L-1239"><span class="linenos">1239</span></a><span class="sd">        Args:</span>
</span><span id="L-1240"><a href="#L-1240"><span class="linenos">1240</span></a><span class="sd">            xs (np.ndarray): A column of continuous values.</span>
</span><span id="L-1241"><a href="#L-1241"><span class="linenos">1241</span></a>
</span><span id="L-1242"><a href="#L-1242"><span class="linenos">1242</span></a><span class="sd">        Returns:</span>
</span><span id="L-1243"><a href="#L-1243"><span class="linenos">1243</span></a><span class="sd">            float: MAD value of xs.</span>
</span><span id="L-1244"><a href="#L-1244"><span class="linenos">1244</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1245"><a href="#L-1245"><span class="linenos">1245</span></a>        <span class="n">xs_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="L-1246"><a href="#L-1246"><span class="linenos">1246</span></a>        <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="n">xs_median</span><span class="p">))</span>
</span><span id="L-1247"><a href="#L-1247"><span class="linenos">1247</span></a>        <span class="k">return</span> <span class="n">mad</span>
</span><span id="L-1248"><a href="#L-1248"><span class="linenos">1248</span></a>
</span><span id="L-1249"><a href="#L-1249"><span class="linenos">1249</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-1250"><a href="#L-1250"><span class="linenos">1250</span></a>    <span class="k">def</span> <span class="nf">compute_frequency_distance</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="L-1251"><a href="#L-1251"><span class="linenos">1251</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1252"><a href="#L-1252"><span class="linenos">1252</span></a><span class="sd">        For categorical variables, we compute 1 - frequency as their distance. It implies</span>
</span><span id="L-1253"><a href="#L-1253"><span class="linenos">1253</span></a><span class="sd">        that switching to a frequent value takes less effort.</span>
</span><span id="L-1254"><a href="#L-1254"><span class="linenos">1254</span></a>
</span><span id="L-1255"><a href="#L-1255"><span class="linenos">1255</span></a><span class="sd">        Args:</span>
</span><span id="L-1256"><a href="#L-1256"><span class="linenos">1256</span></a><span class="sd">            xs (np.ndarray): A column of categorical values.</span>
</span><span id="L-1257"><a href="#L-1257"><span class="linenos">1257</span></a>
</span><span id="L-1258"><a href="#L-1258"><span class="linenos">1258</span></a><span class="sd">        Returns:</span>
</span><span id="L-1259"><a href="#L-1259"><span class="linenos">1259</span></a><span class="sd">            dict: category level -&gt; 1 - frequency.</span>
</span><span id="L-1260"><a href="#L-1260"><span class="linenos">1260</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1261"><a href="#L-1261"><span class="linenos">1261</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="L-1262"><a href="#L-1262"><span class="linenos">1262</span></a>
</span><span id="L-1263"><a href="#L-1263"><span class="linenos">1263</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1264"><a href="#L-1264"><span class="linenos">1264</span></a>
</span><span id="L-1265"><a href="#L-1265"><span class="linenos">1265</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">counter</span><span class="p">:</span>
</span><span id="L-1266"><a href="#L-1266"><span class="linenos">1266</span></a>            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
</span><span id="L-1267"><a href="#L-1267"><span class="linenos">1267</span></a>
</span><span id="L-1268"><a href="#L-1268"><span class="linenos">1268</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="L-1269"><a href="#L-1269"><span class="linenos">1269</span></a>
</span><span id="L-1270"><a href="#L-1270"><span class="linenos">1270</span></a>    <span class="nd">@staticmethod</span>
</span><span id="L-1271"><a href="#L-1271"><span class="linenos">1271</span></a>    <span class="k">def</span> <span class="nf">compute_naive_cat_distance</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="L-1272"><a href="#L-1272"><span class="linenos">1272</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1273"><a href="#L-1273"><span class="linenos">1273</span></a><span class="sd">        Alternative to compute_frequency_distance() to compute distance for</span>
</span><span id="L-1274"><a href="#L-1274"><span class="linenos">1274</span></a><span class="sd">        categorical variables. The distance 1 for different levels and 0 for</span>
</span><span id="L-1275"><a href="#L-1275"><span class="linenos">1275</span></a><span class="sd">        the same levels. Here we give them all score 1, because same-level</span>
</span><span id="L-1276"><a href="#L-1276"><span class="linenos">1276</span></a><span class="sd">        options will be filtered out when we create categorical options for the</span>
</span><span id="L-1277"><a href="#L-1277"><span class="linenos">1277</span></a><span class="sd">        optimization program.</span>
</span><span id="L-1278"><a href="#L-1278"><span class="linenos">1278</span></a>
</span><span id="L-1279"><a href="#L-1279"><span class="linenos">1279</span></a><span class="sd">        Args:</span>
</span><span id="L-1280"><a href="#L-1280"><span class="linenos">1280</span></a><span class="sd">            xs (np.ndarray): A column of categorical values.</span>
</span><span id="L-1281"><a href="#L-1281"><span class="linenos">1281</span></a>
</span><span id="L-1282"><a href="#L-1282"><span class="linenos">1282</span></a><span class="sd">        Returns:</span>
</span><span id="L-1283"><a href="#L-1283"><span class="linenos">1283</span></a><span class="sd">            dict: category level -&gt; 1.</span>
</span><span id="L-1284"><a href="#L-1284"><span class="linenos">1284</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-1285"><a href="#L-1285"><span class="linenos">1285</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="L-1286"><a href="#L-1286"><span class="linenos">1286</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1287"><a href="#L-1287"><span class="linenos">1287</span></a>
</span><span id="L-1288"><a href="#L-1288"><span class="linenos">1288</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">counter</span><span class="p">:</span>
</span><span id="L-1289"><a href="#L-1289"><span class="linenos">1289</span></a>            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1290"><a href="#L-1290"><span class="linenos">1290</span></a>
</span><span id="L-1291"><a href="#L-1291"><span class="linenos">1291</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="L-1292"><a href="#L-1292"><span class="linenos">1292</span></a>
</span><span id="L-1293"><a href="#L-1293"><span class="linenos">1293</span></a>
</span><span id="L-1294"><a href="#L-1294"><span class="linenos">1294</span></a><span class="k">def</span> <span class="nf">search_sorted_lower_index</span><span class="p">(</span><span class="n">sorted_edges</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="L-1295"><a href="#L-1295"><span class="linenos">1295</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Binary search to locate the correct bin for continuous features.&quot;&quot;&quot;</span>
</span><span id="L-1296"><a href="#L-1296"><span class="linenos">1296</span></a>    <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="L-1297"><a href="#L-1297"><span class="linenos">1297</span></a>    <span class="n">right</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1298"><a href="#L-1298"><span class="linenos">1298</span></a>
</span><span id="L-1299"><a href="#L-1299"><span class="linenos">1299</span></a>    <span class="k">while</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1300"><a href="#L-1300"><span class="linenos">1300</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-1301"><a href="#L-1301"><span class="linenos">1301</span></a>
</span><span id="L-1302"><a href="#L-1302"><span class="linenos">1302</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">sorted_edges</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-1303"><a href="#L-1303"><span class="linenos">1303</span></a>            <span class="n">left</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-1304"><a href="#L-1304"><span class="linenos">1304</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">sorted_edges</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="L-1305"><a href="#L-1305"><span class="linenos">1305</span></a>            <span class="n">right</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="L-1306"><a href="#L-1306"><span class="linenos">1306</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1307"><a href="#L-1307"><span class="linenos">1307</span></a>            <span class="k">return</span> <span class="n">i</span>
</span><span id="L-1308"><a href="#L-1308"><span class="linenos">1308</span></a>
</span><span id="L-1309"><a href="#L-1309"><span class="linenos">1309</span></a>    <span class="c1"># Handle out of bound issues</span>
</span><span id="L-1310"><a href="#L-1310"><span class="linenos">1310</span></a>    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">sorted_edges</span><span class="p">[</span><span class="n">right</span><span class="p">]:</span>
</span><span id="L-1311"><a href="#L-1311"><span class="linenos">1311</span></a>        <span class="k">return</span> <span class="n">right</span>
</span><span id="L-1312"><a href="#L-1312"><span class="linenos">1312</span></a>    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">sorted_edges</span><span class="p">[</span><span class="n">left</span><span class="p">]:</span>
</span><span id="L-1313"><a href="#L-1313"><span class="linenos">1313</span></a>        <span class="k">return</span> <span class="n">left</span>
</span><span id="L-1314"><a href="#L-1314"><span class="linenos">1314</span></a>
</span><span id="L-1315"><a href="#L-1315"><span class="linenos">1315</span></a>    <span class="k">return</span> <span class="n">right</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="L-1316"><a href="#L-1316"><span class="linenos">1316</span></a>
</span><span id="L-1317"><a href="#L-1317"><span class="linenos">1317</span></a>
</span><span id="L-1318"><a href="#L-1318"><span class="linenos">1318</span></a><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="L-1319"><a href="#L-1319"><span class="linenos">1319</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sigmoid function.&quot;&quot;&quot;</span>
</span><span id="L-1320"><a href="#L-1320"><span class="linenos">1320</span></a>    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span><span id="L-1321"><a href="#L-1321"><span class="linenos">1321</span></a>
</span><span id="L-1322"><a href="#L-1322"><span class="linenos">1322</span></a>
</span><span id="L-1323"><a href="#L-1323"><span class="linenos">1323</span></a><span class="k">def</span> <span class="nf">_resort_categorical_level</span><span class="p">(</span><span class="n">col_mapping</span><span class="p">):</span>
</span><span id="L-1324"><a href="#L-1324"><span class="linenos">1324</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1325"><a href="#L-1325"><span class="linenos">1325</span></a><span class="sd">    Resort the levels in the categorical encoders if all levels can be converted</span>
</span><span id="L-1326"><a href="#L-1326"><span class="linenos">1326</span></a><span class="sd">    to numbers (integer or float).</span>
</span><span id="L-1327"><a href="#L-1327"><span class="linenos">1327</span></a>
</span><span id="L-1328"><a href="#L-1328"><span class="linenos">1328</span></a><span class="sd">    Args:</span>
</span><span id="L-1329"><a href="#L-1329"><span class="linenos">1329</span></a><span class="sd">        col_mapping: the dictionary that maps level string to int</span>
</span><span id="L-1330"><a href="#L-1330"><span class="linenos">1330</span></a>
</span><span id="L-1331"><a href="#L-1331"><span class="linenos">1331</span></a><span class="sd">    Returns:</span>
</span><span id="L-1332"><a href="#L-1332"><span class="linenos">1332</span></a><span class="sd">        New col_mapping if all levels can be converted to numbers, otherwise</span>
</span><span id="L-1333"><a href="#L-1333"><span class="linenos">1333</span></a><span class="sd">        the original col_mapping</span>
</span><span id="L-1334"><a href="#L-1334"><span class="linenos">1334</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1335"><a href="#L-1335"><span class="linenos">1335</span></a>
</span><span id="L-1336"><a href="#L-1336"><span class="linenos">1336</span></a>    <span class="k">def</span> <span class="nf">is_number</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
</span><span id="L-1337"><a href="#L-1337"><span class="linenos">1337</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="L-1338"><a href="#L-1338"><span class="linenos">1338</span></a>            <span class="nb">float</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span id="L-1339"><a href="#L-1339"><span class="linenos">1339</span></a>            <span class="k">return</span> <span class="kc">True</span>
</span><span id="L-1340"><a href="#L-1340"><span class="linenos">1340</span></a>        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
</span><span id="L-1341"><a href="#L-1341"><span class="linenos">1341</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="L-1342"><a href="#L-1342"><span class="linenos">1342</span></a>
</span><span id="L-1343"><a href="#L-1343"><span class="linenos">1343</span></a>    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">is_number</span><span class="p">,</span> <span class="n">col_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
</span><span id="L-1344"><a href="#L-1344"><span class="linenos">1344</span></a>
</span><span id="L-1345"><a href="#L-1345"><span class="linenos">1345</span></a>        <span class="n">key_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">col_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
</span><span id="L-1346"><a href="#L-1346"><span class="linenos">1346</span></a>        <span class="n">sorted_key_tuples</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">key_tuples</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1347"><a href="#L-1347"><span class="linenos">1347</span></a>
</span><span id="L-1348"><a href="#L-1348"><span class="linenos">1348</span></a>        <span class="n">new_mapping</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1349"><a href="#L-1349"><span class="linenos">1349</span></a>        <span class="n">value</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="L-1350"><a href="#L-1350"><span class="linenos">1350</span></a>
</span><span id="L-1351"><a href="#L-1351"><span class="linenos">1351</span></a>        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">sorted_key_tuples</span><span class="p">:</span>
</span><span id="L-1352"><a href="#L-1352"><span class="linenos">1352</span></a>            <span class="n">new_mapping</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="L-1353"><a href="#L-1353"><span class="linenos">1353</span></a>            <span class="n">value</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="L-1354"><a href="#L-1354"><span class="linenos">1354</span></a>
</span><span id="L-1355"><a href="#L-1355"><span class="linenos">1355</span></a>        <span class="k">return</span> <span class="n">new_mapping</span>
</span><span id="L-1356"><a href="#L-1356"><span class="linenos">1356</span></a>
</span><span id="L-1357"><a href="#L-1357"><span class="linenos">1357</span></a>    <span class="k">else</span><span class="p">:</span>
</span><span id="L-1358"><a href="#L-1358"><span class="linenos">1358</span></a>        <span class="k">return</span> <span class="n">col_mapping</span>
</span><span id="L-1359"><a href="#L-1359"><span class="linenos">1359</span></a>
</span><span id="L-1360"><a href="#L-1360"><span class="linenos">1360</span></a>
</span><span id="L-1361"><a href="#L-1361"><span class="linenos">1361</span></a><span class="k">def</span> <span class="nf">_init_feature_descriptions</span><span class="p">(</span><span class="n">ebm</span><span class="p">,</span> <span class="n">label_encoder</span><span class="p">):</span>
</span><span id="L-1362"><a href="#L-1362"><span class="linenos">1362</span></a>    <span class="c1"># Initialize the feature description dictionary</span>
</span><span id="L-1363"><a href="#L-1363"><span class="linenos">1363</span></a>    <span class="n">feature_descriptions</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1364"><a href="#L-1364"><span class="linenos">1364</span></a>
</span><span id="L-1365"><a href="#L-1365"><span class="linenos">1365</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-1366"><a href="#L-1366"><span class="linenos">1366</span></a>        <span class="n">cur_name</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1367"><a href="#L-1367"><span class="linenos">1367</span></a>        <span class="n">cur_type</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1368"><a href="#L-1368"><span class="linenos">1368</span></a>
</span><span id="L-1369"><a href="#L-1369"><span class="linenos">1369</span></a>        <span class="c1"># Use the feature name as the default display name</span>
</span><span id="L-1370"><a href="#L-1370"><span class="linenos">1370</span></a>        <span class="k">if</span> <span class="n">cur_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-1371"><a href="#L-1371"><span class="linenos">1371</span></a>            <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">cur_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1372"><a href="#L-1372"><span class="linenos">1372</span></a>                <span class="s2">&quot;displayName&quot;</span><span class="p">:</span> <span class="n">cur_name</span><span class="p">,</span>
</span><span id="L-1373"><a href="#L-1373"><span class="linenos">1373</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1374"><a href="#L-1374"><span class="linenos">1374</span></a>            <span class="p">}</span>
</span><span id="L-1375"><a href="#L-1375"><span class="linenos">1375</span></a>
</span><span id="L-1376"><a href="#L-1376"><span class="linenos">1376</span></a>        <span class="c1"># For categorical features, we can also give display name and description</span>
</span><span id="L-1377"><a href="#L-1377"><span class="linenos">1377</span></a>        <span class="c1"># for different levels</span>
</span><span id="L-1378"><a href="#L-1378"><span class="linenos">1378</span></a>        <span class="k">elif</span> <span class="n">cur_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-1379"><a href="#L-1379"><span class="linenos">1379</span></a>
</span><span id="L-1380"><a href="#L-1380"><span class="linenos">1380</span></a>            <span class="n">level_descriptions</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1381"><a href="#L-1381"><span class="linenos">1381</span></a>
</span><span id="L-1382"><a href="#L-1382"><span class="linenos">1382</span></a>            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">label_encoder</span><span class="p">[</span><span class="n">cur_name</span><span class="p">]:</span>
</span><span id="L-1383"><a href="#L-1383"><span class="linenos">1383</span></a>                <span class="n">level_descriptions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1384"><a href="#L-1384"><span class="linenos">1384</span></a>                    <span class="s2">&quot;displayName&quot;</span><span class="p">:</span> <span class="n">label_encoder</span><span class="p">[</span><span class="n">cur_name</span><span class="p">][</span><span class="n">level</span><span class="p">],</span>
</span><span id="L-1385"><a href="#L-1385"><span class="linenos">1385</span></a>                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1386"><a href="#L-1386"><span class="linenos">1386</span></a>                <span class="p">}</span>
</span><span id="L-1387"><a href="#L-1387"><span class="linenos">1387</span></a>
</span><span id="L-1388"><a href="#L-1388"><span class="linenos">1388</span></a>            <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">cur_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1389"><a href="#L-1389"><span class="linenos">1389</span></a>                <span class="s2">&quot;displayName&quot;</span><span class="p">:</span> <span class="n">cur_name</span><span class="p">,</span>
</span><span id="L-1390"><a href="#L-1390"><span class="linenos">1390</span></a>                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
</span><span id="L-1391"><a href="#L-1391"><span class="linenos">1391</span></a>                <span class="s2">&quot;levelDescription&quot;</span><span class="p">:</span> <span class="n">level_descriptions</span><span class="p">,</span>
</span><span id="L-1392"><a href="#L-1392"><span class="linenos">1392</span></a>            <span class="p">}</span>
</span><span id="L-1393"><a href="#L-1393"><span class="linenos">1393</span></a>
</span><span id="L-1394"><a href="#L-1394"><span class="linenos">1394</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1395"><a href="#L-1395"><span class="linenos">1395</span></a>            <span class="k">continue</span>
</span><span id="L-1396"><a href="#L-1396"><span class="linenos">1396</span></a>
</span><span id="L-1397"><a href="#L-1397"><span class="linenos">1397</span></a>    <span class="k">return</span> <span class="n">feature_descriptions</span>
</span><span id="L-1398"><a href="#L-1398"><span class="linenos">1398</span></a>
</span><span id="L-1399"><a href="#L-1399"><span class="linenos">1399</span></a>
</span><span id="L-1400"><a href="#L-1400"><span class="linenos">1400</span></a><span class="k">def</span> <span class="nf">_init_feature_configuration</span><span class="p">(</span><span class="n">ebm</span><span class="p">):</span>
</span><span id="L-1401"><a href="#L-1401"><span class="linenos">1401</span></a>    <span class="c1"># Initialize the feature configuration dictionary</span>
</span><span id="L-1402"><a href="#L-1402"><span class="linenos">1402</span></a>    <span class="n">feature_configuration</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1403"><a href="#L-1403"><span class="linenos">1403</span></a>
</span><span id="L-1404"><a href="#L-1404"><span class="linenos">1404</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-1405"><a href="#L-1405"><span class="linenos">1405</span></a>        <span class="n">cur_name</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1406"><a href="#L-1406"><span class="linenos">1406</span></a>        <span class="n">cur_type</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1407"><a href="#L-1407"><span class="linenos">1407</span></a>
</span><span id="L-1408"><a href="#L-1408"><span class="linenos">1408</span></a>        <span class="c1"># Use the feature name as the default display name</span>
</span><span id="L-1409"><a href="#L-1409"><span class="linenos">1409</span></a>        <span class="k">if</span> <span class="n">cur_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span> <span class="ow">or</span> <span class="n">cur_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-1410"><a href="#L-1410"><span class="linenos">1410</span></a>            <span class="n">feature_configuration</span><span class="p">[</span><span class="n">cur_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1411"><a href="#L-1411"><span class="linenos">1411</span></a>                <span class="s2">&quot;difficulty&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span id="L-1412"><a href="#L-1412"><span class="linenos">1412</span></a>                <span class="s2">&quot;requiresInt&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1413"><a href="#L-1413"><span class="linenos">1413</span></a>                <span class="s2">&quot;requiresIncreasing&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1414"><a href="#L-1414"><span class="linenos">1414</span></a>                <span class="s2">&quot;requiresDecreasing&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="L-1415"><a href="#L-1415"><span class="linenos">1415</span></a>                <span class="s2">&quot;usesTransform&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1416"><a href="#L-1416"><span class="linenos">1416</span></a>                <span class="s2">&quot;acceptableRange&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="L-1417"><a href="#L-1417"><span class="linenos">1417</span></a>            <span class="p">}</span>
</span><span id="L-1418"><a href="#L-1418"><span class="linenos">1418</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1419"><a href="#L-1419"><span class="linenos">1419</span></a>            <span class="k">continue</span>
</span><span id="L-1420"><a href="#L-1420"><span class="linenos">1420</span></a>
</span><span id="L-1421"><a href="#L-1421"><span class="linenos">1421</span></a>    <span class="k">return</span> <span class="n">feature_configuration</span>
</span><span id="L-1422"><a href="#L-1422"><span class="linenos">1422</span></a>
</span><span id="L-1423"><a href="#L-1423"><span class="linenos">1423</span></a>
</span><span id="L-1424"><a href="#L-1424"><span class="linenos">1424</span></a><span class="k">def</span> <span class="nf">_get_kde_sample</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">n_sample</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
</span><span id="L-1425"><a href="#L-1425"><span class="linenos">1425</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1426"><a href="#L-1426"><span class="linenos">1426</span></a><span class="sd">    Compute kernel density estimation.</span>
</span><span id="L-1427"><a href="#L-1427"><span class="linenos">1427</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1428"><a href="#L-1428"><span class="linenos">1428</span></a>    <span class="n">kernel</span> <span class="o">=</span> <span class="n">gaussian_kde</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="L-1429"><a href="#L-1429"><span class="linenos">1429</span></a>
</span><span id="L-1430"><a href="#L-1430"><span class="linenos">1430</span></a>    <span class="n">sample_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">xs</span><span class="p">),</span> <span class="n">n_sample</span><span class="p">)</span>
</span><span id="L-1431"><a href="#L-1431"><span class="linenos">1431</span></a>    <span class="n">sample_y</span> <span class="o">=</span> <span class="n">kernel</span><span class="p">(</span><span class="n">sample_x</span><span class="p">)</span>
</span><span id="L-1432"><a href="#L-1432"><span class="linenos">1432</span></a>
</span><span id="L-1433"><a href="#L-1433"><span class="linenos">1433</span></a>    <span class="k">return</span> <span class="n">sample_x</span><span class="p">,</span> <span class="n">sample_y</span>
</span><span id="L-1434"><a href="#L-1434"><span class="linenos">1434</span></a>
</span><span id="L-1435"><a href="#L-1435"><span class="linenos">1435</span></a>
</span><span id="L-1436"><a href="#L-1436"><span class="linenos">1436</span></a><span class="k">def</span> <span class="nf">get_model_data</span><span class="p">(</span>
</span><span id="L-1437"><a href="#L-1437"><span class="linenos">1437</span></a>    <span class="n">ebm</span><span class="p">,</span>
</span><span id="L-1438"><a href="#L-1438"><span class="linenos">1438</span></a>    <span class="n">x_train</span><span class="p">,</span>
</span><span id="L-1439"><a href="#L-1439"><span class="linenos">1439</span></a>    <span class="n">model_info</span><span class="p">,</span>
</span><span id="L-1440"><a href="#L-1440"><span class="linenos">1440</span></a>    <span class="n">resort_categorical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-1441"><a href="#L-1441"><span class="linenos">1441</span></a>    <span class="n">feature_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1442"><a href="#L-1442"><span class="linenos">1442</span></a>    <span class="n">feature_level_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1443"><a href="#L-1443"><span class="linenos">1443</span></a>    <span class="n">feature_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="L-1444"><a href="#L-1444"><span class="linenos">1444</span></a><span class="p">):</span>
</span><span id="L-1445"><a href="#L-1445"><span class="linenos">1445</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-1446"><a href="#L-1446"><span class="linenos">1446</span></a><span class="sd">    Get the model data for GAM Coach.</span>
</span><span id="L-1447"><a href="#L-1447"><span class="linenos">1447</span></a><span class="sd">    Args:</span>
</span><span id="L-1448"><a href="#L-1448"><span class="linenos">1448</span></a><span class="sd">        ebm: Trained EBM model. ExplainableBoostingClassifier or</span>
</span><span id="L-1449"><a href="#L-1449"><span class="linenos">1449</span></a><span class="sd">            ExplainableBoostingRegressor object.</span>
</span><span id="L-1450"><a href="#L-1450"><span class="linenos">1450</span></a><span class="sd">        x_train: Training data. We use it to compute the mean absolute deviation</span>
</span><span id="L-1451"><a href="#L-1451"><span class="linenos">1451</span></a><span class="sd">            score for continuous features, and frequency scores for categorical</span>
</span><span id="L-1452"><a href="#L-1452"><span class="linenos">1452</span></a><span class="sd">            features.</span>
</span><span id="L-1453"><a href="#L-1453"><span class="linenos">1453</span></a><span class="sd">        model_info: Information about the model (class names, regression target</span>
</span><span id="L-1454"><a href="#L-1454"><span class="linenos">1454</span></a><span class="sd">            name). For classification, the order of classes matters. It should</span>
</span><span id="L-1455"><a href="#L-1455"><span class="linenos">1455</span></a><span class="sd">            be consistent with the class encoding index. For example, the first</span>
</span><span id="L-1456"><a href="#L-1456"><span class="linenos">1456</span></a><span class="sd">            element should be the name for class 0.</span>
</span><span id="L-1457"><a href="#L-1457"><span class="linenos">1457</span></a><span class="sd">            It has format:</span>
</span><span id="L-1458"><a href="#L-1458"><span class="linenos">1458</span></a><span class="sd">            `{&#39;classes&#39;: [&#39;loan rejection&#39;, &#39;loan approval&#39;]}` or</span>
</span><span id="L-1459"><a href="#L-1459"><span class="linenos">1459</span></a><span class="sd">            `{&#39;regressionName&#39;: &#39;interest rate&#39;}`</span>
</span><span id="L-1460"><a href="#L-1460"><span class="linenos">1460</span></a><span class="sd">        resort_categorical: Whether to sort the levels in categorical variable</span>
</span><span id="L-1461"><a href="#L-1461"><span class="linenos">1461</span></a><span class="sd">            by increasing order if all levels can be converted to numbers.</span>
</span><span id="L-1462"><a href="#L-1462"><span class="linenos">1462</span></a><span class="sd">        feature_info: You can provide a dictionary to give a separate display</span>
</span><span id="L-1463"><a href="#L-1463"><span class="linenos">1463</span></a><span class="sd">            name and optional description for each feature. By default, the</span>
</span><span id="L-1464"><a href="#L-1464"><span class="linenos">1464</span></a><span class="sd">            display name is the same as the feature name, and the description</span>
</span><span id="L-1465"><a href="#L-1465"><span class="linenos">1465</span></a><span class="sd">            is an emtpy string. `feature_info` can be partial (only including</span>
</span><span id="L-1466"><a href="#L-1466"><span class="linenos">1466</span></a><span class="sd">            some features). It has format:</span>
</span><span id="L-1467"><a href="#L-1467"><span class="linenos">1467</span></a><span class="sd">            `{&#39;feature_name&#39;: [&#39;display_name&#39;, &#39;description&#39;]}`</span>
</span><span id="L-1468"><a href="#L-1468"><span class="linenos">1468</span></a><span class="sd">        feature_level_info: You can provide a dictionary to give separate display</span>
</span><span id="L-1469"><a href="#L-1469"><span class="linenos">1469</span></a><span class="sd">            name and optional description for each level of categorical features.</span>
</span><span id="L-1470"><a href="#L-1470"><span class="linenos">1470</span></a><span class="sd">            By default, the display name is the same as the level name, and the</span>
</span><span id="L-1471"><a href="#L-1471"><span class="linenos">1471</span></a><span class="sd">            description is an empty string. `feature_info` can be partial</span>
</span><span id="L-1472"><a href="#L-1472"><span class="linenos">1472</span></a><span class="sd">            (e.g., only including some levels from some categorical features).</span>
</span><span id="L-1473"><a href="#L-1473"><span class="linenos">1473</span></a><span class="sd">            It has format:</span>
</span><span id="L-1474"><a href="#L-1474"><span class="linenos">1474</span></a><span class="sd">            `{&#39;feature_name&#39;: {level_id: [&#39;display_name&#39;, &#39;description&#39;]}}`</span>
</span><span id="L-1475"><a href="#L-1475"><span class="linenos">1475</span></a><span class="sd">        feature_config: You can provide a dictionary to configure the difficulty,</span>
</span><span id="L-1476"><a href="#L-1476"><span class="linenos">1476</span></a><span class="sd">            integer requirement, and acceptable range of individual features.</span>
</span><span id="L-1477"><a href="#L-1477"><span class="linenos">1477</span></a><span class="sd">            The difficulty is an integer between 1 and 6: 1 (very easy to change),</span>
</span><span id="L-1478"><a href="#L-1478"><span class="linenos">1478</span></a><span class="sd">            2 (easy), 3 (default), 4 (hard), 5 (very hard), 6 (impossible to change).</span>
</span><span id="L-1479"><a href="#L-1479"><span class="linenos">1479</span></a><span class="sd">            By default, difficulty is set to 3 for all features, requiresInt is</span>
</span><span id="L-1480"><a href="#L-1480"><span class="linenos">1480</span></a><span class="sd">            False for continuous variables, and acceptanceRange is None (search</span>
</span><span id="L-1481"><a href="#L-1481"><span class="linenos">1481</span></a><span class="sd">            all range).</span>
</span><span id="L-1482"><a href="#L-1482"><span class="linenos">1482</span></a><span class="sd">            The dictionary property has the following format:</span>
</span><span id="L-1483"><a href="#L-1483"><span class="linenos">1483</span></a><span class="sd">            `{&#39;difficulty&#39;: 3, &#39;requiresInt&#39;: True, &#39;acceptableRange&#39;: None}`</span>
</span><span id="L-1484"><a href="#L-1484"><span class="linenos">1484</span></a><span class="sd">    Returns:</span>
</span><span id="L-1485"><a href="#L-1485"><span class="linenos">1485</span></a><span class="sd">        A Python dictionary of model data</span>
</span><span id="L-1486"><a href="#L-1486"><span class="linenos">1486</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-1487"><a href="#L-1487"><span class="linenos">1487</span></a>    <span class="n">ROUND</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="L-1488"><a href="#L-1488"><span class="linenos">1488</span></a>
</span><span id="L-1489"><a href="#L-1489"><span class="linenos">1489</span></a>    <span class="c1"># Main model info on each feature</span>
</span><span id="L-1490"><a href="#L-1490"><span class="linenos">1490</span></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1491"><a href="#L-1491"><span class="linenos">1491</span></a>
</span><span id="L-1492"><a href="#L-1492"><span class="linenos">1492</span></a>    <span class="c1"># Track the encoding of categorical feature levels</span>
</span><span id="L-1493"><a href="#L-1493"><span class="linenos">1493</span></a>    <span class="n">labelEncoder</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1494"><a href="#L-1494"><span class="linenos">1494</span></a>
</span><span id="L-1495"><a href="#L-1495"><span class="linenos">1495</span></a>    <span class="c1"># Track the score range</span>
</span><span id="L-1496"><a href="#L-1496"><span class="linenos">1496</span></a>    <span class="n">score_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</span><span id="L-1497"><a href="#L-1497"><span class="linenos">1497</span></a>
</span><span id="L-1498"><a href="#L-1498"><span class="linenos">1498</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">))):</span>
</span><span id="L-1499"><a href="#L-1499"><span class="linenos">1499</span></a>        <span class="n">cur_feature</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1500"><a href="#L-1500"><span class="linenos">1500</span></a>        <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1501"><a href="#L-1501"><span class="linenos">1501</span></a>        <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1502"><a href="#L-1502"><span class="linenos">1502</span></a>        <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1503"><a href="#L-1503"><span class="linenos">1503</span></a>
</span><span id="L-1504"><a href="#L-1504"><span class="linenos">1504</span></a>        <span class="c1"># Handle interaction term differently from cont/cat</span>
</span><span id="L-1505"><a href="#L-1505"><span class="linenos">1505</span></a>        <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="L-1506"><a href="#L-1506"><span class="linenos">1506</span></a>            <span class="n">cur_id</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1507"><a href="#L-1507"><span class="linenos">1507</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cur_id</span><span class="p">)</span>
</span><span id="L-1508"><a href="#L-1508"><span class="linenos">1508</span></a>
</span><span id="L-1509"><a href="#L-1509"><span class="linenos">1509</span></a>            <span class="c1"># Info for each individual feature</span>
</span><span id="L-1510"><a href="#L-1510"><span class="linenos">1510</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;name1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1511"><a href="#L-1511"><span class="linenos">1511</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;name2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-1512"><a href="#L-1512"><span class="linenos">1512</span></a>
</span><span id="L-1513"><a href="#L-1513"><span class="linenos">1513</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1514"><a href="#L-1514"><span class="linenos">1514</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-1515"><a href="#L-1515"><span class="linenos">1515</span></a>
</span><span id="L-1516"><a href="#L-1516"><span class="linenos">1516</span></a>            <span class="c1"># Skip the first item from both dimensions</span>
</span><span id="L-1517"><a href="#L-1517"><span class="linenos">1517</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ROUND</span><span class="p">)[</span>
</span><span id="L-1518"><a href="#L-1518"><span class="linenos">1518</span></a>                <span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1519"><a href="#L-1519"><span class="linenos">1519</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1520"><a href="#L-1520"><span class="linenos">1520</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">term_standard_deviations_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ROUND</span><span class="p">)[</span>
</span><span id="L-1521"><a href="#L-1521"><span class="linenos">1521</span></a>                <span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1522"><a href="#L-1522"><span class="linenos">1522</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1523"><a href="#L-1523"><span class="linenos">1523</span></a>
</span><span id="L-1524"><a href="#L-1524"><span class="linenos">1524</span></a>            <span class="c1"># Get the bin label info</span>
</span><span id="L-1525"><a href="#L-1525"><span class="linenos">1525</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1526"><a href="#L-1526"><span class="linenos">1526</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1527"><a href="#L-1527"><span class="linenos">1527</span></a>
</span><span id="L-1528"><a href="#L-1528"><span class="linenos">1528</span></a>            <span class="c1"># Encode categorical levels as integers</span>
</span><span id="L-1529"><a href="#L-1529"><span class="linenos">1529</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-1530"><a href="#L-1530"><span class="linenos">1530</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1531"><a href="#L-1531"><span class="linenos">1531</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1532"><a href="#L-1532"><span class="linenos">1532</span></a>                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel1&quot;</span><span class="p">])</span>
</span><span id="L-1533"><a href="#L-1533"><span class="linenos">1533</span></a>                <span class="p">)</span>
</span><span id="L-1534"><a href="#L-1534"><span class="linenos">1534</span></a>
</span><span id="L-1535"><a href="#L-1535"><span class="linenos">1535</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type2&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-1536"><a href="#L-1536"><span class="linenos">1536</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-1537"><a href="#L-1537"><span class="linenos">1537</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1538"><a href="#L-1538"><span class="linenos">1538</span></a>                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel2&quot;</span><span class="p">])</span>
</span><span id="L-1539"><a href="#L-1539"><span class="linenos">1539</span></a>                <span class="p">)</span>
</span><span id="L-1540"><a href="#L-1540"><span class="linenos">1540</span></a>
</span><span id="L-1541"><a href="#L-1541"><span class="linenos">1541</span></a>            <span class="c1"># Get density info</span>
</span><span id="L-1542"><a href="#L-1542"><span class="linenos">1542</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-1543"><a href="#L-1543"><span class="linenos">1543</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="L-1544"><a href="#L-1544"><span class="linenos">1544</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_edges</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1545"><a href="#L-1545"><span class="linenos">1545</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1546"><a href="#L-1546"><span class="linenos">1546</span></a>                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge1&quot;</span><span class="p">])</span>
</span><span id="L-1547"><a href="#L-1547"><span class="linenos">1547</span></a>                <span class="p">)</span>
</span><span id="L-1548"><a href="#L-1548"><span class="linenos">1548</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="L-1549"><a href="#L-1549"><span class="linenos">1549</span></a>                    <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_counts</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ROUND</span>
</span><span id="L-1550"><a href="#L-1550"><span class="linenos">1550</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1551"><a href="#L-1551"><span class="linenos">1551</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1552"><a href="#L-1552"><span class="linenos">1552</span></a>                <span class="c1"># Use KDE to draw density plots for cont features</span>
</span><span id="L-1553"><a href="#L-1553"><span class="linenos">1553</span></a>                <span class="n">edges</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">_get_kde_sample</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span><span id="L-1554"><a href="#L-1554"><span class="linenos">1554</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1555"><a href="#L-1555"><span class="linenos">1555</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1556"><a href="#L-1556"><span class="linenos">1556</span></a>
</span><span id="L-1557"><a href="#L-1557"><span class="linenos">1557</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type2&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-1558"><a href="#L-1558"><span class="linenos">1558</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="L-1559"><a href="#L-1559"><span class="linenos">1559</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_edges</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="L-1560"><a href="#L-1560"><span class="linenos">1560</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1561"><a href="#L-1561"><span class="linenos">1561</span></a>                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge2&quot;</span><span class="p">])</span>
</span><span id="L-1562"><a href="#L-1562"><span class="linenos">1562</span></a>                <span class="p">)</span>
</span><span id="L-1563"><a href="#L-1563"><span class="linenos">1563</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="L-1564"><a href="#L-1564"><span class="linenos">1564</span></a>                    <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_counts</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ROUND</span>
</span><span id="L-1565"><a href="#L-1565"><span class="linenos">1565</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1566"><a href="#L-1566"><span class="linenos">1566</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-1567"><a href="#L-1567"><span class="linenos">1567</span></a>                <span class="c1"># Use KDE to draw density plots for cont features</span>
</span><span id="L-1568"><a href="#L-1568"><span class="linenos">1568</span></a>                <span class="n">edges</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">_get_kde_sample</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="L-1569"><a href="#L-1569"><span class="linenos">1569</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1570"><a href="#L-1570"><span class="linenos">1570</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1571"><a href="#L-1571"><span class="linenos">1571</span></a>
</span><span id="L-1572"><a href="#L-1572"><span class="linenos">1572</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-1573"><a href="#L-1573"><span class="linenos">1573</span></a>            <span class="c1"># Skip the first item (reserved for missing value)</span>
</span><span id="L-1574"><a href="#L-1574"><span class="linenos">1574</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ROUND</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span>
</span><span id="L-1575"><a href="#L-1575"><span class="linenos">1575</span></a>                <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1576"><a href="#L-1576"><span class="linenos">1576</span></a>            <span class="p">]</span>
</span><span id="L-1577"><a href="#L-1577"><span class="linenos">1577</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="L-1578"><a href="#L-1578"><span class="linenos">1578</span></a>                <span class="n">ebm</span><span class="o">.</span><span class="n">term_standard_deviations_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ROUND</span>
</span><span id="L-1579"><a href="#L-1579"><span class="linenos">1579</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="L-1580"><a href="#L-1580"><span class="linenos">1580</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="L-1581"><a href="#L-1581"><span class="linenos">1581</span></a>            <span class="n">cur_id</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1582"><a href="#L-1582"><span class="linenos">1582</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">col_bin_counts_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span>
</span><span id="L-1583"><a href="#L-1583"><span class="linenos">1583</span></a>                <span class="mi">1</span><span class="p">:</span>
</span><span id="L-1584"><a href="#L-1584"><span class="linenos">1584</span></a>            <span class="p">]</span>
</span><span id="L-1585"><a href="#L-1585"><span class="linenos">1585</span></a>
</span><span id="L-1586"><a href="#L-1586"><span class="linenos">1586</span></a>            <span class="c1"># Track the global score range</span>
</span><span id="L-1587"><a href="#L-1587"><span class="linenos">1587</span></a>            <span class="n">score_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="L-1588"><a href="#L-1588"><span class="linenos">1588</span></a>                <span class="n">score_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="L-1589"><a href="#L-1589"><span class="linenos">1589</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ebm</span><span class="o">.</span><span class="n">term_standard_deviations_</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
</span><span id="L-1590"><a href="#L-1590"><span class="linenos">1590</span></a>            <span class="p">)</span>
</span><span id="L-1591"><a href="#L-1591"><span class="linenos">1591</span></a>            <span class="n">score_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
</span><span id="L-1592"><a href="#L-1592"><span class="linenos">1592</span></a>                <span class="n">score_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="L-1593"><a href="#L-1593"><span class="linenos">1593</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ebm</span><span class="o">.</span><span class="n">term_standard_deviations_</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
</span><span id="L-1594"><a href="#L-1594"><span class="linenos">1594</span></a>            <span class="p">)</span>
</span><span id="L-1595"><a href="#L-1595"><span class="linenos">1595</span></a>
</span><span id="L-1596"><a href="#L-1596"><span class="linenos">1596</span></a>            <span class="c1"># Add the binning information for continuous features</span>
</span><span id="L-1597"><a href="#L-1597"><span class="linenos">1597</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-1598"><a href="#L-1598"><span class="linenos">1598</span></a>                <span class="c1"># Add the bin information</span>
</span><span id="L-1599"><a href="#L-1599"><span class="linenos">1599</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binEdge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_id</span><span class="p">)</span>
</span><span id="L-1600"><a href="#L-1600"><span class="linenos">1600</span></a>
</span><span id="L-1601"><a href="#L-1601"><span class="linenos">1601</span></a>                <span class="c1"># Use KDE to draw density plots for cont features</span>
</span><span id="L-1602"><a href="#L-1602"><span class="linenos">1602</span></a>                <span class="n">edges</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">_get_kde_sample</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">cur_id</span><span class="p">])</span>
</span><span id="L-1603"><a href="#L-1603"><span class="linenos">1603</span></a>
</span><span id="L-1604"><a href="#L-1604"><span class="linenos">1604</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1605"><a href="#L-1605"><span class="linenos">1605</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1606"><a href="#L-1606"><span class="linenos">1606</span></a>
</span><span id="L-1607"><a href="#L-1607"><span class="linenos">1607</span></a>            <span class="k">elif</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="L-1608"><a href="#L-1608"><span class="linenos">1608</span></a>                <span class="c1"># Get the level value mapping</span>
</span><span id="L-1609"><a href="#L-1609"><span class="linenos">1609</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">]</span>
</span><span id="L-1610"><a href="#L-1610"><span class="linenos">1610</span></a>
</span><span id="L-1611"><a href="#L-1611"><span class="linenos">1611</span></a>                <span class="k">if</span> <span class="n">resort_categorical</span><span class="p">:</span>
</span><span id="L-1612"><a href="#L-1612"><span class="linenos">1612</span></a>                    <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">_resort_categorical_level</span><span class="p">(</span><span class="n">level_str_to_int</span><span class="p">)</span>
</span><span id="L-1613"><a href="#L-1613"><span class="linenos">1613</span></a>
</span><span id="L-1614"><a href="#L-1614"><span class="linenos">1614</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1615"><a href="#L-1615"><span class="linenos">1615</span></a>                    <span class="nb">map</span><span class="p">(</span>
</span><span id="L-1616"><a href="#L-1616"><span class="linenos">1616</span></a>                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
</span><span id="L-1617"><a href="#L-1617"><span class="linenos">1617</span></a>                        <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_id</span><span class="p">),</span>
</span><span id="L-1618"><a href="#L-1618"><span class="linenos">1618</span></a>                    <span class="p">)</span>
</span><span id="L-1619"><a href="#L-1619"><span class="linenos">1619</span></a>                <span class="p">)</span>
</span><span id="L-1620"><a href="#L-1620"><span class="linenos">1620</span></a>
</span><span id="L-1621"><a href="#L-1621"><span class="linenos">1621</span></a>                <span class="c1"># Add the hist information</span>
</span><span id="L-1622"><a href="#L-1622"><span class="linenos">1622</span></a>                <span class="c1"># For categorical data, the edges are strings</span>
</span><span id="L-1623"><a href="#L-1623"><span class="linenos">1623</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1624"><a href="#L-1624"><span class="linenos">1624</span></a>                    <span class="nb">map</span><span class="p">(</span>
</span><span id="L-1625"><a href="#L-1625"><span class="linenos">1625</span></a>                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
</span><span id="L-1626"><a href="#L-1626"><span class="linenos">1626</span></a>                        <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_edges</span><span class="p">(</span><span class="n">cur_id</span><span class="p">),</span>
</span><span id="L-1627"><a href="#L-1627"><span class="linenos">1627</span></a>                    <span class="p">)</span>
</span><span id="L-1628"><a href="#L-1628"><span class="linenos">1628</span></a>                <span class="p">)</span>
</span><span id="L-1629"><a href="#L-1629"><span class="linenos">1629</span></a>
</span><span id="L-1630"><a href="#L-1630"><span class="linenos">1630</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="L-1631"><a href="#L-1631"><span class="linenos">1631</span></a>                    <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_counts</span><span class="p">(</span><span class="n">cur_id</span><span class="p">),</span> <span class="n">ROUND</span>
</span><span id="L-1632"><a href="#L-1632"><span class="linenos">1632</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="L-1633"><a href="#L-1633"><span class="linenos">1633</span></a>
</span><span id="L-1634"><a href="#L-1634"><span class="linenos">1634</span></a>                <span class="k">if</span> <span class="n">resort_categorical</span><span class="p">:</span>
</span><span id="L-1635"><a href="#L-1635"><span class="linenos">1635</span></a>                    <span class="n">cur_bin_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1636"><a href="#L-1636"><span class="linenos">1636</span></a>                        <span class="nb">zip</span><span class="p">(</span>
</span><span id="L-1637"><a href="#L-1637"><span class="linenos">1637</span></a>                            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel&quot;</span><span class="p">],</span>
</span><span id="L-1638"><a href="#L-1638"><span class="linenos">1638</span></a>                            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">],</span>
</span><span id="L-1639"><a href="#L-1639"><span class="linenos">1639</span></a>                            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span>
</span><span id="L-1640"><a href="#L-1640"><span class="linenos">1640</span></a>                            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
</span><span id="L-1641"><a href="#L-1641"><span class="linenos">1641</span></a>                        <span class="p">)</span>
</span><span id="L-1642"><a href="#L-1642"><span class="linenos">1642</span></a>                    <span class="p">)</span>
</span><span id="L-1643"><a href="#L-1643"><span class="linenos">1643</span></a>                    <span class="n">cur_bin_info</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cur_bin_info</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1644"><a href="#L-1644"><span class="linenos">1644</span></a>
</span><span id="L-1645"><a href="#L-1645"><span class="linenos">1645</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_bin_info</span><span class="p">]</span>
</span><span id="L-1646"><a href="#L-1646"><span class="linenos">1646</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_bin_info</span><span class="p">]</span>
</span><span id="L-1647"><a href="#L-1647"><span class="linenos">1647</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_bin_info</span><span class="p">]</span>
</span><span id="L-1648"><a href="#L-1648"><span class="linenos">1648</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_bin_info</span><span class="p">]</span>
</span><span id="L-1649"><a href="#L-1649"><span class="linenos">1649</span></a>
</span><span id="L-1650"><a href="#L-1650"><span class="linenos">1650</span></a>                    <span class="n">cur_hist_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-1651"><a href="#L-1651"><span class="linenos">1651</span></a>                        <span class="nb">zip</span><span class="p">(</span><span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge&quot;</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount&quot;</span><span class="p">])</span>
</span><span id="L-1652"><a href="#L-1652"><span class="linenos">1652</span></a>                    <span class="p">)</span>
</span><span id="L-1653"><a href="#L-1653"><span class="linenos">1653</span></a>                    <span class="n">cur_hist_info</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cur_hist_info</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="L-1654"><a href="#L-1654"><span class="linenos">1654</span></a>
</span><span id="L-1655"><a href="#L-1655"><span class="linenos">1655</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_hist_info</span><span class="p">]</span>
</span><span id="L-1656"><a href="#L-1656"><span class="linenos">1656</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_hist_info</span><span class="p">]</span>
</span><span id="L-1657"><a href="#L-1657"><span class="linenos">1657</span></a>
</span><span id="L-1658"><a href="#L-1658"><span class="linenos">1658</span></a>                <span class="c1"># Add the label encoding information</span>
</span><span id="L-1659"><a href="#L-1659"><span class="linenos">1659</span></a>                <span class="n">labelEncoder</span><span class="p">[</span><span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1660"><a href="#L-1660"><span class="linenos">1660</span></a>                    <span class="n">i</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">level_str_to_int</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="L-1661"><a href="#L-1661"><span class="linenos">1661</span></a>                <span class="p">}</span>
</span><span id="L-1662"><a href="#L-1662"><span class="linenos">1662</span></a>
</span><span id="L-1663"><a href="#L-1663"><span class="linenos">1663</span></a>        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_feature</span><span class="p">)</span>
</span><span id="L-1664"><a href="#L-1664"><span class="linenos">1664</span></a>
</span><span id="L-1665"><a href="#L-1665"><span class="linenos">1665</span></a>    <span class="n">score_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ROUND</span><span class="p">),</span> <span class="n">score_range</span><span class="p">))</span>
</span><span id="L-1666"><a href="#L-1666"><span class="linenos">1666</span></a>
</span><span id="L-1667"><a href="#L-1667"><span class="linenos">1667</span></a>    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1668"><a href="#L-1668"><span class="linenos">1668</span></a>    <span class="n">feature_types</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-1669"><a href="#L-1669"><span class="linenos">1669</span></a>
</span><span id="L-1670"><a href="#L-1670"><span class="linenos">1670</span></a>    <span class="c1"># Sample data does not record interaction features</span>
</span><span id="L-1671"><a href="#L-1671"><span class="linenos">1671</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="L-1672"><a href="#L-1672"><span class="linenos">1672</span></a>        <span class="k">if</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="L-1673"><a href="#L-1673"><span class="linenos">1673</span></a>            <span class="n">feature_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-1674"><a href="#L-1674"><span class="linenos">1674</span></a>            <span class="n">feature_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="L-1675"><a href="#L-1675"><span class="linenos">1675</span></a>
</span><span id="L-1676"><a href="#L-1676"><span class="linenos">1676</span></a>    <span class="c1"># Compute the MAD scores and frequencies</span>
</span><span id="L-1677"><a href="#L-1677"><span class="linenos">1677</span></a>    <span class="n">ebm_cont_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-1678"><a href="#L-1678"><span class="linenos">1678</span></a>        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">))</span> <span class="k">if</span> <span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">]</span>
</span><span id="L-1679"><a href="#L-1679"><span class="linenos">1679</span></a>    <span class="p">)</span>
</span><span id="L-1680"><a href="#L-1680"><span class="linenos">1680</span></a>
</span><span id="L-1681"><a href="#L-1681"><span class="linenos">1681</span></a>    <span class="n">contMads</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1682"><a href="#L-1682"><span class="linenos">1682</span></a>
</span><span id="L-1683"><a href="#L-1683"><span class="linenos">1683</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cont_indexes</span><span class="p">:</span>
</span><span id="L-1684"><a href="#L-1684"><span class="linenos">1684</span></a>        <span class="n">contMads</span><span class="p">[</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_mad</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="L-1685"><a href="#L-1685"><span class="linenos">1685</span></a>
</span><span id="L-1686"><a href="#L-1686"><span class="linenos">1686</span></a>    <span class="n">ebm_cat_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="L-1687"><a href="#L-1687"><span class="linenos">1687</span></a>        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">))</span> <span class="k">if</span> <span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">]</span>
</span><span id="L-1688"><a href="#L-1688"><span class="linenos">1688</span></a>    <span class="p">)</span>
</span><span id="L-1689"><a href="#L-1689"><span class="linenos">1689</span></a>
</span><span id="L-1690"><a href="#L-1690"><span class="linenos">1690</span></a>    <span class="n">catDistances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-1691"><a href="#L-1691"><span class="linenos">1691</span></a>
</span><span id="L-1692"><a href="#L-1692"><span class="linenos">1692</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cat_indexes</span><span class="p">:</span>
</span><span id="L-1693"><a href="#L-1693"><span class="linenos">1693</span></a>        <span class="n">catDistances</span><span class="p">[</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_frequency_distance</span><span class="p">(</span>
</span><span id="L-1694"><a href="#L-1694"><span class="linenos">1694</span></a>            <span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="L-1695"><a href="#L-1695"><span class="linenos">1695</span></a>        <span class="p">)</span>
</span><span id="L-1696"><a href="#L-1696"><span class="linenos">1696</span></a>
</span><span id="L-1697"><a href="#L-1697"><span class="linenos">1697</span></a>    <span class="c1"># Initialize a feature description dictionary (provide more information about</span>
</span><span id="L-1698"><a href="#L-1698"><span class="linenos">1698</span></a>    <span class="c1"># each feature in the UI)</span>
</span><span id="L-1699"><a href="#L-1699"><span class="linenos">1699</span></a>    <span class="n">feature_descriptions</span> <span class="o">=</span> <span class="n">_init_feature_descriptions</span><span class="p">(</span><span class="n">ebm</span><span class="p">,</span> <span class="n">labelEncoder</span><span class="p">)</span>
</span><span id="L-1700"><a href="#L-1700"><span class="linenos">1700</span></a>
</span><span id="L-1701"><a href="#L-1701"><span class="linenos">1701</span></a>    <span class="c1"># Overwrite some entries in the default feature_descriptions</span>
</span><span id="L-1702"><a href="#L-1702"><span class="linenos">1702</span></a>    <span class="k">if</span> <span class="n">feature_info</span><span class="p">:</span>
</span><span id="L-1703"><a href="#L-1703"><span class="linenos">1703</span></a>        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_info</span><span class="p">:</span>
</span><span id="L-1704"><a href="#L-1704"><span class="linenos">1704</span></a>            <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s2">&quot;displayName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1705"><a href="#L-1705"><span class="linenos">1705</span></a>            <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1706"><a href="#L-1706"><span class="linenos">1706</span></a>
</span><span id="L-1707"><a href="#L-1707"><span class="linenos">1707</span></a>    <span class="k">if</span> <span class="n">feature_level_info</span><span class="p">:</span>
</span><span id="L-1708"><a href="#L-1708"><span class="linenos">1708</span></a>        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_level_info</span><span class="p">:</span>
</span><span id="L-1709"><a href="#L-1709"><span class="linenos">1709</span></a>            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">feature_level_info</span><span class="p">[</span><span class="n">feature</span><span class="p">]:</span>
</span><span id="L-1710"><a href="#L-1710"><span class="linenos">1710</span></a>                <span class="n">display_name</span> <span class="o">=</span> <span class="n">feature_level_info</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">level</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-1711"><a href="#L-1711"><span class="linenos">1711</span></a>                <span class="n">description</span> <span class="o">=</span> <span class="n">feature_level_info</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">level</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="L-1712"><a href="#L-1712"><span class="linenos">1712</span></a>                <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s2">&quot;levelDescription&quot;</span><span class="p">][</span><span class="n">level</span><span class="p">][</span>
</span><span id="L-1713"><a href="#L-1713"><span class="linenos">1713</span></a>                    <span class="s2">&quot;displayName&quot;</span>
</span><span id="L-1714"><a href="#L-1714"><span class="linenos">1714</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="n">display_name</span>
</span><span id="L-1715"><a href="#L-1715"><span class="linenos">1715</span></a>                <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s2">&quot;levelDescription&quot;</span><span class="p">][</span><span class="n">level</span><span class="p">][</span>
</span><span id="L-1716"><a href="#L-1716"><span class="linenos">1716</span></a>                    <span class="s2">&quot;description&quot;</span>
</span><span id="L-1717"><a href="#L-1717"><span class="linenos">1717</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
</span><span id="L-1718"><a href="#L-1718"><span class="linenos">1718</span></a>
</span><span id="L-1719"><a href="#L-1719"><span class="linenos">1719</span></a>    <span class="c1"># Put descriptions under the &#39;features&#39; key</span>
</span><span id="L-1720"><a href="#L-1720"><span class="linenos">1720</span></a>    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
</span><span id="L-1721"><a href="#L-1721"><span class="linenos">1721</span></a>        <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">feature_descriptions</span><span class="p">:</span>
</span><span id="L-1722"><a href="#L-1722"><span class="linenos">1722</span></a>            <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>
</span><span id="L-1723"><a href="#L-1723"><span class="linenos">1723</span></a>
</span><span id="L-1724"><a href="#L-1724"><span class="linenos">1724</span></a>    <span class="c1"># Set the feature configurations</span>
</span><span id="L-1725"><a href="#L-1725"><span class="linenos">1725</span></a>    <span class="n">feature_configurations</span> <span class="o">=</span> <span class="n">_init_feature_configuration</span><span class="p">(</span><span class="n">ebm</span><span class="p">)</span>
</span><span id="L-1726"><a href="#L-1726"><span class="linenos">1726</span></a>
</span><span id="L-1727"><a href="#L-1727"><span class="linenos">1727</span></a>    <span class="k">if</span> <span class="n">feature_config</span><span class="p">:</span>
</span><span id="L-1728"><a href="#L-1728"><span class="linenos">1728</span></a>        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_config</span><span class="p">:</span>
</span><span id="L-1729"><a href="#L-1729"><span class="linenos">1729</span></a>            <span class="n">cur_config</span> <span class="o">=</span> <span class="n">feature_config</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
</span><span id="L-1730"><a href="#L-1730"><span class="linenos">1730</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="L-1731"><a href="#L-1731"><span class="linenos">1731</span></a>                <span class="s2">&quot;requiresInt&quot;</span><span class="p">,</span>
</span><span id="L-1732"><a href="#L-1732"><span class="linenos">1732</span></a>                <span class="s2">&quot;difficulty&quot;</span><span class="p">,</span>
</span><span id="L-1733"><a href="#L-1733"><span class="linenos">1733</span></a>                <span class="s2">&quot;acceptableRange&quot;</span><span class="p">,</span>
</span><span id="L-1734"><a href="#L-1734"><span class="linenos">1734</span></a>                <span class="s2">&quot;requiresIncreasing&quot;</span><span class="p">,</span>
</span><span id="L-1735"><a href="#L-1735"><span class="linenos">1735</span></a>                <span class="s2">&quot;requiresDecreasing&quot;</span><span class="p">,</span>
</span><span id="L-1736"><a href="#L-1736"><span class="linenos">1736</span></a>                <span class="s2">&quot;usesTransform&quot;</span><span class="p">,</span>
</span><span id="L-1737"><a href="#L-1737"><span class="linenos">1737</span></a>            <span class="p">]:</span>
</span><span id="L-1738"><a href="#L-1738"><span class="linenos">1738</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_config</span><span class="p">:</span>
</span><span id="L-1739"><a href="#L-1739"><span class="linenos">1739</span></a>                    <span class="n">feature_configurations</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="L-1740"><a href="#L-1740"><span class="linenos">1740</span></a>
</span><span id="L-1741"><a href="#L-1741"><span class="linenos">1741</span></a>    <span class="c1"># Attach the configuration to the feature field</span>
</span><span id="L-1742"><a href="#L-1742"><span class="linenos">1742</span></a>    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
</span><span id="L-1743"><a href="#L-1743"><span class="linenos">1743</span></a>        <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">feature_configurations</span><span class="p">:</span>
</span><span id="L-1744"><a href="#L-1744"><span class="linenos">1744</span></a>            <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_configurations</span><span class="p">[</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>
</span><span id="L-1745"><a href="#L-1745"><span class="linenos">1745</span></a>
</span><span id="L-1746"><a href="#L-1746"><span class="linenos">1746</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="L-1747"><a href="#L-1747"><span class="linenos">1747</span></a>        <span class="s2">&quot;intercept&quot;</span><span class="p">:</span> <span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ebm</span><span class="p">,</span> <span class="s2">&quot;classes_&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span>
</span><span id="L-1748"><a href="#L-1748"><span class="linenos">1748</span></a>        <span class="s2">&quot;isClassifier&quot;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ebm</span><span class="p">,</span> <span class="s2">&quot;classes_&quot;</span><span class="p">),</span>
</span><span id="L-1749"><a href="#L-1749"><span class="linenos">1749</span></a>        <span class="s2">&quot;modelInfo&quot;</span><span class="p">:</span> <span class="n">model_info</span><span class="p">,</span>
</span><span id="L-1750"><a href="#L-1750"><span class="linenos">1750</span></a>        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
</span><span id="L-1751"><a href="#L-1751"><span class="linenos">1751</span></a>        <span class="s2">&quot;labelEncoder&quot;</span><span class="p">:</span> <span class="n">labelEncoder</span><span class="p">,</span>
</span><span id="L-1752"><a href="#L-1752"><span class="linenos">1752</span></a>        <span class="s2">&quot;scoreRange&quot;</span><span class="p">:</span> <span class="n">score_range</span><span class="p">,</span>
</span><span id="L-1753"><a href="#L-1753"><span class="linenos">1753</span></a>        <span class="s2">&quot;featureNames&quot;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
</span><span id="L-1754"><a href="#L-1754"><span class="linenos">1754</span></a>        <span class="s2">&quot;featureTypes&quot;</span><span class="p">:</span> <span class="n">feature_types</span><span class="p">,</span>
</span><span id="L-1755"><a href="#L-1755"><span class="linenos">1755</span></a>        <span class="s2">&quot;contMads&quot;</span><span class="p">:</span> <span class="n">contMads</span><span class="p">,</span>
</span><span id="L-1756"><a href="#L-1756"><span class="linenos">1756</span></a>        <span class="s2">&quot;catDistances&quot;</span><span class="p">:</span> <span class="n">catDistances</span><span class="p">,</span>
</span><span id="L-1757"><a href="#L-1757"><span class="linenos">1757</span></a>    <span class="p">}</span>
</span><span id="L-1758"><a href="#L-1758"><span class="linenos">1758</span></a>
</span><span id="L-1759"><a href="#L-1759"><span class="linenos">1759</span></a>    <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


            </section>
                <section id="GAMCoach">
                            <input id="GAMCoach-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">GAMCoach</span>:

                <label class="view-source-button" for="GAMCoach-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach-26"><a href="#GAMCoach-26"><span class="linenos">  26</span></a><span class="k">class</span> <span class="nc">GAMCoach</span><span class="p">:</span>
</span><span id="GAMCoach-27"><a href="#GAMCoach-27"><span class="linenos">  27</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Main class for GAM Coach.&quot;&quot;&quot;</span>
</span><span id="GAMCoach-28"><a href="#GAMCoach-28"><span class="linenos">  28</span></a>
</span><span id="GAMCoach-29"><a href="#GAMCoach-29"><span class="linenos">  29</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="GAMCoach-30"><a href="#GAMCoach-30"><span class="linenos">  30</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach-31"><a href="#GAMCoach-31"><span class="linenos">  31</span></a>        <span class="n">ebm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ExplainableBoostingClassifier</span><span class="p">,</span> <span class="n">ExplainableBoostingRegressor</span><span class="p">],</span>
</span><span id="GAMCoach-32"><a href="#GAMCoach-32"><span class="linenos">  32</span></a>        <span class="n">x_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="GAMCoach-33"><a href="#GAMCoach-33"><span class="linenos">  33</span></a>        <span class="n">cont_mads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-34"><a href="#GAMCoach-34"><span class="linenos">  34</span></a>        <span class="n">cat_distances</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-35"><a href="#GAMCoach-35"><span class="linenos">  35</span></a>        <span class="n">adjust_cat_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="GAMCoach-36"><a href="#GAMCoach-36"><span class="linenos">  36</span></a>    <span class="p">):</span>
</span><span id="GAMCoach-37"><a href="#GAMCoach-37"><span class="linenos">  37</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a GAMCoach object.</span>
</span><span id="GAMCoach-38"><a href="#GAMCoach-38"><span class="linenos">  38</span></a>
</span><span id="GAMCoach-39"><a href="#GAMCoach-39"><span class="linenos">  39</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-40"><a href="#GAMCoach-40"><span class="linenos">  40</span></a><span class="sd">            ebm (Union[ExplainableBoostingClassifier, ExplainableBoostingRegressor]):</span>
</span><span id="GAMCoach-41"><a href="#GAMCoach-41"><span class="linenos">  41</span></a><span class="sd">                The trained EBM model. It can be either a classifier or a regressor.</span>
</span><span id="GAMCoach-42"><a href="#GAMCoach-42"><span class="linenos">  42</span></a><span class="sd">            x_train (np.ndarray): The training data. It is used to compute the</span>
</span><span id="GAMCoach-43"><a href="#GAMCoach-43"><span class="linenos">  43</span></a><span class="sd">                distance for different features.</span>
</span><span id="GAMCoach-44"><a href="#GAMCoach-44"><span class="linenos">  44</span></a><span class="sd">            cont_mads (dict, optional): `feature_name` -&gt; `median absolute</span>
</span><span id="GAMCoach-45"><a href="#GAMCoach-45"><span class="linenos">  45</span></a><span class="sd">                deviation score`. If it is provided, it is used to overwrite the</span>
</span><span id="GAMCoach-46"><a href="#GAMCoach-46"><span class="linenos">  46</span></a><span class="sd">                computed MADs for continuous variables. It is useful when you</span>
</span><span id="GAMCoach-47"><a href="#GAMCoach-47"><span class="linenos">  47</span></a><span class="sd">                want to provide a custom normalization function to compute the</span>
</span><span id="GAMCoach-48"><a href="#GAMCoach-48"><span class="linenos">  48</span></a><span class="sd">                distance between continuous features.</span>
</span><span id="GAMCoach-49"><a href="#GAMCoach-49"><span class="linenos">  49</span></a><span class="sd">            cat_distances (dict, optional): `feature_name` -&gt; {`level_name` -&gt; `distance`}.</span>
</span><span id="GAMCoach-50"><a href="#GAMCoach-50"><span class="linenos">  50</span></a><span class="sd">                Level distance of categorical variables. By default, the distance</span>
</span><span id="GAMCoach-51"><a href="#GAMCoach-51"><span class="linenos">  51</span></a><span class="sd">                is computed by (1 - frequency(level)) for each level. It imples</span>
</span><span id="GAMCoach-52"><a href="#GAMCoach-52"><span class="linenos">  52</span></a><span class="sd">                that it is easier to move to a more frequent. If `cat_distances`</span>
</span><span id="GAMCoach-53"><a href="#GAMCoach-53"><span class="linenos">  53</span></a><span class="sd">                is provided, it will overwrite the default distance for</span>
</span><span id="GAMCoach-54"><a href="#GAMCoach-54"><span class="linenos">  54</span></a><span class="sd">                categorical variables.</span>
</span><span id="GAMCoach-55"><a href="#GAMCoach-55"><span class="linenos">  55</span></a><span class="sd">            adjust_cat_distance (bool, optional): If true, we use (1 -</span>
</span><span id="GAMCoach-56"><a href="#GAMCoach-56"><span class="linenos">  56</span></a><span class="sd">                frequency(level)) for each level. Otherwise, we give distance = 1</span>
</span><span id="GAMCoach-57"><a href="#GAMCoach-57"><span class="linenos">  57</span></a><span class="sd">                for different levels and 0 for the same level.</span>
</span><span id="GAMCoach-58"><a href="#GAMCoach-58"><span class="linenos">  58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-59"><a href="#GAMCoach-59"><span class="linenos">  59</span></a>
</span><span id="GAMCoach-60"><a href="#GAMCoach-60"><span class="linenos">  60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="GAMCoach-61"><a href="#GAMCoach-61"><span class="linenos">  61</span></a>            <span class="n">ExplainableBoostingClassifier</span><span class="p">,</span> <span class="n">ExplainableBoostingRegressor</span>
</span><span id="GAMCoach-62"><a href="#GAMCoach-62"><span class="linenos">  62</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span>
</span><span id="GAMCoach-63"><a href="#GAMCoach-63"><span class="linenos">  63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The trained EBM model.&quot;&quot;&quot;</span>
</span><span id="GAMCoach-64"><a href="#GAMCoach-64"><span class="linenos">  64</span></a>
</span><span id="GAMCoach-65"><a href="#GAMCoach-65"><span class="linenos">  65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">x_train</span>
</span><span id="GAMCoach-66"><a href="#GAMCoach-66"><span class="linenos">  66</span></a>
</span><span id="GAMCoach-67"><a href="#GAMCoach-67"><span class="linenos">  67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">cont_mads</span>
</span><span id="GAMCoach-68"><a href="#GAMCoach-68"><span class="linenos">  68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Median absolute deviation (MAD) of continuous variables.&quot;&quot;&quot;</span>
</span><span id="GAMCoach-69"><a href="#GAMCoach-69"><span class="linenos">  69</span></a>
</span><span id="GAMCoach-70"><a href="#GAMCoach-70"><span class="linenos">  70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">cat_distances</span>
</span><span id="GAMCoach-71"><a href="#GAMCoach-71"><span class="linenos">  71</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Level distance of categorical variables. By default, the distance is</span>
</span><span id="GAMCoach-72"><a href="#GAMCoach-72"><span class="linenos">  72</span></a><span class="sd">        computed by $(1 - \\frac{\\text{count of} L_i}{\\text{count of all L}})$</span>
</span><span id="GAMCoach-73"><a href="#GAMCoach-73"><span class="linenos">  73</span></a><span class="sd">        for one level $L_i$. It implies that it is easier to move to a more</span>
</span><span id="GAMCoach-74"><a href="#GAMCoach-74"><span class="linenos">  74</span></a><span class="sd">        frequent level.</span>
</span><span id="GAMCoach-75"><a href="#GAMCoach-75"><span class="linenos">  75</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-76"><a href="#GAMCoach-76"><span class="linenos">  76</span></a>
</span><span id="GAMCoach-77"><a href="#GAMCoach-77"><span class="linenos">  77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_cat_distance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">adjust_cat_distance</span>
</span><span id="GAMCoach-78"><a href="#GAMCoach-78"><span class="linenos">  78</span></a>
</span><span id="GAMCoach-79"><a href="#GAMCoach-79"><span class="linenos">  79</span></a>        <span class="c1"># If cont_mads is not given, we compute it from the training data</span>
</span><span id="GAMCoach-80"><a href="#GAMCoach-80"><span class="linenos">  80</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach-81"><a href="#GAMCoach-81"><span class="linenos">  81</span></a>            <span class="n">ebm_cont_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="GAMCoach-82"><a href="#GAMCoach-82"><span class="linenos">  82</span></a>                <span class="p">[</span>
</span><span id="GAMCoach-83"><a href="#GAMCoach-83"><span class="linenos">  83</span></a>                    <span class="n">i</span>
</span><span id="GAMCoach-84"><a href="#GAMCoach-84"><span class="linenos">  84</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">))</span>
</span><span id="GAMCoach-85"><a href="#GAMCoach-85"><span class="linenos">  85</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span>
</span><span id="GAMCoach-86"><a href="#GAMCoach-86"><span class="linenos">  86</span></a>                <span class="p">]</span>
</span><span id="GAMCoach-87"><a href="#GAMCoach-87"><span class="linenos">  87</span></a>            <span class="p">)</span>
</span><span id="GAMCoach-88"><a href="#GAMCoach-88"><span class="linenos">  88</span></a>
</span><span id="GAMCoach-89"><a href="#GAMCoach-89"><span class="linenos">  89</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach-90"><a href="#GAMCoach-90"><span class="linenos">  90</span></a>
</span><span id="GAMCoach-91"><a href="#GAMCoach-91"><span class="linenos">  91</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cont_indexes</span><span class="p">:</span>
</span><span id="GAMCoach-92"><a href="#GAMCoach-92"><span class="linenos">  92</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">[</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mad</span><span class="p">(</span>
</span><span id="GAMCoach-93"><a href="#GAMCoach-93"><span class="linenos">  93</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-94"><a href="#GAMCoach-94"><span class="linenos">  94</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-95"><a href="#GAMCoach-95"><span class="linenos">  95</span></a>
</span><span id="GAMCoach-96"><a href="#GAMCoach-96"><span class="linenos">  96</span></a>        <span class="c1"># If cat_distance is not given, we compute it from the training data</span>
</span><span id="GAMCoach-97"><a href="#GAMCoach-97"><span class="linenos">  97</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach-98"><a href="#GAMCoach-98"><span class="linenos">  98</span></a>            <span class="n">ebm_cat_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="GAMCoach-99"><a href="#GAMCoach-99"><span class="linenos">  99</span></a>                <span class="p">[</span>
</span><span id="GAMCoach-100"><a href="#GAMCoach-100"><span class="linenos"> 100</span></a>                    <span class="n">i</span>
</span><span id="GAMCoach-101"><a href="#GAMCoach-101"><span class="linenos"> 101</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">))</span>
</span><span id="GAMCoach-102"><a href="#GAMCoach-102"><span class="linenos"> 102</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span>
</span><span id="GAMCoach-103"><a href="#GAMCoach-103"><span class="linenos"> 103</span></a>                <span class="p">]</span>
</span><span id="GAMCoach-104"><a href="#GAMCoach-104"><span class="linenos"> 104</span></a>            <span class="p">)</span>
</span><span id="GAMCoach-105"><a href="#GAMCoach-105"><span class="linenos"> 105</span></a>
</span><span id="GAMCoach-106"><a href="#GAMCoach-106"><span class="linenos"> 106</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach-107"><a href="#GAMCoach-107"><span class="linenos"> 107</span></a>
</span><span id="GAMCoach-108"><a href="#GAMCoach-108"><span class="linenos"> 108</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_cat_distance</span><span class="p">:</span>
</span><span id="GAMCoach-109"><a href="#GAMCoach-109"><span class="linenos"> 109</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cat_indexes</span><span class="p">:</span>
</span><span id="GAMCoach-110"><a href="#GAMCoach-110"><span class="linenos"> 110</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span>
</span><span id="GAMCoach-111"><a href="#GAMCoach-111"><span class="linenos"> 111</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-112"><a href="#GAMCoach-112"><span class="linenos"> 112</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_frequency_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="GAMCoach-113"><a href="#GAMCoach-113"><span class="linenos"> 113</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-114"><a href="#GAMCoach-114"><span class="linenos"> 114</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cat_indexes</span><span class="p">:</span>
</span><span id="GAMCoach-115"><a href="#GAMCoach-115"><span class="linenos"> 115</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span>
</span><span id="GAMCoach-116"><a href="#GAMCoach-116"><span class="linenos"> 116</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-117"><a href="#GAMCoach-117"><span class="linenos"> 117</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_naive_cat_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="GAMCoach-118"><a href="#GAMCoach-118"><span class="linenos"> 118</span></a>
</span><span id="GAMCoach-119"><a href="#GAMCoach-119"><span class="linenos"> 119</span></a>        <span class="c1"># Determine if the ebm is a classifier or a regressor</span>
</span><span id="GAMCoach-120"><a href="#GAMCoach-120"><span class="linenos"> 120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="GAMCoach-121"><a href="#GAMCoach-121"><span class="linenos"> 121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the ebm model is a classifier, false if it is a regressor.&quot;&quot;&quot;</span>
</span><span id="GAMCoach-122"><a href="#GAMCoach-122"><span class="linenos"> 122</span></a>
</span><span id="GAMCoach-123"><a href="#GAMCoach-123"><span class="linenos"> 123</span></a>    <span class="k">def</span> <span class="nf">generate_cfs</span><span class="p">(</span>
</span><span id="GAMCoach-124"><a href="#GAMCoach-124"><span class="linenos"> 124</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach-125"><a href="#GAMCoach-125"><span class="linenos"> 125</span></a>        <span class="n">cur_example</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="GAMCoach-126"><a href="#GAMCoach-126"><span class="linenos"> 126</span></a>        <span class="n">total_cfs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GAMCoach-127"><a href="#GAMCoach-127"><span class="linenos"> 127</span></a>        <span class="n">target_range</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-128"><a href="#GAMCoach-128"><span class="linenos"> 128</span></a>        <span class="n">sim_threshold_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span>
</span><span id="GAMCoach-129"><a href="#GAMCoach-129"><span class="linenos"> 129</span></a>        <span class="n">sim_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-130"><a href="#GAMCoach-130"><span class="linenos"> 130</span></a>        <span class="n">categorical_weight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="GAMCoach-131"><a href="#GAMCoach-131"><span class="linenos"> 131</span></a>        <span class="n">features_to_vary</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-132"><a href="#GAMCoach-132"><span class="linenos"> 132</span></a>        <span class="n">max_num_features_to_vary</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-133"><a href="#GAMCoach-133"><span class="linenos"> 133</span></a>        <span class="n">feature_ranges</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-134"><a href="#GAMCoach-134"><span class="linenos"> 134</span></a>        <span class="n">continuous_integer_features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-135"><a href="#GAMCoach-135"><span class="linenos"> 135</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GAMCoach-136"><a href="#GAMCoach-136"><span class="linenos"> 136</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Counterfactuals</span><span class="p">:</span>
</span><span id="GAMCoach-137"><a href="#GAMCoach-137"><span class="linenos"> 137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate counterfactual examples.</span>
</span><span id="GAMCoach-138"><a href="#GAMCoach-138"><span class="linenos"> 138</span></a>
</span><span id="GAMCoach-139"><a href="#GAMCoach-139"><span class="linenos"> 139</span></a><span class="sd">        Use mixed-integer linear programming to generate optimal counterfactual</span>
</span><span id="GAMCoach-140"><a href="#GAMCoach-140"><span class="linenos"> 140</span></a><span class="sd">        examples for the given data point.</span>
</span><span id="GAMCoach-141"><a href="#GAMCoach-141"><span class="linenos"> 141</span></a>
</span><span id="GAMCoach-142"><a href="#GAMCoach-142"><span class="linenos"> 142</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-143"><a href="#GAMCoach-143"><span class="linenos"> 143</span></a><span class="sd">            cur_example (np.ndarray): The data point of interest. This function</span>
</span><span id="GAMCoach-144"><a href="#GAMCoach-144"><span class="linenos"> 144</span></a><span class="sd">                aims to find similar examples that the model gives different</span>
</span><span id="GAMCoach-145"><a href="#GAMCoach-145"><span class="linenos"> 145</span></a><span class="sd">                predictions.</span>
</span><span id="GAMCoach-146"><a href="#GAMCoach-146"><span class="linenos"> 146</span></a><span class="sd">            total_cfs (int, optional): The total number of counterfactuals to,</span>
</span><span id="GAMCoach-147"><a href="#GAMCoach-147"><span class="linenos"> 147</span></a><span class="sd">                generate. Default to 1.</span>
</span><span id="GAMCoach-148"><a href="#GAMCoach-148"><span class="linenos"> 148</span></a><span class="sd">            target_range (tuple, optional): The targetted prediction range. This</span>
</span><span id="GAMCoach-149"><a href="#GAMCoach-149"><span class="linenos"> 149</span></a><span class="sd">                parameter is required if the EBM is a regressor.</span>
</span><span id="GAMCoach-150"><a href="#GAMCoach-150"><span class="linenos"> 150</span></a><span class="sd">            sim_threshold_factor (float, optional): A positive float to automatically</span>
</span><span id="GAMCoach-151"><a href="#GAMCoach-151"><span class="linenos"> 151</span></a><span class="sd">                generate a similarity threshold. This parameter has no effect if</span>
</span><span id="GAMCoach-152"><a href="#GAMCoach-152"><span class="linenos"> 152</span></a><span class="sd">                `sim_threshold` is provided. If `sim_threshold` is</span>
</span><span id="GAMCoach-153"><a href="#GAMCoach-153"><span class="linenos"> 153</span></a><span class="sd">                not provided, we compute `sim_threshold` as `sim_threshold_factor`</span>
</span><span id="GAMCoach-154"><a href="#GAMCoach-154"><span class="linenos"> 154</span></a><span class="sd">                * average additive score range of all continuous features. If</span>
</span><span id="GAMCoach-155"><a href="#GAMCoach-155"><span class="linenos"> 155</span></a><span class="sd">                `sim_threshold_factor` is too small, it takes longer time to</span>
</span><span id="GAMCoach-156"><a href="#GAMCoach-156"><span class="linenos"> 156</span></a><span class="sd">                generate CFs. If `sim_threshold_factor` is too large, the</span>
</span><span id="GAMCoach-157"><a href="#GAMCoach-157"><span class="linenos"> 157</span></a><span class="sd">                algorithm might miss some optimal CFs.</span>
</span><span id="GAMCoach-158"><a href="#GAMCoach-158"><span class="linenos"> 158</span></a><span class="sd">            sim_threshold (float, optional): A positive float to determine how we</span>
</span><span id="GAMCoach-159"><a href="#GAMCoach-159"><span class="linenos"> 159</span></a><span class="sd">                decide if two bins of a continuous feature have similar scores.</span>
</span><span id="GAMCoach-160"><a href="#GAMCoach-160"><span class="linenos"> 160</span></a><span class="sd">                Two bins $b_1$ and $b_2$ are similar (the distant one will be</span>
</span><span id="GAMCoach-161"><a href="#GAMCoach-161"><span class="linenos"> 161</span></a><span class="sd">                removed) if $|b_1 - b_2| \\leq$ `sim_threshold`.</span>
</span><span id="GAMCoach-162"><a href="#GAMCoach-162"><span class="linenos"> 162</span></a><span class="sd">            categorical_weight (Union[float, str], optional): A positive float</span>
</span><span id="GAMCoach-163"><a href="#GAMCoach-163"><span class="linenos"> 163</span></a><span class="sd">                to scale the distances of options for categorical variables. Since</span>
</span><span id="GAMCoach-164"><a href="#GAMCoach-164"><span class="linenos"> 164</span></a><span class="sd">                we have very different distance functions for continuous and</span>
</span><span id="GAMCoach-165"><a href="#GAMCoach-165"><span class="linenos"> 165</span></a><span class="sd">                categorical features, we need to scale them so they are at a</span>
</span><span id="GAMCoach-166"><a href="#GAMCoach-166"><span class="linenos"> 166</span></a><span class="sd">                comparable range. To do that, we multiply the categorical feature&#39;s</span>
</span><span id="GAMCoach-167"><a href="#GAMCoach-167"><span class="linenos"> 167</span></a><span class="sd">                distances by `categorical_weight`. By default (&#39;auto&#39;), we scale</span>
</span><span id="GAMCoach-168"><a href="#GAMCoach-168"><span class="linenos"> 168</span></a><span class="sd">                the distances of categorical features so that they have the mean</span>
</span><span id="GAMCoach-169"><a href="#GAMCoach-169"><span class="linenos"> 169</span></a><span class="sd">                distance as continuous features.</span>
</span><span id="GAMCoach-170"><a href="#GAMCoach-170"><span class="linenos"> 170</span></a><span class="sd">            features_to_vary ([str], optional): A list of feature names that</span>
</span><span id="GAMCoach-171"><a href="#GAMCoach-171"><span class="linenos"> 171</span></a><span class="sd">                the CFs can change. If it is `None`, this function will use all</span>
</span><span id="GAMCoach-172"><a href="#GAMCoach-172"><span class="linenos"> 172</span></a><span class="sd">                features.</span>
</span><span id="GAMCoach-173"><a href="#GAMCoach-173"><span class="linenos"> 173</span></a><span class="sd">            max_num_features_to_vary (int, optional): The max number of features</span>
</span><span id="GAMCoach-174"><a href="#GAMCoach-174"><span class="linenos"> 174</span></a><span class="sd">                that the CF can vary. Default is no maximum.</span>
</span><span id="GAMCoach-175"><a href="#GAMCoach-175"><span class="linenos"> 175</span></a><span class="sd">            feature_ranges (dict, optional): A dictionary to control the permitted</span>
</span><span id="GAMCoach-176"><a href="#GAMCoach-176"><span class="linenos"> 176</span></a><span class="sd">                ranges/values for continuous/categorical features. It maps</span>
</span><span id="GAMCoach-177"><a href="#GAMCoach-177"><span class="linenos"> 177</span></a><span class="sd">                `feature_name` -&gt; [`min_value`, `max_value`] for continuous features,</span>
</span><span id="GAMCoach-178"><a href="#GAMCoach-178"><span class="linenos"> 178</span></a><span class="sd">                `feature_name` -&gt; [`level1`, `level2`, ...] for categorical features.</span>
</span><span id="GAMCoach-179"><a href="#GAMCoach-179"><span class="linenos"> 179</span></a><span class="sd">            continuous_integer_features (list, optional): A list of names of</span>
</span><span id="GAMCoach-180"><a href="#GAMCoach-180"><span class="linenos"> 180</span></a><span class="sd">                continuous features that need to be integers (e.g., age, FICO score)</span>
</span><span id="GAMCoach-181"><a href="#GAMCoach-181"><span class="linenos"> 181</span></a><span class="sd">            verbose (int): 0: no any output, 1: show progress bar, 2: show internal</span>
</span><span id="GAMCoach-182"><a href="#GAMCoach-182"><span class="linenos"> 182</span></a><span class="sd">                optimization details</span>
</span><span id="GAMCoach-183"><a href="#GAMCoach-183"><span class="linenos"> 183</span></a>
</span><span id="GAMCoach-184"><a href="#GAMCoach-184"><span class="linenos"> 184</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach-185"><a href="#GAMCoach-185"><span class="linenos"> 185</span></a><span class="sd">            Counterfactuals: The generated counterfactual examples with their</span>
</span><span id="GAMCoach-186"><a href="#GAMCoach-186"><span class="linenos"> 186</span></a><span class="sd">                associated distances and change information.</span>
</span><span id="GAMCoach-187"><a href="#GAMCoach-187"><span class="linenos"> 187</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-188"><a href="#GAMCoach-188"><span class="linenos"> 188</span></a>
</span><span id="GAMCoach-189"><a href="#GAMCoach-189"><span class="linenos"> 189</span></a>        <span class="c1"># Transforming some parameters</span>
</span><span id="GAMCoach-190"><a href="#GAMCoach-190"><span class="linenos"> 190</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_example</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GAMCoach-191"><a href="#GAMCoach-191"><span class="linenos"> 191</span></a>            <span class="n">cur_example</span> <span class="o">=</span> <span class="n">cur_example</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GAMCoach-192"><a href="#GAMCoach-192"><span class="linenos"> 192</span></a>
</span><span id="GAMCoach-193"><a href="#GAMCoach-193"><span class="linenos"> 193</span></a>        <span class="k">if</span> <span class="n">features_to_vary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach-194"><a href="#GAMCoach-194"><span class="linenos"> 194</span></a>            <span class="n">features_to_vary</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="GAMCoach-195"><a href="#GAMCoach-195"><span class="linenos"> 195</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-196"><a href="#GAMCoach-196"><span class="linenos"> 196</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">))</span>
</span><span id="GAMCoach-197"><a href="#GAMCoach-197"><span class="linenos"> 197</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;interaction&quot;</span>
</span><span id="GAMCoach-198"><a href="#GAMCoach-198"><span class="linenos"> 198</span></a>            <span class="p">]</span>
</span><span id="GAMCoach-199"><a href="#GAMCoach-199"><span class="linenos"> 199</span></a>
</span><span id="GAMCoach-200"><a href="#GAMCoach-200"><span class="linenos"> 200</span></a>        <span class="c1"># Step 1: Find the current score for each feature</span>
</span><span id="GAMCoach-201"><a href="#GAMCoach-201"><span class="linenos"> 201</span></a>        <span class="c1"># This is done by ebm.explain_local()</span>
</span><span id="GAMCoach-202"><a href="#GAMCoach-202"><span class="linenos"> 202</span></a>        <span class="n">cur_scores</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach-203"><a href="#GAMCoach-203"><span class="linenos"> 203</span></a>
</span><span id="GAMCoach-204"><a href="#GAMCoach-204"><span class="linenos"> 204</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span><span class="p">:</span>
</span><span id="GAMCoach-205"><a href="#GAMCoach-205"><span class="linenos"> 205</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach-206"><a href="#GAMCoach-206"><span class="linenos"> 206</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-207"><a href="#GAMCoach-207"><span class="linenos"> 207</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span>
</span><span id="GAMCoach-208"><a href="#GAMCoach-208"><span class="linenos"> 208</span></a>
</span><span id="GAMCoach-209"><a href="#GAMCoach-209"><span class="linenos"> 209</span></a>        <span class="n">local_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">explain_local</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)</span><span class="o">.</span><span class="n">_internal_obj</span>
</span><span id="GAMCoach-210"><a href="#GAMCoach-210"><span class="linenos"> 210</span></a>
</span><span id="GAMCoach-211"><a href="#GAMCoach-211"><span class="linenos"> 211</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach-212"><a href="#GAMCoach-212"><span class="linenos"> 212</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-213"><a href="#GAMCoach-213"><span class="linenos"> 213</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-214"><a href="#GAMCoach-214"><span class="linenos"> 214</span></a>
</span><span id="GAMCoach-215"><a href="#GAMCoach-215"><span class="linenos"> 215</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_data</span><span class="p">[</span><span class="s2">&quot;specific&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;scores&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-216"><a href="#GAMCoach-216"><span class="linenos"> 216</span></a>
</span><span id="GAMCoach-217"><a href="#GAMCoach-217"><span class="linenos"> 217</span></a>        <span class="c1"># Find the CF direction</span>
</span><span id="GAMCoach-218"><a href="#GAMCoach-218"><span class="linenos"> 218</span></a>
</span><span id="GAMCoach-219"><a href="#GAMCoach-219"><span class="linenos"> 219</span></a>        <span class="c1"># Binary classification</span>
</span><span id="GAMCoach-220"><a href="#GAMCoach-220"><span class="linenos"> 220</span></a>        <span class="c1"># Predicted 0 =&gt; +1</span>
</span><span id="GAMCoach-221"><a href="#GAMCoach-221"><span class="linenos"> 221</span></a>        <span class="c1"># Predicted 1 =&gt; -1</span>
</span><span id="GAMCoach-222"><a href="#GAMCoach-222"><span class="linenos"> 222</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span><span class="p">:</span>
</span><span id="GAMCoach-223"><a href="#GAMCoach-223"><span class="linenos"> 223</span></a>            <span class="n">cf_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="GAMCoach-224"><a href="#GAMCoach-224"><span class="linenos"> 224</span></a>            <span class="n">total_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cur_scores</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_scores</span><span class="p">])</span>
</span><span id="GAMCoach-225"><a href="#GAMCoach-225"><span class="linenos"> 225</span></a>            <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="o">-</span><span class="n">total_score</span>
</span><span id="GAMCoach-226"><a href="#GAMCoach-226"><span class="linenos"> 226</span></a>            <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach-227"><a href="#GAMCoach-227"><span class="linenos"> 227</span></a>
</span><span id="GAMCoach-228"><a href="#GAMCoach-228"><span class="linenos"> 228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-229"><a href="#GAMCoach-229"><span class="linenos"> 229</span></a>            <span class="c1"># Regression</span>
</span><span id="GAMCoach-230"><a href="#GAMCoach-230"><span class="linenos"> 230</span></a>            <span class="c1"># Increase +1</span>
</span><span id="GAMCoach-231"><a href="#GAMCoach-231"><span class="linenos"> 231</span></a>            <span class="c1"># Decrease -1</span>
</span><span id="GAMCoach-232"><a href="#GAMCoach-232"><span class="linenos"> 232</span></a>            <span class="k">if</span> <span class="n">target_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach-233"><a href="#GAMCoach-233"><span class="linenos"> 233</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="GAMCoach-234"><a href="#GAMCoach-234"><span class="linenos"> 234</span></a>                    <span class="s2">&quot;target_range cannot be None when the model is a regressor&quot;</span>
</span><span id="GAMCoach-235"><a href="#GAMCoach-235"><span class="linenos"> 235</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-236"><a href="#GAMCoach-236"><span class="linenos"> 236</span></a>
</span><span id="GAMCoach-237"><a href="#GAMCoach-237"><span class="linenos"> 237</span></a>            <span class="n">predicted_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach-238"><a href="#GAMCoach-238"><span class="linenos"> 238</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="GAMCoach-239"><a href="#GAMCoach-239"><span class="linenos"> 239</span></a>                <span class="n">predicted_value</span> <span class="o">&gt;=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach-240"><a href="#GAMCoach-240"><span class="linenos"> 240</span></a>                <span class="ow">and</span> <span class="n">predicted_value</span> <span class="o">&lt;=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-241"><a href="#GAMCoach-241"><span class="linenos"> 241</span></a>            <span class="p">):</span>
</span><span id="GAMCoach-242"><a href="#GAMCoach-242"><span class="linenos"> 242</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The target_range cannot cover the current prediction&quot;</span><span class="p">)</span>
</span><span id="GAMCoach-243"><a href="#GAMCoach-243"><span class="linenos"> 243</span></a>
</span><span id="GAMCoach-244"><a href="#GAMCoach-244"><span class="linenos"> 244</span></a>            <span class="k">elif</span> <span class="n">predicted_value</span> <span class="o">&lt;</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="GAMCoach-245"><a href="#GAMCoach-245"><span class="linenos"> 245</span></a>                <span class="n">cf_direction</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="GAMCoach-246"><a href="#GAMCoach-246"><span class="linenos"> 246</span></a>                <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="GAMCoach-247"><a href="#GAMCoach-247"><span class="linenos"> 247</span></a>                <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="GAMCoach-248"><a href="#GAMCoach-248"><span class="linenos"> 248</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-249"><a href="#GAMCoach-249"><span class="linenos"> 249</span></a>                <span class="n">cf_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="GAMCoach-250"><a href="#GAMCoach-250"><span class="linenos"> 250</span></a>                <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="GAMCoach-251"><a href="#GAMCoach-251"><span class="linenos"> 251</span></a>                <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="GAMCoach-252"><a href="#GAMCoach-252"><span class="linenos"> 252</span></a>
</span><span id="GAMCoach-253"><a href="#GAMCoach-253"><span class="linenos"> 253</span></a>        <span class="c1"># Step 2: Generate continuous and categorical options</span>
</span><span id="GAMCoach-254"><a href="#GAMCoach-254"><span class="linenos"> 254</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach-255"><a href="#GAMCoach-255"><span class="linenos"> 255</span></a>
</span><span id="GAMCoach-256"><a href="#GAMCoach-256"><span class="linenos"> 256</span></a>        <span class="c1"># Generate a similarity threshold if it is not provided</span>
</span><span id="GAMCoach-257"><a href="#GAMCoach-257"><span class="linenos"> 257</span></a>        <span class="k">if</span> <span class="n">sim_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach-258"><a href="#GAMCoach-258"><span class="linenos"> 258</span></a>            <span class="n">additive_ranges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-259"><a href="#GAMCoach-259"><span class="linenos"> 259</span></a>
</span><span id="GAMCoach-260"><a href="#GAMCoach-260"><span class="linenos"> 260</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach-261"><a href="#GAMCoach-261"><span class="linenos"> 261</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-262"><a href="#GAMCoach-262"><span class="linenos"> 262</span></a>                    <span class="n">cur_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-263"><a href="#GAMCoach-263"><span class="linenos"> 263</span></a>                    <span class="n">additive_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cur_values</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cur_values</span><span class="p">))</span>
</span><span id="GAMCoach-264"><a href="#GAMCoach-264"><span class="linenos"> 264</span></a>
</span><span id="GAMCoach-265"><a href="#GAMCoach-265"><span class="linenos"> 265</span></a>            <span class="n">sim_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">additive_ranges</span><span class="p">)</span> <span class="o">*</span> <span class="n">sim_threshold_factor</span>
</span><span id="GAMCoach-266"><a href="#GAMCoach-266"><span class="linenos"> 266</span></a>
</span><span id="GAMCoach-267"><a href="#GAMCoach-267"><span class="linenos"> 267</span></a>        <span class="c1"># To make it faster to solve the MILP problem, we can decrease the</span>
</span><span id="GAMCoach-268"><a href="#GAMCoach-268"><span class="linenos"> 268</span></a>        <span class="c1"># number of variables by filtering out unhelpful and redundant options</span>
</span><span id="GAMCoach-269"><a href="#GAMCoach-269"><span class="linenos"> 269</span></a>        <span class="c1">#</span>
</span><span id="GAMCoach-270"><a href="#GAMCoach-270"><span class="linenos"> 270</span></a>        <span class="c1"># (1) Unhelpful options: options that move the score to an undesirable</span>
</span><span id="GAMCoach-271"><a href="#GAMCoach-271"><span class="linenos"> 271</span></a>        <span class="c1"># direction. For example, if we want to flip 0 to 1, options that decrease</span>
</span><span id="GAMCoach-272"><a href="#GAMCoach-272"><span class="linenos"> 272</span></a>        <span class="c1"># the score are unhelpful.</span>
</span><span id="GAMCoach-273"><a href="#GAMCoach-273"><span class="linenos"> 273</span></a>        <span class="c1">#</span>
</span><span id="GAMCoach-274"><a href="#GAMCoach-274"><span class="linenos"> 274</span></a>        <span class="c1"># (2) Redundant options: for a set of options that give similar score</span>
</span><span id="GAMCoach-275"><a href="#GAMCoach-275"><span class="linenos"> 275</span></a>        <span class="c1"># gains (bounded by a parameter epsilon), we only need to incldue one</span>
</span><span id="GAMCoach-276"><a href="#GAMCoach-276"><span class="linenos"> 276</span></a>        <span class="c1"># option that has the lowest distance. This is only relevant for</span>
</span><span id="GAMCoach-277"><a href="#GAMCoach-277"><span class="linenos"> 277</span></a>        <span class="c1"># continuous variables. Users can set the parameter epsilon. The default</span>
</span><span id="GAMCoach-278"><a href="#GAMCoach-278"><span class="linenos"> 278</span></a>        <span class="c1"># should be relatively small, otherwise we might miss the optimal solution.</span>
</span><span id="GAMCoach-279"><a href="#GAMCoach-279"><span class="linenos"> 279</span></a>
</span><span id="GAMCoach-280"><a href="#GAMCoach-280"><span class="linenos"> 280</span></a>        <span class="c1"># Step 2.1: Find all good options from continuous and categorical features</span>
</span><span id="GAMCoach-281"><a href="#GAMCoach-281"><span class="linenos"> 281</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach-282"><a href="#GAMCoach-282"><span class="linenos"> 282</span></a>
</span><span id="GAMCoach-283"><a href="#GAMCoach-283"><span class="linenos"> 283</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach-284"><a href="#GAMCoach-284"><span class="linenos"> 284</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach-285"><a href="#GAMCoach-285"><span class="linenos"> 285</span></a>            <span class="n">cur_feature_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach-286"><a href="#GAMCoach-286"><span class="linenos"> 286</span></a>
</span><span id="GAMCoach-287"><a href="#GAMCoach-287"><span class="linenos"> 287</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-288"><a href="#GAMCoach-288"><span class="linenos"> 288</span></a>                <span class="k">continue</span>
</span><span id="GAMCoach-289"><a href="#GAMCoach-289"><span class="linenos"> 289</span></a>
</span><span id="GAMCoach-290"><a href="#GAMCoach-290"><span class="linenos"> 290</span></a>            <span class="k">elif</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-291"><a href="#GAMCoach-291"><span class="linenos"> 291</span></a>                <span class="c1"># The parameter epsilon controls the threshold of how we determine</span>
</span><span id="GAMCoach-292"><a href="#GAMCoach-292"><span class="linenos"> 292</span></a>                <span class="c1"># &quot;similar&quot; options for continuous variables</span>
</span><span id="GAMCoach-293"><a href="#GAMCoach-293"><span class="linenos"> 293</span></a>                <span class="n">epsilon</span> <span class="o">=</span> <span class="n">sim_threshold</span>
</span><span id="GAMCoach-294"><a href="#GAMCoach-294"><span class="linenos"> 294</span></a>
</span><span id="GAMCoach-295"><a href="#GAMCoach-295"><span class="linenos"> 295</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach-296"><a href="#GAMCoach-296"><span class="linenos"> 296</span></a>                <span class="n">cur_feature_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cur_feature_id</span><span class="p">])</span>
</span><span id="GAMCoach-297"><a href="#GAMCoach-297"><span class="linenos"> 297</span></a>
</span><span id="GAMCoach-298"><a href="#GAMCoach-298"><span class="linenos"> 298</span></a>                <span class="c1"># Users can require the continuous feature to have integer values</span>
</span><span id="GAMCoach-299"><a href="#GAMCoach-299"><span class="linenos"> 299</span></a>                <span class="c1"># For example, age, FICO score, and number of accounts</span>
</span><span id="GAMCoach-300"><a href="#GAMCoach-300"><span class="linenos"> 300</span></a>                <span class="n">need_to_be_int</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GAMCoach-301"><a href="#GAMCoach-301"><span class="linenos"> 301</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="GAMCoach-302"><a href="#GAMCoach-302"><span class="linenos"> 302</span></a>                    <span class="n">continuous_integer_features</span>
</span><span id="GAMCoach-303"><a href="#GAMCoach-303"><span class="linenos"> 303</span></a>                    <span class="ow">and</span> <span class="n">cur_feature_name</span> <span class="ow">in</span> <span class="n">continuous_integer_features</span>
</span><span id="GAMCoach-304"><a href="#GAMCoach-304"><span class="linenos"> 304</span></a>                <span class="p">):</span>
</span><span id="GAMCoach-305"><a href="#GAMCoach-305"><span class="linenos"> 305</span></a>                    <span class="n">need_to_be_int</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="GAMCoach-306"><a href="#GAMCoach-306"><span class="linenos"> 306</span></a>
</span><span id="GAMCoach-307"><a href="#GAMCoach-307"><span class="linenos"> 307</span></a>                <span class="n">cur_cont_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cont_options</span><span class="p">(</span>
</span><span id="GAMCoach-308"><a href="#GAMCoach-308"><span class="linenos"> 308</span></a>                    <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach-309"><a href="#GAMCoach-309"><span class="linenos"> 309</span></a>                    <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="GAMCoach-310"><a href="#GAMCoach-310"><span class="linenos"> 310</span></a>                    <span class="n">cur_feature_name</span><span class="p">,</span>
</span><span id="GAMCoach-311"><a href="#GAMCoach-311"><span class="linenos"> 311</span></a>                    <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="GAMCoach-312"><a href="#GAMCoach-312"><span class="linenos"> 312</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach-313"><a href="#GAMCoach-313"><span class="linenos"> 313</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">,</span>
</span><span id="GAMCoach-314"><a href="#GAMCoach-314"><span class="linenos"> 314</span></a>                    <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="GAMCoach-315"><a href="#GAMCoach-315"><span class="linenos"> 315</span></a>                    <span class="n">score_gain_bound</span><span class="p">,</span>
</span><span id="GAMCoach-316"><a href="#GAMCoach-316"><span class="linenos"> 316</span></a>                    <span class="n">epsilon</span><span class="p">,</span>
</span><span id="GAMCoach-317"><a href="#GAMCoach-317"><span class="linenos"> 317</span></a>                    <span class="n">need_to_be_int</span><span class="p">,</span>
</span><span id="GAMCoach-318"><a href="#GAMCoach-318"><span class="linenos"> 318</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-319"><a href="#GAMCoach-319"><span class="linenos"> 319</span></a>
</span><span id="GAMCoach-320"><a href="#GAMCoach-320"><span class="linenos"> 320</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_cont_options</span>
</span><span id="GAMCoach-321"><a href="#GAMCoach-321"><span class="linenos"> 321</span></a>
</span><span id="GAMCoach-322"><a href="#GAMCoach-322"><span class="linenos"> 322</span></a>            <span class="k">elif</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-323"><a href="#GAMCoach-323"><span class="linenos"> 323</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach-324"><a href="#GAMCoach-324"><span class="linenos"> 324</span></a>                <span class="n">cur_feature_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cur_feature_id</span><span class="p">])</span>
</span><span id="GAMCoach-325"><a href="#GAMCoach-325"><span class="linenos"> 325</span></a>                <span class="n">cur_cat_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach-326"><a href="#GAMCoach-326"><span class="linenos"> 326</span></a>
</span><span id="GAMCoach-327"><a href="#GAMCoach-327"><span class="linenos"> 327</span></a>                <span class="n">cur_cat_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cat_options</span><span class="p">(</span>
</span><span id="GAMCoach-328"><a href="#GAMCoach-328"><span class="linenos"> 328</span></a>                    <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach-329"><a href="#GAMCoach-329"><span class="linenos"> 329</span></a>                    <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="GAMCoach-330"><a href="#GAMCoach-330"><span class="linenos"> 330</span></a>                    <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="GAMCoach-331"><a href="#GAMCoach-331"><span class="linenos"> 331</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach-332"><a href="#GAMCoach-332"><span class="linenos"> 332</span></a>                    <span class="n">cur_cat_distance</span><span class="p">,</span>
</span><span id="GAMCoach-333"><a href="#GAMCoach-333"><span class="linenos"> 333</span></a>                    <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="GAMCoach-334"><a href="#GAMCoach-334"><span class="linenos"> 334</span></a>                    <span class="n">score_gain_bound</span><span class="p">,</span>
</span><span id="GAMCoach-335"><a href="#GAMCoach-335"><span class="linenos"> 335</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-336"><a href="#GAMCoach-336"><span class="linenos"> 336</span></a>
</span><span id="GAMCoach-337"><a href="#GAMCoach-337"><span class="linenos"> 337</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_cat_options</span>
</span><span id="GAMCoach-338"><a href="#GAMCoach-338"><span class="linenos"> 338</span></a>
</span><span id="GAMCoach-339"><a href="#GAMCoach-339"><span class="linenos"> 339</span></a>        <span class="c1"># Step 2.2: Filter out undesired options (based on the feature_range)</span>
</span><span id="GAMCoach-340"><a href="#GAMCoach-340"><span class="linenos"> 340</span></a>        <span class="k">if</span> <span class="n">feature_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach-341"><a href="#GAMCoach-341"><span class="linenos"> 341</span></a>            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">feature_ranges</span><span class="p">:</span>
</span><span id="GAMCoach-342"><a href="#GAMCoach-342"><span class="linenos"> 342</span></a>                <span class="n">cur_range</span> <span class="o">=</span> <span class="n">feature_ranges</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span>
</span><span id="GAMCoach-343"><a href="#GAMCoach-343"><span class="linenos"> 343</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="GAMCoach-344"><a href="#GAMCoach-344"><span class="linenos"> 344</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="GAMCoach-345"><a href="#GAMCoach-345"><span class="linenos"> 345</span></a>
</span><span id="GAMCoach-346"><a href="#GAMCoach-346"><span class="linenos"> 346</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-347"><a href="#GAMCoach-347"><span class="linenos"> 347</span></a>                    <span class="c1"># Delete options that use out-of-range options</span>
</span><span id="GAMCoach-348"><a href="#GAMCoach-348"><span class="linenos"> 348</span></a>                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="GAMCoach-349"><a href="#GAMCoach-349"><span class="linenos"> 349</span></a>                        <span class="n">cur_target</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach-350"><a href="#GAMCoach-350"><span class="linenos"> 350</span></a>                        <span class="k">if</span> <span class="n">cur_target</span> <span class="o">&lt;</span> <span class="n">cur_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cur_target</span> <span class="o">&gt;</span> <span class="n">cur_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="GAMCoach-351"><a href="#GAMCoach-351"><span class="linenos"> 351</span></a>                            <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="GAMCoach-352"><a href="#GAMCoach-352"><span class="linenos"> 352</span></a>                <span class="k">elif</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-353"><a href="#GAMCoach-353"><span class="linenos"> 353</span></a>                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="GAMCoach-354"><a href="#GAMCoach-354"><span class="linenos"> 354</span></a>                        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cur_range</span><span class="p">:</span>
</span><span id="GAMCoach-355"><a href="#GAMCoach-355"><span class="linenos"> 355</span></a>                            <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="GAMCoach-356"><a href="#GAMCoach-356"><span class="linenos"> 356</span></a>
</span><span id="GAMCoach-357"><a href="#GAMCoach-357"><span class="linenos"> 357</span></a>        <span class="c1"># Step 2.3: Compute the interaction offsets for all possible options</span>
</span><span id="GAMCoach-358"><a href="#GAMCoach-358"><span class="linenos"> 358</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach-359"><a href="#GAMCoach-359"><span class="linenos"> 359</span></a>
</span><span id="GAMCoach-360"><a href="#GAMCoach-360"><span class="linenos"> 360</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach-361"><a href="#GAMCoach-361"><span class="linenos"> 361</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach-362"><a href="#GAMCoach-362"><span class="linenos"> 362</span></a>
</span><span id="GAMCoach-363"><a href="#GAMCoach-363"><span class="linenos"> 363</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-364"><a href="#GAMCoach-364"><span class="linenos"> 364</span></a>
</span><span id="GAMCoach-365"><a href="#GAMCoach-365"><span class="linenos"> 365</span></a>                <span class="n">cur_feature_index_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach-366"><a href="#GAMCoach-366"><span class="linenos"> 366</span></a>                <span class="n">cur_feature_index_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-367"><a href="#GAMCoach-367"><span class="linenos"> 367</span></a>
</span><span id="GAMCoach-368"><a href="#GAMCoach-368"><span class="linenos"> 368</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach-369"><a href="#GAMCoach-369"><span class="linenos"> 369</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_inter_options</span><span class="p">(</span>
</span><span id="GAMCoach-370"><a href="#GAMCoach-370"><span class="linenos"> 370</span></a>                    <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="GAMCoach-371"><a href="#GAMCoach-371"><span class="linenos"> 371</span></a>                    <span class="n">cur_feature_index_1</span><span class="p">,</span>
</span><span id="GAMCoach-372"><a href="#GAMCoach-372"><span class="linenos"> 372</span></a>                    <span class="n">cur_feature_index_2</span><span class="p">,</span>
</span><span id="GAMCoach-373"><a href="#GAMCoach-373"><span class="linenos"> 373</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach-374"><a href="#GAMCoach-374"><span class="linenos"> 374</span></a>                    <span class="n">options</span><span class="p">,</span>
</span><span id="GAMCoach-375"><a href="#GAMCoach-375"><span class="linenos"> 375</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-376"><a href="#GAMCoach-376"><span class="linenos"> 376</span></a>
</span><span id="GAMCoach-377"><a href="#GAMCoach-377"><span class="linenos"> 377</span></a>        <span class="c1"># Step 2.4: Rescale categorical distances so that they have the same mean</span>
</span><span id="GAMCoach-378"><a href="#GAMCoach-378"><span class="linenos"> 378</span></a>        <span class="c1"># as continuous variables (default)</span>
</span><span id="GAMCoach-379"><a href="#GAMCoach-379"><span class="linenos"> 379</span></a>        <span class="k">if</span> <span class="n">categorical_weight</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-380"><a href="#GAMCoach-380"><span class="linenos"> 380</span></a>            <span class="n">cont_distances</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-381"><a href="#GAMCoach-381"><span class="linenos"> 381</span></a>            <span class="n">cat_distances</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-382"><a href="#GAMCoach-382"><span class="linenos"> 382</span></a>
</span><span id="GAMCoach-383"><a href="#GAMCoach-383"><span class="linenos"> 383</span></a>            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="GAMCoach-384"><a href="#GAMCoach-384"><span class="linenos"> 384</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="GAMCoach-385"><a href="#GAMCoach-385"><span class="linenos"> 385</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="GAMCoach-386"><a href="#GAMCoach-386"><span class="linenos"> 386</span></a>
</span><span id="GAMCoach-387"><a href="#GAMCoach-387"><span class="linenos"> 387</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-388"><a href="#GAMCoach-388"><span class="linenos"> 388</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach-389"><a href="#GAMCoach-389"><span class="linenos"> 389</span></a>                        <span class="n">cont_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="GAMCoach-390"><a href="#GAMCoach-390"><span class="linenos"> 390</span></a>                <span class="k">elif</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-391"><a href="#GAMCoach-391"><span class="linenos"> 391</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach-392"><a href="#GAMCoach-392"><span class="linenos"> 392</span></a>                        <span class="n">cat_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="GAMCoach-393"><a href="#GAMCoach-393"><span class="linenos"> 393</span></a>
</span><span id="GAMCoach-394"><a href="#GAMCoach-394"><span class="linenos"> 394</span></a>            <span class="n">categorical_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cont_distances</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cat_distances</span><span class="p">)</span>
</span><span id="GAMCoach-395"><a href="#GAMCoach-395"><span class="linenos"> 395</span></a>
</span><span id="GAMCoach-396"><a href="#GAMCoach-396"><span class="linenos"> 396</span></a>        <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="GAMCoach-397"><a href="#GAMCoach-397"><span class="linenos"> 397</span></a>            <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="GAMCoach-398"><a href="#GAMCoach-398"><span class="linenos"> 398</span></a>            <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="GAMCoach-399"><a href="#GAMCoach-399"><span class="linenos"> 399</span></a>
</span><span id="GAMCoach-400"><a href="#GAMCoach-400"><span class="linenos"> 400</span></a>            <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-401"><a href="#GAMCoach-401"><span class="linenos"> 401</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach-402"><a href="#GAMCoach-402"><span class="linenos"> 402</span></a>                    <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">categorical_weight</span>
</span><span id="GAMCoach-403"><a href="#GAMCoach-403"><span class="linenos"> 403</span></a>
</span><span id="GAMCoach-404"><a href="#GAMCoach-404"><span class="linenos"> 404</span></a>        <span class="c1"># Step 3. Formulate the MILP model and solve it</span>
</span><span id="GAMCoach-405"><a href="#GAMCoach-405"><span class="linenos"> 405</span></a>
</span><span id="GAMCoach-406"><a href="#GAMCoach-406"><span class="linenos"> 406</span></a>        <span class="c1"># Find diverse solutions by accumulatively muting the optimal solutions</span>
</span><span id="GAMCoach-407"><a href="#GAMCoach-407"><span class="linenos"> 407</span></a>        <span class="n">solutions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-408"><a href="#GAMCoach-408"><span class="linenos"> 408</span></a>        <span class="n">muted_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-409"><a href="#GAMCoach-409"><span class="linenos"> 409</span></a>        <span class="n">is_successful</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="GAMCoach-410"><a href="#GAMCoach-410"><span class="linenos"> 410</span></a>
</span><span id="GAMCoach-411"><a href="#GAMCoach-411"><span class="linenos"> 411</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">total_cfs</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="GAMCoach-412"><a href="#GAMCoach-412"><span class="linenos"> 412</span></a>            <span class="n">model</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_milp</span><span class="p">(</span>
</span><span id="GAMCoach-413"><a href="#GAMCoach-413"><span class="linenos"> 413</span></a>                <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach-414"><a href="#GAMCoach-414"><span class="linenos"> 414</span></a>                <span class="n">needed_score_gain</span><span class="p">,</span>
</span><span id="GAMCoach-415"><a href="#GAMCoach-415"><span class="linenos"> 415</span></a>                <span class="n">features_to_vary</span><span class="p">,</span>
</span><span id="GAMCoach-416"><a href="#GAMCoach-416"><span class="linenos"> 416</span></a>                <span class="n">options</span><span class="p">,</span>
</span><span id="GAMCoach-417"><a href="#GAMCoach-417"><span class="linenos"> 417</span></a>                <span class="n">max_num_features_to_vary</span><span class="p">,</span>
</span><span id="GAMCoach-418"><a href="#GAMCoach-418"><span class="linenos"> 418</span></a>                <span class="n">muted_variables</span><span class="o">=</span><span class="n">muted_variables</span><span class="p">,</span>
</span><span id="GAMCoach-419"><a href="#GAMCoach-419"><span class="linenos"> 419</span></a>            <span class="p">)</span>
</span><span id="GAMCoach-420"><a href="#GAMCoach-420"><span class="linenos"> 420</span></a>
</span><span id="GAMCoach-421"><a href="#GAMCoach-421"><span class="linenos"> 421</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pulp</span><span class="o">.</span><span class="n">apis</span><span class="o">.</span><span class="n">PULP_CBC_CMD</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">warmStart</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="GAMCoach-422"><a href="#GAMCoach-422"><span class="linenos"> 422</span></a>
</span><span id="GAMCoach-423"><a href="#GAMCoach-423"><span class="linenos"> 423</span></a>            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GAMCoach-424"><a href="#GAMCoach-424"><span class="linenos"> 424</span></a>                <span class="n">is_successful</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GAMCoach-425"><a href="#GAMCoach-425"><span class="linenos"> 425</span></a>
</span><span id="GAMCoach-426"><a href="#GAMCoach-426"><span class="linenos"> 426</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="GAMCoach-427"><a href="#GAMCoach-427"><span class="linenos"> 427</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solver runs for </span><span class="si">{:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">solutionTime</span><span class="p">))</span>
</span><span id="GAMCoach-428"><a href="#GAMCoach-428"><span class="linenos"> 428</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;status: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pulp</span><span class="o">.</span><span class="n">LpStatus</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">status</span><span class="p">]))</span>
</span><span id="GAMCoach-429"><a href="#GAMCoach-429"><span class="linenos"> 429</span></a>
</span><span id="GAMCoach-430"><a href="#GAMCoach-430"><span class="linenos"> 430</span></a>            <span class="n">active_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-431"><a href="#GAMCoach-431"><span class="linenos"> 431</span></a>
</span><span id="GAMCoach-432"><a href="#GAMCoach-432"><span class="linenos"> 432</span></a>            <span class="c1"># Print the optimal solution</span>
</span><span id="GAMCoach-433"><a href="#GAMCoach-433"><span class="linenos"> 433</span></a>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
</span><span id="GAMCoach-434"><a href="#GAMCoach-434"><span class="linenos"> 434</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
</span><span id="GAMCoach-435"><a href="#GAMCoach-435"><span class="linenos"> 435</span></a>                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">varValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach-436"><a href="#GAMCoach-436"><span class="linenos"> 436</span></a>                        <span class="n">active_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="GAMCoach-437"><a href="#GAMCoach-437"><span class="linenos"> 437</span></a>
</span><span id="GAMCoach-438"><a href="#GAMCoach-438"><span class="linenos"> 438</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="GAMCoach-439"><a href="#GAMCoach-439"><span class="linenos"> 439</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found solutions:&quot;</span><span class="p">)</span>
</span><span id="GAMCoach-440"><a href="#GAMCoach-440"><span class="linenos"> 440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">print_solution</span><span class="p">(</span><span class="n">cur_example</span><span class="p">,</span> <span class="n">active_variables</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="GAMCoach-441"><a href="#GAMCoach-441"><span class="linenos"> 441</span></a>
</span><span id="GAMCoach-442"><a href="#GAMCoach-442"><span class="linenos"> 442</span></a>            <span class="c1"># Collect the current solution and mute the associated variables</span>
</span><span id="GAMCoach-443"><a href="#GAMCoach-443"><span class="linenos"> 443</span></a>            <span class="n">solutions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">active_variables</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">objective</span><span class="p">)])</span>
</span><span id="GAMCoach-444"><a href="#GAMCoach-444"><span class="linenos"> 444</span></a>
</span><span id="GAMCoach-445"><a href="#GAMCoach-445"><span class="linenos"> 445</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">active_variables</span><span class="p">:</span>
</span><span id="GAMCoach-446"><a href="#GAMCoach-446"><span class="linenos"> 446</span></a>                <span class="k">if</span> <span class="s2">&quot; x &quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="GAMCoach-447"><a href="#GAMCoach-447"><span class="linenos"> 447</span></a>                    <span class="n">muted_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="GAMCoach-448"><a href="#GAMCoach-448"><span class="linenos"> 448</span></a>
</span><span id="GAMCoach-449"><a href="#GAMCoach-449"><span class="linenos"> 449</span></a>        <span class="n">cfs</span> <span class="o">=</span> <span class="n">Counterfactuals</span><span class="p">(</span>
</span><span id="GAMCoach-450"><a href="#GAMCoach-450"><span class="linenos"> 450</span></a>            <span class="n">solutions</span><span class="p">,</span> <span class="n">is_successful</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="p">,</span> <span class="n">cur_example</span><span class="p">,</span> <span class="n">options</span>
</span><span id="GAMCoach-451"><a href="#GAMCoach-451"><span class="linenos"> 451</span></a>        <span class="p">)</span>
</span><span id="GAMCoach-452"><a href="#GAMCoach-452"><span class="linenos"> 452</span></a>
</span><span id="GAMCoach-453"><a href="#GAMCoach-453"><span class="linenos"> 453</span></a>        <span class="k">return</span> <span class="n">cfs</span>
</span><span id="GAMCoach-454"><a href="#GAMCoach-454"><span class="linenos"> 454</span></a>
</span><span id="GAMCoach-455"><a href="#GAMCoach-455"><span class="linenos"> 455</span></a>    <span class="k">def</span> <span class="nf">generate_cont_options</span><span class="p">(</span>
</span><span id="GAMCoach-456"><a href="#GAMCoach-456"><span class="linenos"> 456</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach-457"><a href="#GAMCoach-457"><span class="linenos"> 457</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach-458"><a href="#GAMCoach-458"><span class="linenos"> 458</span></a>        <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="GAMCoach-459"><a href="#GAMCoach-459"><span class="linenos"> 459</span></a>        <span class="n">cur_feature_name</span><span class="p">,</span>
</span><span id="GAMCoach-460"><a href="#GAMCoach-460"><span class="linenos"> 460</span></a>        <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="GAMCoach-461"><a href="#GAMCoach-461"><span class="linenos"> 461</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach-462"><a href="#GAMCoach-462"><span class="linenos"> 462</span></a>        <span class="n">cont_mads</span><span class="p">,</span>
</span><span id="GAMCoach-463"><a href="#GAMCoach-463"><span class="linenos"> 463</span></a>        <span class="n">cur_example</span><span class="p">,</span>
</span><span id="GAMCoach-464"><a href="#GAMCoach-464"><span class="linenos"> 464</span></a>        <span class="n">score_gain_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-465"><a href="#GAMCoach-465"><span class="linenos"> 465</span></a>        <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
</span><span id="GAMCoach-466"><a href="#GAMCoach-466"><span class="linenos"> 466</span></a>        <span class="n">need_to_be_int</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="GAMCoach-467"><a href="#GAMCoach-467"><span class="linenos"> 467</span></a>        <span class="n">skip_unhelpful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="GAMCoach-468"><a href="#GAMCoach-468"><span class="linenos"> 468</span></a>    <span class="p">):</span>
</span><span id="GAMCoach-469"><a href="#GAMCoach-469"><span class="linenos"> 469</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach-470"><a href="#GAMCoach-470"><span class="linenos"> 470</span></a><span class="sd">        Generate all alternative options for this continuous variable. This function</span>
</span><span id="GAMCoach-471"><a href="#GAMCoach-471"><span class="linenos"> 471</span></a><span class="sd">        would filter out all options that are:</span>
</span><span id="GAMCoach-472"><a href="#GAMCoach-472"><span class="linenos"> 472</span></a>
</span><span id="GAMCoach-473"><a href="#GAMCoach-473"><span class="linenos"> 473</span></a><span class="sd">        1. Not helpful for the counterfactual generation.</span>
</span><span id="GAMCoach-474"><a href="#GAMCoach-474"><span class="linenos"> 474</span></a><span class="sd">        2. Give similar score gain but requires larger distance.</span>
</span><span id="GAMCoach-475"><a href="#GAMCoach-475"><span class="linenos"> 475</span></a>
</span><span id="GAMCoach-476"><a href="#GAMCoach-476"><span class="linenos"> 476</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-477"><a href="#GAMCoach-477"><span class="linenos"> 477</span></a><span class="sd">            cf_direction (int): Integer `+1` if 0 =&gt; 1, `-1` if 1 =&gt; 0</span>
</span><span id="GAMCoach-478"><a href="#GAMCoach-478"><span class="linenos"> 478</span></a><span class="sd">                (classification); `+1` if we need to increase the prediction,</span>
</span><span id="GAMCoach-479"><a href="#GAMCoach-479"><span class="linenos"> 479</span></a><span class="sd">                `-1` if decrease (regression).</span>
</span><span id="GAMCoach-480"><a href="#GAMCoach-480"><span class="linenos"> 480</span></a><span class="sd">            cur_feature_index (int): The index of the current continuous feature.</span>
</span><span id="GAMCoach-481"><a href="#GAMCoach-481"><span class="linenos"> 481</span></a><span class="sd">            cur_feature_name (str): Name of the current feature.</span>
</span><span id="GAMCoach-482"><a href="#GAMCoach-482"><span class="linenos"> 482</span></a><span class="sd">            cur_feature_value (float): The current feature value.</span>
</span><span id="GAMCoach-483"><a href="#GAMCoach-483"><span class="linenos"> 483</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="GAMCoach-484"><a href="#GAMCoach-484"><span class="linenos"> 484</span></a><span class="sd">            cont_mads (dict): A map of feature_name =&gt; MAD score.</span>
</span><span id="GAMCoach-485"><a href="#GAMCoach-485"><span class="linenos"> 485</span></a><span class="sd">            cur_example (list): Current sample values</span>
</span><span id="GAMCoach-486"><a href="#GAMCoach-486"><span class="linenos"> 486</span></a><span class="sd">            score_gain_bound (float): Bound of the score gain. We do not collect</span>
</span><span id="GAMCoach-487"><a href="#GAMCoach-487"><span class="linenos"> 487</span></a><span class="sd">                options that give `score_gain` &gt; `score_gain_bound` (when</span>
</span><span id="GAMCoach-488"><a href="#GAMCoach-488"><span class="linenos"> 488</span></a><span class="sd">                `cf_direction=1`), or `score_gain` &lt; `score_gain_bound` (when</span>
</span><span id="GAMCoach-489"><a href="#GAMCoach-489"><span class="linenos"> 489</span></a><span class="sd">                `cf_direction=-1`)</span>
</span><span id="GAMCoach-490"><a href="#GAMCoach-490"><span class="linenos"> 490</span></a><span class="sd">            epsilon (float): The threshold to determine if two options give similar</span>
</span><span id="GAMCoach-491"><a href="#GAMCoach-491"><span class="linenos"> 491</span></a><span class="sd">                score gains. Score gains $s_1$ and $s_2$ are similar if</span>
</span><span id="GAMCoach-492"><a href="#GAMCoach-492"><span class="linenos"> 492</span></a><span class="sd">                $|s_1 - s_2| &lt;$ epsilon. Smaller epsilon significantly increases</span>
</span><span id="GAMCoach-493"><a href="#GAMCoach-493"><span class="linenos"> 493</span></a><span class="sd">                the time to solve the MILP. Large epsilon might filter out the</span>
</span><span id="GAMCoach-494"><a href="#GAMCoach-494"><span class="linenos"> 494</span></a><span class="sd">                optimal CF. Defaults to 0.005.</span>
</span><span id="GAMCoach-495"><a href="#GAMCoach-495"><span class="linenos"> 495</span></a><span class="sd">            need_to_be_int (bool): True if the target values for this continuous</span>
</span><span id="GAMCoach-496"><a href="#GAMCoach-496"><span class="linenos"> 496</span></a><span class="sd">                variable need to have integer values.</span>
</span><span id="GAMCoach-497"><a href="#GAMCoach-497"><span class="linenos"> 497</span></a><span class="sd">            skip_unhelpful (bool): True if to skip options from main</span>
</span><span id="GAMCoach-498"><a href="#GAMCoach-498"><span class="linenos"> 498</span></a><span class="sd">                effects that give opposite score gain. It is rare that there is a</span>
</span><span id="GAMCoach-499"><a href="#GAMCoach-499"><span class="linenos"> 499</span></a><span class="sd">                positive score gain from pair-interaction that outweigh negative</span>
</span><span id="GAMCoach-500"><a href="#GAMCoach-500"><span class="linenos"> 500</span></a><span class="sd">                score gain from two main effects, and adjusting the distance penalty.</span>
</span><span id="GAMCoach-501"><a href="#GAMCoach-501"><span class="linenos"> 501</span></a>
</span><span id="GAMCoach-502"><a href="#GAMCoach-502"><span class="linenos"> 502</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach-503"><a href="#GAMCoach-503"><span class="linenos"> 503</span></a><span class="sd">            list: List of option tuples (target, score gain, distance, bin_index)</span>
</span><span id="GAMCoach-504"><a href="#GAMCoach-504"><span class="linenos"> 504</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-505"><a href="#GAMCoach-505"><span class="linenos"> 505</span></a>
</span><span id="GAMCoach-506"><a href="#GAMCoach-506"><span class="linenos"> 506</span></a>        <span class="c1"># For each continuous feature, each bin is a variable</span>
</span><span id="GAMCoach-507"><a href="#GAMCoach-507"><span class="linenos"> 507</span></a>        <span class="c1"># For each bin, we need to compute (1) score gain, (2) distance</span>
</span><span id="GAMCoach-508"><a href="#GAMCoach-508"><span class="linenos"> 508</span></a>        <span class="c1"># (1) score gain is the difference between new bin and current bin</span>
</span><span id="GAMCoach-509"><a href="#GAMCoach-509"><span class="linenos"> 509</span></a>        <span class="c1"># (2) distance is L1 distance divided by median absolute deviation (MAD)</span>
</span><span id="GAMCoach-510"><a href="#GAMCoach-510"><span class="linenos"> 510</span></a>
</span><span id="GAMCoach-511"><a href="#GAMCoach-511"><span class="linenos"> 511</span></a>        <span class="c1"># Get the additive scores of this feature</span>
</span><span id="GAMCoach-512"><a href="#GAMCoach-512"><span class="linenos"> 512</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_index</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach-513"><a href="#GAMCoach-513"><span class="linenos"> 513</span></a>
</span><span id="GAMCoach-514"><a href="#GAMCoach-514"><span class="linenos"> 514</span></a>        <span class="c1"># Get the bin edges of this feature</span>
</span><span id="GAMCoach-515"><a href="#GAMCoach-515"><span class="linenos"> 515</span></a>        <span class="n">bin_starts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_feature_index</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-516"><a href="#GAMCoach-516"><span class="linenos"> 516</span></a>
</span><span id="GAMCoach-517"><a href="#GAMCoach-517"><span class="linenos"> 517</span></a>        <span class="c1"># Create &quot;options&quot;, each option is a tuple (target, score_gain, distance,</span>
</span><span id="GAMCoach-518"><a href="#GAMCoach-518"><span class="linenos"> 518</span></a>        <span class="c1"># bin_index)</span>
</span><span id="GAMCoach-519"><a href="#GAMCoach-519"><span class="linenos"> 519</span></a>        <span class="n">cont_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-520"><a href="#GAMCoach-520"><span class="linenos"> 520</span></a>
</span><span id="GAMCoach-521"><a href="#GAMCoach-521"><span class="linenos"> 521</span></a>        <span class="c1"># Identify which bin this value falls into</span>
</span><span id="GAMCoach-522"><a href="#GAMCoach-522"><span class="linenos"> 522</span></a>        <span class="n">cur_bin_id</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">,</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach-523"><a href="#GAMCoach-523"><span class="linenos"> 523</span></a>        <span class="k">assert</span> <span class="n">additives</span><span class="p">[</span><span class="n">cur_bin_id</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_score</span>
</span><span id="GAMCoach-524"><a href="#GAMCoach-524"><span class="linenos"> 524</span></a>
</span><span id="GAMCoach-525"><a href="#GAMCoach-525"><span class="linenos"> 525</span></a>        <span class="c1"># Identify interaction terms that we need to consider</span>
</span><span id="GAMCoach-526"><a href="#GAMCoach-526"><span class="linenos"> 526</span></a>        <span class="n">associated_interactions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-527"><a href="#GAMCoach-527"><span class="linenos"> 527</span></a>
</span><span id="GAMCoach-528"><a href="#GAMCoach-528"><span class="linenos"> 528</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach-529"><a href="#GAMCoach-529"><span class="linenos"> 529</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach-530"><a href="#GAMCoach-530"><span class="linenos"> 530</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-531"><a href="#GAMCoach-531"><span class="linenos"> 531</span></a>
</span><span id="GAMCoach-532"><a href="#GAMCoach-532"><span class="linenos"> 532</span></a>                <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach-533"><a href="#GAMCoach-533"><span class="linenos"> 533</span></a>
</span><span id="GAMCoach-534"><a href="#GAMCoach-534"><span class="linenos"> 534</span></a>                <span class="k">if</span> <span class="n">cur_feature_index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
</span><span id="GAMCoach-535"><a href="#GAMCoach-535"><span class="linenos"> 535</span></a>                    <span class="n">feature_position</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_index</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="GAMCoach-536"><a href="#GAMCoach-536"><span class="linenos"> 536</span></a>
</span><span id="GAMCoach-537"><a href="#GAMCoach-537"><span class="linenos"> 537</span></a>                    <span class="n">other_position</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">feature_position</span>
</span><span id="GAMCoach-538"><a href="#GAMCoach-538"><span class="linenos"> 538</span></a>                    <span class="n">other_index</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">other_position</span><span class="p">]</span>
</span><span id="GAMCoach-539"><a href="#GAMCoach-539"><span class="linenos"> 539</span></a>                    <span class="n">other_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="GAMCoach-540"><a href="#GAMCoach-540"><span class="linenos"> 540</span></a>
</span><span id="GAMCoach-541"><a href="#GAMCoach-541"><span class="linenos"> 541</span></a>                    <span class="c1"># Get the current additive scores and bin edges</span>
</span><span id="GAMCoach-542"><a href="#GAMCoach-542"><span class="linenos"> 542</span></a>                    <span class="n">inter_additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach-543"><a href="#GAMCoach-543"><span class="linenos"> 543</span></a>
</span><span id="GAMCoach-544"><a href="#GAMCoach-544"><span class="linenos"> 544</span></a>                    <span class="c1"># Have to skip the max edge if it is continuous</span>
</span><span id="GAMCoach-545"><a href="#GAMCoach-545"><span class="linenos"> 545</span></a>                    <span class="n">bin_starts_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach-546"><a href="#GAMCoach-546"><span class="linenos"> 546</span></a>                        <span class="n">cur_feature_index</span>
</span><span id="GAMCoach-547"><a href="#GAMCoach-547"><span class="linenos"> 547</span></a>                    <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-548"><a href="#GAMCoach-548"><span class="linenos"> 548</span></a>
</span><span id="GAMCoach-549"><a href="#GAMCoach-549"><span class="linenos"> 549</span></a>                    <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach-550"><a href="#GAMCoach-550"><span class="linenos"> 550</span></a>                        <span class="n">other_index</span>
</span><span id="GAMCoach-551"><a href="#GAMCoach-551"><span class="linenos"> 551</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach-552"><a href="#GAMCoach-552"><span class="linenos"> 552</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-553"><a href="#GAMCoach-553"><span class="linenos"> 553</span></a>                        <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-554"><a href="#GAMCoach-554"><span class="linenos"> 554</span></a>
</span><span id="GAMCoach-555"><a href="#GAMCoach-555"><span class="linenos"> 555</span></a>                    <span class="c1"># Get the current interaction term score</span>
</span><span id="GAMCoach-556"><a href="#GAMCoach-556"><span class="linenos"> 556</span></a>                    <span class="n">other_bin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach-557"><a href="#GAMCoach-557"><span class="linenos"> 557</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-558"><a href="#GAMCoach-558"><span class="linenos"> 558</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="GAMCoach-559"><a href="#GAMCoach-559"><span class="linenos"> 559</span></a>                            <span class="n">bin_starts_other</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="GAMCoach-560"><a href="#GAMCoach-560"><span class="linenos"> 560</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach-561"><a href="#GAMCoach-561"><span class="linenos"> 561</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-562"><a href="#GAMCoach-562"><span class="linenos"> 562</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="GAMCoach-563"><a href="#GAMCoach-563"><span class="linenos"> 563</span></a>
</span><span id="GAMCoach-564"><a href="#GAMCoach-564"><span class="linenos"> 564</span></a>                    <span class="n">feature_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="GAMCoach-565"><a href="#GAMCoach-565"><span class="linenos"> 565</span></a>                        <span class="n">bin_starts_feature</span><span class="p">,</span> <span class="n">cur_feature_value</span>
</span><span id="GAMCoach-566"><a href="#GAMCoach-566"><span class="linenos"> 566</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach-567"><a href="#GAMCoach-567"><span class="linenos"> 567</span></a>
</span><span id="GAMCoach-568"><a href="#GAMCoach-568"><span class="linenos"> 568</span></a>                    <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach-569"><a href="#GAMCoach-569"><span class="linenos"> 569</span></a>
</span><span id="GAMCoach-570"><a href="#GAMCoach-570"><span class="linenos"> 570</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach-571"><a href="#GAMCoach-571"><span class="linenos"> 571</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">feature_bin</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="GAMCoach-572"><a href="#GAMCoach-572"><span class="linenos"> 572</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-573"><a href="#GAMCoach-573"><span class="linenos"> 573</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">feature_bin</span><span class="p">]</span>
</span><span id="GAMCoach-574"><a href="#GAMCoach-574"><span class="linenos"> 574</span></a>
</span><span id="GAMCoach-575"><a href="#GAMCoach-575"><span class="linenos"> 575</span></a>                    <span class="c1"># Extract the row or column where we fix the other feature and</span>
</span><span id="GAMCoach-576"><a href="#GAMCoach-576"><span class="linenos"> 576</span></a>                    <span class="c1"># vary the current feature</span>
</span><span id="GAMCoach-577"><a href="#GAMCoach-577"><span class="linenos"> 577</span></a>                    <span class="n">feature_inter_bin_starts</span> <span class="o">=</span> <span class="n">bin_starts_feature</span>
</span><span id="GAMCoach-578"><a href="#GAMCoach-578"><span class="linenos"> 578</span></a>                    <span class="n">feature_inter_additives</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-579"><a href="#GAMCoach-579"><span class="linenos"> 579</span></a>
</span><span id="GAMCoach-580"><a href="#GAMCoach-580"><span class="linenos"> 580</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach-581"><a href="#GAMCoach-581"><span class="linenos"> 581</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">)):</span>
</span><span id="GAMCoach-582"><a href="#GAMCoach-582"><span class="linenos"> 582</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-583"><a href="#GAMCoach-583"><span class="linenos"> 583</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="GAMCoach-584"><a href="#GAMCoach-584"><span class="linenos"> 584</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach-585"><a href="#GAMCoach-585"><span class="linenos"> 585</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-586"><a href="#GAMCoach-586"><span class="linenos"> 586</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span><span id="GAMCoach-587"><a href="#GAMCoach-587"><span class="linenos"> 587</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-588"><a href="#GAMCoach-588"><span class="linenos"> 588</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-589"><a href="#GAMCoach-589"><span class="linenos"> 589</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach-590"><a href="#GAMCoach-590"><span class="linenos"> 590</span></a>
</span><span id="GAMCoach-591"><a href="#GAMCoach-591"><span class="linenos"> 591</span></a>                    <span class="c1"># Register this interaction term</span>
</span><span id="GAMCoach-592"><a href="#GAMCoach-592"><span class="linenos"> 592</span></a>                    <span class="n">associated_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-593"><a href="#GAMCoach-593"><span class="linenos"> 593</span></a>                        <span class="p">{</span>
</span><span id="GAMCoach-594"><a href="#GAMCoach-594"><span class="linenos"> 594</span></a>                            <span class="s2">&quot;inter_index&quot;</span><span class="p">:</span> <span class="n">indexes</span><span class="p">,</span>
</span><span id="GAMCoach-595"><a href="#GAMCoach-595"><span class="linenos"> 595</span></a>                            <span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">:</span> <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="GAMCoach-596"><a href="#GAMCoach-596"><span class="linenos"> 596</span></a>                            <span class="s2">&quot;feature_inter_score&quot;</span><span class="p">:</span> <span class="n">feature_inter_score</span><span class="p">,</span>
</span><span id="GAMCoach-597"><a href="#GAMCoach-597"><span class="linenos"> 597</span></a>                            <span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">:</span> <span class="n">feature_inter_bin_starts</span><span class="p">,</span>
</span><span id="GAMCoach-598"><a href="#GAMCoach-598"><span class="linenos"> 598</span></a>                            <span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">:</span> <span class="n">feature_inter_additives</span><span class="p">,</span>
</span><span id="GAMCoach-599"><a href="#GAMCoach-599"><span class="linenos"> 599</span></a>                        <span class="p">}</span>
</span><span id="GAMCoach-600"><a href="#GAMCoach-600"><span class="linenos"> 600</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach-601"><a href="#GAMCoach-601"><span class="linenos"> 601</span></a>
</span><span id="GAMCoach-602"><a href="#GAMCoach-602"><span class="linenos"> 602</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)):</span>
</span><span id="GAMCoach-603"><a href="#GAMCoach-603"><span class="linenos"> 603</span></a>            <span class="c1"># Because of the special binning structure of EBM, the distance of</span>
</span><span id="GAMCoach-604"><a href="#GAMCoach-604"><span class="linenos"> 604</span></a>            <span class="c1"># bins on the left to the current value is different from the bins</span>
</span><span id="GAMCoach-605"><a href="#GAMCoach-605"><span class="linenos"> 605</span></a>            <span class="c1"># that are on the right</span>
</span><span id="GAMCoach-606"><a href="#GAMCoach-606"><span class="linenos"> 606</span></a>            <span class="c1">#</span>
</span><span id="GAMCoach-607"><a href="#GAMCoach-607"><span class="linenos"> 607</span></a>            <span class="c1"># For bins on the left, the raw distance is abs(bin_start[i + 1] - x)</span>
</span><span id="GAMCoach-608"><a href="#GAMCoach-608"><span class="linenos"> 608</span></a>            <span class="c1"># For bins on the right, the raw distance is abs(bin_start[i] - x)</span>
</span><span id="GAMCoach-609"><a href="#GAMCoach-609"><span class="linenos"> 609</span></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">cur_feature_value</span>
</span><span id="GAMCoach-610"><a href="#GAMCoach-610"><span class="linenos"> 610</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach-611"><a href="#GAMCoach-611"><span class="linenos"> 611</span></a>
</span><span id="GAMCoach-612"><a href="#GAMCoach-612"><span class="linenos"> 612</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cur_bin_id</span><span class="p">:</span>
</span><span id="GAMCoach-613"><a href="#GAMCoach-613"><span class="linenos"> 613</span></a>                <span class="c1"># First need to consider if it is need to be an integer</span>
</span><span id="GAMCoach-614"><a href="#GAMCoach-614"><span class="linenos"> 614</span></a>                <span class="c1"># If so, it would be the closest integer to the right point</span>
</span><span id="GAMCoach-615"><a href="#GAMCoach-615"><span class="linenos"> 615</span></a>                <span class="k">if</span> <span class="n">need_to_be_int</span><span class="p">:</span>
</span><span id="GAMCoach-616"><a href="#GAMCoach-616"><span class="linenos"> 616</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="GAMCoach-617"><a href="#GAMCoach-617"><span class="linenos"> 617</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="GAMCoach-618"><a href="#GAMCoach-618"><span class="linenos"> 618</span></a>                        <span class="n">target</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="GAMCoach-619"><a href="#GAMCoach-619"><span class="linenos"> 619</span></a>
</span><span id="GAMCoach-620"><a href="#GAMCoach-620"><span class="linenos"> 620</span></a>                    <span class="c1"># Skip this option if it is not possible to find an int value</span>
</span><span id="GAMCoach-621"><a href="#GAMCoach-621"><span class="linenos"> 621</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="GAMCoach-622"><a href="#GAMCoach-622"><span class="linenos"> 622</span></a>                        <span class="k">continue</span>
</span><span id="GAMCoach-623"><a href="#GAMCoach-623"><span class="linenos"> 623</span></a>
</span><span id="GAMCoach-624"><a href="#GAMCoach-624"><span class="linenos"> 624</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach-625"><a href="#GAMCoach-625"><span class="linenos"> 625</span></a>
</span><span id="GAMCoach-626"><a href="#GAMCoach-626"><span class="linenos"> 626</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-627"><a href="#GAMCoach-627"><span class="linenos"> 627</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-628"><a href="#GAMCoach-628"><span class="linenos"> 628</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach-629"><a href="#GAMCoach-629"><span class="linenos"> 629</span></a>
</span><span id="GAMCoach-630"><a href="#GAMCoach-630"><span class="linenos"> 630</span></a>                    <span class="c1"># Subtract a very smaller value to make the target</span>
</span><span id="GAMCoach-631"><a href="#GAMCoach-631"><span class="linenos"> 631</span></a>                    <span class="c1"># technically fall into the left bin</span>
</span><span id="GAMCoach-632"><a href="#GAMCoach-632"><span class="linenos"> 632</span></a>                    <span class="n">target</span> <span class="o">-=</span> <span class="mf">1e-4</span>
</span><span id="GAMCoach-633"><a href="#GAMCoach-633"><span class="linenos"> 633</span></a>
</span><span id="GAMCoach-634"><a href="#GAMCoach-634"><span class="linenos"> 634</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">cur_bin_id</span><span class="p">:</span>
</span><span id="GAMCoach-635"><a href="#GAMCoach-635"><span class="linenos"> 635</span></a>                <span class="c1"># First need to consider if it should be an integer value</span>
</span><span id="GAMCoach-636"><a href="#GAMCoach-636"><span class="linenos"> 636</span></a>                <span class="c1"># If so, it would be the closest integer to the left point</span>
</span><span id="GAMCoach-637"><a href="#GAMCoach-637"><span class="linenos"> 637</span></a>                <span class="k">if</span> <span class="n">need_to_be_int</span><span class="p">:</span>
</span><span id="GAMCoach-638"><a href="#GAMCoach-638"><span class="linenos"> 638</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="GAMCoach-639"><a href="#GAMCoach-639"><span class="linenos"> 639</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="GAMCoach-640"><a href="#GAMCoach-640"><span class="linenos"> 640</span></a>                        <span class="n">target</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="GAMCoach-641"><a href="#GAMCoach-641"><span class="linenos"> 641</span></a>
</span><span id="GAMCoach-642"><a href="#GAMCoach-642"><span class="linenos"> 642</span></a>                    <span class="c1"># Skip this option if it is not possible to find an int value</span>
</span><span id="GAMCoach-643"><a href="#GAMCoach-643"><span class="linenos"> 643</span></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="GAMCoach-644"><a href="#GAMCoach-644"><span class="linenos"> 644</span></a>                        <span class="k">continue</span>
</span><span id="GAMCoach-645"><a href="#GAMCoach-645"><span class="linenos"> 645</span></a>
</span><span id="GAMCoach-646"><a href="#GAMCoach-646"><span class="linenos"> 646</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach-647"><a href="#GAMCoach-647"><span class="linenos"> 647</span></a>
</span><span id="GAMCoach-648"><a href="#GAMCoach-648"><span class="linenos"> 648</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-649"><a href="#GAMCoach-649"><span class="linenos"> 649</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-650"><a href="#GAMCoach-650"><span class="linenos"> 650</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach-651"><a href="#GAMCoach-651"><span class="linenos"> 651</span></a>
</span><span id="GAMCoach-652"><a href="#GAMCoach-652"><span class="linenos"> 652</span></a>            <span class="c1"># Scale the distance based on the deviation of the feature (how changeable it is)</span>
</span><span id="GAMCoach-653"><a href="#GAMCoach-653"><span class="linenos"> 653</span></a>            <span class="k">if</span> <span class="n">cont_mads</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach-654"><a href="#GAMCoach-654"><span class="linenos"> 654</span></a>                <span class="n">distance</span> <span class="o">/=</span> <span class="n">cont_mads</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach-655"><a href="#GAMCoach-655"><span class="linenos"> 655</span></a>
</span><span id="GAMCoach-656"><a href="#GAMCoach-656"><span class="linenos"> 656</span></a>            <span class="c1"># Compute score gain which has two parts:</span>
</span><span id="GAMCoach-657"><a href="#GAMCoach-657"><span class="linenos"> 657</span></a>            <span class="c1"># (1) gain from the change of main effect</span>
</span><span id="GAMCoach-658"><a href="#GAMCoach-658"><span class="linenos"> 658</span></a>            <span class="c1"># (2) gain from the change of interaction effect</span>
</span><span id="GAMCoach-659"><a href="#GAMCoach-659"><span class="linenos"> 659</span></a>
</span><span id="GAMCoach-660"><a href="#GAMCoach-660"><span class="linenos"> 660</span></a>            <span class="c1"># Main effect</span>
</span><span id="GAMCoach-661"><a href="#GAMCoach-661"><span class="linenos"> 661</span></a>            <span class="n">main_score_gain</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="GAMCoach-662"><a href="#GAMCoach-662"><span class="linenos"> 662</span></a>
</span><span id="GAMCoach-663"><a href="#GAMCoach-663"><span class="linenos"> 663</span></a>            <span class="c1"># Interaction terms</span>
</span><span id="GAMCoach-664"><a href="#GAMCoach-664"><span class="linenos"> 664</span></a>            <span class="c1"># A list to track all interaction score gain offsets</span>
</span><span id="GAMCoach-665"><a href="#GAMCoach-665"><span class="linenos"> 665</span></a>            <span class="c1"># [[interaction id, interaction score gain]]</span>
</span><span id="GAMCoach-666"><a href="#GAMCoach-666"><span class="linenos"> 666</span></a>            <span class="n">inter_score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach-667"><a href="#GAMCoach-667"><span class="linenos"> 667</span></a>            <span class="n">inter_score_gains</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-668"><a href="#GAMCoach-668"><span class="linenos"> 668</span></a>
</span><span id="GAMCoach-669"><a href="#GAMCoach-669"><span class="linenos"> 669</span></a>            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">associated_interactions</span><span class="p">:</span>
</span><span id="GAMCoach-670"><a href="#GAMCoach-670"><span class="linenos"> 670</span></a>                <span class="n">inter_bin_id</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="GAMCoach-671"><a href="#GAMCoach-671"><span class="linenos"> 671</span></a>                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">],</span> <span class="n">target</span>
</span><span id="GAMCoach-672"><a href="#GAMCoach-672"><span class="linenos"> 672</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-673"><a href="#GAMCoach-673"><span class="linenos"> 673</span></a>                <span class="n">inter_score_gain</span> <span class="o">+=</span> <span class="p">(</span>
</span><span id="GAMCoach-674"><a href="#GAMCoach-674"><span class="linenos"> 674</span></a>                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="GAMCoach-675"><a href="#GAMCoach-675"><span class="linenos"> 675</span></a>                    <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">]</span>
</span><span id="GAMCoach-676"><a href="#GAMCoach-676"><span class="linenos"> 676</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-677"><a href="#GAMCoach-677"><span class="linenos"> 677</span></a>                <span class="n">inter_score_gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-678"><a href="#GAMCoach-678"><span class="linenos"> 678</span></a>                    <span class="p">[</span>
</span><span id="GAMCoach-679"><a href="#GAMCoach-679"><span class="linenos"> 679</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">],</span>
</span><span id="GAMCoach-680"><a href="#GAMCoach-680"><span class="linenos"> 680</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="GAMCoach-681"><a href="#GAMCoach-681"><span class="linenos"> 681</span></a>                        <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">],</span>
</span><span id="GAMCoach-682"><a href="#GAMCoach-682"><span class="linenos"> 682</span></a>                    <span class="p">]</span>
</span><span id="GAMCoach-683"><a href="#GAMCoach-683"><span class="linenos"> 683</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-684"><a href="#GAMCoach-684"><span class="linenos"> 684</span></a>
</span><span id="GAMCoach-685"><a href="#GAMCoach-685"><span class="linenos"> 685</span></a>            <span class="n">score_gain</span> <span class="o">=</span> <span class="n">main_score_gain</span> <span class="o">+</span> <span class="n">inter_score_gain</span>
</span><span id="GAMCoach-686"><a href="#GAMCoach-686"><span class="linenos"> 686</span></a>
</span><span id="GAMCoach-687"><a href="#GAMCoach-687"><span class="linenos"> 687</span></a>            <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">*</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="GAMCoach-688"><a href="#GAMCoach-688"><span class="linenos"> 688</span></a>                <span class="k">continue</span>
</span><span id="GAMCoach-689"><a href="#GAMCoach-689"><span class="linenos"> 689</span></a>
</span><span id="GAMCoach-690"><a href="#GAMCoach-690"><span class="linenos"> 690</span></a>            <span class="c1"># Filter out of bound options</span>
</span><span id="GAMCoach-691"><a href="#GAMCoach-691"><span class="linenos"> 691</span></a>            <span class="k">if</span> <span class="n">score_gain_bound</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="GAMCoach-692"><a href="#GAMCoach-692"><span class="linenos"> 692</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&gt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="GAMCoach-693"><a href="#GAMCoach-693"><span class="linenos"> 693</span></a>                    <span class="k">continue</span>
</span><span id="GAMCoach-694"><a href="#GAMCoach-694"><span class="linenos"> 694</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&lt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="GAMCoach-695"><a href="#GAMCoach-695"><span class="linenos"> 695</span></a>                    <span class="k">continue</span>
</span><span id="GAMCoach-696"><a href="#GAMCoach-696"><span class="linenos"> 696</span></a>
</span><span id="GAMCoach-697"><a href="#GAMCoach-697"><span class="linenos"> 697</span></a>            <span class="n">cont_options</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">score_gain</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inter_score_gains</span><span class="p">])</span>
</span><span id="GAMCoach-698"><a href="#GAMCoach-698"><span class="linenos"> 698</span></a>
</span><span id="GAMCoach-699"><a href="#GAMCoach-699"><span class="linenos"> 699</span></a>        <span class="c1"># Now we can apply the second round of filtering to remove redundant options</span>
</span><span id="GAMCoach-700"><a href="#GAMCoach-700"><span class="linenos"> 700</span></a>        <span class="c1"># Redundant options refer to bins that give similar score gain with larger distance</span>
</span><span id="GAMCoach-701"><a href="#GAMCoach-701"><span class="linenos"> 701</span></a>        <span class="n">cont_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cont_options</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="GAMCoach-702"><a href="#GAMCoach-702"><span class="linenos"> 702</span></a>
</span><span id="GAMCoach-703"><a href="#GAMCoach-703"><span class="linenos"> 703</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach-704"><a href="#GAMCoach-704"><span class="linenos"> 704</span></a>        <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont_options</span><span class="p">):</span>
</span><span id="GAMCoach-705"><a href="#GAMCoach-705"><span class="linenos"> 705</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cont_options</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="GAMCoach-706"><a href="#GAMCoach-706"><span class="linenos"> 706</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cont_options</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cont_options</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
</span><span id="GAMCoach-707"><a href="#GAMCoach-707"><span class="linenos"> 707</span></a>                    <span class="n">cont_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="GAMCoach-708"><a href="#GAMCoach-708"><span class="linenos"> 708</span></a>
</span><span id="GAMCoach-709"><a href="#GAMCoach-709"><span class="linenos"> 709</span></a>            <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="GAMCoach-710"><a href="#GAMCoach-710"><span class="linenos"> 710</span></a>
</span><span id="GAMCoach-711"><a href="#GAMCoach-711"><span class="linenos"> 711</span></a>        <span class="k">return</span> <span class="n">cont_options</span>
</span><span id="GAMCoach-712"><a href="#GAMCoach-712"><span class="linenos"> 712</span></a>
</span><span id="GAMCoach-713"><a href="#GAMCoach-713"><span class="linenos"> 713</span></a>    <span class="k">def</span> <span class="nf">generate_cat_options</span><span class="p">(</span>
</span><span id="GAMCoach-714"><a href="#GAMCoach-714"><span class="linenos"> 714</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach-715"><a href="#GAMCoach-715"><span class="linenos"> 715</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach-716"><a href="#GAMCoach-716"><span class="linenos"> 716</span></a>        <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="GAMCoach-717"><a href="#GAMCoach-717"><span class="linenos"> 717</span></a>        <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="GAMCoach-718"><a href="#GAMCoach-718"><span class="linenos"> 718</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach-719"><a href="#GAMCoach-719"><span class="linenos"> 719</span></a>        <span class="n">cur_cat_distance</span><span class="p">,</span>
</span><span id="GAMCoach-720"><a href="#GAMCoach-720"><span class="linenos"> 720</span></a>        <span class="n">cur_example</span><span class="p">,</span>
</span><span id="GAMCoach-721"><a href="#GAMCoach-721"><span class="linenos"> 721</span></a>        <span class="n">score_gain_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-722"><a href="#GAMCoach-722"><span class="linenos"> 722</span></a>        <span class="n">skip_unhelpful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="GAMCoach-723"><a href="#GAMCoach-723"><span class="linenos"> 723</span></a>    <span class="p">):</span>
</span><span id="GAMCoach-724"><a href="#GAMCoach-724"><span class="linenos"> 724</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach-725"><a href="#GAMCoach-725"><span class="linenos"> 725</span></a><span class="sd">        Generate all alternative options for this categorical variable. This function</span>
</span><span id="GAMCoach-726"><a href="#GAMCoach-726"><span class="linenos"> 726</span></a><span class="sd">        would filter out all options that are not helpful for the counterfactual</span>
</span><span id="GAMCoach-727"><a href="#GAMCoach-727"><span class="linenos"> 727</span></a><span class="sd">        generation.</span>
</span><span id="GAMCoach-728"><a href="#GAMCoach-728"><span class="linenos"> 728</span></a>
</span><span id="GAMCoach-729"><a href="#GAMCoach-729"><span class="linenos"> 729</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-730"><a href="#GAMCoach-730"><span class="linenos"> 730</span></a><span class="sd">            cf_direction (int): Integer `+1` if 0 =&gt; 1, `-1` if 1 =&gt; 0</span>
</span><span id="GAMCoach-731"><a href="#GAMCoach-731"><span class="linenos"> 731</span></a><span class="sd">                (classification); `+1` if we need to increase the prediction,</span>
</span><span id="GAMCoach-732"><a href="#GAMCoach-732"><span class="linenos"> 732</span></a><span class="sd">                `-1` if decrease (regression).</span>
</span><span id="GAMCoach-733"><a href="#GAMCoach-733"><span class="linenos"> 733</span></a><span class="sd">            cur_feature_index (int): The index of the current continuous feature.</span>
</span><span id="GAMCoach-734"><a href="#GAMCoach-734"><span class="linenos"> 734</span></a><span class="sd">            cur_feature_value (float): The current feature value.</span>
</span><span id="GAMCoach-735"><a href="#GAMCoach-735"><span class="linenos"> 735</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="GAMCoach-736"><a href="#GAMCoach-736"><span class="linenos"> 736</span></a><span class="sd">            cur_cat_distance (dict): A map of feature_level =&gt; 1 - frequency.</span>
</span><span id="GAMCoach-737"><a href="#GAMCoach-737"><span class="linenos"> 737</span></a><span class="sd">            cur_example (list): Current sample values.</span>
</span><span id="GAMCoach-738"><a href="#GAMCoach-738"><span class="linenos"> 738</span></a><span class="sd">            score_gain_bound (float): Bound of the score gain. We do not collect</span>
</span><span id="GAMCoach-739"><a href="#GAMCoach-739"><span class="linenos"> 739</span></a><span class="sd">                options that give `score_gain` &gt; `score_gain_bound` (when</span>
</span><span id="GAMCoach-740"><a href="#GAMCoach-740"><span class="linenos"> 740</span></a><span class="sd">                `cf_direction=1`), or `score_gain` &lt; `score_gain_bound` (when</span>
</span><span id="GAMCoach-741"><a href="#GAMCoach-741"><span class="linenos"> 741</span></a><span class="sd">                `cf_direction=-1`)</span>
</span><span id="GAMCoach-742"><a href="#GAMCoach-742"><span class="linenos"> 742</span></a><span class="sd">            skip_unhelpful (bool): True if to skip options from main</span>
</span><span id="GAMCoach-743"><a href="#GAMCoach-743"><span class="linenos"> 743</span></a><span class="sd">                effects that give opposite score gain. It is rare that there is a</span>
</span><span id="GAMCoach-744"><a href="#GAMCoach-744"><span class="linenos"> 744</span></a><span class="sd">                positive score gain from pair-interaction that outweigh negative</span>
</span><span id="GAMCoach-745"><a href="#GAMCoach-745"><span class="linenos"> 745</span></a><span class="sd">                score gain from two main effects, and adjusting the distance penalty.</span>
</span><span id="GAMCoach-746"><a href="#GAMCoach-746"><span class="linenos"> 746</span></a>
</span><span id="GAMCoach-747"><a href="#GAMCoach-747"><span class="linenos"> 747</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach-748"><a href="#GAMCoach-748"><span class="linenos"> 748</span></a><span class="sd">            list: List of option tuples (target, score_gain, distance, bin_index).</span>
</span><span id="GAMCoach-749"><a href="#GAMCoach-749"><span class="linenos"> 749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-750"><a href="#GAMCoach-750"><span class="linenos"> 750</span></a>
</span><span id="GAMCoach-751"><a href="#GAMCoach-751"><span class="linenos"> 751</span></a>        <span class="c1"># Find other options for this categorical variable</span>
</span><span id="GAMCoach-752"><a href="#GAMCoach-752"><span class="linenos"> 752</span></a>        <span class="c1"># For each option, we compute the (1) score gain, and (2) distance</span>
</span><span id="GAMCoach-753"><a href="#GAMCoach-753"><span class="linenos"> 753</span></a>        <span class="c1">#</span>
</span><span id="GAMCoach-754"><a href="#GAMCoach-754"><span class="linenos"> 754</span></a>        <span class="c1"># (1) Score gain is the same as continuous variables</span>
</span><span id="GAMCoach-755"><a href="#GAMCoach-755"><span class="linenos"> 755</span></a>        <span class="c1"># (2) The distance is determined by 1 - the level frequency in the</span>
</span><span id="GAMCoach-756"><a href="#GAMCoach-756"><span class="linenos"> 756</span></a>        <span class="c1"># training data. It implies that levels with high frequency are easier</span>
</span><span id="GAMCoach-757"><a href="#GAMCoach-757"><span class="linenos"> 757</span></a>        <span class="c1"># to &quot;move to&quot;</span>
</span><span id="GAMCoach-758"><a href="#GAMCoach-758"><span class="linenos"> 758</span></a>
</span><span id="GAMCoach-759"><a href="#GAMCoach-759"><span class="linenos"> 759</span></a>        <span class="c1"># Get the additive scores of this feature</span>
</span><span id="GAMCoach-760"><a href="#GAMCoach-760"><span class="linenos"> 760</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_index</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach-761"><a href="#GAMCoach-761"><span class="linenos"> 761</span></a>
</span><span id="GAMCoach-762"><a href="#GAMCoach-762"><span class="linenos"> 762</span></a>        <span class="c1"># Get the bin edges of this feature</span>
</span><span id="GAMCoach-763"><a href="#GAMCoach-763"><span class="linenos"> 763</span></a>        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_feature_index</span><span class="p">)</span>
</span><span id="GAMCoach-764"><a href="#GAMCoach-764"><span class="linenos"> 764</span></a>
</span><span id="GAMCoach-765"><a href="#GAMCoach-765"><span class="linenos"> 765</span></a>        <span class="c1"># Create &quot;options&quot;, each option is a tuple (target, score_gain, distance, bin_index)</span>
</span><span id="GAMCoach-766"><a href="#GAMCoach-766"><span class="linenos"> 766</span></a>        <span class="n">cat_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-767"><a href="#GAMCoach-767"><span class="linenos"> 767</span></a>
</span><span id="GAMCoach-768"><a href="#GAMCoach-768"><span class="linenos"> 768</span></a>        <span class="c1"># Identify interaction terms that we need to consider</span>
</span><span id="GAMCoach-769"><a href="#GAMCoach-769"><span class="linenos"> 769</span></a>        <span class="n">associated_interactions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-770"><a href="#GAMCoach-770"><span class="linenos"> 770</span></a>
</span><span id="GAMCoach-771"><a href="#GAMCoach-771"><span class="linenos"> 771</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach-772"><a href="#GAMCoach-772"><span class="linenos"> 772</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach-773"><a href="#GAMCoach-773"><span class="linenos"> 773</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-774"><a href="#GAMCoach-774"><span class="linenos"> 774</span></a>
</span><span id="GAMCoach-775"><a href="#GAMCoach-775"><span class="linenos"> 775</span></a>                <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach-776"><a href="#GAMCoach-776"><span class="linenos"> 776</span></a>
</span><span id="GAMCoach-777"><a href="#GAMCoach-777"><span class="linenos"> 777</span></a>                <span class="k">if</span> <span class="n">cur_feature_index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
</span><span id="GAMCoach-778"><a href="#GAMCoach-778"><span class="linenos"> 778</span></a>                    <span class="n">feature_position</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_index</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="GAMCoach-779"><a href="#GAMCoach-779"><span class="linenos"> 779</span></a>
</span><span id="GAMCoach-780"><a href="#GAMCoach-780"><span class="linenos"> 780</span></a>                    <span class="n">other_position</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">feature_position</span>
</span><span id="GAMCoach-781"><a href="#GAMCoach-781"><span class="linenos"> 781</span></a>                    <span class="n">other_index</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">other_position</span><span class="p">]</span>
</span><span id="GAMCoach-782"><a href="#GAMCoach-782"><span class="linenos"> 782</span></a>                    <span class="n">other_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="GAMCoach-783"><a href="#GAMCoach-783"><span class="linenos"> 783</span></a>                    <span class="n">other_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="GAMCoach-784"><a href="#GAMCoach-784"><span class="linenos"> 784</span></a>
</span><span id="GAMCoach-785"><a href="#GAMCoach-785"><span class="linenos"> 785</span></a>                    <span class="c1"># Get the current additive scores and bin edges</span>
</span><span id="GAMCoach-786"><a href="#GAMCoach-786"><span class="linenos"> 786</span></a>                    <span class="n">inter_additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach-787"><a href="#GAMCoach-787"><span class="linenos"> 787</span></a>
</span><span id="GAMCoach-788"><a href="#GAMCoach-788"><span class="linenos"> 788</span></a>                    <span class="n">bin_starts_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach-789"><a href="#GAMCoach-789"><span class="linenos"> 789</span></a>                        <span class="n">cur_feature_index</span>
</span><span id="GAMCoach-790"><a href="#GAMCoach-790"><span class="linenos"> 790</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach-791"><a href="#GAMCoach-791"><span class="linenos"> 791</span></a>                    <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach-792"><a href="#GAMCoach-792"><span class="linenos"> 792</span></a>                        <span class="n">other_index</span>
</span><span id="GAMCoach-793"><a href="#GAMCoach-793"><span class="linenos"> 793</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach-794"><a href="#GAMCoach-794"><span class="linenos"> 794</span></a>
</span><span id="GAMCoach-795"><a href="#GAMCoach-795"><span class="linenos"> 795</span></a>                    <span class="c1"># Have to skip the max edge if it is continuous</span>
</span><span id="GAMCoach-796"><a href="#GAMCoach-796"><span class="linenos"> 796</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-797"><a href="#GAMCoach-797"><span class="linenos"> 797</span></a>                        <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-798"><a href="#GAMCoach-798"><span class="linenos"> 798</span></a>
</span><span id="GAMCoach-799"><a href="#GAMCoach-799"><span class="linenos"> 799</span></a>                    <span class="c1"># Get the current interaction term score</span>
</span><span id="GAMCoach-800"><a href="#GAMCoach-800"><span class="linenos"> 800</span></a>                    <span class="n">other_bin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach-801"><a href="#GAMCoach-801"><span class="linenos"> 801</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-802"><a href="#GAMCoach-802"><span class="linenos"> 802</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="GAMCoach-803"><a href="#GAMCoach-803"><span class="linenos"> 803</span></a>                            <span class="n">bin_starts_other</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="GAMCoach-804"><a href="#GAMCoach-804"><span class="linenos"> 804</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach-805"><a href="#GAMCoach-805"><span class="linenos"> 805</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-806"><a href="#GAMCoach-806"><span class="linenos"> 806</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="GAMCoach-807"><a href="#GAMCoach-807"><span class="linenos"> 807</span></a>
</span><span id="GAMCoach-808"><a href="#GAMCoach-808"><span class="linenos"> 808</span></a>                    <span class="n">feature_bin</span> <span class="o">=</span> <span class="n">bin_starts_feature</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach-809"><a href="#GAMCoach-809"><span class="linenos"> 809</span></a>
</span><span id="GAMCoach-810"><a href="#GAMCoach-810"><span class="linenos"> 810</span></a>                    <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach-811"><a href="#GAMCoach-811"><span class="linenos"> 811</span></a>
</span><span id="GAMCoach-812"><a href="#GAMCoach-812"><span class="linenos"> 812</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach-813"><a href="#GAMCoach-813"><span class="linenos"> 813</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">feature_bin</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="GAMCoach-814"><a href="#GAMCoach-814"><span class="linenos"> 814</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-815"><a href="#GAMCoach-815"><span class="linenos"> 815</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">feature_bin</span><span class="p">]</span>
</span><span id="GAMCoach-816"><a href="#GAMCoach-816"><span class="linenos"> 816</span></a>
</span><span id="GAMCoach-817"><a href="#GAMCoach-817"><span class="linenos"> 817</span></a>                    <span class="c1"># Extract the row or column where we fix the other features and</span>
</span><span id="GAMCoach-818"><a href="#GAMCoach-818"><span class="linenos"> 818</span></a>                    <span class="c1"># vary the current feature</span>
</span><span id="GAMCoach-819"><a href="#GAMCoach-819"><span class="linenos"> 819</span></a>                    <span class="n">feature_inter_bin_starts</span> <span class="o">=</span> <span class="n">bin_starts_feature</span>
</span><span id="GAMCoach-820"><a href="#GAMCoach-820"><span class="linenos"> 820</span></a>                    <span class="n">feature_inter_additives</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-821"><a href="#GAMCoach-821"><span class="linenos"> 821</span></a>
</span><span id="GAMCoach-822"><a href="#GAMCoach-822"><span class="linenos"> 822</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach-823"><a href="#GAMCoach-823"><span class="linenos"> 823</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">)):</span>
</span><span id="GAMCoach-824"><a href="#GAMCoach-824"><span class="linenos"> 824</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-825"><a href="#GAMCoach-825"><span class="linenos"> 825</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="GAMCoach-826"><a href="#GAMCoach-826"><span class="linenos"> 826</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach-827"><a href="#GAMCoach-827"><span class="linenos"> 827</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-828"><a href="#GAMCoach-828"><span class="linenos"> 828</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span><span id="GAMCoach-829"><a href="#GAMCoach-829"><span class="linenos"> 829</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-830"><a href="#GAMCoach-830"><span class="linenos"> 830</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-831"><a href="#GAMCoach-831"><span class="linenos"> 831</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach-832"><a href="#GAMCoach-832"><span class="linenos"> 832</span></a>
</span><span id="GAMCoach-833"><a href="#GAMCoach-833"><span class="linenos"> 833</span></a>                    <span class="c1"># Register this interaction term</span>
</span><span id="GAMCoach-834"><a href="#GAMCoach-834"><span class="linenos"> 834</span></a>                    <span class="n">associated_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-835"><a href="#GAMCoach-835"><span class="linenos"> 835</span></a>                        <span class="p">{</span>
</span><span id="GAMCoach-836"><a href="#GAMCoach-836"><span class="linenos"> 836</span></a>                            <span class="s2">&quot;inter_index&quot;</span><span class="p">:</span> <span class="n">indexes</span><span class="p">,</span>
</span><span id="GAMCoach-837"><a href="#GAMCoach-837"><span class="linenos"> 837</span></a>                            <span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">:</span> <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="GAMCoach-838"><a href="#GAMCoach-838"><span class="linenos"> 838</span></a>                            <span class="s2">&quot;feature_inter_score&quot;</span><span class="p">:</span> <span class="n">feature_inter_score</span><span class="p">,</span>
</span><span id="GAMCoach-839"><a href="#GAMCoach-839"><span class="linenos"> 839</span></a>                            <span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">:</span> <span class="n">feature_inter_bin_starts</span><span class="p">,</span>
</span><span id="GAMCoach-840"><a href="#GAMCoach-840"><span class="linenos"> 840</span></a>                            <span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">:</span> <span class="n">feature_inter_additives</span><span class="p">,</span>
</span><span id="GAMCoach-841"><a href="#GAMCoach-841"><span class="linenos"> 841</span></a>                        <span class="p">}</span>
</span><span id="GAMCoach-842"><a href="#GAMCoach-842"><span class="linenos"> 842</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach-843"><a href="#GAMCoach-843"><span class="linenos"> 843</span></a>
</span><span id="GAMCoach-844"><a href="#GAMCoach-844"><span class="linenos"> 844</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)):</span>
</span><span id="GAMCoach-845"><a href="#GAMCoach-845"><span class="linenos"> 845</span></a>            <span class="k">if</span> <span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cur_feature_value</span><span class="p">:</span>
</span><span id="GAMCoach-846"><a href="#GAMCoach-846"><span class="linenos"> 846</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach-847"><a href="#GAMCoach-847"><span class="linenos"> 847</span></a>                <span class="n">distance</span> <span class="o">=</span> <span class="n">cur_cat_distance</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
</span><span id="GAMCoach-848"><a href="#GAMCoach-848"><span class="linenos"> 848</span></a>
</span><span id="GAMCoach-849"><a href="#GAMCoach-849"><span class="linenos"> 849</span></a>                <span class="c1"># Compute score gain which has two parts:</span>
</span><span id="GAMCoach-850"><a href="#GAMCoach-850"><span class="linenos"> 850</span></a>                <span class="c1"># (1) gain from the change of main effect</span>
</span><span id="GAMCoach-851"><a href="#GAMCoach-851"><span class="linenos"> 851</span></a>                <span class="c1"># (2) gain from the change of interaction effect</span>
</span><span id="GAMCoach-852"><a href="#GAMCoach-852"><span class="linenos"> 852</span></a>
</span><span id="GAMCoach-853"><a href="#GAMCoach-853"><span class="linenos"> 853</span></a>                <span class="c1"># Main effect</span>
</span><span id="GAMCoach-854"><a href="#GAMCoach-854"><span class="linenos"> 854</span></a>                <span class="n">main_score_gain</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="GAMCoach-855"><a href="#GAMCoach-855"><span class="linenos"> 855</span></a>
</span><span id="GAMCoach-856"><a href="#GAMCoach-856"><span class="linenos"> 856</span></a>                <span class="c1"># Interaction terms</span>
</span><span id="GAMCoach-857"><a href="#GAMCoach-857"><span class="linenos"> 857</span></a>                <span class="c1"># A list to track all interaction score gain offsets</span>
</span><span id="GAMCoach-858"><a href="#GAMCoach-858"><span class="linenos"> 858</span></a>                <span class="c1"># [[interaction id, interaction score gain]]</span>
</span><span id="GAMCoach-859"><a href="#GAMCoach-859"><span class="linenos"> 859</span></a>                <span class="n">inter_score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach-860"><a href="#GAMCoach-860"><span class="linenos"> 860</span></a>                <span class="n">inter_score_gains</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-861"><a href="#GAMCoach-861"><span class="linenos"> 861</span></a>
</span><span id="GAMCoach-862"><a href="#GAMCoach-862"><span class="linenos"> 862</span></a>                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">associated_interactions</span><span class="p">:</span>
</span><span id="GAMCoach-863"><a href="#GAMCoach-863"><span class="linenos"> 863</span></a>                    <span class="n">inter_bin_id</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="GAMCoach-864"><a href="#GAMCoach-864"><span class="linenos"> 864</span></a>                    <span class="n">inter_score_gain</span> <span class="o">+=</span> <span class="p">(</span>
</span><span id="GAMCoach-865"><a href="#GAMCoach-865"><span class="linenos"> 865</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="GAMCoach-866"><a href="#GAMCoach-866"><span class="linenos"> 866</span></a>                        <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">]</span>
</span><span id="GAMCoach-867"><a href="#GAMCoach-867"><span class="linenos"> 867</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach-868"><a href="#GAMCoach-868"><span class="linenos"> 868</span></a>                    <span class="n">inter_score_gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-869"><a href="#GAMCoach-869"><span class="linenos"> 869</span></a>                        <span class="p">[</span>
</span><span id="GAMCoach-870"><a href="#GAMCoach-870"><span class="linenos"> 870</span></a>                            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">],</span>
</span><span id="GAMCoach-871"><a href="#GAMCoach-871"><span class="linenos"> 871</span></a>                            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="GAMCoach-872"><a href="#GAMCoach-872"><span class="linenos"> 872</span></a>                            <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">],</span>
</span><span id="GAMCoach-873"><a href="#GAMCoach-873"><span class="linenos"> 873</span></a>                        <span class="p">]</span>
</span><span id="GAMCoach-874"><a href="#GAMCoach-874"><span class="linenos"> 874</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach-875"><a href="#GAMCoach-875"><span class="linenos"> 875</span></a>
</span><span id="GAMCoach-876"><a href="#GAMCoach-876"><span class="linenos"> 876</span></a>                <span class="n">score_gain</span> <span class="o">=</span> <span class="n">main_score_gain</span> <span class="o">+</span> <span class="n">inter_score_gain</span>
</span><span id="GAMCoach-877"><a href="#GAMCoach-877"><span class="linenos"> 877</span></a>
</span><span id="GAMCoach-878"><a href="#GAMCoach-878"><span class="linenos"> 878</span></a>                <span class="c1"># Skip unhelpful options</span>
</span><span id="GAMCoach-879"><a href="#GAMCoach-879"><span class="linenos"> 879</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">*</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="GAMCoach-880"><a href="#GAMCoach-880"><span class="linenos"> 880</span></a>                    <span class="k">continue</span>
</span><span id="GAMCoach-881"><a href="#GAMCoach-881"><span class="linenos"> 881</span></a>
</span><span id="GAMCoach-882"><a href="#GAMCoach-882"><span class="linenos"> 882</span></a>                <span class="c1"># Filter out of bound options</span>
</span><span id="GAMCoach-883"><a href="#GAMCoach-883"><span class="linenos"> 883</span></a>                <span class="k">if</span> <span class="n">score_gain_bound</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="GAMCoach-884"><a href="#GAMCoach-884"><span class="linenos"> 884</span></a>                    <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&gt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="GAMCoach-885"><a href="#GAMCoach-885"><span class="linenos"> 885</span></a>                        <span class="k">continue</span>
</span><span id="GAMCoach-886"><a href="#GAMCoach-886"><span class="linenos"> 886</span></a>                    <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&lt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="GAMCoach-887"><a href="#GAMCoach-887"><span class="linenos"> 887</span></a>                        <span class="k">continue</span>
</span><span id="GAMCoach-888"><a href="#GAMCoach-888"><span class="linenos"> 888</span></a>
</span><span id="GAMCoach-889"><a href="#GAMCoach-889"><span class="linenos"> 889</span></a>                <span class="n">cat_options</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">score_gain</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inter_score_gains</span><span class="p">])</span>
</span><span id="GAMCoach-890"><a href="#GAMCoach-890"><span class="linenos"> 890</span></a>
</span><span id="GAMCoach-891"><a href="#GAMCoach-891"><span class="linenos"> 891</span></a>        <span class="k">return</span> <span class="n">cat_options</span>
</span><span id="GAMCoach-892"><a href="#GAMCoach-892"><span class="linenos"> 892</span></a>
</span><span id="GAMCoach-893"><a href="#GAMCoach-893"><span class="linenos"> 893</span></a>    <span class="k">def</span> <span class="nf">generate_inter_options</span><span class="p">(</span>
</span><span id="GAMCoach-894"><a href="#GAMCoach-894"><span class="linenos"> 894</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach-895"><a href="#GAMCoach-895"><span class="linenos"> 895</span></a>        <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="GAMCoach-896"><a href="#GAMCoach-896"><span class="linenos"> 896</span></a>        <span class="n">cur_feature_index_1</span><span class="p">,</span>
</span><span id="GAMCoach-897"><a href="#GAMCoach-897"><span class="linenos"> 897</span></a>        <span class="n">cur_feature_index_2</span><span class="p">,</span>
</span><span id="GAMCoach-898"><a href="#GAMCoach-898"><span class="linenos"> 898</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach-899"><a href="#GAMCoach-899"><span class="linenos"> 899</span></a>        <span class="n">options</span><span class="p">,</span>
</span><span id="GAMCoach-900"><a href="#GAMCoach-900"><span class="linenos"> 900</span></a>    <span class="p">):</span>
</span><span id="GAMCoach-901"><a href="#GAMCoach-901"><span class="linenos"> 901</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach-902"><a href="#GAMCoach-902"><span class="linenos"> 902</span></a><span class="sd">        Generate all possible options for this interaction variable.</span>
</span><span id="GAMCoach-903"><a href="#GAMCoach-903"><span class="linenos"> 903</span></a>
</span><span id="GAMCoach-904"><a href="#GAMCoach-904"><span class="linenos"> 904</span></a><span class="sd">        Interaction terms are interesting in this MILP. Each option counts as a</span>
</span><span id="GAMCoach-905"><a href="#GAMCoach-905"><span class="linenos"> 905</span></a><span class="sd">        variable, but each variable only affects the score gain, not the distance.</span>
</span><span id="GAMCoach-906"><a href="#GAMCoach-906"><span class="linenos"> 906</span></a>
</span><span id="GAMCoach-907"><a href="#GAMCoach-907"><span class="linenos"> 907</span></a><span class="sd">        Note that in EBM, the bin definitions for interaction terms can be different</span>
</span><span id="GAMCoach-908"><a href="#GAMCoach-908"><span class="linenos"> 908</span></a><span class="sd">        from their definitions for individual continuous variables.</span>
</span><span id="GAMCoach-909"><a href="#GAMCoach-909"><span class="linenos"> 909</span></a>
</span><span id="GAMCoach-910"><a href="#GAMCoach-910"><span class="linenos"> 910</span></a><span class="sd">        To model interaction terms, we can think it as a binary variable. The</span>
</span><span id="GAMCoach-911"><a href="#GAMCoach-911"><span class="linenos"> 911</span></a><span class="sd">        value is determined by the multiplication of two main effect variables.</span>
</span><span id="GAMCoach-912"><a href="#GAMCoach-912"><span class="linenos"> 912</span></a><span class="sd">        Each interaction variable describes a combination of two main effect</span>
</span><span id="GAMCoach-913"><a href="#GAMCoach-913"><span class="linenos"> 913</span></a><span class="sd">        variables. Therefore, say continuous variable A has $x$ probable options,</span>
</span><span id="GAMCoach-914"><a href="#GAMCoach-914"><span class="linenos"> 914</span></a><span class="sd">        and another continuous variable B has $y$ probable options, then we should</span>
</span><span id="GAMCoach-915"><a href="#GAMCoach-915"><span class="linenos"> 915</span></a><span class="sd">        add $x \\times y$ binary variables to offset their probable interaction</span>
</span><span id="GAMCoach-916"><a href="#GAMCoach-916"><span class="linenos"> 916</span></a><span class="sd">        effects.</span>
</span><span id="GAMCoach-917"><a href="#GAMCoach-917"><span class="linenos"> 917</span></a>
</span><span id="GAMCoach-918"><a href="#GAMCoach-918"><span class="linenos"> 918</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-919"><a href="#GAMCoach-919"><span class="linenos"> 919</span></a><span class="sd">            cur_feature_id (int): The id of this interaction effect.</span>
</span><span id="GAMCoach-920"><a href="#GAMCoach-920"><span class="linenos"> 920</span></a><span class="sd">            cur_feature_index_1 (int): The index of the first main effect.</span>
</span><span id="GAMCoach-921"><a href="#GAMCoach-921"><span class="linenos"> 921</span></a><span class="sd">            cur_feature_index_2 (int): The index of the second main effect.</span>
</span><span id="GAMCoach-922"><a href="#GAMCoach-922"><span class="linenos"> 922</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="GAMCoach-923"><a href="#GAMCoach-923"><span class="linenos"> 923</span></a><span class="sd">            options (dict): The current option list, feature_name -&gt;</span>
</span><span id="GAMCoach-924"><a href="#GAMCoach-924"><span class="linenos"> 924</span></a><span class="sd">                [`target`, `score_gain`, `distance`, `bin_id`].</span>
</span><span id="GAMCoach-925"><a href="#GAMCoach-925"><span class="linenos"> 925</span></a>
</span><span id="GAMCoach-926"><a href="#GAMCoach-926"><span class="linenos"> 926</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach-927"><a href="#GAMCoach-927"><span class="linenos"> 927</span></a><span class="sd">            List of option tuples (target, score_gain, distance, bin_index)</span>
</span><span id="GAMCoach-928"><a href="#GAMCoach-928"><span class="linenos"> 928</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-929"><a href="#GAMCoach-929"><span class="linenos"> 929</span></a>
</span><span id="GAMCoach-930"><a href="#GAMCoach-930"><span class="linenos"> 930</span></a>        <span class="c1"># Get the sub-types for this interaction term</span>
</span><span id="GAMCoach-931"><a href="#GAMCoach-931"><span class="linenos"> 931</span></a>        <span class="n">cur_feature_type_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_index_1</span><span class="p">]</span>
</span><span id="GAMCoach-932"><a href="#GAMCoach-932"><span class="linenos"> 932</span></a>        <span class="n">cur_feature_type_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_index_2</span><span class="p">]</span>
</span><span id="GAMCoach-933"><a href="#GAMCoach-933"><span class="linenos"> 933</span></a>
</span><span id="GAMCoach-934"><a href="#GAMCoach-934"><span class="linenos"> 934</span></a>        <span class="c1"># Get the sub-names for this interaction term</span>
</span><span id="GAMCoach-935"><a href="#GAMCoach-935"><span class="linenos"> 935</span></a>        <span class="n">cur_feature_name_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_index_1</span><span class="p">]</span>
</span><span id="GAMCoach-936"><a href="#GAMCoach-936"><span class="linenos"> 936</span></a>        <span class="n">cur_feature_name_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_index_2</span><span class="p">]</span>
</span><span id="GAMCoach-937"><a href="#GAMCoach-937"><span class="linenos"> 937</span></a>
</span><span id="GAMCoach-938"><a href="#GAMCoach-938"><span class="linenos"> 938</span></a>        <span class="c1"># The first column and row are reserved for missing values (even with</span>
</span><span id="GAMCoach-939"><a href="#GAMCoach-939"><span class="linenos"> 939</span></a>        <span class="c1"># categorical features)</span>
</span><span id="GAMCoach-940"><a href="#GAMCoach-940"><span class="linenos"> 940</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach-941"><a href="#GAMCoach-941"><span class="linenos"> 941</span></a>
</span><span id="GAMCoach-942"><a href="#GAMCoach-942"><span class="linenos"> 942</span></a>        <span class="c1"># Four possibilities here: cont x cont, cont x cat, cat x cont, cat x cat.</span>
</span><span id="GAMCoach-943"><a href="#GAMCoach-943"><span class="linenos"> 943</span></a>        <span class="c1"># Each has a different way to lookup the bin table.</span>
</span><span id="GAMCoach-944"><a href="#GAMCoach-944"><span class="linenos"> 944</span></a>        <span class="n">inter_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-945"><a href="#GAMCoach-945"><span class="linenos"> 945</span></a>
</span><span id="GAMCoach-946"><a href="#GAMCoach-946"><span class="linenos"> 946</span></a>        <span class="c1"># Iterate through all possible combinations of options from these two</span>
</span><span id="GAMCoach-947"><a href="#GAMCoach-947"><span class="linenos"> 947</span></a>        <span class="c1"># variables</span>
</span><span id="GAMCoach-948"><a href="#GAMCoach-948"><span class="linenos"> 948</span></a>        <span class="k">for</span> <span class="n">opt_1</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name_1</span><span class="p">]:</span>
</span><span id="GAMCoach-949"><a href="#GAMCoach-949"><span class="linenos"> 949</span></a>            <span class="k">for</span> <span class="n">opt_2</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name_2</span><span class="p">]:</span>
</span><span id="GAMCoach-950"><a href="#GAMCoach-950"><span class="linenos"> 950</span></a>
</span><span id="GAMCoach-951"><a href="#GAMCoach-951"><span class="linenos"> 951</span></a>                <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach-952"><a href="#GAMCoach-952"><span class="linenos"> 952</span></a>                    <span class="n">cur_feature_index_1</span>
</span><span id="GAMCoach-953"><a href="#GAMCoach-953"><span class="linenos"> 953</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-954"><a href="#GAMCoach-954"><span class="linenos"> 954</span></a>                <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach-955"><a href="#GAMCoach-955"><span class="linenos"> 955</span></a>                    <span class="n">cur_feature_index_2</span>
</span><span id="GAMCoach-956"><a href="#GAMCoach-956"><span class="linenos"> 956</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-957"><a href="#GAMCoach-957"><span class="linenos"> 957</span></a>
</span><span id="GAMCoach-958"><a href="#GAMCoach-958"><span class="linenos"> 958</span></a>                <span class="n">bin_1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach-959"><a href="#GAMCoach-959"><span class="linenos"> 959</span></a>                <span class="n">bin_2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach-960"><a href="#GAMCoach-960"><span class="linenos"> 960</span></a>
</span><span id="GAMCoach-961"><a href="#GAMCoach-961"><span class="linenos"> 961</span></a>                <span class="k">if</span> <span class="n">cur_feature_type_1</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-962"><a href="#GAMCoach-962"><span class="linenos"> 962</span></a>                    <span class="k">if</span> <span class="n">cur_feature_type_2</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-963"><a href="#GAMCoach-963"><span class="linenos"> 963</span></a>                        <span class="c1"># cont x cont</span>
</span><span id="GAMCoach-964"><a href="#GAMCoach-964"><span class="linenos"> 964</span></a>                        <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-965"><a href="#GAMCoach-965"><span class="linenos"> 965</span></a>                        <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-966"><a href="#GAMCoach-966"><span class="linenos"> 966</span></a>
</span><span id="GAMCoach-967"><a href="#GAMCoach-967"><span class="linenos"> 967</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="GAMCoach-968"><a href="#GAMCoach-968"><span class="linenos"> 968</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_1</span><span class="p">,</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-969"><a href="#GAMCoach-969"><span class="linenos"> 969</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_2</span><span class="p">,</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-970"><a href="#GAMCoach-970"><span class="linenos"> 970</span></a>
</span><span id="GAMCoach-971"><a href="#GAMCoach-971"><span class="linenos"> 971</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-972"><a href="#GAMCoach-972"><span class="linenos"> 972</span></a>                        <span class="c1"># cont x cat</span>
</span><span id="GAMCoach-973"><a href="#GAMCoach-973"><span class="linenos"> 973</span></a>                        <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-974"><a href="#GAMCoach-974"><span class="linenos"> 974</span></a>
</span><span id="GAMCoach-975"><a href="#GAMCoach-975"><span class="linenos"> 975</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="GAMCoach-976"><a href="#GAMCoach-976"><span class="linenos"> 976</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_1</span><span class="p">,</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-977"><a href="#GAMCoach-977"><span class="linenos"> 977</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-978"><a href="#GAMCoach-978"><span class="linenos"> 978</span></a>
</span><span id="GAMCoach-979"><a href="#GAMCoach-979"><span class="linenos"> 979</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-980"><a href="#GAMCoach-980"><span class="linenos"> 980</span></a>                    <span class="k">if</span> <span class="n">cur_feature_type_2</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-981"><a href="#GAMCoach-981"><span class="linenos"> 981</span></a>                        <span class="c1"># cat x cont</span>
</span><span id="GAMCoach-982"><a href="#GAMCoach-982"><span class="linenos"> 982</span></a>                        <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-983"><a href="#GAMCoach-983"><span class="linenos"> 983</span></a>
</span><span id="GAMCoach-984"><a href="#GAMCoach-984"><span class="linenos"> 984</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="GAMCoach-985"><a href="#GAMCoach-985"><span class="linenos"> 985</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-986"><a href="#GAMCoach-986"><span class="linenos"> 986</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_2</span><span class="p">,</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-987"><a href="#GAMCoach-987"><span class="linenos"> 987</span></a>
</span><span id="GAMCoach-988"><a href="#GAMCoach-988"><span class="linenos"> 988</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-989"><a href="#GAMCoach-989"><span class="linenos"> 989</span></a>                        <span class="c1"># cat x cat</span>
</span><span id="GAMCoach-990"><a href="#GAMCoach-990"><span class="linenos"> 990</span></a>
</span><span id="GAMCoach-991"><a href="#GAMCoach-991"><span class="linenos"> 991</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="GAMCoach-992"><a href="#GAMCoach-992"><span class="linenos"> 992</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-993"><a href="#GAMCoach-993"><span class="linenos"> 993</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-994"><a href="#GAMCoach-994"><span class="linenos"> 994</span></a>
</span><span id="GAMCoach-995"><a href="#GAMCoach-995"><span class="linenos"> 995</span></a>                <span class="n">new_score</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">bin_1</span><span class="p">,</span> <span class="n">bin_2</span><span class="p">]</span>
</span><span id="GAMCoach-996"><a href="#GAMCoach-996"><span class="linenos"> 996</span></a>                <span class="n">score_gain</span> <span class="o">=</span> <span class="n">new_score</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="GAMCoach-997"><a href="#GAMCoach-997"><span class="linenos"> 997</span></a>
</span><span id="GAMCoach-998"><a href="#GAMCoach-998"><span class="linenos"> 998</span></a>                <span class="c1"># The score gain on the interaction term need to offset the interaction</span>
</span><span id="GAMCoach-999"><a href="#GAMCoach-999"><span class="linenos"> 999</span></a>                <span class="c1"># score gain we have already counted on the main effect options. That</span>
</span><span id="GAMCoach-1000"><a href="#GAMCoach-1000"><span class="linenos">1000</span></a>                <span class="c1"># score is saved in the option tuple.</span>
</span><span id="GAMCoach-1001"><a href="#GAMCoach-1001"><span class="linenos">1001</span></a>
</span><span id="GAMCoach-1002"><a href="#GAMCoach-1002"><span class="linenos">1002</span></a>                <span class="c1"># We first need to find the common interaction id</span>
</span><span id="GAMCoach-1003"><a href="#GAMCoach-1003"><span class="linenos">1003</span></a>                <span class="n">common_index</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-1004"><a href="#GAMCoach-1004"><span class="linenos">1004</span></a>                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="GAMCoach-1005"><a href="#GAMCoach-1005"><span class="linenos">1005</span></a>                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="GAMCoach-1006"><a href="#GAMCoach-1006"><span class="linenos">1006</span></a>                        <span class="k">if</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="GAMCoach-1007"><a href="#GAMCoach-1007"><span class="linenos">1007</span></a>                            <span class="n">common_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
</span><span id="GAMCoach-1008"><a href="#GAMCoach-1008"><span class="linenos">1008</span></a>                            <span class="k">break</span>
</span><span id="GAMCoach-1009"><a href="#GAMCoach-1009"><span class="linenos">1009</span></a>
</span><span id="GAMCoach-1010"><a href="#GAMCoach-1010"><span class="linenos">1010</span></a>                    <span class="k">if</span> <span class="n">common_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">common_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="GAMCoach-1011"><a href="#GAMCoach-1011"><span class="linenos">1011</span></a>                        <span class="k">break</span>
</span><span id="GAMCoach-1012"><a href="#GAMCoach-1012"><span class="linenos">1012</span></a>
</span><span id="GAMCoach-1013"><a href="#GAMCoach-1013"><span class="linenos">1013</span></a>                <span class="n">score_gain</span> <span class="o">-=</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">common_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-1014"><a href="#GAMCoach-1014"><span class="linenos">1014</span></a>                <span class="n">score_gain</span> <span class="o">-=</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">common_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-1015"><a href="#GAMCoach-1015"><span class="linenos">1015</span></a>
</span><span id="GAMCoach-1016"><a href="#GAMCoach-1016"><span class="linenos">1016</span></a>                <span class="n">inter_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach-1017"><a href="#GAMCoach-1017"><span class="linenos">1017</span></a>                    <span class="p">[[</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">score_gain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach-1018"><a href="#GAMCoach-1018"><span class="linenos">1018</span></a>                <span class="p">)</span>
</span><span id="GAMCoach-1019"><a href="#GAMCoach-1019"><span class="linenos">1019</span></a>
</span><span id="GAMCoach-1020"><a href="#GAMCoach-1020"><span class="linenos">1020</span></a>        <span class="k">return</span> <span class="n">inter_options</span>
</span><span id="GAMCoach-1021"><a href="#GAMCoach-1021"><span class="linenos">1021</span></a>
</span><span id="GAMCoach-1022"><a href="#GAMCoach-1022"><span class="linenos">1022</span></a>    <span class="nd">@staticmethod</span>
</span><span id="GAMCoach-1023"><a href="#GAMCoach-1023"><span class="linenos">1023</span></a>    <span class="k">def</span> <span class="nf">create_milp</span><span class="p">(</span>
</span><span id="GAMCoach-1024"><a href="#GAMCoach-1024"><span class="linenos">1024</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach-1025"><a href="#GAMCoach-1025"><span class="linenos">1025</span></a>        <span class="n">needed_score_gain</span><span class="p">,</span>
</span><span id="GAMCoach-1026"><a href="#GAMCoach-1026"><span class="linenos">1026</span></a>        <span class="n">features_to_vary</span><span class="p">,</span>
</span><span id="GAMCoach-1027"><a href="#GAMCoach-1027"><span class="linenos">1027</span></a>        <span class="n">options</span><span class="p">,</span>
</span><span id="GAMCoach-1028"><a href="#GAMCoach-1028"><span class="linenos">1028</span></a>        <span class="n">max_num_features_to_vary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach-1029"><a href="#GAMCoach-1029"><span class="linenos">1029</span></a>        <span class="n">muted_variables</span><span class="o">=</span><span class="p">[],</span>
</span><span id="GAMCoach-1030"><a href="#GAMCoach-1030"><span class="linenos">1030</span></a>    <span class="p">):</span>
</span><span id="GAMCoach-1031"><a href="#GAMCoach-1031"><span class="linenos">1031</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach-1032"><a href="#GAMCoach-1032"><span class="linenos">1032</span></a><span class="sd">        Create a MILP to find counterfactuals (CF) using PuLP.</span>
</span><span id="GAMCoach-1033"><a href="#GAMCoach-1033"><span class="linenos">1033</span></a>
</span><span id="GAMCoach-1034"><a href="#GAMCoach-1034"><span class="linenos">1034</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-1035"><a href="#GAMCoach-1035"><span class="linenos">1035</span></a><span class="sd">            cf_direction (int): Integer +1 if 0 =&gt; 1, -1 if 1 =&gt; 0 (classification),</span>
</span><span id="GAMCoach-1036"><a href="#GAMCoach-1036"><span class="linenos">1036</span></a><span class="sd">                +1 if we need to incrase the prediction, -1 if decrease (regression).</span>
</span><span id="GAMCoach-1037"><a href="#GAMCoach-1037"><span class="linenos">1037</span></a><span class="sd">            needed_score_gain (float): The score gain needed to achieve the CF goal.</span>
</span><span id="GAMCoach-1038"><a href="#GAMCoach-1038"><span class="linenos">1038</span></a><span class="sd">            features_to_vary (list[str]): Feature names of features that the</span>
</span><span id="GAMCoach-1039"><a href="#GAMCoach-1039"><span class="linenos">1039</span></a><span class="sd">                generated CF can change.</span>
</span><span id="GAMCoach-1040"><a href="#GAMCoach-1040"><span class="linenos">1040</span></a><span class="sd">            options (dict): Possible options for each variable. Each option is a</span>
</span><span id="GAMCoach-1041"><a href="#GAMCoach-1041"><span class="linenos">1041</span></a><span class="sd">                list [target, score_gain, distance, bin_index].</span>
</span><span id="GAMCoach-1042"><a href="#GAMCoach-1042"><span class="linenos">1042</span></a><span class="sd">            max_num_features_to_vary (int, optional): Max number of features that the</span>
</span><span id="GAMCoach-1043"><a href="#GAMCoach-1043"><span class="linenos">1043</span></a><span class="sd">                generated CF can change. If the value is `None`, the CFs can</span>
</span><span id="GAMCoach-1044"><a href="#GAMCoach-1044"><span class="linenos">1044</span></a><span class="sd">                change any number of features.</span>
</span><span id="GAMCoach-1045"><a href="#GAMCoach-1045"><span class="linenos">1045</span></a><span class="sd">            muted_variables (list[str], optional): Variables that this MILP should</span>
</span><span id="GAMCoach-1046"><a href="#GAMCoach-1046"><span class="linenos">1046</span></a><span class="sd">                not use. This is useful to mute optimal variables so we can explore</span>
</span><span id="GAMCoach-1047"><a href="#GAMCoach-1047"><span class="linenos">1047</span></a><span class="sd">                diverse solutions. This list should not include interaction variables.</span>
</span><span id="GAMCoach-1048"><a href="#GAMCoach-1048"><span class="linenos">1048</span></a>
</span><span id="GAMCoach-1049"><a href="#GAMCoach-1049"><span class="linenos">1049</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach-1050"><a href="#GAMCoach-1050"><span class="linenos">1050</span></a><span class="sd">            A tuple (`model`, `variables`), where `model` is a pulp.LpProblem</span>
</span><span id="GAMCoach-1051"><a href="#GAMCoach-1051"><span class="linenos">1051</span></a><span class="sd">            model that encodes the MILP problem, and `variables` is a dict of</span>
</span><span id="GAMCoach-1052"><a href="#GAMCoach-1052"><span class="linenos">1052</span></a><span class="sd">            variables used in the `model`: `feature_name` =&gt; [`variables`].</span>
</span><span id="GAMCoach-1053"><a href="#GAMCoach-1053"><span class="linenos">1053</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-1054"><a href="#GAMCoach-1054"><span class="linenos">1054</span></a>
</span><span id="GAMCoach-1055"><a href="#GAMCoach-1055"><span class="linenos">1055</span></a>        <span class="c1"># Create a model (minimizing the distance)</span>
</span><span id="GAMCoach-1056"><a href="#GAMCoach-1056"><span class="linenos">1056</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">(</span><span class="s2">&quot;ebmCounterfactual&quot;</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpMinimize</span><span class="p">)</span>
</span><span id="GAMCoach-1057"><a href="#GAMCoach-1057"><span class="linenos">1057</span></a>
</span><span id="GAMCoach-1058"><a href="#GAMCoach-1058"><span class="linenos">1058</span></a>        <span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach-1059"><a href="#GAMCoach-1059"><span class="linenos">1059</span></a>        <span class="n">score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach-1060"><a href="#GAMCoach-1060"><span class="linenos">1060</span></a>
</span><span id="GAMCoach-1061"><a href="#GAMCoach-1061"><span class="linenos">1061</span></a>        <span class="n">muted_variables_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">muted_variables</span><span class="p">)</span>
</span><span id="GAMCoach-1062"><a href="#GAMCoach-1062"><span class="linenos">1062</span></a>
</span><span id="GAMCoach-1063"><a href="#GAMCoach-1063"><span class="linenos">1063</span></a>        <span class="c1"># Create variables</span>
</span><span id="GAMCoach-1064"><a href="#GAMCoach-1064"><span class="linenos">1064</span></a>        <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach-1065"><a href="#GAMCoach-1065"><span class="linenos">1065</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_to_vary</span><span class="p">:</span>
</span><span id="GAMCoach-1066"><a href="#GAMCoach-1066"><span class="linenos">1066</span></a>            <span class="c1"># Each variable encodes an option (0: not use this option,</span>
</span><span id="GAMCoach-1067"><a href="#GAMCoach-1067"><span class="linenos">1067</span></a>            <span class="c1"># 1: use this option)</span>
</span><span id="GAMCoach-1068"><a href="#GAMCoach-1068"><span class="linenos">1068</span></a>            <span class="n">cur_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-1069"><a href="#GAMCoach-1069"><span class="linenos">1069</span></a>
</span><span id="GAMCoach-1070"><a href="#GAMCoach-1070"><span class="linenos">1070</span></a>            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
</span><span id="GAMCoach-1071"><a href="#GAMCoach-1071"><span class="linenos">1071</span></a>                <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="GAMCoach-1072"><a href="#GAMCoach-1072"><span class="linenos">1072</span></a>
</span><span id="GAMCoach-1073"><a href="#GAMCoach-1073"><span class="linenos">1073</span></a>                <span class="c1"># Skip the muted variables</span>
</span><span id="GAMCoach-1074"><a href="#GAMCoach-1074"><span class="linenos">1074</span></a>                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span><span class="p">:</span>
</span><span id="GAMCoach-1075"><a href="#GAMCoach-1075"><span class="linenos">1075</span></a>                    <span class="k">continue</span>
</span><span id="GAMCoach-1076"><a href="#GAMCoach-1076"><span class="linenos">1076</span></a>
</span><span id="GAMCoach-1077"><a href="#GAMCoach-1077"><span class="linenos">1077</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upBound</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Binary&quot;</span><span class="p">)</span>
</span><span id="GAMCoach-1078"><a href="#GAMCoach-1078"><span class="linenos">1078</span></a>                <span class="n">x</span><span class="o">.</span><span class="n">setInitialValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="GAMCoach-1079"><a href="#GAMCoach-1079"><span class="linenos">1079</span></a>
</span><span id="GAMCoach-1080"><a href="#GAMCoach-1080"><span class="linenos">1080</span></a>                <span class="n">score_gain</span> <span class="o">+=</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
</span><span id="GAMCoach-1081"><a href="#GAMCoach-1081"><span class="linenos">1081</span></a>                <span class="n">distance</span> <span class="o">+=</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
</span><span id="GAMCoach-1082"><a href="#GAMCoach-1082"><span class="linenos">1082</span></a>
</span><span id="GAMCoach-1083"><a href="#GAMCoach-1083"><span class="linenos">1083</span></a>                <span class="n">cur_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="GAMCoach-1084"><a href="#GAMCoach-1084"><span class="linenos">1084</span></a>
</span><span id="GAMCoach-1085"><a href="#GAMCoach-1085"><span class="linenos">1085</span></a>            <span class="n">variables</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_variables</span>
</span><span id="GAMCoach-1086"><a href="#GAMCoach-1086"><span class="linenos">1086</span></a>
</span><span id="GAMCoach-1087"><a href="#GAMCoach-1087"><span class="linenos">1087</span></a>            <span class="c1"># A local constraint is that we can only at most selection one option from</span>
</span><span id="GAMCoach-1088"><a href="#GAMCoach-1088"><span class="linenos">1088</span></a>            <span class="c1"># one feature</span>
</span><span id="GAMCoach-1089"><a href="#GAMCoach-1089"><span class="linenos">1089</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">lpSum</span><span class="p">(</span><span class="n">cur_variables</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
</span><span id="GAMCoach-1090"><a href="#GAMCoach-1090"><span class="linenos">1090</span></a>
</span><span id="GAMCoach-1091"><a href="#GAMCoach-1091"><span class="linenos">1091</span></a>        <span class="c1"># Users can also set `max_num_features_to_vary` to control the total</span>
</span><span id="GAMCoach-1092"><a href="#GAMCoach-1092"><span class="linenos">1092</span></a>        <span class="c1"># number of features to vary</span>
</span><span id="GAMCoach-1093"><a href="#GAMCoach-1093"><span class="linenos">1093</span></a>        <span class="k">if</span> <span class="n">max_num_features_to_vary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach-1094"><a href="#GAMCoach-1094"><span class="linenos">1094</span></a>            <span class="n">main_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-1095"><a href="#GAMCoach-1095"><span class="linenos">1095</span></a>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
</span><span id="GAMCoach-1096"><a href="#GAMCoach-1096"><span class="linenos">1096</span></a>                <span class="n">main_variables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
</span><span id="GAMCoach-1097"><a href="#GAMCoach-1097"><span class="linenos">1097</span></a>
</span><span id="GAMCoach-1098"><a href="#GAMCoach-1098"><span class="linenos">1098</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">lpSum</span><span class="p">(</span><span class="n">main_variables</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_num_features_to_vary</span>
</span><span id="GAMCoach-1099"><a href="#GAMCoach-1099"><span class="linenos">1099</span></a>
</span><span id="GAMCoach-1100"><a href="#GAMCoach-1100"><span class="linenos">1100</span></a>        <span class="c1"># Create variables for interaction effects</span>
</span><span id="GAMCoach-1101"><a href="#GAMCoach-1101"><span class="linenos">1101</span></a>        <span class="k">for</span> <span class="n">opt_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="GAMCoach-1102"><a href="#GAMCoach-1102"><span class="linenos">1102</span></a>            <span class="k">if</span> <span class="s2">&quot; x &quot;</span> <span class="ow">in</span> <span class="n">opt_name</span><span class="p">:</span>
</span><span id="GAMCoach-1103"><a href="#GAMCoach-1103"><span class="linenos">1103</span></a>                <span class="n">f1_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+)\sx\s.+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">opt_name</span><span class="p">)</span>
</span><span id="GAMCoach-1104"><a href="#GAMCoach-1104"><span class="linenos">1104</span></a>                <span class="n">f2_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+\sx\s(.+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">opt_name</span><span class="p">)</span>
</span><span id="GAMCoach-1105"><a href="#GAMCoach-1105"><span class="linenos">1105</span></a>
</span><span id="GAMCoach-1106"><a href="#GAMCoach-1106"><span class="linenos">1106</span></a>                <span class="k">if</span> <span class="n">f1_name</span> <span class="ow">in</span> <span class="n">features_to_vary</span> <span class="ow">and</span> <span class="n">f2_name</span> <span class="ow">in</span> <span class="n">features_to_vary</span><span class="p">:</span>
</span><span id="GAMCoach-1107"><a href="#GAMCoach-1107"><span class="linenos">1107</span></a>
</span><span id="GAMCoach-1108"><a href="#GAMCoach-1108"><span class="linenos">1108</span></a>                    <span class="c1"># We need to include this interaction effect</span>
</span><span id="GAMCoach-1109"><a href="#GAMCoach-1109"><span class="linenos">1109</span></a>                    <span class="n">cur_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach-1110"><a href="#GAMCoach-1110"><span class="linenos">1110</span></a>
</span><span id="GAMCoach-1111"><a href="#GAMCoach-1111"><span class="linenos">1111</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">opt_name</span><span class="p">]:</span>
</span><span id="GAMCoach-1112"><a href="#GAMCoach-1112"><span class="linenos">1112</span></a>                        <span class="n">z</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">(</span>
</span><span id="GAMCoach-1113"><a href="#GAMCoach-1113"><span class="linenos">1113</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="GAMCoach-1114"><a href="#GAMCoach-1114"><span class="linenos">1114</span></a>                            <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="GAMCoach-1115"><a href="#GAMCoach-1115"><span class="linenos">1115</span></a>                            <span class="n">upBound</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="GAMCoach-1116"><a href="#GAMCoach-1116"><span class="linenos">1116</span></a>                            <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Continuous&quot;</span><span class="p">,</span>
</span><span id="GAMCoach-1117"><a href="#GAMCoach-1117"><span class="linenos">1117</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach-1118"><a href="#GAMCoach-1118"><span class="linenos">1118</span></a>                        <span class="n">z</span><span class="o">.</span><span class="n">setInitialValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="GAMCoach-1119"><a href="#GAMCoach-1119"><span class="linenos">1119</span></a>
</span><span id="GAMCoach-1120"><a href="#GAMCoach-1120"><span class="linenos">1120</span></a>                        <span class="c1"># Need to iterate through existing variables for f1 and f2 to find</span>
</span><span id="GAMCoach-1121"><a href="#GAMCoach-1121"><span class="linenos">1121</span></a>                        <span class="c1"># the corresponding variables</span>
</span><span id="GAMCoach-1122"><a href="#GAMCoach-1122"><span class="linenos">1122</span></a>                        <span class="n">x_f1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach-1123"><a href="#GAMCoach-1123"><span class="linenos">1123</span></a>                        <span class="n">x_f2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach-1124"><a href="#GAMCoach-1124"><span class="linenos">1124</span></a>
</span><span id="GAMCoach-1125"><a href="#GAMCoach-1125"><span class="linenos">1125</span></a>                        <span class="c1"># Skp if this interaction variable involves muted main variable</span>
</span><span id="GAMCoach-1126"><a href="#GAMCoach-1126"><span class="linenos">1126</span></a>                        <span class="n">x_f1_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f1_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach-1127"><a href="#GAMCoach-1127"><span class="linenos">1127</span></a>                        <span class="n">x_f2_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f2_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="GAMCoach-1128"><a href="#GAMCoach-1128"><span class="linenos">1128</span></a>
</span><span id="GAMCoach-1129"><a href="#GAMCoach-1129"><span class="linenos">1129</span></a>                        <span class="k">if</span> <span class="p">(</span>
</span><span id="GAMCoach-1130"><a href="#GAMCoach-1130"><span class="linenos">1130</span></a>                            <span class="n">x_f1_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span>
</span><span id="GAMCoach-1131"><a href="#GAMCoach-1131"><span class="linenos">1131</span></a>                            <span class="ow">or</span> <span class="n">x_f2_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span>
</span><span id="GAMCoach-1132"><a href="#GAMCoach-1132"><span class="linenos">1132</span></a>                        <span class="p">):</span>
</span><span id="GAMCoach-1133"><a href="#GAMCoach-1133"><span class="linenos">1133</span></a>                            <span class="k">continue</span>
</span><span id="GAMCoach-1134"><a href="#GAMCoach-1134"><span class="linenos">1134</span></a>
</span><span id="GAMCoach-1135"><a href="#GAMCoach-1135"><span class="linenos">1135</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">f1_name</span><span class="p">]:</span>
</span><span id="GAMCoach-1136"><a href="#GAMCoach-1136"><span class="linenos">1136</span></a>                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">x_f1_name</span><span class="p">:</span>
</span><span id="GAMCoach-1137"><a href="#GAMCoach-1137"><span class="linenos">1137</span></a>                                <span class="n">x_f1</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="GAMCoach-1138"><a href="#GAMCoach-1138"><span class="linenos">1138</span></a>                                <span class="k">break</span>
</span><span id="GAMCoach-1139"><a href="#GAMCoach-1139"><span class="linenos">1139</span></a>
</span><span id="GAMCoach-1140"><a href="#GAMCoach-1140"><span class="linenos">1140</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">f2_name</span><span class="p">]:</span>
</span><span id="GAMCoach-1141"><a href="#GAMCoach-1141"><span class="linenos">1141</span></a>                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">x_f2_name</span><span class="p">:</span>
</span><span id="GAMCoach-1142"><a href="#GAMCoach-1142"><span class="linenos">1142</span></a>                                <span class="n">x_f2</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="GAMCoach-1143"><a href="#GAMCoach-1143"><span class="linenos">1143</span></a>                                <span class="k">break</span>
</span><span id="GAMCoach-1144"><a href="#GAMCoach-1144"><span class="linenos">1144</span></a>
</span><span id="GAMCoach-1145"><a href="#GAMCoach-1145"><span class="linenos">1145</span></a>                        <span class="k">assert</span> <span class="n">x_f1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x_f2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="GAMCoach-1146"><a href="#GAMCoach-1146"><span class="linenos">1146</span></a>
</span><span id="GAMCoach-1147"><a href="#GAMCoach-1147"><span class="linenos">1147</span></a>                        <span class="c1"># variable z is actually the product of x_f1 and x_f2</span>
</span><span id="GAMCoach-1148"><a href="#GAMCoach-1148"><span class="linenos">1148</span></a>                        <span class="c1"># We can linearize it by 3 constraints</span>
</span><span id="GAMCoach-1149"><a href="#GAMCoach-1149"><span class="linenos">1149</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">x_f1</span>
</span><span id="GAMCoach-1150"><a href="#GAMCoach-1150"><span class="linenos">1150</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">x_f2</span>
</span><span id="GAMCoach-1151"><a href="#GAMCoach-1151"><span class="linenos">1151</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">x_f1</span> <span class="o">+</span> <span class="n">x_f2</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="GAMCoach-1152"><a href="#GAMCoach-1152"><span class="linenos">1152</span></a>
</span><span id="GAMCoach-1153"><a href="#GAMCoach-1153"><span class="linenos">1153</span></a>                        <span class="n">cur_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="GAMCoach-1154"><a href="#GAMCoach-1154"><span class="linenos">1154</span></a>
</span><span id="GAMCoach-1155"><a href="#GAMCoach-1155"><span class="linenos">1155</span></a>                    <span class="n">variables</span><span class="p">[</span><span class="n">opt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_variables</span>
</span><span id="GAMCoach-1156"><a href="#GAMCoach-1156"><span class="linenos">1156</span></a>
</span><span id="GAMCoach-1157"><a href="#GAMCoach-1157"><span class="linenos">1157</span></a>        <span class="c1"># Use constraint to express counterfactual</span>
</span><span id="GAMCoach-1158"><a href="#GAMCoach-1158"><span class="linenos">1158</span></a>        <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GAMCoach-1159"><a href="#GAMCoach-1159"><span class="linenos">1159</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">score_gain</span> <span class="o">&gt;=</span> <span class="n">needed_score_gain</span>
</span><span id="GAMCoach-1160"><a href="#GAMCoach-1160"><span class="linenos">1160</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-1161"><a href="#GAMCoach-1161"><span class="linenos">1161</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="n">needed_score_gain</span>
</span><span id="GAMCoach-1162"><a href="#GAMCoach-1162"><span class="linenos">1162</span></a>
</span><span id="GAMCoach-1163"><a href="#GAMCoach-1163"><span class="linenos">1163</span></a>        <span class="c1"># We want to minimize the distance</span>
</span><span id="GAMCoach-1164"><a href="#GAMCoach-1164"><span class="linenos">1164</span></a>        <span class="n">model</span> <span class="o">+=</span> <span class="n">distance</span>
</span><span id="GAMCoach-1165"><a href="#GAMCoach-1165"><span class="linenos">1165</span></a>
</span><span id="GAMCoach-1166"><a href="#GAMCoach-1166"><span class="linenos">1166</span></a>        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">variables</span>
</span><span id="GAMCoach-1167"><a href="#GAMCoach-1167"><span class="linenos">1167</span></a>
</span><span id="GAMCoach-1168"><a href="#GAMCoach-1168"><span class="linenos">1168</span></a>    <span class="k">def</span> <span class="nf">print_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cur_example</span><span class="p">,</span> <span class="n">active_variables</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
</span><span id="GAMCoach-1169"><a href="#GAMCoach-1169"><span class="linenos">1169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach-1170"><a href="#GAMCoach-1170"><span class="linenos">1170</span></a><span class="sd">        Print the optimal solution.</span>
</span><span id="GAMCoach-1171"><a href="#GAMCoach-1171"><span class="linenos">1171</span></a>
</span><span id="GAMCoach-1172"><a href="#GAMCoach-1172"><span class="linenos">1172</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-1173"><a href="#GAMCoach-1173"><span class="linenos">1173</span></a><span class="sd">            cur_example (np.ndarray): the original data point.</span>
</span><span id="GAMCoach-1174"><a href="#GAMCoach-1174"><span class="linenos">1174</span></a><span class="sd">            active_variables (list[variable]): binary variables with value 1.</span>
</span><span id="GAMCoach-1175"><a href="#GAMCoach-1175"><span class="linenos">1175</span></a><span class="sd">            options (dict): all the possible options for all features.</span>
</span><span id="GAMCoach-1176"><a href="#GAMCoach-1176"><span class="linenos">1176</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-1177"><a href="#GAMCoach-1177"><span class="linenos">1177</span></a>
</span><span id="GAMCoach-1178"><a href="#GAMCoach-1178"><span class="linenos">1178</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">active_variables</span><span class="p">:</span>
</span><span id="GAMCoach-1179"><a href="#GAMCoach-1179"><span class="linenos">1179</span></a>            <span class="c1"># Skip interaction vars (included)</span>
</span><span id="GAMCoach-1180"><a href="#GAMCoach-1180"><span class="linenos">1180</span></a>            <span class="k">if</span> <span class="s2">&quot;_x_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="GAMCoach-1181"><a href="#GAMCoach-1181"><span class="linenos">1181</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+):\d+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="GAMCoach-1182"><a href="#GAMCoach-1182"><span class="linenos">1182</span></a>                <span class="n">bin_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:(\d+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="GAMCoach-1183"><a href="#GAMCoach-1183"><span class="linenos">1183</span></a>
</span><span id="GAMCoach-1184"><a href="#GAMCoach-1184"><span class="linenos">1184</span></a>                <span class="c1"># Find the original value</span>
</span><span id="GAMCoach-1185"><a href="#GAMCoach-1185"><span class="linenos">1185</span></a>                <span class="n">org_value</span> <span class="o">=</span> <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)]</span>
</span><span id="GAMCoach-1186"><a href="#GAMCoach-1186"><span class="linenos">1186</span></a>
</span><span id="GAMCoach-1187"><a href="#GAMCoach-1187"><span class="linenos">1187</span></a>                <span class="c1"># Find the target bin</span>
</span><span id="GAMCoach-1188"><a href="#GAMCoach-1188"><span class="linenos">1188</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="GAMCoach-1189"><a href="#GAMCoach-1189"><span class="linenos">1189</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="GAMCoach-1190"><a href="#GAMCoach-1190"><span class="linenos">1190</span></a>
</span><span id="GAMCoach-1191"><a href="#GAMCoach-1191"><span class="linenos">1191</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach-1192"><a href="#GAMCoach-1192"><span class="linenos">1192</span></a>                    <span class="n">bin_starts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">f_index</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach-1193"><a href="#GAMCoach-1193"><span class="linenos">1193</span></a>
</span><span id="GAMCoach-1194"><a href="#GAMCoach-1194"><span class="linenos">1194</span></a>                    <span class="n">target_bin</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">bin_i</span><span class="p">])</span>
</span><span id="GAMCoach-1195"><a href="#GAMCoach-1195"><span class="linenos">1195</span></a>
</span><span id="GAMCoach-1196"><a href="#GAMCoach-1196"><span class="linenos">1196</span></a>                    <span class="k">if</span> <span class="n">bin_i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">):</span>
</span><span id="GAMCoach-1197"><a href="#GAMCoach-1197"><span class="linenos">1197</span></a>                        <span class="n">target_bin</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">bin_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="GAMCoach-1198"><a href="#GAMCoach-1198"><span class="linenos">1198</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-1199"><a href="#GAMCoach-1199"><span class="linenos">1199</span></a>                        <span class="n">target_bin</span> <span class="o">+=</span> <span class="s2">&quot; inf)&quot;</span>
</span><span id="GAMCoach-1200"><a href="#GAMCoach-1200"><span class="linenos">1200</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-1201"><a href="#GAMCoach-1201"><span class="linenos">1201</span></a>                    <span class="n">target_bin</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="GAMCoach-1202"><a href="#GAMCoach-1202"><span class="linenos">1202</span></a>                    <span class="n">org_value</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">org_value</span><span class="p">)</span>
</span><span id="GAMCoach-1203"><a href="#GAMCoach-1203"><span class="linenos">1203</span></a>
</span><span id="GAMCoach-1204"><a href="#GAMCoach-1204"><span class="linenos">1204</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach-1205"><a href="#GAMCoach-1205"><span class="linenos">1205</span></a>                    <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_i</span><span class="p">:</span>
</span><span id="GAMCoach-1206"><a href="#GAMCoach-1206"><span class="linenos">1206</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="GAMCoach-1207"><a href="#GAMCoach-1207"><span class="linenos">1207</span></a>                            <span class="s2">&quot;Change &lt;</span><span class="si">{}</span><span class="s2">&gt; from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="GAMCoach-1208"><a href="#GAMCoach-1208"><span class="linenos">1208</span></a>                                <span class="n">f_name</span><span class="p">,</span> <span class="n">org_value</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_bin</span>
</span><span id="GAMCoach-1209"><a href="#GAMCoach-1209"><span class="linenos">1209</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach-1210"><a href="#GAMCoach-1210"><span class="linenos">1210</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach-1211"><a href="#GAMCoach-1211"><span class="linenos">1211</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="GAMCoach-1212"><a href="#GAMCoach-1212"><span class="linenos">1212</span></a>                            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">* score gain: </span><span class="si">{:.4f}</span><span class="se">\n\t</span><span class="s2">* distance cost: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="GAMCoach-1213"><a href="#GAMCoach-1213"><span class="linenos">1213</span></a>                                <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="GAMCoach-1214"><a href="#GAMCoach-1214"><span class="linenos">1214</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach-1215"><a href="#GAMCoach-1215"><span class="linenos">1215</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach-1216"><a href="#GAMCoach-1216"><span class="linenos">1216</span></a>                        <span class="k">break</span>
</span><span id="GAMCoach-1217"><a href="#GAMCoach-1217"><span class="linenos">1217</span></a>
</span><span id="GAMCoach-1218"><a href="#GAMCoach-1218"><span class="linenos">1218</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach-1219"><a href="#GAMCoach-1219"><span class="linenos">1219</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+):.+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="GAMCoach-1220"><a href="#GAMCoach-1220"><span class="linenos">1220</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">f_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_x_&quot;</span><span class="p">,</span> <span class="s2">&quot; x &quot;</span><span class="p">)</span>
</span><span id="GAMCoach-1221"><a href="#GAMCoach-1221"><span class="linenos">1221</span></a>                <span class="n">bin_0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:(\d+),\d+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="GAMCoach-1222"><a href="#GAMCoach-1222"><span class="linenos">1222</span></a>                <span class="n">bin_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:\d+,(\d+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="GAMCoach-1223"><a href="#GAMCoach-1223"><span class="linenos">1223</span></a>
</span><span id="GAMCoach-1224"><a href="#GAMCoach-1224"><span class="linenos">1224</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach-1225"><a href="#GAMCoach-1225"><span class="linenos">1225</span></a>                    <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_0</span> <span class="ow">and</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_1</span><span class="p">:</span>
</span><span id="GAMCoach-1226"><a href="#GAMCoach-1226"><span class="linenos">1226</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trigger interaction term: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_name</span><span class="p">))</span>
</span><span id="GAMCoach-1227"><a href="#GAMCoach-1227"><span class="linenos">1227</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="GAMCoach-1228"><a href="#GAMCoach-1228"><span class="linenos">1228</span></a>                            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">* score gain: </span><span class="si">{:.4f}</span><span class="se">\n\t</span><span class="s2">* distance cost: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="GAMCoach-1229"><a href="#GAMCoach-1229"><span class="linenos">1229</span></a>                                <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span>
</span><span id="GAMCoach-1230"><a href="#GAMCoach-1230"><span class="linenos">1230</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach-1231"><a href="#GAMCoach-1231"><span class="linenos">1231</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach-1232"><a href="#GAMCoach-1232"><span class="linenos">1232</span></a>                        <span class="k">break</span>
</span><span id="GAMCoach-1233"><a href="#GAMCoach-1233"><span class="linenos">1233</span></a>        <span class="nb">print</span><span class="p">()</span>
</span><span id="GAMCoach-1234"><a href="#GAMCoach-1234"><span class="linenos">1234</span></a>
</span><span id="GAMCoach-1235"><a href="#GAMCoach-1235"><span class="linenos">1235</span></a>    <span class="nd">@staticmethod</span>
</span><span id="GAMCoach-1236"><a href="#GAMCoach-1236"><span class="linenos">1236</span></a>    <span class="k">def</span> <span class="nf">compute_mad</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="GAMCoach-1237"><a href="#GAMCoach-1237"><span class="linenos">1237</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach-1238"><a href="#GAMCoach-1238"><span class="linenos">1238</span></a><span class="sd">        Compute the median absolute deviation of a continuous feature.</span>
</span><span id="GAMCoach-1239"><a href="#GAMCoach-1239"><span class="linenos">1239</span></a>
</span><span id="GAMCoach-1240"><a href="#GAMCoach-1240"><span class="linenos">1240</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-1241"><a href="#GAMCoach-1241"><span class="linenos">1241</span></a><span class="sd">            xs (np.ndarray): A column of continuous values.</span>
</span><span id="GAMCoach-1242"><a href="#GAMCoach-1242"><span class="linenos">1242</span></a>
</span><span id="GAMCoach-1243"><a href="#GAMCoach-1243"><span class="linenos">1243</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach-1244"><a href="#GAMCoach-1244"><span class="linenos">1244</span></a><span class="sd">            float: MAD value of xs.</span>
</span><span id="GAMCoach-1245"><a href="#GAMCoach-1245"><span class="linenos">1245</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-1246"><a href="#GAMCoach-1246"><span class="linenos">1246</span></a>        <span class="n">xs_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="GAMCoach-1247"><a href="#GAMCoach-1247"><span class="linenos">1247</span></a>        <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="n">xs_median</span><span class="p">))</span>
</span><span id="GAMCoach-1248"><a href="#GAMCoach-1248"><span class="linenos">1248</span></a>        <span class="k">return</span> <span class="n">mad</span>
</span><span id="GAMCoach-1249"><a href="#GAMCoach-1249"><span class="linenos">1249</span></a>
</span><span id="GAMCoach-1250"><a href="#GAMCoach-1250"><span class="linenos">1250</span></a>    <span class="nd">@staticmethod</span>
</span><span id="GAMCoach-1251"><a href="#GAMCoach-1251"><span class="linenos">1251</span></a>    <span class="k">def</span> <span class="nf">compute_frequency_distance</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="GAMCoach-1252"><a href="#GAMCoach-1252"><span class="linenos">1252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach-1253"><a href="#GAMCoach-1253"><span class="linenos">1253</span></a><span class="sd">        For categorical variables, we compute 1 - frequency as their distance. It implies</span>
</span><span id="GAMCoach-1254"><a href="#GAMCoach-1254"><span class="linenos">1254</span></a><span class="sd">        that switching to a frequent value takes less effort.</span>
</span><span id="GAMCoach-1255"><a href="#GAMCoach-1255"><span class="linenos">1255</span></a>
</span><span id="GAMCoach-1256"><a href="#GAMCoach-1256"><span class="linenos">1256</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-1257"><a href="#GAMCoach-1257"><span class="linenos">1257</span></a><span class="sd">            xs (np.ndarray): A column of categorical values.</span>
</span><span id="GAMCoach-1258"><a href="#GAMCoach-1258"><span class="linenos">1258</span></a>
</span><span id="GAMCoach-1259"><a href="#GAMCoach-1259"><span class="linenos">1259</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach-1260"><a href="#GAMCoach-1260"><span class="linenos">1260</span></a><span class="sd">            dict: category level -&gt; 1 - frequency.</span>
</span><span id="GAMCoach-1261"><a href="#GAMCoach-1261"><span class="linenos">1261</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-1262"><a href="#GAMCoach-1262"><span class="linenos">1262</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="GAMCoach-1263"><a href="#GAMCoach-1263"><span class="linenos">1263</span></a>
</span><span id="GAMCoach-1264"><a href="#GAMCoach-1264"><span class="linenos">1264</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach-1265"><a href="#GAMCoach-1265"><span class="linenos">1265</span></a>
</span><span id="GAMCoach-1266"><a href="#GAMCoach-1266"><span class="linenos">1266</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">counter</span><span class="p">:</span>
</span><span id="GAMCoach-1267"><a href="#GAMCoach-1267"><span class="linenos">1267</span></a>            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
</span><span id="GAMCoach-1268"><a href="#GAMCoach-1268"><span class="linenos">1268</span></a>
</span><span id="GAMCoach-1269"><a href="#GAMCoach-1269"><span class="linenos">1269</span></a>        <span class="k">return</span> <span class="n">results</span>
</span><span id="GAMCoach-1270"><a href="#GAMCoach-1270"><span class="linenos">1270</span></a>
</span><span id="GAMCoach-1271"><a href="#GAMCoach-1271"><span class="linenos">1271</span></a>    <span class="nd">@staticmethod</span>
</span><span id="GAMCoach-1272"><a href="#GAMCoach-1272"><span class="linenos">1272</span></a>    <span class="k">def</span> <span class="nf">compute_naive_cat_distance</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="GAMCoach-1273"><a href="#GAMCoach-1273"><span class="linenos">1273</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach-1274"><a href="#GAMCoach-1274"><span class="linenos">1274</span></a><span class="sd">        Alternative to compute_frequency_distance() to compute distance for</span>
</span><span id="GAMCoach-1275"><a href="#GAMCoach-1275"><span class="linenos">1275</span></a><span class="sd">        categorical variables. The distance 1 for different levels and 0 for</span>
</span><span id="GAMCoach-1276"><a href="#GAMCoach-1276"><span class="linenos">1276</span></a><span class="sd">        the same levels. Here we give them all score 1, because same-level</span>
</span><span id="GAMCoach-1277"><a href="#GAMCoach-1277"><span class="linenos">1277</span></a><span class="sd">        options will be filtered out when we create categorical options for the</span>
</span><span id="GAMCoach-1278"><a href="#GAMCoach-1278"><span class="linenos">1278</span></a><span class="sd">        optimization program.</span>
</span><span id="GAMCoach-1279"><a href="#GAMCoach-1279"><span class="linenos">1279</span></a>
</span><span id="GAMCoach-1280"><a href="#GAMCoach-1280"><span class="linenos">1280</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach-1281"><a href="#GAMCoach-1281"><span class="linenos">1281</span></a><span class="sd">            xs (np.ndarray): A column of categorical values.</span>
</span><span id="GAMCoach-1282"><a href="#GAMCoach-1282"><span class="linenos">1282</span></a>
</span><span id="GAMCoach-1283"><a href="#GAMCoach-1283"><span class="linenos">1283</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach-1284"><a href="#GAMCoach-1284"><span class="linenos">1284</span></a><span class="sd">            dict: category level -&gt; 1.</span>
</span><span id="GAMCoach-1285"><a href="#GAMCoach-1285"><span class="linenos">1285</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach-1286"><a href="#GAMCoach-1286"><span class="linenos">1286</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="GAMCoach-1287"><a href="#GAMCoach-1287"><span class="linenos">1287</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach-1288"><a href="#GAMCoach-1288"><span class="linenos">1288</span></a>
</span><span id="GAMCoach-1289"><a href="#GAMCoach-1289"><span class="linenos">1289</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">counter</span><span class="p">:</span>
</span><span id="GAMCoach-1290"><a href="#GAMCoach-1290"><span class="linenos">1290</span></a>            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="GAMCoach-1291"><a href="#GAMCoach-1291"><span class="linenos">1291</span></a>
</span><span id="GAMCoach-1292"><a href="#GAMCoach-1292"><span class="linenos">1292</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Main class for GAM Coach.</p>
</div>


                            <div id="GAMCoach.__init__" class="classattr">
                                        <input id="GAMCoach.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">GAMCoach</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ebm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">interpret</span><span class="o">.</span><span class="n">glassbox</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">ExplainableBoostingClassifier</span><span class="p">,</span> <span class="n">interpret</span><span class="o">.</span><span class="n">glassbox</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">ExplainableBoostingRegressor</span><span class="p">]</span>,</span><span class="param">	<span class="n">x_train</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">cont_mads</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">cat_distances</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">adjust_cat_distance</span><span class="o">=</span><span class="kc">True</span></span>)</span>

                <label class="view-source-button" for="GAMCoach.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.__init__-29"><a href="#GAMCoach.__init__-29"><span class="linenos"> 29</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="GAMCoach.__init__-30"><a href="#GAMCoach.__init__-30"><span class="linenos"> 30</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach.__init__-31"><a href="#GAMCoach.__init__-31"><span class="linenos"> 31</span></a>        <span class="n">ebm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">ExplainableBoostingClassifier</span><span class="p">,</span> <span class="n">ExplainableBoostingRegressor</span><span class="p">],</span>
</span><span id="GAMCoach.__init__-32"><a href="#GAMCoach.__init__-32"><span class="linenos"> 32</span></a>        <span class="n">x_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="GAMCoach.__init__-33"><a href="#GAMCoach.__init__-33"><span class="linenos"> 33</span></a>        <span class="n">cont_mads</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.__init__-34"><a href="#GAMCoach.__init__-34"><span class="linenos"> 34</span></a>        <span class="n">cat_distances</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.__init__-35"><a href="#GAMCoach.__init__-35"><span class="linenos"> 35</span></a>        <span class="n">adjust_cat_distance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="GAMCoach.__init__-36"><a href="#GAMCoach.__init__-36"><span class="linenos"> 36</span></a>    <span class="p">):</span>
</span><span id="GAMCoach.__init__-37"><a href="#GAMCoach.__init__-37"><span class="linenos"> 37</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a GAMCoach object.</span>
</span><span id="GAMCoach.__init__-38"><a href="#GAMCoach.__init__-38"><span class="linenos"> 38</span></a>
</span><span id="GAMCoach.__init__-39"><a href="#GAMCoach.__init__-39"><span class="linenos"> 39</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.__init__-40"><a href="#GAMCoach.__init__-40"><span class="linenos"> 40</span></a><span class="sd">            ebm (Union[ExplainableBoostingClassifier, ExplainableBoostingRegressor]):</span>
</span><span id="GAMCoach.__init__-41"><a href="#GAMCoach.__init__-41"><span class="linenos"> 41</span></a><span class="sd">                The trained EBM model. It can be either a classifier or a regressor.</span>
</span><span id="GAMCoach.__init__-42"><a href="#GAMCoach.__init__-42"><span class="linenos"> 42</span></a><span class="sd">            x_train (np.ndarray): The training data. It is used to compute the</span>
</span><span id="GAMCoach.__init__-43"><a href="#GAMCoach.__init__-43"><span class="linenos"> 43</span></a><span class="sd">                distance for different features.</span>
</span><span id="GAMCoach.__init__-44"><a href="#GAMCoach.__init__-44"><span class="linenos"> 44</span></a><span class="sd">            cont_mads (dict, optional): `feature_name` -&gt; `median absolute</span>
</span><span id="GAMCoach.__init__-45"><a href="#GAMCoach.__init__-45"><span class="linenos"> 45</span></a><span class="sd">                deviation score`. If it is provided, it is used to overwrite the</span>
</span><span id="GAMCoach.__init__-46"><a href="#GAMCoach.__init__-46"><span class="linenos"> 46</span></a><span class="sd">                computed MADs for continuous variables. It is useful when you</span>
</span><span id="GAMCoach.__init__-47"><a href="#GAMCoach.__init__-47"><span class="linenos"> 47</span></a><span class="sd">                want to provide a custom normalization function to compute the</span>
</span><span id="GAMCoach.__init__-48"><a href="#GAMCoach.__init__-48"><span class="linenos"> 48</span></a><span class="sd">                distance between continuous features.</span>
</span><span id="GAMCoach.__init__-49"><a href="#GAMCoach.__init__-49"><span class="linenos"> 49</span></a><span class="sd">            cat_distances (dict, optional): `feature_name` -&gt; {`level_name` -&gt; `distance`}.</span>
</span><span id="GAMCoach.__init__-50"><a href="#GAMCoach.__init__-50"><span class="linenos"> 50</span></a><span class="sd">                Level distance of categorical variables. By default, the distance</span>
</span><span id="GAMCoach.__init__-51"><a href="#GAMCoach.__init__-51"><span class="linenos"> 51</span></a><span class="sd">                is computed by (1 - frequency(level)) for each level. It imples</span>
</span><span id="GAMCoach.__init__-52"><a href="#GAMCoach.__init__-52"><span class="linenos"> 52</span></a><span class="sd">                that it is easier to move to a more frequent. If `cat_distances`</span>
</span><span id="GAMCoach.__init__-53"><a href="#GAMCoach.__init__-53"><span class="linenos"> 53</span></a><span class="sd">                is provided, it will overwrite the default distance for</span>
</span><span id="GAMCoach.__init__-54"><a href="#GAMCoach.__init__-54"><span class="linenos"> 54</span></a><span class="sd">                categorical variables.</span>
</span><span id="GAMCoach.__init__-55"><a href="#GAMCoach.__init__-55"><span class="linenos"> 55</span></a><span class="sd">            adjust_cat_distance (bool, optional): If true, we use (1 -</span>
</span><span id="GAMCoach.__init__-56"><a href="#GAMCoach.__init__-56"><span class="linenos"> 56</span></a><span class="sd">                frequency(level)) for each level. Otherwise, we give distance = 1</span>
</span><span id="GAMCoach.__init__-57"><a href="#GAMCoach.__init__-57"><span class="linenos"> 57</span></a><span class="sd">                for different levels and 0 for the same level.</span>
</span><span id="GAMCoach.__init__-58"><a href="#GAMCoach.__init__-58"><span class="linenos"> 58</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.__init__-59"><a href="#GAMCoach.__init__-59"><span class="linenos"> 59</span></a>
</span><span id="GAMCoach.__init__-60"><a href="#GAMCoach.__init__-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="GAMCoach.__init__-61"><a href="#GAMCoach.__init__-61"><span class="linenos"> 61</span></a>            <span class="n">ExplainableBoostingClassifier</span><span class="p">,</span> <span class="n">ExplainableBoostingRegressor</span>
</span><span id="GAMCoach.__init__-62"><a href="#GAMCoach.__init__-62"><span class="linenos"> 62</span></a>        <span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span>
</span><span id="GAMCoach.__init__-63"><a href="#GAMCoach.__init__-63"><span class="linenos"> 63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The trained EBM model.&quot;&quot;&quot;</span>
</span><span id="GAMCoach.__init__-64"><a href="#GAMCoach.__init__-64"><span class="linenos"> 64</span></a>
</span><span id="GAMCoach.__init__-65"><a href="#GAMCoach.__init__-65"><span class="linenos"> 65</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">x_train</span>
</span><span id="GAMCoach.__init__-66"><a href="#GAMCoach.__init__-66"><span class="linenos"> 66</span></a>
</span><span id="GAMCoach.__init__-67"><a href="#GAMCoach.__init__-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">cont_mads</span>
</span><span id="GAMCoach.__init__-68"><a href="#GAMCoach.__init__-68"><span class="linenos"> 68</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Median absolute deviation (MAD) of continuous variables.&quot;&quot;&quot;</span>
</span><span id="GAMCoach.__init__-69"><a href="#GAMCoach.__init__-69"><span class="linenos"> 69</span></a>
</span><span id="GAMCoach.__init__-70"><a href="#GAMCoach.__init__-70"><span class="linenos"> 70</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="n">cat_distances</span>
</span><span id="GAMCoach.__init__-71"><a href="#GAMCoach.__init__-71"><span class="linenos"> 71</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Level distance of categorical variables. By default, the distance is</span>
</span><span id="GAMCoach.__init__-72"><a href="#GAMCoach.__init__-72"><span class="linenos"> 72</span></a><span class="sd">        computed by $(1 - \\frac{\\text{count of} L_i}{\\text{count of all L}})$</span>
</span><span id="GAMCoach.__init__-73"><a href="#GAMCoach.__init__-73"><span class="linenos"> 73</span></a><span class="sd">        for one level $L_i$. It implies that it is easier to move to a more</span>
</span><span id="GAMCoach.__init__-74"><a href="#GAMCoach.__init__-74"><span class="linenos"> 74</span></a><span class="sd">        frequent level.</span>
</span><span id="GAMCoach.__init__-75"><a href="#GAMCoach.__init__-75"><span class="linenos"> 75</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.__init__-76"><a href="#GAMCoach.__init__-76"><span class="linenos"> 76</span></a>
</span><span id="GAMCoach.__init__-77"><a href="#GAMCoach.__init__-77"><span class="linenos"> 77</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">adjust_cat_distance</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">adjust_cat_distance</span>
</span><span id="GAMCoach.__init__-78"><a href="#GAMCoach.__init__-78"><span class="linenos"> 78</span></a>
</span><span id="GAMCoach.__init__-79"><a href="#GAMCoach.__init__-79"><span class="linenos"> 79</span></a>        <span class="c1"># If cont_mads is not given, we compute it from the training data</span>
</span><span id="GAMCoach.__init__-80"><a href="#GAMCoach.__init__-80"><span class="linenos"> 80</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach.__init__-81"><a href="#GAMCoach.__init__-81"><span class="linenos"> 81</span></a>            <span class="n">ebm_cont_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="GAMCoach.__init__-82"><a href="#GAMCoach.__init__-82"><span class="linenos"> 82</span></a>                <span class="p">[</span>
</span><span id="GAMCoach.__init__-83"><a href="#GAMCoach.__init__-83"><span class="linenos"> 83</span></a>                    <span class="n">i</span>
</span><span id="GAMCoach.__init__-84"><a href="#GAMCoach.__init__-84"><span class="linenos"> 84</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">))</span>
</span><span id="GAMCoach.__init__-85"><a href="#GAMCoach.__init__-85"><span class="linenos"> 85</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span>
</span><span id="GAMCoach.__init__-86"><a href="#GAMCoach.__init__-86"><span class="linenos"> 86</span></a>                <span class="p">]</span>
</span><span id="GAMCoach.__init__-87"><a href="#GAMCoach.__init__-87"><span class="linenos"> 87</span></a>            <span class="p">)</span>
</span><span id="GAMCoach.__init__-88"><a href="#GAMCoach.__init__-88"><span class="linenos"> 88</span></a>
</span><span id="GAMCoach.__init__-89"><a href="#GAMCoach.__init__-89"><span class="linenos"> 89</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach.__init__-90"><a href="#GAMCoach.__init__-90"><span class="linenos"> 90</span></a>
</span><span id="GAMCoach.__init__-91"><a href="#GAMCoach.__init__-91"><span class="linenos"> 91</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cont_indexes</span><span class="p">:</span>
</span><span id="GAMCoach.__init__-92"><a href="#GAMCoach.__init__-92"><span class="linenos"> 92</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">[</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mad</span><span class="p">(</span>
</span><span id="GAMCoach.__init__-93"><a href="#GAMCoach.__init__-93"><span class="linenos"> 93</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.__init__-94"><a href="#GAMCoach.__init__-94"><span class="linenos"> 94</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.__init__-95"><a href="#GAMCoach.__init__-95"><span class="linenos"> 95</span></a>
</span><span id="GAMCoach.__init__-96"><a href="#GAMCoach.__init__-96"><span class="linenos"> 96</span></a>        <span class="c1"># If cat_distance is not given, we compute it from the training data</span>
</span><span id="GAMCoach.__init__-97"><a href="#GAMCoach.__init__-97"><span class="linenos"> 97</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach.__init__-98"><a href="#GAMCoach.__init__-98"><span class="linenos"> 98</span></a>            <span class="n">ebm_cat_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="GAMCoach.__init__-99"><a href="#GAMCoach.__init__-99"><span class="linenos"> 99</span></a>                <span class="p">[</span>
</span><span id="GAMCoach.__init__-100"><a href="#GAMCoach.__init__-100"><span class="linenos">100</span></a>                    <span class="n">i</span>
</span><span id="GAMCoach.__init__-101"><a href="#GAMCoach.__init__-101"><span class="linenos">101</span></a>                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">))</span>
</span><span id="GAMCoach.__init__-102"><a href="#GAMCoach.__init__-102"><span class="linenos">102</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span>
</span><span id="GAMCoach.__init__-103"><a href="#GAMCoach.__init__-103"><span class="linenos">103</span></a>                <span class="p">]</span>
</span><span id="GAMCoach.__init__-104"><a href="#GAMCoach.__init__-104"><span class="linenos">104</span></a>            <span class="p">)</span>
</span><span id="GAMCoach.__init__-105"><a href="#GAMCoach.__init__-105"><span class="linenos">105</span></a>
</span><span id="GAMCoach.__init__-106"><a href="#GAMCoach.__init__-106"><span class="linenos">106</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach.__init__-107"><a href="#GAMCoach.__init__-107"><span class="linenos">107</span></a>
</span><span id="GAMCoach.__init__-108"><a href="#GAMCoach.__init__-108"><span class="linenos">108</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">adjust_cat_distance</span><span class="p">:</span>
</span><span id="GAMCoach.__init__-109"><a href="#GAMCoach.__init__-109"><span class="linenos">109</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cat_indexes</span><span class="p">:</span>
</span><span id="GAMCoach.__init__-110"><a href="#GAMCoach.__init__-110"><span class="linenos">110</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span>
</span><span id="GAMCoach.__init__-111"><a href="#GAMCoach.__init__-111"><span class="linenos">111</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.__init__-112"><a href="#GAMCoach.__init__-112"><span class="linenos">112</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_frequency_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="GAMCoach.__init__-113"><a href="#GAMCoach.__init__-113"><span class="linenos">113</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.__init__-114"><a href="#GAMCoach.__init__-114"><span class="linenos">114</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cat_indexes</span><span class="p">:</span>
</span><span id="GAMCoach.__init__-115"><a href="#GAMCoach.__init__-115"><span class="linenos">115</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span>
</span><span id="GAMCoach.__init__-116"><a href="#GAMCoach.__init__-116"><span class="linenos">116</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.__init__-117"><a href="#GAMCoach.__init__-117"><span class="linenos">117</span></a>                    <span class="p">]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_naive_cat_distance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="GAMCoach.__init__-118"><a href="#GAMCoach.__init__-118"><span class="linenos">118</span></a>
</span><span id="GAMCoach.__init__-119"><a href="#GAMCoach.__init__-119"><span class="linenos">119</span></a>        <span class="c1"># Determine if the ebm is a classifier or a regressor</span>
</span><span id="GAMCoach.__init__-120"><a href="#GAMCoach.__init__-120"><span class="linenos">120</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>
</span><span id="GAMCoach.__init__-121"><a href="#GAMCoach.__init__-121"><span class="linenos">121</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;True if the ebm model is a classifier, false if it is a regressor.&quot;&quot;&quot;</span>
</span></pre></div>


            <div class="docstring"><p>Initialize a GAMCoach object.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>ebm (Union[ExplainableBoostingClassifier, ExplainableBoostingRegressor]):</strong>  The trained EBM model. It can be either a classifier or a regressor.</li>
<li><strong>x_train (np.ndarray):</strong>  The training data. It is used to compute the
distance for different features.</li>
<li><strong>cont_mads (dict, optional):</strong>  <code>feature_name</code> -> <code>median absolute
deviation score</code>. If it is provided, it is used to overwrite the
computed MADs for continuous variables. It is useful when you
want to provide a custom normalization function to compute the
distance between continuous features.</li>
<li><strong>cat_distances (dict, optional):</strong>  <code>feature_name</code> -> {<code>level_name</code> -> <code>distance</code>}.
Level distance of categorical variables. By default, the distance
is computed by (1 - frequency(level)) for each level. It imples
that it is easier to move to a more frequent. If <code><a href="#GAMCoach.cat_distances">cat_distances</a></code>
is provided, it will overwrite the default distance for
categorical variables.</li>
<li><strong>adjust_cat_distance (bool, optional):</strong>  If true, we use (1 -
frequency(level)) for each level. Otherwise, we give distance = 1
for different levels and 0 for the same level.</li>
</ul>
</div>


                            </div>
                            <div id="GAMCoach.ebm" class="classattr">
                                <div class="attr variable">
            <span class="name">ebm</span><span class="annotation">: Union[interpret.glassbox.ebm.ebm.ExplainableBoostingClassifier, interpret.glassbox.ebm.ebm.ExplainableBoostingRegressor]</span>

        
    </div>
    <a class="headerlink" href="#GAMCoach.ebm"></a>
    
            <div class="docstring"><p>The trained EBM model.</p>
</div>


                            </div>
                            <div id="GAMCoach.cont_mads" class="classattr">
                                <div class="attr variable">
            <span class="name">cont_mads</span><span class="annotation">: dict</span>

        
    </div>
    <a class="headerlink" href="#GAMCoach.cont_mads"></a>
    
            <div class="docstring"><p>Median absolute deviation (MAD) of continuous variables.</p>
</div>


                            </div>
                            <div id="GAMCoach.cat_distances" class="classattr">
                                <div class="attr variable">
            <span class="name">cat_distances</span><span class="annotation">: dict</span>

        
    </div>
    <a class="headerlink" href="#GAMCoach.cat_distances"></a>
    
            <div class="docstring"><p>Level distance of categorical variables. By default, the distance is
computed by $(1 - \frac{\text{count of} L_i}{\text{count of all L}})$
for one level $L_i$. It implies that it is easier to move to a more
frequent level.</p>
</div>


                            </div>
                            <div id="GAMCoach.is_classifier" class="classattr">
                                <div class="attr variable">
            <span class="name">is_classifier</span>

        
    </div>
    <a class="headerlink" href="#GAMCoach.is_classifier"></a>
    
            <div class="docstring"><p>True if the ebm model is a classifier, false if it is a regressor.</p>
</div>


                            </div>
                            <div id="GAMCoach.generate_cfs" class="classattr">
                                        <input id="GAMCoach.generate_cfs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_cfs</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">cur_example</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span>,</span><span class="param">	<span class="n">total_cfs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>,</span><span class="param">	<span class="n">target_range</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">sim_threshold_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span>,</span><span class="param">	<span class="n">sim_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">categorical_weight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>,</span><span class="param">	<span class="n">features_to_vary</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_num_features_to_vary</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">feature_ranges</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">continuous_integer_features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span></span><span class="return-annotation">) -> <span class="n"><a href="counterfactuals.html#Counterfactuals">gamcoach.counterfactuals.Counterfactuals</a></span>:</span></span>

                <label class="view-source-button" for="GAMCoach.generate_cfs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.generate_cfs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.generate_cfs-123"><a href="#GAMCoach.generate_cfs-123"><span class="linenos">123</span></a>    <span class="k">def</span> <span class="nf">generate_cfs</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-124"><a href="#GAMCoach.generate_cfs-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-125"><a href="#GAMCoach.generate_cfs-125"><span class="linenos">125</span></a>        <span class="n">cur_example</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-126"><a href="#GAMCoach.generate_cfs-126"><span class="linenos">126</span></a>        <span class="n">total_cfs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-127"><a href="#GAMCoach.generate_cfs-127"><span class="linenos">127</span></a>        <span class="n">target_range</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-128"><a href="#GAMCoach.generate_cfs-128"><span class="linenos">128</span></a>        <span class="n">sim_threshold_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-129"><a href="#GAMCoach.generate_cfs-129"><span class="linenos">129</span></a>        <span class="n">sim_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-130"><a href="#GAMCoach.generate_cfs-130"><span class="linenos">130</span></a>        <span class="n">categorical_weight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-131"><a href="#GAMCoach.generate_cfs-131"><span class="linenos">131</span></a>        <span class="n">features_to_vary</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-132"><a href="#GAMCoach.generate_cfs-132"><span class="linenos">132</span></a>        <span class="n">max_num_features_to_vary</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-133"><a href="#GAMCoach.generate_cfs-133"><span class="linenos">133</span></a>        <span class="n">feature_ranges</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-134"><a href="#GAMCoach.generate_cfs-134"><span class="linenos">134</span></a>        <span class="n">continuous_integer_features</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-135"><a href="#GAMCoach.generate_cfs-135"><span class="linenos">135</span></a>        <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-136"><a href="#GAMCoach.generate_cfs-136"><span class="linenos">136</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Counterfactuals</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-137"><a href="#GAMCoach.generate_cfs-137"><span class="linenos">137</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate counterfactual examples.</span>
</span><span id="GAMCoach.generate_cfs-138"><a href="#GAMCoach.generate_cfs-138"><span class="linenos">138</span></a>
</span><span id="GAMCoach.generate_cfs-139"><a href="#GAMCoach.generate_cfs-139"><span class="linenos">139</span></a><span class="sd">        Use mixed-integer linear programming to generate optimal counterfactual</span>
</span><span id="GAMCoach.generate_cfs-140"><a href="#GAMCoach.generate_cfs-140"><span class="linenos">140</span></a><span class="sd">        examples for the given data point.</span>
</span><span id="GAMCoach.generate_cfs-141"><a href="#GAMCoach.generate_cfs-141"><span class="linenos">141</span></a>
</span><span id="GAMCoach.generate_cfs-142"><a href="#GAMCoach.generate_cfs-142"><span class="linenos">142</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.generate_cfs-143"><a href="#GAMCoach.generate_cfs-143"><span class="linenos">143</span></a><span class="sd">            cur_example (np.ndarray): The data point of interest. This function</span>
</span><span id="GAMCoach.generate_cfs-144"><a href="#GAMCoach.generate_cfs-144"><span class="linenos">144</span></a><span class="sd">                aims to find similar examples that the model gives different</span>
</span><span id="GAMCoach.generate_cfs-145"><a href="#GAMCoach.generate_cfs-145"><span class="linenos">145</span></a><span class="sd">                predictions.</span>
</span><span id="GAMCoach.generate_cfs-146"><a href="#GAMCoach.generate_cfs-146"><span class="linenos">146</span></a><span class="sd">            total_cfs (int, optional): The total number of counterfactuals to,</span>
</span><span id="GAMCoach.generate_cfs-147"><a href="#GAMCoach.generate_cfs-147"><span class="linenos">147</span></a><span class="sd">                generate. Default to 1.</span>
</span><span id="GAMCoach.generate_cfs-148"><a href="#GAMCoach.generate_cfs-148"><span class="linenos">148</span></a><span class="sd">            target_range (tuple, optional): The targetted prediction range. This</span>
</span><span id="GAMCoach.generate_cfs-149"><a href="#GAMCoach.generate_cfs-149"><span class="linenos">149</span></a><span class="sd">                parameter is required if the EBM is a regressor.</span>
</span><span id="GAMCoach.generate_cfs-150"><a href="#GAMCoach.generate_cfs-150"><span class="linenos">150</span></a><span class="sd">            sim_threshold_factor (float, optional): A positive float to automatically</span>
</span><span id="GAMCoach.generate_cfs-151"><a href="#GAMCoach.generate_cfs-151"><span class="linenos">151</span></a><span class="sd">                generate a similarity threshold. This parameter has no effect if</span>
</span><span id="GAMCoach.generate_cfs-152"><a href="#GAMCoach.generate_cfs-152"><span class="linenos">152</span></a><span class="sd">                `sim_threshold` is provided. If `sim_threshold` is</span>
</span><span id="GAMCoach.generate_cfs-153"><a href="#GAMCoach.generate_cfs-153"><span class="linenos">153</span></a><span class="sd">                not provided, we compute `sim_threshold` as `sim_threshold_factor`</span>
</span><span id="GAMCoach.generate_cfs-154"><a href="#GAMCoach.generate_cfs-154"><span class="linenos">154</span></a><span class="sd">                * average additive score range of all continuous features. If</span>
</span><span id="GAMCoach.generate_cfs-155"><a href="#GAMCoach.generate_cfs-155"><span class="linenos">155</span></a><span class="sd">                `sim_threshold_factor` is too small, it takes longer time to</span>
</span><span id="GAMCoach.generate_cfs-156"><a href="#GAMCoach.generate_cfs-156"><span class="linenos">156</span></a><span class="sd">                generate CFs. If `sim_threshold_factor` is too large, the</span>
</span><span id="GAMCoach.generate_cfs-157"><a href="#GAMCoach.generate_cfs-157"><span class="linenos">157</span></a><span class="sd">                algorithm might miss some optimal CFs.</span>
</span><span id="GAMCoach.generate_cfs-158"><a href="#GAMCoach.generate_cfs-158"><span class="linenos">158</span></a><span class="sd">            sim_threshold (float, optional): A positive float to determine how we</span>
</span><span id="GAMCoach.generate_cfs-159"><a href="#GAMCoach.generate_cfs-159"><span class="linenos">159</span></a><span class="sd">                decide if two bins of a continuous feature have similar scores.</span>
</span><span id="GAMCoach.generate_cfs-160"><a href="#GAMCoach.generate_cfs-160"><span class="linenos">160</span></a><span class="sd">                Two bins $b_1$ and $b_2$ are similar (the distant one will be</span>
</span><span id="GAMCoach.generate_cfs-161"><a href="#GAMCoach.generate_cfs-161"><span class="linenos">161</span></a><span class="sd">                removed) if $|b_1 - b_2| \\leq$ `sim_threshold`.</span>
</span><span id="GAMCoach.generate_cfs-162"><a href="#GAMCoach.generate_cfs-162"><span class="linenos">162</span></a><span class="sd">            categorical_weight (Union[float, str], optional): A positive float</span>
</span><span id="GAMCoach.generate_cfs-163"><a href="#GAMCoach.generate_cfs-163"><span class="linenos">163</span></a><span class="sd">                to scale the distances of options for categorical variables. Since</span>
</span><span id="GAMCoach.generate_cfs-164"><a href="#GAMCoach.generate_cfs-164"><span class="linenos">164</span></a><span class="sd">                we have very different distance functions for continuous and</span>
</span><span id="GAMCoach.generate_cfs-165"><a href="#GAMCoach.generate_cfs-165"><span class="linenos">165</span></a><span class="sd">                categorical features, we need to scale them so they are at a</span>
</span><span id="GAMCoach.generate_cfs-166"><a href="#GAMCoach.generate_cfs-166"><span class="linenos">166</span></a><span class="sd">                comparable range. To do that, we multiply the categorical feature&#39;s</span>
</span><span id="GAMCoach.generate_cfs-167"><a href="#GAMCoach.generate_cfs-167"><span class="linenos">167</span></a><span class="sd">                distances by `categorical_weight`. By default (&#39;auto&#39;), we scale</span>
</span><span id="GAMCoach.generate_cfs-168"><a href="#GAMCoach.generate_cfs-168"><span class="linenos">168</span></a><span class="sd">                the distances of categorical features so that they have the mean</span>
</span><span id="GAMCoach.generate_cfs-169"><a href="#GAMCoach.generate_cfs-169"><span class="linenos">169</span></a><span class="sd">                distance as continuous features.</span>
</span><span id="GAMCoach.generate_cfs-170"><a href="#GAMCoach.generate_cfs-170"><span class="linenos">170</span></a><span class="sd">            features_to_vary ([str], optional): A list of feature names that</span>
</span><span id="GAMCoach.generate_cfs-171"><a href="#GAMCoach.generate_cfs-171"><span class="linenos">171</span></a><span class="sd">                the CFs can change. If it is `None`, this function will use all</span>
</span><span id="GAMCoach.generate_cfs-172"><a href="#GAMCoach.generate_cfs-172"><span class="linenos">172</span></a><span class="sd">                features.</span>
</span><span id="GAMCoach.generate_cfs-173"><a href="#GAMCoach.generate_cfs-173"><span class="linenos">173</span></a><span class="sd">            max_num_features_to_vary (int, optional): The max number of features</span>
</span><span id="GAMCoach.generate_cfs-174"><a href="#GAMCoach.generate_cfs-174"><span class="linenos">174</span></a><span class="sd">                that the CF can vary. Default is no maximum.</span>
</span><span id="GAMCoach.generate_cfs-175"><a href="#GAMCoach.generate_cfs-175"><span class="linenos">175</span></a><span class="sd">            feature_ranges (dict, optional): A dictionary to control the permitted</span>
</span><span id="GAMCoach.generate_cfs-176"><a href="#GAMCoach.generate_cfs-176"><span class="linenos">176</span></a><span class="sd">                ranges/values for continuous/categorical features. It maps</span>
</span><span id="GAMCoach.generate_cfs-177"><a href="#GAMCoach.generate_cfs-177"><span class="linenos">177</span></a><span class="sd">                `feature_name` -&gt; [`min_value`, `max_value`] for continuous features,</span>
</span><span id="GAMCoach.generate_cfs-178"><a href="#GAMCoach.generate_cfs-178"><span class="linenos">178</span></a><span class="sd">                `feature_name` -&gt; [`level1`, `level2`, ...] for categorical features.</span>
</span><span id="GAMCoach.generate_cfs-179"><a href="#GAMCoach.generate_cfs-179"><span class="linenos">179</span></a><span class="sd">            continuous_integer_features (list, optional): A list of names of</span>
</span><span id="GAMCoach.generate_cfs-180"><a href="#GAMCoach.generate_cfs-180"><span class="linenos">180</span></a><span class="sd">                continuous features that need to be integers (e.g., age, FICO score)</span>
</span><span id="GAMCoach.generate_cfs-181"><a href="#GAMCoach.generate_cfs-181"><span class="linenos">181</span></a><span class="sd">            verbose (int): 0: no any output, 1: show progress bar, 2: show internal</span>
</span><span id="GAMCoach.generate_cfs-182"><a href="#GAMCoach.generate_cfs-182"><span class="linenos">182</span></a><span class="sd">                optimization details</span>
</span><span id="GAMCoach.generate_cfs-183"><a href="#GAMCoach.generate_cfs-183"><span class="linenos">183</span></a>
</span><span id="GAMCoach.generate_cfs-184"><a href="#GAMCoach.generate_cfs-184"><span class="linenos">184</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach.generate_cfs-185"><a href="#GAMCoach.generate_cfs-185"><span class="linenos">185</span></a><span class="sd">            Counterfactuals: The generated counterfactual examples with their</span>
</span><span id="GAMCoach.generate_cfs-186"><a href="#GAMCoach.generate_cfs-186"><span class="linenos">186</span></a><span class="sd">                associated distances and change information.</span>
</span><span id="GAMCoach.generate_cfs-187"><a href="#GAMCoach.generate_cfs-187"><span class="linenos">187</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.generate_cfs-188"><a href="#GAMCoach.generate_cfs-188"><span class="linenos">188</span></a>
</span><span id="GAMCoach.generate_cfs-189"><a href="#GAMCoach.generate_cfs-189"><span class="linenos">189</span></a>        <span class="c1"># Transforming some parameters</span>
</span><span id="GAMCoach.generate_cfs-190"><a href="#GAMCoach.generate_cfs-190"><span class="linenos">190</span></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cur_example</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-191"><a href="#GAMCoach.generate_cfs-191"><span class="linenos">191</span></a>            <span class="n">cur_example</span> <span class="o">=</span> <span class="n">cur_example</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-192"><a href="#GAMCoach.generate_cfs-192"><span class="linenos">192</span></a>
</span><span id="GAMCoach.generate_cfs-193"><a href="#GAMCoach.generate_cfs-193"><span class="linenos">193</span></a>        <span class="k">if</span> <span class="n">features_to_vary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-194"><a href="#GAMCoach.generate_cfs-194"><span class="linenos">194</span></a>            <span class="n">features_to_vary</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="GAMCoach.generate_cfs-195"><a href="#GAMCoach.generate_cfs-195"><span class="linenos">195</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-196"><a href="#GAMCoach.generate_cfs-196"><span class="linenos">196</span></a>                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">))</span>
</span><span id="GAMCoach.generate_cfs-197"><a href="#GAMCoach.generate_cfs-197"><span class="linenos">197</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;interaction&quot;</span>
</span><span id="GAMCoach.generate_cfs-198"><a href="#GAMCoach.generate_cfs-198"><span class="linenos">198</span></a>            <span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-199"><a href="#GAMCoach.generate_cfs-199"><span class="linenos">199</span></a>
</span><span id="GAMCoach.generate_cfs-200"><a href="#GAMCoach.generate_cfs-200"><span class="linenos">200</span></a>        <span class="c1"># Step 1: Find the current score for each feature</span>
</span><span id="GAMCoach.generate_cfs-201"><a href="#GAMCoach.generate_cfs-201"><span class="linenos">201</span></a>        <span class="c1"># This is done by ebm.explain_local()</span>
</span><span id="GAMCoach.generate_cfs-202"><a href="#GAMCoach.generate_cfs-202"><span class="linenos">202</span></a>        <span class="n">cur_scores</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach.generate_cfs-203"><a href="#GAMCoach.generate_cfs-203"><span class="linenos">203</span></a>
</span><span id="GAMCoach.generate_cfs-204"><a href="#GAMCoach.generate_cfs-204"><span class="linenos">204</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-205"><a href="#GAMCoach.generate_cfs-205"><span class="linenos">205</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-206"><a href="#GAMCoach.generate_cfs-206"><span class="linenos">206</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-207"><a href="#GAMCoach.generate_cfs-207"><span class="linenos">207</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="s2">&quot;intercept&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span>
</span><span id="GAMCoach.generate_cfs-208"><a href="#GAMCoach.generate_cfs-208"><span class="linenos">208</span></a>
</span><span id="GAMCoach.generate_cfs-209"><a href="#GAMCoach.generate_cfs-209"><span class="linenos">209</span></a>        <span class="n">local_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">explain_local</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)</span><span class="o">.</span><span class="n">_internal_obj</span>
</span><span id="GAMCoach.generate_cfs-210"><a href="#GAMCoach.generate_cfs-210"><span class="linenos">210</span></a>
</span><span id="GAMCoach.generate_cfs-211"><a href="#GAMCoach.generate_cfs-211"><span class="linenos">211</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cfs-212"><a href="#GAMCoach.generate_cfs-212"><span class="linenos">212</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-213"><a href="#GAMCoach.generate_cfs-213"><span class="linenos">213</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-214"><a href="#GAMCoach.generate_cfs-214"><span class="linenos">214</span></a>
</span><span id="GAMCoach.generate_cfs-215"><a href="#GAMCoach.generate_cfs-215"><span class="linenos">215</span></a>            <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_data</span><span class="p">[</span><span class="s2">&quot;specific&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;scores&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-216"><a href="#GAMCoach.generate_cfs-216"><span class="linenos">216</span></a>
</span><span id="GAMCoach.generate_cfs-217"><a href="#GAMCoach.generate_cfs-217"><span class="linenos">217</span></a>        <span class="c1"># Find the CF direction</span>
</span><span id="GAMCoach.generate_cfs-218"><a href="#GAMCoach.generate_cfs-218"><span class="linenos">218</span></a>
</span><span id="GAMCoach.generate_cfs-219"><a href="#GAMCoach.generate_cfs-219"><span class="linenos">219</span></a>        <span class="c1"># Binary classification</span>
</span><span id="GAMCoach.generate_cfs-220"><a href="#GAMCoach.generate_cfs-220"><span class="linenos">220</span></a>        <span class="c1"># Predicted 0 =&gt; +1</span>
</span><span id="GAMCoach.generate_cfs-221"><a href="#GAMCoach.generate_cfs-221"><span class="linenos">221</span></a>        <span class="c1"># Predicted 1 =&gt; -1</span>
</span><span id="GAMCoach.generate_cfs-222"><a href="#GAMCoach.generate_cfs-222"><span class="linenos">222</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_classifier</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-223"><a href="#GAMCoach.generate_cfs-223"><span class="linenos">223</span></a>            <span class="n">cf_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
</span><span id="GAMCoach.generate_cfs-224"><a href="#GAMCoach.generate_cfs-224"><span class="linenos">224</span></a>            <span class="n">total_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cur_scores</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_scores</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cfs-225"><a href="#GAMCoach.generate_cfs-225"><span class="linenos">225</span></a>            <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="o">-</span><span class="n">total_score</span>
</span><span id="GAMCoach.generate_cfs-226"><a href="#GAMCoach.generate_cfs-226"><span class="linenos">226</span></a>            <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach.generate_cfs-227"><a href="#GAMCoach.generate_cfs-227"><span class="linenos">227</span></a>
</span><span id="GAMCoach.generate_cfs-228"><a href="#GAMCoach.generate_cfs-228"><span class="linenos">228</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-229"><a href="#GAMCoach.generate_cfs-229"><span class="linenos">229</span></a>            <span class="c1"># Regression</span>
</span><span id="GAMCoach.generate_cfs-230"><a href="#GAMCoach.generate_cfs-230"><span class="linenos">230</span></a>            <span class="c1"># Increase +1</span>
</span><span id="GAMCoach.generate_cfs-231"><a href="#GAMCoach.generate_cfs-231"><span class="linenos">231</span></a>            <span class="c1"># Decrease -1</span>
</span><span id="GAMCoach.generate_cfs-232"><a href="#GAMCoach.generate_cfs-232"><span class="linenos">232</span></a>            <span class="k">if</span> <span class="n">target_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-233"><a href="#GAMCoach.generate_cfs-233"><span class="linenos">233</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-234"><a href="#GAMCoach.generate_cfs-234"><span class="linenos">234</span></a>                    <span class="s2">&quot;target_range cannot be None when the model is a regressor&quot;</span>
</span><span id="GAMCoach.generate_cfs-235"><a href="#GAMCoach.generate_cfs-235"><span class="linenos">235</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-236"><a href="#GAMCoach.generate_cfs-236"><span class="linenos">236</span></a>
</span><span id="GAMCoach.generate_cfs-237"><a href="#GAMCoach.generate_cfs-237"><span class="linenos">237</span></a>            <span class="n">predicted_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">cur_example</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-238"><a href="#GAMCoach.generate_cfs-238"><span class="linenos">238</span></a>            <span class="k">if</span> <span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-239"><a href="#GAMCoach.generate_cfs-239"><span class="linenos">239</span></a>                <span class="n">predicted_value</span> <span class="o">&gt;=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-240"><a href="#GAMCoach.generate_cfs-240"><span class="linenos">240</span></a>                <span class="ow">and</span> <span class="n">predicted_value</span> <span class="o">&lt;=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-241"><a href="#GAMCoach.generate_cfs-241"><span class="linenos">241</span></a>            <span class="p">):</span>
</span><span id="GAMCoach.generate_cfs-242"><a href="#GAMCoach.generate_cfs-242"><span class="linenos">242</span></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The target_range cannot cover the current prediction&quot;</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-243"><a href="#GAMCoach.generate_cfs-243"><span class="linenos">243</span></a>
</span><span id="GAMCoach.generate_cfs-244"><a href="#GAMCoach.generate_cfs-244"><span class="linenos">244</span></a>            <span class="k">elif</span> <span class="n">predicted_value</span> <span class="o">&lt;</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cfs-245"><a href="#GAMCoach.generate_cfs-245"><span class="linenos">245</span></a>                <span class="n">cf_direction</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="GAMCoach.generate_cfs-246"><a href="#GAMCoach.generate_cfs-246"><span class="linenos">246</span></a>                <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="GAMCoach.generate_cfs-247"><a href="#GAMCoach.generate_cfs-247"><span class="linenos">247</span></a>                <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="GAMCoach.generate_cfs-248"><a href="#GAMCoach.generate_cfs-248"><span class="linenos">248</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-249"><a href="#GAMCoach.generate_cfs-249"><span class="linenos">249</span></a>                <span class="n">cf_direction</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
</span><span id="GAMCoach.generate_cfs-250"><a href="#GAMCoach.generate_cfs-250"><span class="linenos">250</span></a>                <span class="n">needed_score_gain</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="GAMCoach.generate_cfs-251"><a href="#GAMCoach.generate_cfs-251"><span class="linenos">251</span></a>                <span class="n">score_gain_bound</span> <span class="o">=</span> <span class="n">target_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">predicted_value</span>
</span><span id="GAMCoach.generate_cfs-252"><a href="#GAMCoach.generate_cfs-252"><span class="linenos">252</span></a>
</span><span id="GAMCoach.generate_cfs-253"><a href="#GAMCoach.generate_cfs-253"><span class="linenos">253</span></a>        <span class="c1"># Step 2: Generate continuous and categorical options</span>
</span><span id="GAMCoach.generate_cfs-254"><a href="#GAMCoach.generate_cfs-254"><span class="linenos">254</span></a>        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach.generate_cfs-255"><a href="#GAMCoach.generate_cfs-255"><span class="linenos">255</span></a>
</span><span id="GAMCoach.generate_cfs-256"><a href="#GAMCoach.generate_cfs-256"><span class="linenos">256</span></a>        <span class="c1"># Generate a similarity threshold if it is not provided</span>
</span><span id="GAMCoach.generate_cfs-257"><a href="#GAMCoach.generate_cfs-257"><span class="linenos">257</span></a>        <span class="k">if</span> <span class="n">sim_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-258"><a href="#GAMCoach.generate_cfs-258"><span class="linenos">258</span></a>            <span class="n">additive_ranges</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cfs-259"><a href="#GAMCoach.generate_cfs-259"><span class="linenos">259</span></a>
</span><span id="GAMCoach.generate_cfs-260"><a href="#GAMCoach.generate_cfs-260"><span class="linenos">260</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cfs-261"><a href="#GAMCoach.generate_cfs-261"><span class="linenos">261</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-262"><a href="#GAMCoach.generate_cfs-262"><span class="linenos">262</span></a>                    <span class="n">cur_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-263"><a href="#GAMCoach.generate_cfs-263"><span class="linenos">263</span></a>                    <span class="n">additive_ranges</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cur_values</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">cur_values</span><span class="p">))</span>
</span><span id="GAMCoach.generate_cfs-264"><a href="#GAMCoach.generate_cfs-264"><span class="linenos">264</span></a>
</span><span id="GAMCoach.generate_cfs-265"><a href="#GAMCoach.generate_cfs-265"><span class="linenos">265</span></a>            <span class="n">sim_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">additive_ranges</span><span class="p">)</span> <span class="o">*</span> <span class="n">sim_threshold_factor</span>
</span><span id="GAMCoach.generate_cfs-266"><a href="#GAMCoach.generate_cfs-266"><span class="linenos">266</span></a>
</span><span id="GAMCoach.generate_cfs-267"><a href="#GAMCoach.generate_cfs-267"><span class="linenos">267</span></a>        <span class="c1"># To make it faster to solve the MILP problem, we can decrease the</span>
</span><span id="GAMCoach.generate_cfs-268"><a href="#GAMCoach.generate_cfs-268"><span class="linenos">268</span></a>        <span class="c1"># number of variables by filtering out unhelpful and redundant options</span>
</span><span id="GAMCoach.generate_cfs-269"><a href="#GAMCoach.generate_cfs-269"><span class="linenos">269</span></a>        <span class="c1">#</span>
</span><span id="GAMCoach.generate_cfs-270"><a href="#GAMCoach.generate_cfs-270"><span class="linenos">270</span></a>        <span class="c1"># (1) Unhelpful options: options that move the score to an undesirable</span>
</span><span id="GAMCoach.generate_cfs-271"><a href="#GAMCoach.generate_cfs-271"><span class="linenos">271</span></a>        <span class="c1"># direction. For example, if we want to flip 0 to 1, options that decrease</span>
</span><span id="GAMCoach.generate_cfs-272"><a href="#GAMCoach.generate_cfs-272"><span class="linenos">272</span></a>        <span class="c1"># the score are unhelpful.</span>
</span><span id="GAMCoach.generate_cfs-273"><a href="#GAMCoach.generate_cfs-273"><span class="linenos">273</span></a>        <span class="c1">#</span>
</span><span id="GAMCoach.generate_cfs-274"><a href="#GAMCoach.generate_cfs-274"><span class="linenos">274</span></a>        <span class="c1"># (2) Redundant options: for a set of options that give similar score</span>
</span><span id="GAMCoach.generate_cfs-275"><a href="#GAMCoach.generate_cfs-275"><span class="linenos">275</span></a>        <span class="c1"># gains (bounded by a parameter epsilon), we only need to incldue one</span>
</span><span id="GAMCoach.generate_cfs-276"><a href="#GAMCoach.generate_cfs-276"><span class="linenos">276</span></a>        <span class="c1"># option that has the lowest distance. This is only relevant for</span>
</span><span id="GAMCoach.generate_cfs-277"><a href="#GAMCoach.generate_cfs-277"><span class="linenos">277</span></a>        <span class="c1"># continuous variables. Users can set the parameter epsilon. The default</span>
</span><span id="GAMCoach.generate_cfs-278"><a href="#GAMCoach.generate_cfs-278"><span class="linenos">278</span></a>        <span class="c1"># should be relatively small, otherwise we might miss the optimal solution.</span>
</span><span id="GAMCoach.generate_cfs-279"><a href="#GAMCoach.generate_cfs-279"><span class="linenos">279</span></a>
</span><span id="GAMCoach.generate_cfs-280"><a href="#GAMCoach.generate_cfs-280"><span class="linenos">280</span></a>        <span class="c1"># Step 2.1: Find all good options from continuous and categorical features</span>
</span><span id="GAMCoach.generate_cfs-281"><a href="#GAMCoach.generate_cfs-281"><span class="linenos">281</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cfs-282"><a href="#GAMCoach.generate_cfs-282"><span class="linenos">282</span></a>
</span><span id="GAMCoach.generate_cfs-283"><a href="#GAMCoach.generate_cfs-283"><span class="linenos">283</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-284"><a href="#GAMCoach.generate_cfs-284"><span class="linenos">284</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-285"><a href="#GAMCoach.generate_cfs-285"><span class="linenos">285</span></a>            <span class="n">cur_feature_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-286"><a href="#GAMCoach.generate_cfs-286"><span class="linenos">286</span></a>
</span><span id="GAMCoach.generate_cfs-287"><a href="#GAMCoach.generate_cfs-287"><span class="linenos">287</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-288"><a href="#GAMCoach.generate_cfs-288"><span class="linenos">288</span></a>                <span class="k">continue</span>
</span><span id="GAMCoach.generate_cfs-289"><a href="#GAMCoach.generate_cfs-289"><span class="linenos">289</span></a>
</span><span id="GAMCoach.generate_cfs-290"><a href="#GAMCoach.generate_cfs-290"><span class="linenos">290</span></a>            <span class="k">elif</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-291"><a href="#GAMCoach.generate_cfs-291"><span class="linenos">291</span></a>                <span class="c1"># The parameter epsilon controls the threshold of how we determine</span>
</span><span id="GAMCoach.generate_cfs-292"><a href="#GAMCoach.generate_cfs-292"><span class="linenos">292</span></a>                <span class="c1"># &quot;similar&quot; options for continuous variables</span>
</span><span id="GAMCoach.generate_cfs-293"><a href="#GAMCoach.generate_cfs-293"><span class="linenos">293</span></a>                <span class="n">epsilon</span> <span class="o">=</span> <span class="n">sim_threshold</span>
</span><span id="GAMCoach.generate_cfs-294"><a href="#GAMCoach.generate_cfs-294"><span class="linenos">294</span></a>
</span><span id="GAMCoach.generate_cfs-295"><a href="#GAMCoach.generate_cfs-295"><span class="linenos">295</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-296"><a href="#GAMCoach.generate_cfs-296"><span class="linenos">296</span></a>                <span class="n">cur_feature_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cur_feature_id</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cfs-297"><a href="#GAMCoach.generate_cfs-297"><span class="linenos">297</span></a>
</span><span id="GAMCoach.generate_cfs-298"><a href="#GAMCoach.generate_cfs-298"><span class="linenos">298</span></a>                <span class="c1"># Users can require the continuous feature to have integer values</span>
</span><span id="GAMCoach.generate_cfs-299"><a href="#GAMCoach.generate_cfs-299"><span class="linenos">299</span></a>                <span class="c1"># For example, age, FICO score, and number of accounts</span>
</span><span id="GAMCoach.generate_cfs-300"><a href="#GAMCoach.generate_cfs-300"><span class="linenos">300</span></a>                <span class="n">need_to_be_int</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GAMCoach.generate_cfs-301"><a href="#GAMCoach.generate_cfs-301"><span class="linenos">301</span></a>                <span class="k">if</span> <span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-302"><a href="#GAMCoach.generate_cfs-302"><span class="linenos">302</span></a>                    <span class="n">continuous_integer_features</span>
</span><span id="GAMCoach.generate_cfs-303"><a href="#GAMCoach.generate_cfs-303"><span class="linenos">303</span></a>                    <span class="ow">and</span> <span class="n">cur_feature_name</span> <span class="ow">in</span> <span class="n">continuous_integer_features</span>
</span><span id="GAMCoach.generate_cfs-304"><a href="#GAMCoach.generate_cfs-304"><span class="linenos">304</span></a>                <span class="p">):</span>
</span><span id="GAMCoach.generate_cfs-305"><a href="#GAMCoach.generate_cfs-305"><span class="linenos">305</span></a>                    <span class="n">need_to_be_int</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="GAMCoach.generate_cfs-306"><a href="#GAMCoach.generate_cfs-306"><span class="linenos">306</span></a>
</span><span id="GAMCoach.generate_cfs-307"><a href="#GAMCoach.generate_cfs-307"><span class="linenos">307</span></a>                <span class="n">cur_cont_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cont_options</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-308"><a href="#GAMCoach.generate_cfs-308"><span class="linenos">308</span></a>                    <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-309"><a href="#GAMCoach.generate_cfs-309"><span class="linenos">309</span></a>                    <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-310"><a href="#GAMCoach.generate_cfs-310"><span class="linenos">310</span></a>                    <span class="n">cur_feature_name</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-311"><a href="#GAMCoach.generate_cfs-311"><span class="linenos">311</span></a>                    <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-312"><a href="#GAMCoach.generate_cfs-312"><span class="linenos">312</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-313"><a href="#GAMCoach.generate_cfs-313"><span class="linenos">313</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cont_mads</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-314"><a href="#GAMCoach.generate_cfs-314"><span class="linenos">314</span></a>                    <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="GAMCoach.generate_cfs-315"><a href="#GAMCoach.generate_cfs-315"><span class="linenos">315</span></a>                    <span class="n">score_gain_bound</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-316"><a href="#GAMCoach.generate_cfs-316"><span class="linenos">316</span></a>                    <span class="n">epsilon</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-317"><a href="#GAMCoach.generate_cfs-317"><span class="linenos">317</span></a>                    <span class="n">need_to_be_int</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-318"><a href="#GAMCoach.generate_cfs-318"><span class="linenos">318</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-319"><a href="#GAMCoach.generate_cfs-319"><span class="linenos">319</span></a>
</span><span id="GAMCoach.generate_cfs-320"><a href="#GAMCoach.generate_cfs-320"><span class="linenos">320</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_cont_options</span>
</span><span id="GAMCoach.generate_cfs-321"><a href="#GAMCoach.generate_cfs-321"><span class="linenos">321</span></a>
</span><span id="GAMCoach.generate_cfs-322"><a href="#GAMCoach.generate_cfs-322"><span class="linenos">322</span></a>            <span class="k">elif</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-323"><a href="#GAMCoach.generate_cfs-323"><span class="linenos">323</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-324"><a href="#GAMCoach.generate_cfs-324"><span class="linenos">324</span></a>                <span class="n">cur_feature_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">cur_feature_id</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cfs-325"><a href="#GAMCoach.generate_cfs-325"><span class="linenos">325</span></a>                <span class="n">cur_cat_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_distances</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-326"><a href="#GAMCoach.generate_cfs-326"><span class="linenos">326</span></a>
</span><span id="GAMCoach.generate_cfs-327"><a href="#GAMCoach.generate_cfs-327"><span class="linenos">327</span></a>                <span class="n">cur_cat_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_cat_options</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-328"><a href="#GAMCoach.generate_cfs-328"><span class="linenos">328</span></a>                    <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-329"><a href="#GAMCoach.generate_cfs-329"><span class="linenos">329</span></a>                    <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-330"><a href="#GAMCoach.generate_cfs-330"><span class="linenos">330</span></a>                    <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-331"><a href="#GAMCoach.generate_cfs-331"><span class="linenos">331</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-332"><a href="#GAMCoach.generate_cfs-332"><span class="linenos">332</span></a>                    <span class="n">cur_cat_distance</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-333"><a href="#GAMCoach.generate_cfs-333"><span class="linenos">333</span></a>                    <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="GAMCoach.generate_cfs-334"><a href="#GAMCoach.generate_cfs-334"><span class="linenos">334</span></a>                    <span class="n">score_gain_bound</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-335"><a href="#GAMCoach.generate_cfs-335"><span class="linenos">335</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-336"><a href="#GAMCoach.generate_cfs-336"><span class="linenos">336</span></a>
</span><span id="GAMCoach.generate_cfs-337"><a href="#GAMCoach.generate_cfs-337"><span class="linenos">337</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_cat_options</span>
</span><span id="GAMCoach.generate_cfs-338"><a href="#GAMCoach.generate_cfs-338"><span class="linenos">338</span></a>
</span><span id="GAMCoach.generate_cfs-339"><a href="#GAMCoach.generate_cfs-339"><span class="linenos">339</span></a>        <span class="c1"># Step 2.2: Filter out undesired options (based on the feature_range)</span>
</span><span id="GAMCoach.generate_cfs-340"><a href="#GAMCoach.generate_cfs-340"><span class="linenos">340</span></a>        <span class="k">if</span> <span class="n">feature_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-341"><a href="#GAMCoach.generate_cfs-341"><span class="linenos">341</span></a>            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">feature_ranges</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-342"><a href="#GAMCoach.generate_cfs-342"><span class="linenos">342</span></a>                <span class="n">cur_range</span> <span class="o">=</span> <span class="n">feature_ranges</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-343"><a href="#GAMCoach.generate_cfs-343"><span class="linenos">343</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-344"><a href="#GAMCoach.generate_cfs-344"><span class="linenos">344</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-345"><a href="#GAMCoach.generate_cfs-345"><span class="linenos">345</span></a>
</span><span id="GAMCoach.generate_cfs-346"><a href="#GAMCoach.generate_cfs-346"><span class="linenos">346</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-347"><a href="#GAMCoach.generate_cfs-347"><span class="linenos">347</span></a>                    <span class="c1"># Delete options that use out-of-range options</span>
</span><span id="GAMCoach.generate_cfs-348"><a href="#GAMCoach.generate_cfs-348"><span class="linenos">348</span></a>                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="GAMCoach.generate_cfs-349"><a href="#GAMCoach.generate_cfs-349"><span class="linenos">349</span></a>                        <span class="n">cur_target</span> <span class="o">=</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-350"><a href="#GAMCoach.generate_cfs-350"><span class="linenos">350</span></a>                        <span class="k">if</span> <span class="n">cur_target</span> <span class="o">&lt;</span> <span class="n">cur_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">cur_target</span> <span class="o">&gt;</span> <span class="n">cur_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cfs-351"><a href="#GAMCoach.generate_cfs-351"><span class="linenos">351</span></a>                            <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-352"><a href="#GAMCoach.generate_cfs-352"><span class="linenos">352</span></a>                <span class="k">elif</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-353"><a href="#GAMCoach.generate_cfs-353"><span class="linenos">353</span></a>                    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="GAMCoach.generate_cfs-354"><a href="#GAMCoach.generate_cfs-354"><span class="linenos">354</span></a>                        <span class="k">if</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">][</span><span class="n">o</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cur_range</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-355"><a href="#GAMCoach.generate_cfs-355"><span class="linenos">355</span></a>                            <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-356"><a href="#GAMCoach.generate_cfs-356"><span class="linenos">356</span></a>
</span><span id="GAMCoach.generate_cfs-357"><a href="#GAMCoach.generate_cfs-357"><span class="linenos">357</span></a>        <span class="c1"># Step 2.3: Compute the interaction offsets for all possible options</span>
</span><span id="GAMCoach.generate_cfs-358"><a href="#GAMCoach.generate_cfs-358"><span class="linenos">358</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cfs-359"><a href="#GAMCoach.generate_cfs-359"><span class="linenos">359</span></a>
</span><span id="GAMCoach.generate_cfs-360"><a href="#GAMCoach.generate_cfs-360"><span class="linenos">360</span></a>            <span class="n">cur_feature_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-361"><a href="#GAMCoach.generate_cfs-361"><span class="linenos">361</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-362"><a href="#GAMCoach.generate_cfs-362"><span class="linenos">362</span></a>
</span><span id="GAMCoach.generate_cfs-363"><a href="#GAMCoach.generate_cfs-363"><span class="linenos">363</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-364"><a href="#GAMCoach.generate_cfs-364"><span class="linenos">364</span></a>
</span><span id="GAMCoach.generate_cfs-365"><a href="#GAMCoach.generate_cfs-365"><span class="linenos">365</span></a>                <span class="n">cur_feature_index_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-366"><a href="#GAMCoach.generate_cfs-366"><span class="linenos">366</span></a>                <span class="n">cur_feature_index_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-367"><a href="#GAMCoach.generate_cfs-367"><span class="linenos">367</span></a>
</span><span id="GAMCoach.generate_cfs-368"><a href="#GAMCoach.generate_cfs-368"><span class="linenos">368</span></a>                <span class="n">cur_feature_score</span> <span class="o">=</span> <span class="n">cur_scores</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-369"><a href="#GAMCoach.generate_cfs-369"><span class="linenos">369</span></a>                <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_inter_options</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-370"><a href="#GAMCoach.generate_cfs-370"><span class="linenos">370</span></a>                    <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-371"><a href="#GAMCoach.generate_cfs-371"><span class="linenos">371</span></a>                    <span class="n">cur_feature_index_1</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-372"><a href="#GAMCoach.generate_cfs-372"><span class="linenos">372</span></a>                    <span class="n">cur_feature_index_2</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-373"><a href="#GAMCoach.generate_cfs-373"><span class="linenos">373</span></a>                    <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-374"><a href="#GAMCoach.generate_cfs-374"><span class="linenos">374</span></a>                    <span class="n">options</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-375"><a href="#GAMCoach.generate_cfs-375"><span class="linenos">375</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-376"><a href="#GAMCoach.generate_cfs-376"><span class="linenos">376</span></a>
</span><span id="GAMCoach.generate_cfs-377"><a href="#GAMCoach.generate_cfs-377"><span class="linenos">377</span></a>        <span class="c1"># Step 2.4: Rescale categorical distances so that they have the same mean</span>
</span><span id="GAMCoach.generate_cfs-378"><a href="#GAMCoach.generate_cfs-378"><span class="linenos">378</span></a>        <span class="c1"># as continuous variables (default)</span>
</span><span id="GAMCoach.generate_cfs-379"><a href="#GAMCoach.generate_cfs-379"><span class="linenos">379</span></a>        <span class="k">if</span> <span class="n">categorical_weight</span> <span class="o">==</span> <span class="s2">&quot;auto&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-380"><a href="#GAMCoach.generate_cfs-380"><span class="linenos">380</span></a>            <span class="n">cont_distances</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cfs-381"><a href="#GAMCoach.generate_cfs-381"><span class="linenos">381</span></a>            <span class="n">cat_distances</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cfs-382"><a href="#GAMCoach.generate_cfs-382"><span class="linenos">382</span></a>
</span><span id="GAMCoach.generate_cfs-383"><a href="#GAMCoach.generate_cfs-383"><span class="linenos">383</span></a>            <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-384"><a href="#GAMCoach.generate_cfs-384"><span class="linenos">384</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-385"><a href="#GAMCoach.generate_cfs-385"><span class="linenos">385</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-386"><a href="#GAMCoach.generate_cfs-386"><span class="linenos">386</span></a>
</span><span id="GAMCoach.generate_cfs-387"><a href="#GAMCoach.generate_cfs-387"><span class="linenos">387</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-388"><a href="#GAMCoach.generate_cfs-388"><span class="linenos">388</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cfs-389"><a href="#GAMCoach.generate_cfs-389"><span class="linenos">389</span></a>                        <span class="n">cont_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cfs-390"><a href="#GAMCoach.generate_cfs-390"><span class="linenos">390</span></a>                <span class="k">elif</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-391"><a href="#GAMCoach.generate_cfs-391"><span class="linenos">391</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cfs-392"><a href="#GAMCoach.generate_cfs-392"><span class="linenos">392</span></a>                        <span class="n">cat_distances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cfs-393"><a href="#GAMCoach.generate_cfs-393"><span class="linenos">393</span></a>
</span><span id="GAMCoach.generate_cfs-394"><a href="#GAMCoach.generate_cfs-394"><span class="linenos">394</span></a>            <span class="n">categorical_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cont_distances</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cat_distances</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-395"><a href="#GAMCoach.generate_cfs-395"><span class="linenos">395</span></a>
</span><span id="GAMCoach.generate_cfs-396"><a href="#GAMCoach.generate_cfs-396"><span class="linenos">396</span></a>        <span class="k">for</span> <span class="n">f_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-397"><a href="#GAMCoach.generate_cfs-397"><span class="linenos">397</span></a>            <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-398"><a href="#GAMCoach.generate_cfs-398"><span class="linenos">398</span></a>            <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cfs-399"><a href="#GAMCoach.generate_cfs-399"><span class="linenos">399</span></a>
</span><span id="GAMCoach.generate_cfs-400"><a href="#GAMCoach.generate_cfs-400"><span class="linenos">400</span></a>            <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-401"><a href="#GAMCoach.generate_cfs-401"><span class="linenos">401</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cfs-402"><a href="#GAMCoach.generate_cfs-402"><span class="linenos">402</span></a>                    <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">categorical_weight</span>
</span><span id="GAMCoach.generate_cfs-403"><a href="#GAMCoach.generate_cfs-403"><span class="linenos">403</span></a>
</span><span id="GAMCoach.generate_cfs-404"><a href="#GAMCoach.generate_cfs-404"><span class="linenos">404</span></a>        <span class="c1"># Step 3. Formulate the MILP model and solve it</span>
</span><span id="GAMCoach.generate_cfs-405"><a href="#GAMCoach.generate_cfs-405"><span class="linenos">405</span></a>
</span><span id="GAMCoach.generate_cfs-406"><a href="#GAMCoach.generate_cfs-406"><span class="linenos">406</span></a>        <span class="c1"># Find diverse solutions by accumulatively muting the optimal solutions</span>
</span><span id="GAMCoach.generate_cfs-407"><a href="#GAMCoach.generate_cfs-407"><span class="linenos">407</span></a>        <span class="n">solutions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cfs-408"><a href="#GAMCoach.generate_cfs-408"><span class="linenos">408</span></a>        <span class="n">muted_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cfs-409"><a href="#GAMCoach.generate_cfs-409"><span class="linenos">409</span></a>        <span class="n">is_successful</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="GAMCoach.generate_cfs-410"><a href="#GAMCoach.generate_cfs-410"><span class="linenos">410</span></a>
</span><span id="GAMCoach.generate_cfs-411"><a href="#GAMCoach.generate_cfs-411"><span class="linenos">411</span></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">total_cfs</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">verbose</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
</span><span id="GAMCoach.generate_cfs-412"><a href="#GAMCoach.generate_cfs-412"><span class="linenos">412</span></a>            <span class="n">model</span><span class="p">,</span> <span class="n">variables</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_milp</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-413"><a href="#GAMCoach.generate_cfs-413"><span class="linenos">413</span></a>                <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-414"><a href="#GAMCoach.generate_cfs-414"><span class="linenos">414</span></a>                <span class="n">needed_score_gain</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-415"><a href="#GAMCoach.generate_cfs-415"><span class="linenos">415</span></a>                <span class="n">features_to_vary</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-416"><a href="#GAMCoach.generate_cfs-416"><span class="linenos">416</span></a>                <span class="n">options</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-417"><a href="#GAMCoach.generate_cfs-417"><span class="linenos">417</span></a>                <span class="n">max_num_features_to_vary</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-418"><a href="#GAMCoach.generate_cfs-418"><span class="linenos">418</span></a>                <span class="n">muted_variables</span><span class="o">=</span><span class="n">muted_variables</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cfs-419"><a href="#GAMCoach.generate_cfs-419"><span class="linenos">419</span></a>            <span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-420"><a href="#GAMCoach.generate_cfs-420"><span class="linenos">420</span></a>
</span><span id="GAMCoach.generate_cfs-421"><a href="#GAMCoach.generate_cfs-421"><span class="linenos">421</span></a>            <span class="n">model</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">pulp</span><span class="o">.</span><span class="n">apis</span><span class="o">.</span><span class="n">PULP_CBC_CMD</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">warmStart</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
</span><span id="GAMCoach.generate_cfs-422"><a href="#GAMCoach.generate_cfs-422"><span class="linenos">422</span></a>
</span><span id="GAMCoach.generate_cfs-423"><a href="#GAMCoach.generate_cfs-423"><span class="linenos">423</span></a>            <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-424"><a href="#GAMCoach.generate_cfs-424"><span class="linenos">424</span></a>                <span class="n">is_successful</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="GAMCoach.generate_cfs-425"><a href="#GAMCoach.generate_cfs-425"><span class="linenos">425</span></a>
</span><span id="GAMCoach.generate_cfs-426"><a href="#GAMCoach.generate_cfs-426"><span class="linenos">426</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-427"><a href="#GAMCoach.generate_cfs-427"><span class="linenos">427</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;solver runs for </span><span class="si">{:.2f}</span><span class="s2"> seconds&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">solutionTime</span><span class="p">))</span>
</span><span id="GAMCoach.generate_cfs-428"><a href="#GAMCoach.generate_cfs-428"><span class="linenos">428</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;status: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pulp</span><span class="o">.</span><span class="n">LpStatus</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">status</span><span class="p">]))</span>
</span><span id="GAMCoach.generate_cfs-429"><a href="#GAMCoach.generate_cfs-429"><span class="linenos">429</span></a>
</span><span id="GAMCoach.generate_cfs-430"><a href="#GAMCoach.generate_cfs-430"><span class="linenos">430</span></a>            <span class="n">active_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cfs-431"><a href="#GAMCoach.generate_cfs-431"><span class="linenos">431</span></a>
</span><span id="GAMCoach.generate_cfs-432"><a href="#GAMCoach.generate_cfs-432"><span class="linenos">432</span></a>            <span class="c1"># Print the optimal solution</span>
</span><span id="GAMCoach.generate_cfs-433"><a href="#GAMCoach.generate_cfs-433"><span class="linenos">433</span></a>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-434"><a href="#GAMCoach.generate_cfs-434"><span class="linenos">434</span></a>                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cfs-435"><a href="#GAMCoach.generate_cfs-435"><span class="linenos">435</span></a>                    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">varValue</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-436"><a href="#GAMCoach.generate_cfs-436"><span class="linenos">436</span></a>                        <span class="n">active_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-437"><a href="#GAMCoach.generate_cfs-437"><span class="linenos">437</span></a>
</span><span id="GAMCoach.generate_cfs-438"><a href="#GAMCoach.generate_cfs-438"><span class="linenos">438</span></a>            <span class="k">if</span> <span class="n">verbose</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-439"><a href="#GAMCoach.generate_cfs-439"><span class="linenos">439</span></a>                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Found solutions:&quot;</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-440"><a href="#GAMCoach.generate_cfs-440"><span class="linenos">440</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">print_solution</span><span class="p">(</span><span class="n">cur_example</span><span class="p">,</span> <span class="n">active_variables</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-441"><a href="#GAMCoach.generate_cfs-441"><span class="linenos">441</span></a>
</span><span id="GAMCoach.generate_cfs-442"><a href="#GAMCoach.generate_cfs-442"><span class="linenos">442</span></a>            <span class="c1"># Collect the current solution and mute the associated variables</span>
</span><span id="GAMCoach.generate_cfs-443"><a href="#GAMCoach.generate_cfs-443"><span class="linenos">443</span></a>            <span class="n">solutions</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">active_variables</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">objective</span><span class="p">)])</span>
</span><span id="GAMCoach.generate_cfs-444"><a href="#GAMCoach.generate_cfs-444"><span class="linenos">444</span></a>
</span><span id="GAMCoach.generate_cfs-445"><a href="#GAMCoach.generate_cfs-445"><span class="linenos">445</span></a>            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">active_variables</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-446"><a href="#GAMCoach.generate_cfs-446"><span class="linenos">446</span></a>                <span class="k">if</span> <span class="s2">&quot; x &quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cfs-447"><a href="#GAMCoach.generate_cfs-447"><span class="linenos">447</span></a>                    <span class="n">muted_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-448"><a href="#GAMCoach.generate_cfs-448"><span class="linenos">448</span></a>
</span><span id="GAMCoach.generate_cfs-449"><a href="#GAMCoach.generate_cfs-449"><span class="linenos">449</span></a>        <span class="n">cfs</span> <span class="o">=</span> <span class="n">Counterfactuals</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cfs-450"><a href="#GAMCoach.generate_cfs-450"><span class="linenos">450</span></a>            <span class="n">solutions</span><span class="p">,</span> <span class="n">is_successful</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">variables</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="p">,</span> <span class="n">cur_example</span><span class="p">,</span> <span class="n">options</span>
</span><span id="GAMCoach.generate_cfs-451"><a href="#GAMCoach.generate_cfs-451"><span class="linenos">451</span></a>        <span class="p">)</span>
</span><span id="GAMCoach.generate_cfs-452"><a href="#GAMCoach.generate_cfs-452"><span class="linenos">452</span></a>
</span><span id="GAMCoach.generate_cfs-453"><a href="#GAMCoach.generate_cfs-453"><span class="linenos">453</span></a>        <span class="k">return</span> <span class="n">cfs</span>
</span></pre></div>


            <div class="docstring"><p>Generate counterfactual examples.</p>

<p>Use mixed-integer linear programming to generate optimal counterfactual
examples for the given data point.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>cur_example (np.ndarray):</strong>  The data point of interest. This function
aims to find similar examples that the model gives different
predictions.</li>
<li><strong>total_cfs (int, optional):</strong>  The total number of counterfactuals to,
generate. Default to 1.</li>
<li><strong>target_range (tuple, optional):</strong>  The targetted prediction range. This
parameter is required if the EBM is a regressor.</li>
<li><strong>sim_threshold_factor (float, optional):</strong>  A positive float to automatically
generate a similarity threshold. This parameter has no effect if
<code>sim_threshold</code> is provided. If <code>sim_threshold</code> is
not provided, we compute <code>sim_threshold</code> as <code>sim_threshold_factor</code>
<ul>
<li>average additive score range of all continuous features. If
<code>sim_threshold_factor</code> is too small, it takes longer time to
generate CFs. If <code>sim_threshold_factor</code> is too large, the
algorithm might miss some optimal CFs.</li>
</ul></li>
<li><strong>sim_threshold (float, optional):</strong>  A positive float to determine how we
decide if two bins of a continuous feature have similar scores.
Two bins $b_1$ and $b_2$ are similar (the distant one will be
removed) if $|b_1 - b_2| \leq$ <code>sim_threshold</code>.</li>
<li><strong>categorical_weight (Union[float, str], optional):</strong>  A positive float
to scale the distances of options for categorical variables. Since
we have very different distance functions for continuous and
categorical features, we need to scale them so they are at a
comparable range. To do that, we multiply the categorical feature's
distances by <code>categorical_weight</code>. By default ('auto'), we scale
the distances of categorical features so that they have the mean
distance as continuous features.</li>
<li><strong>features_to_vary ([str], optional):</strong>  A list of feature names that
the CFs can change. If it is <code>None</code>, this function will use all
features.</li>
<li><strong>max_num_features_to_vary (int, optional):</strong>  The max number of features
that the CF can vary. Default is no maximum.</li>
<li><strong>feature_ranges (dict, optional):</strong>  A dictionary to control the permitted
ranges/values for continuous/categorical features. It maps
<code>feature_name</code> -> [<code>min_value</code>, <code>max_value</code>] for continuous features,
<code>feature_name</code> -> [<code>level1</code>, <code>level2</code>, ...] for categorical features.</li>
<li><strong>continuous_integer_features (list, optional):</strong>  A list of names of
continuous features that need to be integers (e.g., age, FICO score)</li>
<li><strong>verbose (int):</strong>  0: no any output, 1: show progress bar, 2: show internal
optimization details</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>Counterfactuals: The generated counterfactual examples with their
      associated distances and change information.</p>
</blockquote>
</div>


                            </div>
                            <div id="GAMCoach.generate_cont_options" class="classattr">
                                        <input id="GAMCoach.generate_cont_options-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_cont_options</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">cf_direction</span>,</span><span class="param">	<span class="n">cur_feature_index</span>,</span><span class="param">	<span class="n">cur_feature_name</span>,</span><span class="param">	<span class="n">cur_feature_value</span>,</span><span class="param">	<span class="n">cur_feature_score</span>,</span><span class="param">	<span class="n">cont_mads</span>,</span><span class="param">	<span class="n">cur_example</span>,</span><span class="param">	<span class="n">score_gain_bound</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">epsilon</span><span class="o">=</span><span class="mf">0.005</span>,</span><span class="param">	<span class="n">need_to_be_int</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">skip_unhelpful</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GAMCoach.generate_cont_options-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.generate_cont_options"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.generate_cont_options-455"><a href="#GAMCoach.generate_cont_options-455"><span class="linenos">455</span></a>    <span class="k">def</span> <span class="nf">generate_cont_options</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-456"><a href="#GAMCoach.generate_cont_options-456"><span class="linenos">456</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-457"><a href="#GAMCoach.generate_cont_options-457"><span class="linenos">457</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-458"><a href="#GAMCoach.generate_cont_options-458"><span class="linenos">458</span></a>        <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-459"><a href="#GAMCoach.generate_cont_options-459"><span class="linenos">459</span></a>        <span class="n">cur_feature_name</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-460"><a href="#GAMCoach.generate_cont_options-460"><span class="linenos">460</span></a>        <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-461"><a href="#GAMCoach.generate_cont_options-461"><span class="linenos">461</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-462"><a href="#GAMCoach.generate_cont_options-462"><span class="linenos">462</span></a>        <span class="n">cont_mads</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-463"><a href="#GAMCoach.generate_cont_options-463"><span class="linenos">463</span></a>        <span class="n">cur_example</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-464"><a href="#GAMCoach.generate_cont_options-464"><span class="linenos">464</span></a>        <span class="n">score_gain_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-465"><a href="#GAMCoach.generate_cont_options-465"><span class="linenos">465</span></a>        <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-466"><a href="#GAMCoach.generate_cont_options-466"><span class="linenos">466</span></a>        <span class="n">need_to_be_int</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-467"><a href="#GAMCoach.generate_cont_options-467"><span class="linenos">467</span></a>        <span class="n">skip_unhelpful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-468"><a href="#GAMCoach.generate_cont_options-468"><span class="linenos">468</span></a>    <span class="p">):</span>
</span><span id="GAMCoach.generate_cont_options-469"><a href="#GAMCoach.generate_cont_options-469"><span class="linenos">469</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach.generate_cont_options-470"><a href="#GAMCoach.generate_cont_options-470"><span class="linenos">470</span></a><span class="sd">        Generate all alternative options for this continuous variable. This function</span>
</span><span id="GAMCoach.generate_cont_options-471"><a href="#GAMCoach.generate_cont_options-471"><span class="linenos">471</span></a><span class="sd">        would filter out all options that are:</span>
</span><span id="GAMCoach.generate_cont_options-472"><a href="#GAMCoach.generate_cont_options-472"><span class="linenos">472</span></a>
</span><span id="GAMCoach.generate_cont_options-473"><a href="#GAMCoach.generate_cont_options-473"><span class="linenos">473</span></a><span class="sd">        1. Not helpful for the counterfactual generation.</span>
</span><span id="GAMCoach.generate_cont_options-474"><a href="#GAMCoach.generate_cont_options-474"><span class="linenos">474</span></a><span class="sd">        2. Give similar score gain but requires larger distance.</span>
</span><span id="GAMCoach.generate_cont_options-475"><a href="#GAMCoach.generate_cont_options-475"><span class="linenos">475</span></a>
</span><span id="GAMCoach.generate_cont_options-476"><a href="#GAMCoach.generate_cont_options-476"><span class="linenos">476</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.generate_cont_options-477"><a href="#GAMCoach.generate_cont_options-477"><span class="linenos">477</span></a><span class="sd">            cf_direction (int): Integer `+1` if 0 =&gt; 1, `-1` if 1 =&gt; 0</span>
</span><span id="GAMCoach.generate_cont_options-478"><a href="#GAMCoach.generate_cont_options-478"><span class="linenos">478</span></a><span class="sd">                (classification); `+1` if we need to increase the prediction,</span>
</span><span id="GAMCoach.generate_cont_options-479"><a href="#GAMCoach.generate_cont_options-479"><span class="linenos">479</span></a><span class="sd">                `-1` if decrease (regression).</span>
</span><span id="GAMCoach.generate_cont_options-480"><a href="#GAMCoach.generate_cont_options-480"><span class="linenos">480</span></a><span class="sd">            cur_feature_index (int): The index of the current continuous feature.</span>
</span><span id="GAMCoach.generate_cont_options-481"><a href="#GAMCoach.generate_cont_options-481"><span class="linenos">481</span></a><span class="sd">            cur_feature_name (str): Name of the current feature.</span>
</span><span id="GAMCoach.generate_cont_options-482"><a href="#GAMCoach.generate_cont_options-482"><span class="linenos">482</span></a><span class="sd">            cur_feature_value (float): The current feature value.</span>
</span><span id="GAMCoach.generate_cont_options-483"><a href="#GAMCoach.generate_cont_options-483"><span class="linenos">483</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="GAMCoach.generate_cont_options-484"><a href="#GAMCoach.generate_cont_options-484"><span class="linenos">484</span></a><span class="sd">            cont_mads (dict): A map of feature_name =&gt; MAD score.</span>
</span><span id="GAMCoach.generate_cont_options-485"><a href="#GAMCoach.generate_cont_options-485"><span class="linenos">485</span></a><span class="sd">            cur_example (list): Current sample values</span>
</span><span id="GAMCoach.generate_cont_options-486"><a href="#GAMCoach.generate_cont_options-486"><span class="linenos">486</span></a><span class="sd">            score_gain_bound (float): Bound of the score gain. We do not collect</span>
</span><span id="GAMCoach.generate_cont_options-487"><a href="#GAMCoach.generate_cont_options-487"><span class="linenos">487</span></a><span class="sd">                options that give `score_gain` &gt; `score_gain_bound` (when</span>
</span><span id="GAMCoach.generate_cont_options-488"><a href="#GAMCoach.generate_cont_options-488"><span class="linenos">488</span></a><span class="sd">                `cf_direction=1`), or `score_gain` &lt; `score_gain_bound` (when</span>
</span><span id="GAMCoach.generate_cont_options-489"><a href="#GAMCoach.generate_cont_options-489"><span class="linenos">489</span></a><span class="sd">                `cf_direction=-1`)</span>
</span><span id="GAMCoach.generate_cont_options-490"><a href="#GAMCoach.generate_cont_options-490"><span class="linenos">490</span></a><span class="sd">            epsilon (float): The threshold to determine if two options give similar</span>
</span><span id="GAMCoach.generate_cont_options-491"><a href="#GAMCoach.generate_cont_options-491"><span class="linenos">491</span></a><span class="sd">                score gains. Score gains $s_1$ and $s_2$ are similar if</span>
</span><span id="GAMCoach.generate_cont_options-492"><a href="#GAMCoach.generate_cont_options-492"><span class="linenos">492</span></a><span class="sd">                $|s_1 - s_2| &lt;$ epsilon. Smaller epsilon significantly increases</span>
</span><span id="GAMCoach.generate_cont_options-493"><a href="#GAMCoach.generate_cont_options-493"><span class="linenos">493</span></a><span class="sd">                the time to solve the MILP. Large epsilon might filter out the</span>
</span><span id="GAMCoach.generate_cont_options-494"><a href="#GAMCoach.generate_cont_options-494"><span class="linenos">494</span></a><span class="sd">                optimal CF. Defaults to 0.005.</span>
</span><span id="GAMCoach.generate_cont_options-495"><a href="#GAMCoach.generate_cont_options-495"><span class="linenos">495</span></a><span class="sd">            need_to_be_int (bool): True if the target values for this continuous</span>
</span><span id="GAMCoach.generate_cont_options-496"><a href="#GAMCoach.generate_cont_options-496"><span class="linenos">496</span></a><span class="sd">                variable need to have integer values.</span>
</span><span id="GAMCoach.generate_cont_options-497"><a href="#GAMCoach.generate_cont_options-497"><span class="linenos">497</span></a><span class="sd">            skip_unhelpful (bool): True if to skip options from main</span>
</span><span id="GAMCoach.generate_cont_options-498"><a href="#GAMCoach.generate_cont_options-498"><span class="linenos">498</span></a><span class="sd">                effects that give opposite score gain. It is rare that there is a</span>
</span><span id="GAMCoach.generate_cont_options-499"><a href="#GAMCoach.generate_cont_options-499"><span class="linenos">499</span></a><span class="sd">                positive score gain from pair-interaction that outweigh negative</span>
</span><span id="GAMCoach.generate_cont_options-500"><a href="#GAMCoach.generate_cont_options-500"><span class="linenos">500</span></a><span class="sd">                score gain from two main effects, and adjusting the distance penalty.</span>
</span><span id="GAMCoach.generate_cont_options-501"><a href="#GAMCoach.generate_cont_options-501"><span class="linenos">501</span></a>
</span><span id="GAMCoach.generate_cont_options-502"><a href="#GAMCoach.generate_cont_options-502"><span class="linenos">502</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach.generate_cont_options-503"><a href="#GAMCoach.generate_cont_options-503"><span class="linenos">503</span></a><span class="sd">            list: List of option tuples (target, score gain, distance, bin_index)</span>
</span><span id="GAMCoach.generate_cont_options-504"><a href="#GAMCoach.generate_cont_options-504"><span class="linenos">504</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.generate_cont_options-505"><a href="#GAMCoach.generate_cont_options-505"><span class="linenos">505</span></a>
</span><span id="GAMCoach.generate_cont_options-506"><a href="#GAMCoach.generate_cont_options-506"><span class="linenos">506</span></a>        <span class="c1"># For each continuous feature, each bin is a variable</span>
</span><span id="GAMCoach.generate_cont_options-507"><a href="#GAMCoach.generate_cont_options-507"><span class="linenos">507</span></a>        <span class="c1"># For each bin, we need to compute (1) score gain, (2) distance</span>
</span><span id="GAMCoach.generate_cont_options-508"><a href="#GAMCoach.generate_cont_options-508"><span class="linenos">508</span></a>        <span class="c1"># (1) score gain is the difference between new bin and current bin</span>
</span><span id="GAMCoach.generate_cont_options-509"><a href="#GAMCoach.generate_cont_options-509"><span class="linenos">509</span></a>        <span class="c1"># (2) distance is L1 distance divided by median absolute deviation (MAD)</span>
</span><span id="GAMCoach.generate_cont_options-510"><a href="#GAMCoach.generate_cont_options-510"><span class="linenos">510</span></a>
</span><span id="GAMCoach.generate_cont_options-511"><a href="#GAMCoach.generate_cont_options-511"><span class="linenos">511</span></a>        <span class="c1"># Get the additive scores of this feature</span>
</span><span id="GAMCoach.generate_cont_options-512"><a href="#GAMCoach.generate_cont_options-512"><span class="linenos">512</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_index</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach.generate_cont_options-513"><a href="#GAMCoach.generate_cont_options-513"><span class="linenos">513</span></a>
</span><span id="GAMCoach.generate_cont_options-514"><a href="#GAMCoach.generate_cont_options-514"><span class="linenos">514</span></a>        <span class="c1"># Get the bin edges of this feature</span>
</span><span id="GAMCoach.generate_cont_options-515"><a href="#GAMCoach.generate_cont_options-515"><span class="linenos">515</span></a>        <span class="n">bin_starts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_feature_index</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-516"><a href="#GAMCoach.generate_cont_options-516"><span class="linenos">516</span></a>
</span><span id="GAMCoach.generate_cont_options-517"><a href="#GAMCoach.generate_cont_options-517"><span class="linenos">517</span></a>        <span class="c1"># Create &quot;options&quot;, each option is a tuple (target, score_gain, distance,</span>
</span><span id="GAMCoach.generate_cont_options-518"><a href="#GAMCoach.generate_cont_options-518"><span class="linenos">518</span></a>        <span class="c1"># bin_index)</span>
</span><span id="GAMCoach.generate_cont_options-519"><a href="#GAMCoach.generate_cont_options-519"><span class="linenos">519</span></a>        <span class="n">cont_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cont_options-520"><a href="#GAMCoach.generate_cont_options-520"><span class="linenos">520</span></a>
</span><span id="GAMCoach.generate_cont_options-521"><a href="#GAMCoach.generate_cont_options-521"><span class="linenos">521</span></a>        <span class="c1"># Identify which bin this value falls into</span>
</span><span id="GAMCoach.generate_cont_options-522"><a href="#GAMCoach.generate_cont_options-522"><span class="linenos">522</span></a>        <span class="n">cur_bin_id</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">,</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-523"><a href="#GAMCoach.generate_cont_options-523"><span class="linenos">523</span></a>        <span class="k">assert</span> <span class="n">additives</span><span class="p">[</span><span class="n">cur_bin_id</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_score</span>
</span><span id="GAMCoach.generate_cont_options-524"><a href="#GAMCoach.generate_cont_options-524"><span class="linenos">524</span></a>
</span><span id="GAMCoach.generate_cont_options-525"><a href="#GAMCoach.generate_cont_options-525"><span class="linenos">525</span></a>        <span class="c1"># Identify interaction terms that we need to consider</span>
</span><span id="GAMCoach.generate_cont_options-526"><a href="#GAMCoach.generate_cont_options-526"><span class="linenos">526</span></a>        <span class="n">associated_interactions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cont_options-527"><a href="#GAMCoach.generate_cont_options-527"><span class="linenos">527</span></a>
</span><span id="GAMCoach.generate_cont_options-528"><a href="#GAMCoach.generate_cont_options-528"><span class="linenos">528</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cont_options-529"><a href="#GAMCoach.generate_cont_options-529"><span class="linenos">529</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-530"><a href="#GAMCoach.generate_cont_options-530"><span class="linenos">530</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-531"><a href="#GAMCoach.generate_cont_options-531"><span class="linenos">531</span></a>
</span><span id="GAMCoach.generate_cont_options-532"><a href="#GAMCoach.generate_cont_options-532"><span class="linenos">532</span></a>                <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-533"><a href="#GAMCoach.generate_cont_options-533"><span class="linenos">533</span></a>
</span><span id="GAMCoach.generate_cont_options-534"><a href="#GAMCoach.generate_cont_options-534"><span class="linenos">534</span></a>                <span class="k">if</span> <span class="n">cur_feature_index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-535"><a href="#GAMCoach.generate_cont_options-535"><span class="linenos">535</span></a>                    <span class="n">feature_position</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_index</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="GAMCoach.generate_cont_options-536"><a href="#GAMCoach.generate_cont_options-536"><span class="linenos">536</span></a>
</span><span id="GAMCoach.generate_cont_options-537"><a href="#GAMCoach.generate_cont_options-537"><span class="linenos">537</span></a>                    <span class="n">other_position</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">feature_position</span>
</span><span id="GAMCoach.generate_cont_options-538"><a href="#GAMCoach.generate_cont_options-538"><span class="linenos">538</span></a>                    <span class="n">other_index</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">other_position</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-539"><a href="#GAMCoach.generate_cont_options-539"><span class="linenos">539</span></a>                    <span class="n">other_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-540"><a href="#GAMCoach.generate_cont_options-540"><span class="linenos">540</span></a>
</span><span id="GAMCoach.generate_cont_options-541"><a href="#GAMCoach.generate_cont_options-541"><span class="linenos">541</span></a>                    <span class="c1"># Get the current additive scores and bin edges</span>
</span><span id="GAMCoach.generate_cont_options-542"><a href="#GAMCoach.generate_cont_options-542"><span class="linenos">542</span></a>                    <span class="n">inter_additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach.generate_cont_options-543"><a href="#GAMCoach.generate_cont_options-543"><span class="linenos">543</span></a>
</span><span id="GAMCoach.generate_cont_options-544"><a href="#GAMCoach.generate_cont_options-544"><span class="linenos">544</span></a>                    <span class="c1"># Have to skip the max edge if it is continuous</span>
</span><span id="GAMCoach.generate_cont_options-545"><a href="#GAMCoach.generate_cont_options-545"><span class="linenos">545</span></a>                    <span class="n">bin_starts_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-546"><a href="#GAMCoach.generate_cont_options-546"><span class="linenos">546</span></a>                        <span class="n">cur_feature_index</span>
</span><span id="GAMCoach.generate_cont_options-547"><a href="#GAMCoach.generate_cont_options-547"><span class="linenos">547</span></a>                    <span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-548"><a href="#GAMCoach.generate_cont_options-548"><span class="linenos">548</span></a>
</span><span id="GAMCoach.generate_cont_options-549"><a href="#GAMCoach.generate_cont_options-549"><span class="linenos">549</span></a>                    <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-550"><a href="#GAMCoach.generate_cont_options-550"><span class="linenos">550</span></a>                        <span class="n">other_index</span>
</span><span id="GAMCoach.generate_cont_options-551"><a href="#GAMCoach.generate_cont_options-551"><span class="linenos">551</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-552"><a href="#GAMCoach.generate_cont_options-552"><span class="linenos">552</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-553"><a href="#GAMCoach.generate_cont_options-553"><span class="linenos">553</span></a>                        <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-554"><a href="#GAMCoach.generate_cont_options-554"><span class="linenos">554</span></a>
</span><span id="GAMCoach.generate_cont_options-555"><a href="#GAMCoach.generate_cont_options-555"><span class="linenos">555</span></a>                    <span class="c1"># Get the current interaction term score</span>
</span><span id="GAMCoach.generate_cont_options-556"><a href="#GAMCoach.generate_cont_options-556"><span class="linenos">556</span></a>                    <span class="n">other_bin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach.generate_cont_options-557"><a href="#GAMCoach.generate_cont_options-557"><span class="linenos">557</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-558"><a href="#GAMCoach.generate_cont_options-558"><span class="linenos">558</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-559"><a href="#GAMCoach.generate_cont_options-559"><span class="linenos">559</span></a>                            <span class="n">bin_starts_other</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cont_options-560"><a href="#GAMCoach.generate_cont_options-560"><span class="linenos">560</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-561"><a href="#GAMCoach.generate_cont_options-561"><span class="linenos">561</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-562"><a href="#GAMCoach.generate_cont_options-562"><span class="linenos">562</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cont_options-563"><a href="#GAMCoach.generate_cont_options-563"><span class="linenos">563</span></a>
</span><span id="GAMCoach.generate_cont_options-564"><a href="#GAMCoach.generate_cont_options-564"><span class="linenos">564</span></a>                    <span class="n">feature_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-565"><a href="#GAMCoach.generate_cont_options-565"><span class="linenos">565</span></a>                        <span class="n">bin_starts_feature</span><span class="p">,</span> <span class="n">cur_feature_value</span>
</span><span id="GAMCoach.generate_cont_options-566"><a href="#GAMCoach.generate_cont_options-566"><span class="linenos">566</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-567"><a href="#GAMCoach.generate_cont_options-567"><span class="linenos">567</span></a>
</span><span id="GAMCoach.generate_cont_options-568"><a href="#GAMCoach.generate_cont_options-568"><span class="linenos">568</span></a>                    <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach.generate_cont_options-569"><a href="#GAMCoach.generate_cont_options-569"><span class="linenos">569</span></a>
</span><span id="GAMCoach.generate_cont_options-570"><a href="#GAMCoach.generate_cont_options-570"><span class="linenos">570</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-571"><a href="#GAMCoach.generate_cont_options-571"><span class="linenos">571</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">feature_bin</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-572"><a href="#GAMCoach.generate_cont_options-572"><span class="linenos">572</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-573"><a href="#GAMCoach.generate_cont_options-573"><span class="linenos">573</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">feature_bin</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-574"><a href="#GAMCoach.generate_cont_options-574"><span class="linenos">574</span></a>
</span><span id="GAMCoach.generate_cont_options-575"><a href="#GAMCoach.generate_cont_options-575"><span class="linenos">575</span></a>                    <span class="c1"># Extract the row or column where we fix the other feature and</span>
</span><span id="GAMCoach.generate_cont_options-576"><a href="#GAMCoach.generate_cont_options-576"><span class="linenos">576</span></a>                    <span class="c1"># vary the current feature</span>
</span><span id="GAMCoach.generate_cont_options-577"><a href="#GAMCoach.generate_cont_options-577"><span class="linenos">577</span></a>                    <span class="n">feature_inter_bin_starts</span> <span class="o">=</span> <span class="n">bin_starts_feature</span>
</span><span id="GAMCoach.generate_cont_options-578"><a href="#GAMCoach.generate_cont_options-578"><span class="linenos">578</span></a>                    <span class="n">feature_inter_additives</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cont_options-579"><a href="#GAMCoach.generate_cont_options-579"><span class="linenos">579</span></a>
</span><span id="GAMCoach.generate_cont_options-580"><a href="#GAMCoach.generate_cont_options-580"><span class="linenos">580</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-581"><a href="#GAMCoach.generate_cont_options-581"><span class="linenos">581</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cont_options-582"><a href="#GAMCoach.generate_cont_options-582"><span class="linenos">582</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-583"><a href="#GAMCoach.generate_cont_options-583"><span class="linenos">583</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-584"><a href="#GAMCoach.generate_cont_options-584"><span class="linenos">584</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-585"><a href="#GAMCoach.generate_cont_options-585"><span class="linenos">585</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-586"><a href="#GAMCoach.generate_cont_options-586"><span class="linenos">586</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span><span id="GAMCoach.generate_cont_options-587"><a href="#GAMCoach.generate_cont_options-587"><span class="linenos">587</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-588"><a href="#GAMCoach.generate_cont_options-588"><span class="linenos">588</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-589"><a href="#GAMCoach.generate_cont_options-589"><span class="linenos">589</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-590"><a href="#GAMCoach.generate_cont_options-590"><span class="linenos">590</span></a>
</span><span id="GAMCoach.generate_cont_options-591"><a href="#GAMCoach.generate_cont_options-591"><span class="linenos">591</span></a>                    <span class="c1"># Register this interaction term</span>
</span><span id="GAMCoach.generate_cont_options-592"><a href="#GAMCoach.generate_cont_options-592"><span class="linenos">592</span></a>                    <span class="n">associated_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-593"><a href="#GAMCoach.generate_cont_options-593"><span class="linenos">593</span></a>                        <span class="p">{</span>
</span><span id="GAMCoach.generate_cont_options-594"><a href="#GAMCoach.generate_cont_options-594"><span class="linenos">594</span></a>                            <span class="s2">&quot;inter_index&quot;</span><span class="p">:</span> <span class="n">indexes</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-595"><a href="#GAMCoach.generate_cont_options-595"><span class="linenos">595</span></a>                            <span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">:</span> <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-596"><a href="#GAMCoach.generate_cont_options-596"><span class="linenos">596</span></a>                            <span class="s2">&quot;feature_inter_score&quot;</span><span class="p">:</span> <span class="n">feature_inter_score</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-597"><a href="#GAMCoach.generate_cont_options-597"><span class="linenos">597</span></a>                            <span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">:</span> <span class="n">feature_inter_bin_starts</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-598"><a href="#GAMCoach.generate_cont_options-598"><span class="linenos">598</span></a>                            <span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">:</span> <span class="n">feature_inter_additives</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cont_options-599"><a href="#GAMCoach.generate_cont_options-599"><span class="linenos">599</span></a>                        <span class="p">}</span>
</span><span id="GAMCoach.generate_cont_options-600"><a href="#GAMCoach.generate_cont_options-600"><span class="linenos">600</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-601"><a href="#GAMCoach.generate_cont_options-601"><span class="linenos">601</span></a>
</span><span id="GAMCoach.generate_cont_options-602"><a href="#GAMCoach.generate_cont_options-602"><span class="linenos">602</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cont_options-603"><a href="#GAMCoach.generate_cont_options-603"><span class="linenos">603</span></a>            <span class="c1"># Because of the special binning structure of EBM, the distance of</span>
</span><span id="GAMCoach.generate_cont_options-604"><a href="#GAMCoach.generate_cont_options-604"><span class="linenos">604</span></a>            <span class="c1"># bins on the left to the current value is different from the bins</span>
</span><span id="GAMCoach.generate_cont_options-605"><a href="#GAMCoach.generate_cont_options-605"><span class="linenos">605</span></a>            <span class="c1"># that are on the right</span>
</span><span id="GAMCoach.generate_cont_options-606"><a href="#GAMCoach.generate_cont_options-606"><span class="linenos">606</span></a>            <span class="c1">#</span>
</span><span id="GAMCoach.generate_cont_options-607"><a href="#GAMCoach.generate_cont_options-607"><span class="linenos">607</span></a>            <span class="c1"># For bins on the left, the raw distance is abs(bin_start[i + 1] - x)</span>
</span><span id="GAMCoach.generate_cont_options-608"><a href="#GAMCoach.generate_cont_options-608"><span class="linenos">608</span></a>            <span class="c1"># For bins on the right, the raw distance is abs(bin_start[i] - x)</span>
</span><span id="GAMCoach.generate_cont_options-609"><a href="#GAMCoach.generate_cont_options-609"><span class="linenos">609</span></a>            <span class="n">target</span> <span class="o">=</span> <span class="n">cur_feature_value</span>
</span><span id="GAMCoach.generate_cont_options-610"><a href="#GAMCoach.generate_cont_options-610"><span class="linenos">610</span></a>            <span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach.generate_cont_options-611"><a href="#GAMCoach.generate_cont_options-611"><span class="linenos">611</span></a>
</span><span id="GAMCoach.generate_cont_options-612"><a href="#GAMCoach.generate_cont_options-612"><span class="linenos">612</span></a>            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cur_bin_id</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-613"><a href="#GAMCoach.generate_cont_options-613"><span class="linenos">613</span></a>                <span class="c1"># First need to consider if it is need to be an integer</span>
</span><span id="GAMCoach.generate_cont_options-614"><a href="#GAMCoach.generate_cont_options-614"><span class="linenos">614</span></a>                <span class="c1"># If so, it would be the closest integer to the right point</span>
</span><span id="GAMCoach.generate_cont_options-615"><a href="#GAMCoach.generate_cont_options-615"><span class="linenos">615</span></a>                <span class="k">if</span> <span class="n">need_to_be_int</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-616"><a href="#GAMCoach.generate_cont_options-616"><span class="linenos">616</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
</span><span id="GAMCoach.generate_cont_options-617"><a href="#GAMCoach.generate_cont_options-617"><span class="linenos">617</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cont_options-618"><a href="#GAMCoach.generate_cont_options-618"><span class="linenos">618</span></a>                        <span class="n">target</span> <span class="o">-=</span> <span class="mi">1</span>
</span><span id="GAMCoach.generate_cont_options-619"><a href="#GAMCoach.generate_cont_options-619"><span class="linenos">619</span></a>
</span><span id="GAMCoach.generate_cont_options-620"><a href="#GAMCoach.generate_cont_options-620"><span class="linenos">620</span></a>                    <span class="c1"># Skip this option if it is not possible to find an int value</span>
</span><span id="GAMCoach.generate_cont_options-621"><a href="#GAMCoach.generate_cont_options-621"><span class="linenos">621</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cont_options-622"><a href="#GAMCoach.generate_cont_options-622"><span class="linenos">622</span></a>                        <span class="k">continue</span>
</span><span id="GAMCoach.generate_cont_options-623"><a href="#GAMCoach.generate_cont_options-623"><span class="linenos">623</span></a>
</span><span id="GAMCoach.generate_cont_options-624"><a href="#GAMCoach.generate_cont_options-624"><span class="linenos">624</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-625"><a href="#GAMCoach.generate_cont_options-625"><span class="linenos">625</span></a>
</span><span id="GAMCoach.generate_cont_options-626"><a href="#GAMCoach.generate_cont_options-626"><span class="linenos">626</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-627"><a href="#GAMCoach.generate_cont_options-627"><span class="linenos">627</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-628"><a href="#GAMCoach.generate_cont_options-628"><span class="linenos">628</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-629"><a href="#GAMCoach.generate_cont_options-629"><span class="linenos">629</span></a>
</span><span id="GAMCoach.generate_cont_options-630"><a href="#GAMCoach.generate_cont_options-630"><span class="linenos">630</span></a>                    <span class="c1"># Subtract a very smaller value to make the target</span>
</span><span id="GAMCoach.generate_cont_options-631"><a href="#GAMCoach.generate_cont_options-631"><span class="linenos">631</span></a>                    <span class="c1"># technically fall into the left bin</span>
</span><span id="GAMCoach.generate_cont_options-632"><a href="#GAMCoach.generate_cont_options-632"><span class="linenos">632</span></a>                    <span class="n">target</span> <span class="o">-=</span> <span class="mf">1e-4</span>
</span><span id="GAMCoach.generate_cont_options-633"><a href="#GAMCoach.generate_cont_options-633"><span class="linenos">633</span></a>
</span><span id="GAMCoach.generate_cont_options-634"><a href="#GAMCoach.generate_cont_options-634"><span class="linenos">634</span></a>            <span class="k">elif</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">cur_bin_id</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-635"><a href="#GAMCoach.generate_cont_options-635"><span class="linenos">635</span></a>                <span class="c1"># First need to consider if it should be an integer value</span>
</span><span id="GAMCoach.generate_cont_options-636"><a href="#GAMCoach.generate_cont_options-636"><span class="linenos">636</span></a>                <span class="c1"># If so, it would be the closest integer to the left point</span>
</span><span id="GAMCoach.generate_cont_options-637"><a href="#GAMCoach.generate_cont_options-637"><span class="linenos">637</span></a>                <span class="k">if</span> <span class="n">need_to_be_int</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-638"><a href="#GAMCoach.generate_cont_options-638"><span class="linenos">638</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
</span><span id="GAMCoach.generate_cont_options-639"><a href="#GAMCoach.generate_cont_options-639"><span class="linenos">639</span></a>                    <span class="k">if</span> <span class="n">target</span> <span class="o">==</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cont_options-640"><a href="#GAMCoach.generate_cont_options-640"><span class="linenos">640</span></a>                        <span class="n">target</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="GAMCoach.generate_cont_options-641"><a href="#GAMCoach.generate_cont_options-641"><span class="linenos">641</span></a>
</span><span id="GAMCoach.generate_cont_options-642"><a href="#GAMCoach.generate_cont_options-642"><span class="linenos">642</span></a>                    <span class="c1"># Skip this option if it is not possible to find an int value</span>
</span><span id="GAMCoach.generate_cont_options-643"><a href="#GAMCoach.generate_cont_options-643"><span class="linenos">643</span></a>                    <span class="k">if</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)</span> <span class="ow">and</span> <span class="n">target</span> <span class="o">&gt;=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_cont_options-644"><a href="#GAMCoach.generate_cont_options-644"><span class="linenos">644</span></a>                        <span class="k">continue</span>
</span><span id="GAMCoach.generate_cont_options-645"><a href="#GAMCoach.generate_cont_options-645"><span class="linenos">645</span></a>
</span><span id="GAMCoach.generate_cont_options-646"><a href="#GAMCoach.generate_cont_options-646"><span class="linenos">646</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-647"><a href="#GAMCoach.generate_cont_options-647"><span class="linenos">647</span></a>
</span><span id="GAMCoach.generate_cont_options-648"><a href="#GAMCoach.generate_cont_options-648"><span class="linenos">648</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-649"><a href="#GAMCoach.generate_cont_options-649"><span class="linenos">649</span></a>                    <span class="n">target</span> <span class="o">=</span> <span class="n">bin_starts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-650"><a href="#GAMCoach.generate_cont_options-650"><span class="linenos">650</span></a>                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span> <span class="o">-</span> <span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-651"><a href="#GAMCoach.generate_cont_options-651"><span class="linenos">651</span></a>
</span><span id="GAMCoach.generate_cont_options-652"><a href="#GAMCoach.generate_cont_options-652"><span class="linenos">652</span></a>            <span class="c1"># Scale the distance based on the deviation of the feature (how changeable it is)</span>
</span><span id="GAMCoach.generate_cont_options-653"><a href="#GAMCoach.generate_cont_options-653"><span class="linenos">653</span></a>            <span class="k">if</span> <span class="n">cont_mads</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-654"><a href="#GAMCoach.generate_cont_options-654"><span class="linenos">654</span></a>                <span class="n">distance</span> <span class="o">/=</span> <span class="n">cont_mads</span><span class="p">[</span><span class="n">cur_feature_name</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-655"><a href="#GAMCoach.generate_cont_options-655"><span class="linenos">655</span></a>
</span><span id="GAMCoach.generate_cont_options-656"><a href="#GAMCoach.generate_cont_options-656"><span class="linenos">656</span></a>            <span class="c1"># Compute score gain which has two parts:</span>
</span><span id="GAMCoach.generate_cont_options-657"><a href="#GAMCoach.generate_cont_options-657"><span class="linenos">657</span></a>            <span class="c1"># (1) gain from the change of main effect</span>
</span><span id="GAMCoach.generate_cont_options-658"><a href="#GAMCoach.generate_cont_options-658"><span class="linenos">658</span></a>            <span class="c1"># (2) gain from the change of interaction effect</span>
</span><span id="GAMCoach.generate_cont_options-659"><a href="#GAMCoach.generate_cont_options-659"><span class="linenos">659</span></a>
</span><span id="GAMCoach.generate_cont_options-660"><a href="#GAMCoach.generate_cont_options-660"><span class="linenos">660</span></a>            <span class="c1"># Main effect</span>
</span><span id="GAMCoach.generate_cont_options-661"><a href="#GAMCoach.generate_cont_options-661"><span class="linenos">661</span></a>            <span class="n">main_score_gain</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="GAMCoach.generate_cont_options-662"><a href="#GAMCoach.generate_cont_options-662"><span class="linenos">662</span></a>
</span><span id="GAMCoach.generate_cont_options-663"><a href="#GAMCoach.generate_cont_options-663"><span class="linenos">663</span></a>            <span class="c1"># Interaction terms</span>
</span><span id="GAMCoach.generate_cont_options-664"><a href="#GAMCoach.generate_cont_options-664"><span class="linenos">664</span></a>            <span class="c1"># A list to track all interaction score gain offsets</span>
</span><span id="GAMCoach.generate_cont_options-665"><a href="#GAMCoach.generate_cont_options-665"><span class="linenos">665</span></a>            <span class="c1"># [[interaction id, interaction score gain]]</span>
</span><span id="GAMCoach.generate_cont_options-666"><a href="#GAMCoach.generate_cont_options-666"><span class="linenos">666</span></a>            <span class="n">inter_score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach.generate_cont_options-667"><a href="#GAMCoach.generate_cont_options-667"><span class="linenos">667</span></a>            <span class="n">inter_score_gains</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cont_options-668"><a href="#GAMCoach.generate_cont_options-668"><span class="linenos">668</span></a>
</span><span id="GAMCoach.generate_cont_options-669"><a href="#GAMCoach.generate_cont_options-669"><span class="linenos">669</span></a>            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">associated_interactions</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-670"><a href="#GAMCoach.generate_cont_options-670"><span class="linenos">670</span></a>                <span class="n">inter_bin_id</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-671"><a href="#GAMCoach.generate_cont_options-671"><span class="linenos">671</span></a>                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">],</span> <span class="n">target</span>
</span><span id="GAMCoach.generate_cont_options-672"><a href="#GAMCoach.generate_cont_options-672"><span class="linenos">672</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-673"><a href="#GAMCoach.generate_cont_options-673"><span class="linenos">673</span></a>                <span class="n">inter_score_gain</span> <span class="o">+=</span> <span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-674"><a href="#GAMCoach.generate_cont_options-674"><span class="linenos">674</span></a>                    <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-675"><a href="#GAMCoach.generate_cont_options-675"><span class="linenos">675</span></a>                    <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-676"><a href="#GAMCoach.generate_cont_options-676"><span class="linenos">676</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-677"><a href="#GAMCoach.generate_cont_options-677"><span class="linenos">677</span></a>                <span class="n">inter_score_gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cont_options-678"><a href="#GAMCoach.generate_cont_options-678"><span class="linenos">678</span></a>                    <span class="p">[</span>
</span><span id="GAMCoach.generate_cont_options-679"><a href="#GAMCoach.generate_cont_options-679"><span class="linenos">679</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">],</span>
</span><span id="GAMCoach.generate_cont_options-680"><a href="#GAMCoach.generate_cont_options-680"><span class="linenos">680</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-681"><a href="#GAMCoach.generate_cont_options-681"><span class="linenos">681</span></a>                        <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">],</span>
</span><span id="GAMCoach.generate_cont_options-682"><a href="#GAMCoach.generate_cont_options-682"><span class="linenos">682</span></a>                    <span class="p">]</span>
</span><span id="GAMCoach.generate_cont_options-683"><a href="#GAMCoach.generate_cont_options-683"><span class="linenos">683</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-684"><a href="#GAMCoach.generate_cont_options-684"><span class="linenos">684</span></a>
</span><span id="GAMCoach.generate_cont_options-685"><a href="#GAMCoach.generate_cont_options-685"><span class="linenos">685</span></a>            <span class="n">score_gain</span> <span class="o">=</span> <span class="n">main_score_gain</span> <span class="o">+</span> <span class="n">inter_score_gain</span>
</span><span id="GAMCoach.generate_cont_options-686"><a href="#GAMCoach.generate_cont_options-686"><span class="linenos">686</span></a>
</span><span id="GAMCoach.generate_cont_options-687"><a href="#GAMCoach.generate_cont_options-687"><span class="linenos">687</span></a>            <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">*</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-688"><a href="#GAMCoach.generate_cont_options-688"><span class="linenos">688</span></a>                <span class="k">continue</span>
</span><span id="GAMCoach.generate_cont_options-689"><a href="#GAMCoach.generate_cont_options-689"><span class="linenos">689</span></a>
</span><span id="GAMCoach.generate_cont_options-690"><a href="#GAMCoach.generate_cont_options-690"><span class="linenos">690</span></a>            <span class="c1"># Filter out of bound options</span>
</span><span id="GAMCoach.generate_cont_options-691"><a href="#GAMCoach.generate_cont_options-691"><span class="linenos">691</span></a>            <span class="k">if</span> <span class="n">score_gain_bound</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-692"><a href="#GAMCoach.generate_cont_options-692"><span class="linenos">692</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&gt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-693"><a href="#GAMCoach.generate_cont_options-693"><span class="linenos">693</span></a>                    <span class="k">continue</span>
</span><span id="GAMCoach.generate_cont_options-694"><a href="#GAMCoach.generate_cont_options-694"><span class="linenos">694</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&lt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-695"><a href="#GAMCoach.generate_cont_options-695"><span class="linenos">695</span></a>                    <span class="k">continue</span>
</span><span id="GAMCoach.generate_cont_options-696"><a href="#GAMCoach.generate_cont_options-696"><span class="linenos">696</span></a>
</span><span id="GAMCoach.generate_cont_options-697"><a href="#GAMCoach.generate_cont_options-697"><span class="linenos">697</span></a>            <span class="n">cont_options</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">score_gain</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inter_score_gains</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cont_options-698"><a href="#GAMCoach.generate_cont_options-698"><span class="linenos">698</span></a>
</span><span id="GAMCoach.generate_cont_options-699"><a href="#GAMCoach.generate_cont_options-699"><span class="linenos">699</span></a>        <span class="c1"># Now we can apply the second round of filtering to remove redundant options</span>
</span><span id="GAMCoach.generate_cont_options-700"><a href="#GAMCoach.generate_cont_options-700"><span class="linenos">700</span></a>        <span class="c1"># Redundant options refer to bins that give similar score gain with larger distance</span>
</span><span id="GAMCoach.generate_cont_options-701"><a href="#GAMCoach.generate_cont_options-701"><span class="linenos">701</span></a>        <span class="n">cont_options</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cont_options</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cont_options-702"><a href="#GAMCoach.generate_cont_options-702"><span class="linenos">702</span></a>
</span><span id="GAMCoach.generate_cont_options-703"><a href="#GAMCoach.generate_cont_options-703"><span class="linenos">703</span></a>        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach.generate_cont_options-704"><a href="#GAMCoach.generate_cont_options-704"><span class="linenos">704</span></a>        <span class="k">while</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">cont_options</span><span class="p">):</span>
</span><span id="GAMCoach.generate_cont_options-705"><a href="#GAMCoach.generate_cont_options-705"><span class="linenos">705</span></a>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cont_options</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
</span><span id="GAMCoach.generate_cont_options-706"><a href="#GAMCoach.generate_cont_options-706"><span class="linenos">706</span></a>                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cont_options</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cont_options</span><span class="p">[</span><span class="n">start</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cont_options-707"><a href="#GAMCoach.generate_cont_options-707"><span class="linenos">707</span></a>                    <span class="n">cont_options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cont_options-708"><a href="#GAMCoach.generate_cont_options-708"><span class="linenos">708</span></a>
</span><span id="GAMCoach.generate_cont_options-709"><a href="#GAMCoach.generate_cont_options-709"><span class="linenos">709</span></a>            <span class="n">start</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="GAMCoach.generate_cont_options-710"><a href="#GAMCoach.generate_cont_options-710"><span class="linenos">710</span></a>
</span><span id="GAMCoach.generate_cont_options-711"><a href="#GAMCoach.generate_cont_options-711"><span class="linenos">711</span></a>        <span class="k">return</span> <span class="n">cont_options</span>
</span></pre></div>


            <div class="docstring"><p>Generate all alternative options for this continuous variable. This function
would filter out all options that are:</p>

<ol>
<li>Not helpful for the counterfactual generation.</li>
<li>Give similar score gain but requires larger distance.</li>
</ol>

<h6 id="args">Args</h6>

<ul>
<li><strong>cf_direction (int):</strong>  Integer <code>+1</code> if 0 =&gt; 1, <code>-1</code> if 1 =&gt; 0
(classification); <code>+1</code> if we need to increase the prediction,
<code>-1</code> if decrease (regression).</li>
<li><strong>cur_feature_index (int):</strong>  The index of the current continuous feature.</li>
<li><strong>cur_feature_name (str):</strong>  Name of the current feature.</li>
<li><strong>cur_feature_value (float):</strong>  The current feature value.</li>
<li><strong>cur_feature_score (float):</strong>  The score for the current feature value.</li>
<li><strong>cont_mads (dict):</strong>  A map of feature_name =&gt; MAD score.</li>
<li><strong>cur_example (list):</strong>  Current sample values</li>
<li><strong>score_gain_bound (float):</strong>  Bound of the score gain. We do not collect
options that give <code>score_gain</code> &gt; <code>score_gain_bound</code> (when
<code>cf_direction=1</code>), or <code>score_gain</code> &lt; <code>score_gain_bound</code> (when
<code>cf_direction=-1</code>)</li>
<li><strong>epsilon (float):</strong>  The threshold to determine if two options give similar
score gains. Score gains $s_1$ and $s_2$ are similar if
$|s_1 - s_2| <$ epsilon. Smaller epsilon significantly increases
the time to solve the MILP. Large epsilon might filter out the
optimal CF. Defaults to 0.005.</li>
<li><strong>need_to_be_int (bool):</strong>  True if the target values for this continuous
variable need to have integer values.</li>
<li><strong>skip_unhelpful (bool):</strong>  True if to skip options from main
effects that give opposite score gain. It is rare that there is a
positive score gain from pair-interaction that outweigh negative
score gain from two main effects, and adjusting the distance penalty.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>list: List of option tuples (target, score gain, distance, bin_index)</p>
</blockquote>
</div>


                            </div>
                            <div id="GAMCoach.generate_cat_options" class="classattr">
                                        <input id="GAMCoach.generate_cat_options-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_cat_options</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">cf_direction</span>,</span><span class="param">	<span class="n">cur_feature_index</span>,</span><span class="param">	<span class="n">cur_feature_value</span>,</span><span class="param">	<span class="n">cur_feature_score</span>,</span><span class="param">	<span class="n">cur_cat_distance</span>,</span><span class="param">	<span class="n">cur_example</span>,</span><span class="param">	<span class="n">score_gain_bound</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">skip_unhelpful</span><span class="o">=</span><span class="kc">True</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GAMCoach.generate_cat_options-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.generate_cat_options"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.generate_cat_options-713"><a href="#GAMCoach.generate_cat_options-713"><span class="linenos">713</span></a>    <span class="k">def</span> <span class="nf">generate_cat_options</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-714"><a href="#GAMCoach.generate_cat_options-714"><span class="linenos">714</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-715"><a href="#GAMCoach.generate_cat_options-715"><span class="linenos">715</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-716"><a href="#GAMCoach.generate_cat_options-716"><span class="linenos">716</span></a>        <span class="n">cur_feature_index</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-717"><a href="#GAMCoach.generate_cat_options-717"><span class="linenos">717</span></a>        <span class="n">cur_feature_value</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-718"><a href="#GAMCoach.generate_cat_options-718"><span class="linenos">718</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-719"><a href="#GAMCoach.generate_cat_options-719"><span class="linenos">719</span></a>        <span class="n">cur_cat_distance</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-720"><a href="#GAMCoach.generate_cat_options-720"><span class="linenos">720</span></a>        <span class="n">cur_example</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-721"><a href="#GAMCoach.generate_cat_options-721"><span class="linenos">721</span></a>        <span class="n">score_gain_bound</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-722"><a href="#GAMCoach.generate_cat_options-722"><span class="linenos">722</span></a>        <span class="n">skip_unhelpful</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-723"><a href="#GAMCoach.generate_cat_options-723"><span class="linenos">723</span></a>    <span class="p">):</span>
</span><span id="GAMCoach.generate_cat_options-724"><a href="#GAMCoach.generate_cat_options-724"><span class="linenos">724</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach.generate_cat_options-725"><a href="#GAMCoach.generate_cat_options-725"><span class="linenos">725</span></a><span class="sd">        Generate all alternative options for this categorical variable. This function</span>
</span><span id="GAMCoach.generate_cat_options-726"><a href="#GAMCoach.generate_cat_options-726"><span class="linenos">726</span></a><span class="sd">        would filter out all options that are not helpful for the counterfactual</span>
</span><span id="GAMCoach.generate_cat_options-727"><a href="#GAMCoach.generate_cat_options-727"><span class="linenos">727</span></a><span class="sd">        generation.</span>
</span><span id="GAMCoach.generate_cat_options-728"><a href="#GAMCoach.generate_cat_options-728"><span class="linenos">728</span></a>
</span><span id="GAMCoach.generate_cat_options-729"><a href="#GAMCoach.generate_cat_options-729"><span class="linenos">729</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.generate_cat_options-730"><a href="#GAMCoach.generate_cat_options-730"><span class="linenos">730</span></a><span class="sd">            cf_direction (int): Integer `+1` if 0 =&gt; 1, `-1` if 1 =&gt; 0</span>
</span><span id="GAMCoach.generate_cat_options-731"><a href="#GAMCoach.generate_cat_options-731"><span class="linenos">731</span></a><span class="sd">                (classification); `+1` if we need to increase the prediction,</span>
</span><span id="GAMCoach.generate_cat_options-732"><a href="#GAMCoach.generate_cat_options-732"><span class="linenos">732</span></a><span class="sd">                `-1` if decrease (regression).</span>
</span><span id="GAMCoach.generate_cat_options-733"><a href="#GAMCoach.generate_cat_options-733"><span class="linenos">733</span></a><span class="sd">            cur_feature_index (int): The index of the current continuous feature.</span>
</span><span id="GAMCoach.generate_cat_options-734"><a href="#GAMCoach.generate_cat_options-734"><span class="linenos">734</span></a><span class="sd">            cur_feature_value (float): The current feature value.</span>
</span><span id="GAMCoach.generate_cat_options-735"><a href="#GAMCoach.generate_cat_options-735"><span class="linenos">735</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="GAMCoach.generate_cat_options-736"><a href="#GAMCoach.generate_cat_options-736"><span class="linenos">736</span></a><span class="sd">            cur_cat_distance (dict): A map of feature_level =&gt; 1 - frequency.</span>
</span><span id="GAMCoach.generate_cat_options-737"><a href="#GAMCoach.generate_cat_options-737"><span class="linenos">737</span></a><span class="sd">            cur_example (list): Current sample values.</span>
</span><span id="GAMCoach.generate_cat_options-738"><a href="#GAMCoach.generate_cat_options-738"><span class="linenos">738</span></a><span class="sd">            score_gain_bound (float): Bound of the score gain. We do not collect</span>
</span><span id="GAMCoach.generate_cat_options-739"><a href="#GAMCoach.generate_cat_options-739"><span class="linenos">739</span></a><span class="sd">                options that give `score_gain` &gt; `score_gain_bound` (when</span>
</span><span id="GAMCoach.generate_cat_options-740"><a href="#GAMCoach.generate_cat_options-740"><span class="linenos">740</span></a><span class="sd">                `cf_direction=1`), or `score_gain` &lt; `score_gain_bound` (when</span>
</span><span id="GAMCoach.generate_cat_options-741"><a href="#GAMCoach.generate_cat_options-741"><span class="linenos">741</span></a><span class="sd">                `cf_direction=-1`)</span>
</span><span id="GAMCoach.generate_cat_options-742"><a href="#GAMCoach.generate_cat_options-742"><span class="linenos">742</span></a><span class="sd">            skip_unhelpful (bool): True if to skip options from main</span>
</span><span id="GAMCoach.generate_cat_options-743"><a href="#GAMCoach.generate_cat_options-743"><span class="linenos">743</span></a><span class="sd">                effects that give opposite score gain. It is rare that there is a</span>
</span><span id="GAMCoach.generate_cat_options-744"><a href="#GAMCoach.generate_cat_options-744"><span class="linenos">744</span></a><span class="sd">                positive score gain from pair-interaction that outweigh negative</span>
</span><span id="GAMCoach.generate_cat_options-745"><a href="#GAMCoach.generate_cat_options-745"><span class="linenos">745</span></a><span class="sd">                score gain from two main effects, and adjusting the distance penalty.</span>
</span><span id="GAMCoach.generate_cat_options-746"><a href="#GAMCoach.generate_cat_options-746"><span class="linenos">746</span></a>
</span><span id="GAMCoach.generate_cat_options-747"><a href="#GAMCoach.generate_cat_options-747"><span class="linenos">747</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach.generate_cat_options-748"><a href="#GAMCoach.generate_cat_options-748"><span class="linenos">748</span></a><span class="sd">            list: List of option tuples (target, score_gain, distance, bin_index).</span>
</span><span id="GAMCoach.generate_cat_options-749"><a href="#GAMCoach.generate_cat_options-749"><span class="linenos">749</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.generate_cat_options-750"><a href="#GAMCoach.generate_cat_options-750"><span class="linenos">750</span></a>
</span><span id="GAMCoach.generate_cat_options-751"><a href="#GAMCoach.generate_cat_options-751"><span class="linenos">751</span></a>        <span class="c1"># Find other options for this categorical variable</span>
</span><span id="GAMCoach.generate_cat_options-752"><a href="#GAMCoach.generate_cat_options-752"><span class="linenos">752</span></a>        <span class="c1"># For each option, we compute the (1) score gain, and (2) distance</span>
</span><span id="GAMCoach.generate_cat_options-753"><a href="#GAMCoach.generate_cat_options-753"><span class="linenos">753</span></a>        <span class="c1">#</span>
</span><span id="GAMCoach.generate_cat_options-754"><a href="#GAMCoach.generate_cat_options-754"><span class="linenos">754</span></a>        <span class="c1"># (1) Score gain is the same as continuous variables</span>
</span><span id="GAMCoach.generate_cat_options-755"><a href="#GAMCoach.generate_cat_options-755"><span class="linenos">755</span></a>        <span class="c1"># (2) The distance is determined by 1 - the level frequency in the</span>
</span><span id="GAMCoach.generate_cat_options-756"><a href="#GAMCoach.generate_cat_options-756"><span class="linenos">756</span></a>        <span class="c1"># training data. It implies that levels with high frequency are easier</span>
</span><span id="GAMCoach.generate_cat_options-757"><a href="#GAMCoach.generate_cat_options-757"><span class="linenos">757</span></a>        <span class="c1"># to &quot;move to&quot;</span>
</span><span id="GAMCoach.generate_cat_options-758"><a href="#GAMCoach.generate_cat_options-758"><span class="linenos">758</span></a>
</span><span id="GAMCoach.generate_cat_options-759"><a href="#GAMCoach.generate_cat_options-759"><span class="linenos">759</span></a>        <span class="c1"># Get the additive scores of this feature</span>
</span><span id="GAMCoach.generate_cat_options-760"><a href="#GAMCoach.generate_cat_options-760"><span class="linenos">760</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_index</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach.generate_cat_options-761"><a href="#GAMCoach.generate_cat_options-761"><span class="linenos">761</span></a>
</span><span id="GAMCoach.generate_cat_options-762"><a href="#GAMCoach.generate_cat_options-762"><span class="linenos">762</span></a>        <span class="c1"># Get the bin edges of this feature</span>
</span><span id="GAMCoach.generate_cat_options-763"><a href="#GAMCoach.generate_cat_options-763"><span class="linenos">763</span></a>        <span class="n">levels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_feature_index</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-764"><a href="#GAMCoach.generate_cat_options-764"><span class="linenos">764</span></a>
</span><span id="GAMCoach.generate_cat_options-765"><a href="#GAMCoach.generate_cat_options-765"><span class="linenos">765</span></a>        <span class="c1"># Create &quot;options&quot;, each option is a tuple (target, score_gain, distance, bin_index)</span>
</span><span id="GAMCoach.generate_cat_options-766"><a href="#GAMCoach.generate_cat_options-766"><span class="linenos">766</span></a>        <span class="n">cat_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cat_options-767"><a href="#GAMCoach.generate_cat_options-767"><span class="linenos">767</span></a>
</span><span id="GAMCoach.generate_cat_options-768"><a href="#GAMCoach.generate_cat_options-768"><span class="linenos">768</span></a>        <span class="c1"># Identify interaction terms that we need to consider</span>
</span><span id="GAMCoach.generate_cat_options-769"><a href="#GAMCoach.generate_cat_options-769"><span class="linenos">769</span></a>        <span class="n">associated_interactions</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cat_options-770"><a href="#GAMCoach.generate_cat_options-770"><span class="linenos">770</span></a>
</span><span id="GAMCoach.generate_cat_options-771"><a href="#GAMCoach.generate_cat_options-771"><span class="linenos">771</span></a>        <span class="k">for</span> <span class="n">cur_feature_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cat_options-772"><a href="#GAMCoach.generate_cat_options-772"><span class="linenos">772</span></a>            <span class="n">cur_feature_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-773"><a href="#GAMCoach.generate_cat_options-773"><span class="linenos">773</span></a>            <span class="k">if</span> <span class="n">cur_feature_type</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-774"><a href="#GAMCoach.generate_cat_options-774"><span class="linenos">774</span></a>
</span><span id="GAMCoach.generate_cat_options-775"><a href="#GAMCoach.generate_cat_options-775"><span class="linenos">775</span></a>                <span class="n">indexes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-776"><a href="#GAMCoach.generate_cat_options-776"><span class="linenos">776</span></a>
</span><span id="GAMCoach.generate_cat_options-777"><a href="#GAMCoach.generate_cat_options-777"><span class="linenos">777</span></a>                <span class="k">if</span> <span class="n">cur_feature_index</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-778"><a href="#GAMCoach.generate_cat_options-778"><span class="linenos">778</span></a>                    <span class="n">feature_position</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">indexes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">cur_feature_index</span> <span class="k">else</span> <span class="mi">1</span>
</span><span id="GAMCoach.generate_cat_options-779"><a href="#GAMCoach.generate_cat_options-779"><span class="linenos">779</span></a>
</span><span id="GAMCoach.generate_cat_options-780"><a href="#GAMCoach.generate_cat_options-780"><span class="linenos">780</span></a>                    <span class="n">other_position</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">feature_position</span>
</span><span id="GAMCoach.generate_cat_options-781"><a href="#GAMCoach.generate_cat_options-781"><span class="linenos">781</span></a>                    <span class="n">other_index</span> <span class="o">=</span> <span class="n">indexes</span><span class="p">[</span><span class="n">other_position</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-782"><a href="#GAMCoach.generate_cat_options-782"><span class="linenos">782</span></a>                    <span class="n">other_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-783"><a href="#GAMCoach.generate_cat_options-783"><span class="linenos">783</span></a>                    <span class="n">other_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">other_index</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-784"><a href="#GAMCoach.generate_cat_options-784"><span class="linenos">784</span></a>
</span><span id="GAMCoach.generate_cat_options-785"><a href="#GAMCoach.generate_cat_options-785"><span class="linenos">785</span></a>                    <span class="c1"># Get the current additive scores and bin edges</span>
</span><span id="GAMCoach.generate_cat_options-786"><a href="#GAMCoach.generate_cat_options-786"><span class="linenos">786</span></a>                    <span class="n">inter_additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach.generate_cat_options-787"><a href="#GAMCoach.generate_cat_options-787"><span class="linenos">787</span></a>
</span><span id="GAMCoach.generate_cat_options-788"><a href="#GAMCoach.generate_cat_options-788"><span class="linenos">788</span></a>                    <span class="n">bin_starts_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-789"><a href="#GAMCoach.generate_cat_options-789"><span class="linenos">789</span></a>                        <span class="n">cur_feature_index</span>
</span><span id="GAMCoach.generate_cat_options-790"><a href="#GAMCoach.generate_cat_options-790"><span class="linenos">790</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-791"><a href="#GAMCoach.generate_cat_options-791"><span class="linenos">791</span></a>                    <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-792"><a href="#GAMCoach.generate_cat_options-792"><span class="linenos">792</span></a>                        <span class="n">other_index</span>
</span><span id="GAMCoach.generate_cat_options-793"><a href="#GAMCoach.generate_cat_options-793"><span class="linenos">793</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-794"><a href="#GAMCoach.generate_cat_options-794"><span class="linenos">794</span></a>
</span><span id="GAMCoach.generate_cat_options-795"><a href="#GAMCoach.generate_cat_options-795"><span class="linenos">795</span></a>                    <span class="c1"># Have to skip the max edge if it is continuous</span>
</span><span id="GAMCoach.generate_cat_options-796"><a href="#GAMCoach.generate_cat_options-796"><span class="linenos">796</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-797"><a href="#GAMCoach.generate_cat_options-797"><span class="linenos">797</span></a>                        <span class="n">bin_starts_other</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-798"><a href="#GAMCoach.generate_cat_options-798"><span class="linenos">798</span></a>
</span><span id="GAMCoach.generate_cat_options-799"><a href="#GAMCoach.generate_cat_options-799"><span class="linenos">799</span></a>                    <span class="c1"># Get the current interaction term score</span>
</span><span id="GAMCoach.generate_cat_options-800"><a href="#GAMCoach.generate_cat_options-800"><span class="linenos">800</span></a>                    <span class="n">other_bin</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach.generate_cat_options-801"><a href="#GAMCoach.generate_cat_options-801"><span class="linenos">801</span></a>                    <span class="k">if</span> <span class="n">other_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-802"><a href="#GAMCoach.generate_cat_options-802"><span class="linenos">802</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-803"><a href="#GAMCoach.generate_cat_options-803"><span class="linenos">803</span></a>                            <span class="n">bin_starts_other</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cat_options-804"><a href="#GAMCoach.generate_cat_options-804"><span class="linenos">804</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-805"><a href="#GAMCoach.generate_cat_options-805"><span class="linenos">805</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-806"><a href="#GAMCoach.generate_cat_options-806"><span class="linenos">806</span></a>                        <span class="n">other_bin</span> <span class="o">=</span> <span class="n">bin_starts_other</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_example</span><span class="p">[</span><span class="n">other_index</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cat_options-807"><a href="#GAMCoach.generate_cat_options-807"><span class="linenos">807</span></a>
</span><span id="GAMCoach.generate_cat_options-808"><a href="#GAMCoach.generate_cat_options-808"><span class="linenos">808</span></a>                    <span class="n">feature_bin</span> <span class="o">=</span> <span class="n">bin_starts_feature</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">cur_feature_value</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-809"><a href="#GAMCoach.generate_cat_options-809"><span class="linenos">809</span></a>
</span><span id="GAMCoach.generate_cat_options-810"><a href="#GAMCoach.generate_cat_options-810"><span class="linenos">810</span></a>                    <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach.generate_cat_options-811"><a href="#GAMCoach.generate_cat_options-811"><span class="linenos">811</span></a>
</span><span id="GAMCoach.generate_cat_options-812"><a href="#GAMCoach.generate_cat_options-812"><span class="linenos">812</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-813"><a href="#GAMCoach.generate_cat_options-813"><span class="linenos">813</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">feature_bin</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-814"><a href="#GAMCoach.generate_cat_options-814"><span class="linenos">814</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-815"><a href="#GAMCoach.generate_cat_options-815"><span class="linenos">815</span></a>                        <span class="n">feature_inter_score</span> <span class="o">=</span> <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">feature_bin</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-816"><a href="#GAMCoach.generate_cat_options-816"><span class="linenos">816</span></a>
</span><span id="GAMCoach.generate_cat_options-817"><a href="#GAMCoach.generate_cat_options-817"><span class="linenos">817</span></a>                    <span class="c1"># Extract the row or column where we fix the other features and</span>
</span><span id="GAMCoach.generate_cat_options-818"><a href="#GAMCoach.generate_cat_options-818"><span class="linenos">818</span></a>                    <span class="c1"># vary the current feature</span>
</span><span id="GAMCoach.generate_cat_options-819"><a href="#GAMCoach.generate_cat_options-819"><span class="linenos">819</span></a>                    <span class="n">feature_inter_bin_starts</span> <span class="o">=</span> <span class="n">bin_starts_feature</span>
</span><span id="GAMCoach.generate_cat_options-820"><a href="#GAMCoach.generate_cat_options-820"><span class="linenos">820</span></a>                    <span class="n">feature_inter_additives</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cat_options-821"><a href="#GAMCoach.generate_cat_options-821"><span class="linenos">821</span></a>
</span><span id="GAMCoach.generate_cat_options-822"><a href="#GAMCoach.generate_cat_options-822"><span class="linenos">822</span></a>                    <span class="k">if</span> <span class="n">feature_position</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-823"><a href="#GAMCoach.generate_cat_options-823"><span class="linenos">823</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cat_options-824"><a href="#GAMCoach.generate_cat_options-824"><span class="linenos">824</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-825"><a href="#GAMCoach.generate_cat_options-825"><span class="linenos">825</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">other_bin</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-826"><a href="#GAMCoach.generate_cat_options-826"><span class="linenos">826</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-827"><a href="#GAMCoach.generate_cat_options-827"><span class="linenos">827</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-828"><a href="#GAMCoach.generate_cat_options-828"><span class="linenos">828</span></a>                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">inter_additives</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
</span><span id="GAMCoach.generate_cat_options-829"><a href="#GAMCoach.generate_cat_options-829"><span class="linenos">829</span></a>                            <span class="n">feature_inter_additives</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-830"><a href="#GAMCoach.generate_cat_options-830"><span class="linenos">830</span></a>                                <span class="n">inter_additives</span><span class="p">[</span><span class="n">other_bin</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-831"><a href="#GAMCoach.generate_cat_options-831"><span class="linenos">831</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-832"><a href="#GAMCoach.generate_cat_options-832"><span class="linenos">832</span></a>
</span><span id="GAMCoach.generate_cat_options-833"><a href="#GAMCoach.generate_cat_options-833"><span class="linenos">833</span></a>                    <span class="c1"># Register this interaction term</span>
</span><span id="GAMCoach.generate_cat_options-834"><a href="#GAMCoach.generate_cat_options-834"><span class="linenos">834</span></a>                    <span class="n">associated_interactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-835"><a href="#GAMCoach.generate_cat_options-835"><span class="linenos">835</span></a>                        <span class="p">{</span>
</span><span id="GAMCoach.generate_cat_options-836"><a href="#GAMCoach.generate_cat_options-836"><span class="linenos">836</span></a>                            <span class="s2">&quot;inter_index&quot;</span><span class="p">:</span> <span class="n">indexes</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-837"><a href="#GAMCoach.generate_cat_options-837"><span class="linenos">837</span></a>                            <span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">:</span> <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-838"><a href="#GAMCoach.generate_cat_options-838"><span class="linenos">838</span></a>                            <span class="s2">&quot;feature_inter_score&quot;</span><span class="p">:</span> <span class="n">feature_inter_score</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-839"><a href="#GAMCoach.generate_cat_options-839"><span class="linenos">839</span></a>                            <span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">:</span> <span class="n">feature_inter_bin_starts</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-840"><a href="#GAMCoach.generate_cat_options-840"><span class="linenos">840</span></a>                            <span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">:</span> <span class="n">feature_inter_additives</span><span class="p">,</span>
</span><span id="GAMCoach.generate_cat_options-841"><a href="#GAMCoach.generate_cat_options-841"><span class="linenos">841</span></a>                        <span class="p">}</span>
</span><span id="GAMCoach.generate_cat_options-842"><a href="#GAMCoach.generate_cat_options-842"><span class="linenos">842</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-843"><a href="#GAMCoach.generate_cat_options-843"><span class="linenos">843</span></a>
</span><span id="GAMCoach.generate_cat_options-844"><a href="#GAMCoach.generate_cat_options-844"><span class="linenos">844</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">additives</span><span class="p">)):</span>
</span><span id="GAMCoach.generate_cat_options-845"><a href="#GAMCoach.generate_cat_options-845"><span class="linenos">845</span></a>            <span class="k">if</span> <span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cur_feature_value</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-846"><a href="#GAMCoach.generate_cat_options-846"><span class="linenos">846</span></a>                <span class="n">target</span> <span class="o">=</span> <span class="n">levels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-847"><a href="#GAMCoach.generate_cat_options-847"><span class="linenos">847</span></a>                <span class="n">distance</span> <span class="o">=</span> <span class="n">cur_cat_distance</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-848"><a href="#GAMCoach.generate_cat_options-848"><span class="linenos">848</span></a>
</span><span id="GAMCoach.generate_cat_options-849"><a href="#GAMCoach.generate_cat_options-849"><span class="linenos">849</span></a>                <span class="c1"># Compute score gain which has two parts:</span>
</span><span id="GAMCoach.generate_cat_options-850"><a href="#GAMCoach.generate_cat_options-850"><span class="linenos">850</span></a>                <span class="c1"># (1) gain from the change of main effect</span>
</span><span id="GAMCoach.generate_cat_options-851"><a href="#GAMCoach.generate_cat_options-851"><span class="linenos">851</span></a>                <span class="c1"># (2) gain from the change of interaction effect</span>
</span><span id="GAMCoach.generate_cat_options-852"><a href="#GAMCoach.generate_cat_options-852"><span class="linenos">852</span></a>
</span><span id="GAMCoach.generate_cat_options-853"><a href="#GAMCoach.generate_cat_options-853"><span class="linenos">853</span></a>                <span class="c1"># Main effect</span>
</span><span id="GAMCoach.generate_cat_options-854"><a href="#GAMCoach.generate_cat_options-854"><span class="linenos">854</span></a>                <span class="n">main_score_gain</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="GAMCoach.generate_cat_options-855"><a href="#GAMCoach.generate_cat_options-855"><span class="linenos">855</span></a>
</span><span id="GAMCoach.generate_cat_options-856"><a href="#GAMCoach.generate_cat_options-856"><span class="linenos">856</span></a>                <span class="c1"># Interaction terms</span>
</span><span id="GAMCoach.generate_cat_options-857"><a href="#GAMCoach.generate_cat_options-857"><span class="linenos">857</span></a>                <span class="c1"># A list to track all interaction score gain offsets</span>
</span><span id="GAMCoach.generate_cat_options-858"><a href="#GAMCoach.generate_cat_options-858"><span class="linenos">858</span></a>                <span class="c1"># [[interaction id, interaction score gain]]</span>
</span><span id="GAMCoach.generate_cat_options-859"><a href="#GAMCoach.generate_cat_options-859"><span class="linenos">859</span></a>                <span class="n">inter_score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach.generate_cat_options-860"><a href="#GAMCoach.generate_cat_options-860"><span class="linenos">860</span></a>                <span class="n">inter_score_gains</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_cat_options-861"><a href="#GAMCoach.generate_cat_options-861"><span class="linenos">861</span></a>
</span><span id="GAMCoach.generate_cat_options-862"><a href="#GAMCoach.generate_cat_options-862"><span class="linenos">862</span></a>                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">associated_interactions</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-863"><a href="#GAMCoach.generate_cat_options-863"><span class="linenos">863</span></a>                    <span class="n">inter_bin_id</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_bin_starts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-864"><a href="#GAMCoach.generate_cat_options-864"><span class="linenos">864</span></a>                    <span class="n">inter_score_gain</span> <span class="o">+=</span> <span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-865"><a href="#GAMCoach.generate_cat_options-865"><span class="linenos">865</span></a>                        <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-866"><a href="#GAMCoach.generate_cat_options-866"><span class="linenos">866</span></a>                        <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-867"><a href="#GAMCoach.generate_cat_options-867"><span class="linenos">867</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-868"><a href="#GAMCoach.generate_cat_options-868"><span class="linenos">868</span></a>                    <span class="n">inter_score_gains</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_cat_options-869"><a href="#GAMCoach.generate_cat_options-869"><span class="linenos">869</span></a>                        <span class="p">[</span>
</span><span id="GAMCoach.generate_cat_options-870"><a href="#GAMCoach.generate_cat_options-870"><span class="linenos">870</span></a>                            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cur_interaction_id&quot;</span><span class="p">],</span>
</span><span id="GAMCoach.generate_cat_options-871"><a href="#GAMCoach.generate_cat_options-871"><span class="linenos">871</span></a>                            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_additives&quot;</span><span class="p">][</span><span class="n">inter_bin_id</span><span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-872"><a href="#GAMCoach.generate_cat_options-872"><span class="linenos">872</span></a>                            <span class="o">-</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;feature_inter_score&quot;</span><span class="p">],</span>
</span><span id="GAMCoach.generate_cat_options-873"><a href="#GAMCoach.generate_cat_options-873"><span class="linenos">873</span></a>                        <span class="p">]</span>
</span><span id="GAMCoach.generate_cat_options-874"><a href="#GAMCoach.generate_cat_options-874"><span class="linenos">874</span></a>                    <span class="p">)</span>
</span><span id="GAMCoach.generate_cat_options-875"><a href="#GAMCoach.generate_cat_options-875"><span class="linenos">875</span></a>
</span><span id="GAMCoach.generate_cat_options-876"><a href="#GAMCoach.generate_cat_options-876"><span class="linenos">876</span></a>                <span class="n">score_gain</span> <span class="o">=</span> <span class="n">main_score_gain</span> <span class="o">+</span> <span class="n">inter_score_gain</span>
</span><span id="GAMCoach.generate_cat_options-877"><a href="#GAMCoach.generate_cat_options-877"><span class="linenos">877</span></a>
</span><span id="GAMCoach.generate_cat_options-878"><a href="#GAMCoach.generate_cat_options-878"><span class="linenos">878</span></a>                <span class="c1"># Skip unhelpful options</span>
</span><span id="GAMCoach.generate_cat_options-879"><a href="#GAMCoach.generate_cat_options-879"><span class="linenos">879</span></a>                <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">*</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-880"><a href="#GAMCoach.generate_cat_options-880"><span class="linenos">880</span></a>                    <span class="k">continue</span>
</span><span id="GAMCoach.generate_cat_options-881"><a href="#GAMCoach.generate_cat_options-881"><span class="linenos">881</span></a>
</span><span id="GAMCoach.generate_cat_options-882"><a href="#GAMCoach.generate_cat_options-882"><span class="linenos">882</span></a>                <span class="c1"># Filter out of bound options</span>
</span><span id="GAMCoach.generate_cat_options-883"><a href="#GAMCoach.generate_cat_options-883"><span class="linenos">883</span></a>                <span class="k">if</span> <span class="n">score_gain_bound</span> <span class="ow">and</span> <span class="n">skip_unhelpful</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-884"><a href="#GAMCoach.generate_cat_options-884"><span class="linenos">884</span></a>                    <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&gt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-885"><a href="#GAMCoach.generate_cat_options-885"><span class="linenos">885</span></a>                        <span class="k">continue</span>
</span><span id="GAMCoach.generate_cat_options-886"><a href="#GAMCoach.generate_cat_options-886"><span class="linenos">886</span></a>                    <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">score_gain</span> <span class="o">&lt;</span> <span class="n">score_gain_bound</span><span class="p">:</span>
</span><span id="GAMCoach.generate_cat_options-887"><a href="#GAMCoach.generate_cat_options-887"><span class="linenos">887</span></a>                        <span class="k">continue</span>
</span><span id="GAMCoach.generate_cat_options-888"><a href="#GAMCoach.generate_cat_options-888"><span class="linenos">888</span></a>
</span><span id="GAMCoach.generate_cat_options-889"><a href="#GAMCoach.generate_cat_options-889"><span class="linenos">889</span></a>                <span class="n">cat_options</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">target</span><span class="p">,</span> <span class="n">score_gain</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">inter_score_gains</span><span class="p">])</span>
</span><span id="GAMCoach.generate_cat_options-890"><a href="#GAMCoach.generate_cat_options-890"><span class="linenos">890</span></a>
</span><span id="GAMCoach.generate_cat_options-891"><a href="#GAMCoach.generate_cat_options-891"><span class="linenos">891</span></a>        <span class="k">return</span> <span class="n">cat_options</span>
</span></pre></div>


            <div class="docstring"><p>Generate all alternative options for this categorical variable. This function
would filter out all options that are not helpful for the counterfactual
generation.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>cf_direction (int):</strong>  Integer <code>+1</code> if 0 =&gt; 1, <code>-1</code> if 1 =&gt; 0
(classification); <code>+1</code> if we need to increase the prediction,
<code>-1</code> if decrease (regression).</li>
<li><strong>cur_feature_index (int):</strong>  The index of the current continuous feature.</li>
<li><strong>cur_feature_value (float):</strong>  The current feature value.</li>
<li><strong>cur_feature_score (float):</strong>  The score for the current feature value.</li>
<li><strong>cur_cat_distance (dict):</strong>  A map of feature_level =&gt; 1 - frequency.</li>
<li><strong>cur_example (list):</strong>  Current sample values.</li>
<li><strong>score_gain_bound (float):</strong>  Bound of the score gain. We do not collect
options that give <code>score_gain</code> &gt; <code>score_gain_bound</code> (when
<code>cf_direction=1</code>), or <code>score_gain</code> &lt; <code>score_gain_bound</code> (when
<code>cf_direction=-1</code>)</li>
<li><strong>skip_unhelpful (bool):</strong>  True if to skip options from main
effects that give opposite score gain. It is rare that there is a
positive score gain from pair-interaction that outweigh negative
score gain from two main effects, and adjusting the distance penalty.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>list: List of option tuples (target, score_gain, distance, bin_index).</p>
</blockquote>
</div>


                            </div>
                            <div id="GAMCoach.generate_inter_options" class="classattr">
                                        <input id="GAMCoach.generate_inter_options-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">generate_inter_options</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">cur_feature_id</span>,</span><span class="param">	<span class="n">cur_feature_index_1</span>,</span><span class="param">	<span class="n">cur_feature_index_2</span>,</span><span class="param">	<span class="n">cur_feature_score</span>,</span><span class="param">	<span class="n">options</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GAMCoach.generate_inter_options-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.generate_inter_options"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.generate_inter_options-893"><a href="#GAMCoach.generate_inter_options-893"><span class="linenos"> 893</span></a>    <span class="k">def</span> <span class="nf">generate_inter_options</span><span class="p">(</span>
</span><span id="GAMCoach.generate_inter_options-894"><a href="#GAMCoach.generate_inter_options-894"><span class="linenos"> 894</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="GAMCoach.generate_inter_options-895"><a href="#GAMCoach.generate_inter_options-895"><span class="linenos"> 895</span></a>        <span class="n">cur_feature_id</span><span class="p">,</span>
</span><span id="GAMCoach.generate_inter_options-896"><a href="#GAMCoach.generate_inter_options-896"><span class="linenos"> 896</span></a>        <span class="n">cur_feature_index_1</span><span class="p">,</span>
</span><span id="GAMCoach.generate_inter_options-897"><a href="#GAMCoach.generate_inter_options-897"><span class="linenos"> 897</span></a>        <span class="n">cur_feature_index_2</span><span class="p">,</span>
</span><span id="GAMCoach.generate_inter_options-898"><a href="#GAMCoach.generate_inter_options-898"><span class="linenos"> 898</span></a>        <span class="n">cur_feature_score</span><span class="p">,</span>
</span><span id="GAMCoach.generate_inter_options-899"><a href="#GAMCoach.generate_inter_options-899"><span class="linenos"> 899</span></a>        <span class="n">options</span><span class="p">,</span>
</span><span id="GAMCoach.generate_inter_options-900"><a href="#GAMCoach.generate_inter_options-900"><span class="linenos"> 900</span></a>    <span class="p">):</span>
</span><span id="GAMCoach.generate_inter_options-901"><a href="#GAMCoach.generate_inter_options-901"><span class="linenos"> 901</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach.generate_inter_options-902"><a href="#GAMCoach.generate_inter_options-902"><span class="linenos"> 902</span></a><span class="sd">        Generate all possible options for this interaction variable.</span>
</span><span id="GAMCoach.generate_inter_options-903"><a href="#GAMCoach.generate_inter_options-903"><span class="linenos"> 903</span></a>
</span><span id="GAMCoach.generate_inter_options-904"><a href="#GAMCoach.generate_inter_options-904"><span class="linenos"> 904</span></a><span class="sd">        Interaction terms are interesting in this MILP. Each option counts as a</span>
</span><span id="GAMCoach.generate_inter_options-905"><a href="#GAMCoach.generate_inter_options-905"><span class="linenos"> 905</span></a><span class="sd">        variable, but each variable only affects the score gain, not the distance.</span>
</span><span id="GAMCoach.generate_inter_options-906"><a href="#GAMCoach.generate_inter_options-906"><span class="linenos"> 906</span></a>
</span><span id="GAMCoach.generate_inter_options-907"><a href="#GAMCoach.generate_inter_options-907"><span class="linenos"> 907</span></a><span class="sd">        Note that in EBM, the bin definitions for interaction terms can be different</span>
</span><span id="GAMCoach.generate_inter_options-908"><a href="#GAMCoach.generate_inter_options-908"><span class="linenos"> 908</span></a><span class="sd">        from their definitions for individual continuous variables.</span>
</span><span id="GAMCoach.generate_inter_options-909"><a href="#GAMCoach.generate_inter_options-909"><span class="linenos"> 909</span></a>
</span><span id="GAMCoach.generate_inter_options-910"><a href="#GAMCoach.generate_inter_options-910"><span class="linenos"> 910</span></a><span class="sd">        To model interaction terms, we can think it as a binary variable. The</span>
</span><span id="GAMCoach.generate_inter_options-911"><a href="#GAMCoach.generate_inter_options-911"><span class="linenos"> 911</span></a><span class="sd">        value is determined by the multiplication of two main effect variables.</span>
</span><span id="GAMCoach.generate_inter_options-912"><a href="#GAMCoach.generate_inter_options-912"><span class="linenos"> 912</span></a><span class="sd">        Each interaction variable describes a combination of two main effect</span>
</span><span id="GAMCoach.generate_inter_options-913"><a href="#GAMCoach.generate_inter_options-913"><span class="linenos"> 913</span></a><span class="sd">        variables. Therefore, say continuous variable A has $x$ probable options,</span>
</span><span id="GAMCoach.generate_inter_options-914"><a href="#GAMCoach.generate_inter_options-914"><span class="linenos"> 914</span></a><span class="sd">        and another continuous variable B has $y$ probable options, then we should</span>
</span><span id="GAMCoach.generate_inter_options-915"><a href="#GAMCoach.generate_inter_options-915"><span class="linenos"> 915</span></a><span class="sd">        add $x \\times y$ binary variables to offset their probable interaction</span>
</span><span id="GAMCoach.generate_inter_options-916"><a href="#GAMCoach.generate_inter_options-916"><span class="linenos"> 916</span></a><span class="sd">        effects.</span>
</span><span id="GAMCoach.generate_inter_options-917"><a href="#GAMCoach.generate_inter_options-917"><span class="linenos"> 917</span></a>
</span><span id="GAMCoach.generate_inter_options-918"><a href="#GAMCoach.generate_inter_options-918"><span class="linenos"> 918</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.generate_inter_options-919"><a href="#GAMCoach.generate_inter_options-919"><span class="linenos"> 919</span></a><span class="sd">            cur_feature_id (int): The id of this interaction effect.</span>
</span><span id="GAMCoach.generate_inter_options-920"><a href="#GAMCoach.generate_inter_options-920"><span class="linenos"> 920</span></a><span class="sd">            cur_feature_index_1 (int): The index of the first main effect.</span>
</span><span id="GAMCoach.generate_inter_options-921"><a href="#GAMCoach.generate_inter_options-921"><span class="linenos"> 921</span></a><span class="sd">            cur_feature_index_2 (int): The index of the second main effect.</span>
</span><span id="GAMCoach.generate_inter_options-922"><a href="#GAMCoach.generate_inter_options-922"><span class="linenos"> 922</span></a><span class="sd">            cur_feature_score (float): The score for the current feature value.</span>
</span><span id="GAMCoach.generate_inter_options-923"><a href="#GAMCoach.generate_inter_options-923"><span class="linenos"> 923</span></a><span class="sd">            options (dict): The current option list, feature_name -&gt;</span>
</span><span id="GAMCoach.generate_inter_options-924"><a href="#GAMCoach.generate_inter_options-924"><span class="linenos"> 924</span></a><span class="sd">                [`target`, `score_gain`, `distance`, `bin_id`].</span>
</span><span id="GAMCoach.generate_inter_options-925"><a href="#GAMCoach.generate_inter_options-925"><span class="linenos"> 925</span></a>
</span><span id="GAMCoach.generate_inter_options-926"><a href="#GAMCoach.generate_inter_options-926"><span class="linenos"> 926</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach.generate_inter_options-927"><a href="#GAMCoach.generate_inter_options-927"><span class="linenos"> 927</span></a><span class="sd">            List of option tuples (target, score_gain, distance, bin_index)</span>
</span><span id="GAMCoach.generate_inter_options-928"><a href="#GAMCoach.generate_inter_options-928"><span class="linenos"> 928</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.generate_inter_options-929"><a href="#GAMCoach.generate_inter_options-929"><span class="linenos"> 929</span></a>
</span><span id="GAMCoach.generate_inter_options-930"><a href="#GAMCoach.generate_inter_options-930"><span class="linenos"> 930</span></a>        <span class="c1"># Get the sub-types for this interaction term</span>
</span><span id="GAMCoach.generate_inter_options-931"><a href="#GAMCoach.generate_inter_options-931"><span class="linenos"> 931</span></a>        <span class="n">cur_feature_type_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_index_1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-932"><a href="#GAMCoach.generate_inter_options-932"><span class="linenos"> 932</span></a>        <span class="n">cur_feature_type_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_feature_index_2</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-933"><a href="#GAMCoach.generate_inter_options-933"><span class="linenos"> 933</span></a>
</span><span id="GAMCoach.generate_inter_options-934"><a href="#GAMCoach.generate_inter_options-934"><span class="linenos"> 934</span></a>        <span class="c1"># Get the sub-names for this interaction term</span>
</span><span id="GAMCoach.generate_inter_options-935"><a href="#GAMCoach.generate_inter_options-935"><span class="linenos"> 935</span></a>        <span class="n">cur_feature_name_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_index_1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-936"><a href="#GAMCoach.generate_inter_options-936"><span class="linenos"> 936</span></a>        <span class="n">cur_feature_name_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_feature_index_2</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-937"><a href="#GAMCoach.generate_inter_options-937"><span class="linenos"> 937</span></a>
</span><span id="GAMCoach.generate_inter_options-938"><a href="#GAMCoach.generate_inter_options-938"><span class="linenos"> 938</span></a>        <span class="c1"># The first column and row are reserved for missing values (even with</span>
</span><span id="GAMCoach.generate_inter_options-939"><a href="#GAMCoach.generate_inter_options-939"><span class="linenos"> 939</span></a>        <span class="c1"># categorical features)</span>
</span><span id="GAMCoach.generate_inter_options-940"><a href="#GAMCoach.generate_inter_options-940"><span class="linenos"> 940</span></a>        <span class="n">additives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">cur_feature_id</span><span class="p">][</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
</span><span id="GAMCoach.generate_inter_options-941"><a href="#GAMCoach.generate_inter_options-941"><span class="linenos"> 941</span></a>
</span><span id="GAMCoach.generate_inter_options-942"><a href="#GAMCoach.generate_inter_options-942"><span class="linenos"> 942</span></a>        <span class="c1"># Four possibilities here: cont x cont, cont x cat, cat x cont, cat x cat.</span>
</span><span id="GAMCoach.generate_inter_options-943"><a href="#GAMCoach.generate_inter_options-943"><span class="linenos"> 943</span></a>        <span class="c1"># Each has a different way to lookup the bin table.</span>
</span><span id="GAMCoach.generate_inter_options-944"><a href="#GAMCoach.generate_inter_options-944"><span class="linenos"> 944</span></a>        <span class="n">inter_options</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.generate_inter_options-945"><a href="#GAMCoach.generate_inter_options-945"><span class="linenos"> 945</span></a>
</span><span id="GAMCoach.generate_inter_options-946"><a href="#GAMCoach.generate_inter_options-946"><span class="linenos"> 946</span></a>        <span class="c1"># Iterate through all possible combinations of options from these two</span>
</span><span id="GAMCoach.generate_inter_options-947"><a href="#GAMCoach.generate_inter_options-947"><span class="linenos"> 947</span></a>        <span class="c1"># variables</span>
</span><span id="GAMCoach.generate_inter_options-948"><a href="#GAMCoach.generate_inter_options-948"><span class="linenos"> 948</span></a>        <span class="k">for</span> <span class="n">opt_1</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name_1</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_inter_options-949"><a href="#GAMCoach.generate_inter_options-949"><span class="linenos"> 949</span></a>            <span class="k">for</span> <span class="n">opt_2</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">cur_feature_name_2</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_inter_options-950"><a href="#GAMCoach.generate_inter_options-950"><span class="linenos"> 950</span></a>
</span><span id="GAMCoach.generate_inter_options-951"><a href="#GAMCoach.generate_inter_options-951"><span class="linenos"> 951</span></a>                <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach.generate_inter_options-952"><a href="#GAMCoach.generate_inter_options-952"><span class="linenos"> 952</span></a>                    <span class="n">cur_feature_index_1</span>
</span><span id="GAMCoach.generate_inter_options-953"><a href="#GAMCoach.generate_inter_options-953"><span class="linenos"> 953</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_inter_options-954"><a href="#GAMCoach.generate_inter_options-954"><span class="linenos"> 954</span></a>                <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span>
</span><span id="GAMCoach.generate_inter_options-955"><a href="#GAMCoach.generate_inter_options-955"><span class="linenos"> 955</span></a>                    <span class="n">cur_feature_index_2</span>
</span><span id="GAMCoach.generate_inter_options-956"><a href="#GAMCoach.generate_inter_options-956"><span class="linenos"> 956</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_inter_options-957"><a href="#GAMCoach.generate_inter_options-957"><span class="linenos"> 957</span></a>
</span><span id="GAMCoach.generate_inter_options-958"><a href="#GAMCoach.generate_inter_options-958"><span class="linenos"> 958</span></a>                <span class="n">bin_1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach.generate_inter_options-959"><a href="#GAMCoach.generate_inter_options-959"><span class="linenos"> 959</span></a>                <span class="n">bin_2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach.generate_inter_options-960"><a href="#GAMCoach.generate_inter_options-960"><span class="linenos"> 960</span></a>
</span><span id="GAMCoach.generate_inter_options-961"><a href="#GAMCoach.generate_inter_options-961"><span class="linenos"> 961</span></a>                <span class="k">if</span> <span class="n">cur_feature_type_1</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_inter_options-962"><a href="#GAMCoach.generate_inter_options-962"><span class="linenos"> 962</span></a>                    <span class="k">if</span> <span class="n">cur_feature_type_2</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_inter_options-963"><a href="#GAMCoach.generate_inter_options-963"><span class="linenos"> 963</span></a>                        <span class="c1"># cont x cont</span>
</span><span id="GAMCoach.generate_inter_options-964"><a href="#GAMCoach.generate_inter_options-964"><span class="linenos"> 964</span></a>                        <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-965"><a href="#GAMCoach.generate_inter_options-965"><span class="linenos"> 965</span></a>                        <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-966"><a href="#GAMCoach.generate_inter_options-966"><span class="linenos"> 966</span></a>
</span><span id="GAMCoach.generate_inter_options-967"><a href="#GAMCoach.generate_inter_options-967"><span class="linenos"> 967</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="GAMCoach.generate_inter_options-968"><a href="#GAMCoach.generate_inter_options-968"><span class="linenos"> 968</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_1</span><span class="p">,</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.generate_inter_options-969"><a href="#GAMCoach.generate_inter_options-969"><span class="linenos"> 969</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_2</span><span class="p">,</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.generate_inter_options-970"><a href="#GAMCoach.generate_inter_options-970"><span class="linenos"> 970</span></a>
</span><span id="GAMCoach.generate_inter_options-971"><a href="#GAMCoach.generate_inter_options-971"><span class="linenos"> 971</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_inter_options-972"><a href="#GAMCoach.generate_inter_options-972"><span class="linenos"> 972</span></a>                        <span class="c1"># cont x cat</span>
</span><span id="GAMCoach.generate_inter_options-973"><a href="#GAMCoach.generate_inter_options-973"><span class="linenos"> 973</span></a>                        <span class="n">bin_starts_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-974"><a href="#GAMCoach.generate_inter_options-974"><span class="linenos"> 974</span></a>
</span><span id="GAMCoach.generate_inter_options-975"><a href="#GAMCoach.generate_inter_options-975"><span class="linenos"> 975</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="GAMCoach.generate_inter_options-976"><a href="#GAMCoach.generate_inter_options-976"><span class="linenos"> 976</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_1</span><span class="p">,</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.generate_inter_options-977"><a href="#GAMCoach.generate_inter_options-977"><span class="linenos"> 977</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.generate_inter_options-978"><a href="#GAMCoach.generate_inter_options-978"><span class="linenos"> 978</span></a>
</span><span id="GAMCoach.generate_inter_options-979"><a href="#GAMCoach.generate_inter_options-979"><span class="linenos"> 979</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_inter_options-980"><a href="#GAMCoach.generate_inter_options-980"><span class="linenos"> 980</span></a>                    <span class="k">if</span> <span class="n">cur_feature_type_2</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.generate_inter_options-981"><a href="#GAMCoach.generate_inter_options-981"><span class="linenos"> 981</span></a>                        <span class="c1"># cat x cont</span>
</span><span id="GAMCoach.generate_inter_options-982"><a href="#GAMCoach.generate_inter_options-982"><span class="linenos"> 982</span></a>                        <span class="n">bin_starts_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-983"><a href="#GAMCoach.generate_inter_options-983"><span class="linenos"> 983</span></a>
</span><span id="GAMCoach.generate_inter_options-984"><a href="#GAMCoach.generate_inter_options-984"><span class="linenos"> 984</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="GAMCoach.generate_inter_options-985"><a href="#GAMCoach.generate_inter_options-985"><span class="linenos"> 985</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.generate_inter_options-986"><a href="#GAMCoach.generate_inter_options-986"><span class="linenos"> 986</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">search_sorted_lower_index</span><span class="p">(</span><span class="n">bin_starts_2</span><span class="p">,</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.generate_inter_options-987"><a href="#GAMCoach.generate_inter_options-987"><span class="linenos"> 987</span></a>
</span><span id="GAMCoach.generate_inter_options-988"><a href="#GAMCoach.generate_inter_options-988"><span class="linenos"> 988</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.generate_inter_options-989"><a href="#GAMCoach.generate_inter_options-989"><span class="linenos"> 989</span></a>                        <span class="c1"># cat x cat</span>
</span><span id="GAMCoach.generate_inter_options-990"><a href="#GAMCoach.generate_inter_options-990"><span class="linenos"> 990</span></a>
</span><span id="GAMCoach.generate_inter_options-991"><a href="#GAMCoach.generate_inter_options-991"><span class="linenos"> 991</span></a>                        <span class="c1"># locate the bin for each option value</span>
</span><span id="GAMCoach.generate_inter_options-992"><a href="#GAMCoach.generate_inter_options-992"><span class="linenos"> 992</span></a>                        <span class="n">bin_1</span> <span class="o">=</span> <span class="n">bin_starts_1</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.generate_inter_options-993"><a href="#GAMCoach.generate_inter_options-993"><span class="linenos"> 993</span></a>                        <span class="n">bin_2</span> <span class="o">=</span> <span class="n">bin_starts_2</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.generate_inter_options-994"><a href="#GAMCoach.generate_inter_options-994"><span class="linenos"> 994</span></a>
</span><span id="GAMCoach.generate_inter_options-995"><a href="#GAMCoach.generate_inter_options-995"><span class="linenos"> 995</span></a>                <span class="n">new_score</span> <span class="o">=</span> <span class="n">additives</span><span class="p">[</span><span class="n">bin_1</span><span class="p">,</span> <span class="n">bin_2</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-996"><a href="#GAMCoach.generate_inter_options-996"><span class="linenos"> 996</span></a>                <span class="n">score_gain</span> <span class="o">=</span> <span class="n">new_score</span> <span class="o">-</span> <span class="n">cur_feature_score</span>
</span><span id="GAMCoach.generate_inter_options-997"><a href="#GAMCoach.generate_inter_options-997"><span class="linenos"> 997</span></a>
</span><span id="GAMCoach.generate_inter_options-998"><a href="#GAMCoach.generate_inter_options-998"><span class="linenos"> 998</span></a>                <span class="c1"># The score gain on the interaction term need to offset the interaction</span>
</span><span id="GAMCoach.generate_inter_options-999"><a href="#GAMCoach.generate_inter_options-999"><span class="linenos"> 999</span></a>                <span class="c1"># score gain we have already counted on the main effect options. That</span>
</span><span id="GAMCoach.generate_inter_options-1000"><a href="#GAMCoach.generate_inter_options-1000"><span class="linenos">1000</span></a>                <span class="c1"># score is saved in the option tuple.</span>
</span><span id="GAMCoach.generate_inter_options-1001"><a href="#GAMCoach.generate_inter_options-1001"><span class="linenos">1001</span></a>
</span><span id="GAMCoach.generate_inter_options-1002"><a href="#GAMCoach.generate_inter_options-1002"><span class="linenos">1002</span></a>                <span class="c1"># We first need to find the common interaction id</span>
</span><span id="GAMCoach.generate_inter_options-1003"><a href="#GAMCoach.generate_inter_options-1003"><span class="linenos">1003</span></a>                <span class="n">common_index</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-1004"><a href="#GAMCoach.generate_inter_options-1004"><span class="linenos">1004</span></a>                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="GAMCoach.generate_inter_options-1005"><a href="#GAMCoach.generate_inter_options-1005"><span class="linenos">1005</span></a>                    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">])):</span>
</span><span id="GAMCoach.generate_inter_options-1006"><a href="#GAMCoach.generate_inter_options-1006"><span class="linenos">1006</span></a>                        <span class="k">if</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">m</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">n</span><span class="p">][</span><span class="mi">0</span><span class="p">]:</span>
</span><span id="GAMCoach.generate_inter_options-1007"><a href="#GAMCoach.generate_inter_options-1007"><span class="linenos">1007</span></a>                            <span class="n">common_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">,</span> <span class="n">n</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-1008"><a href="#GAMCoach.generate_inter_options-1008"><span class="linenos">1008</span></a>                            <span class="k">break</span>
</span><span id="GAMCoach.generate_inter_options-1009"><a href="#GAMCoach.generate_inter_options-1009"><span class="linenos">1009</span></a>
</span><span id="GAMCoach.generate_inter_options-1010"><a href="#GAMCoach.generate_inter_options-1010"><span class="linenos">1010</span></a>                    <span class="k">if</span> <span class="n">common_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">common_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
</span><span id="GAMCoach.generate_inter_options-1011"><a href="#GAMCoach.generate_inter_options-1011"><span class="linenos">1011</span></a>                        <span class="k">break</span>
</span><span id="GAMCoach.generate_inter_options-1012"><a href="#GAMCoach.generate_inter_options-1012"><span class="linenos">1012</span></a>
</span><span id="GAMCoach.generate_inter_options-1013"><a href="#GAMCoach.generate_inter_options-1013"><span class="linenos">1013</span></a>                <span class="n">score_gain</span> <span class="o">-=</span> <span class="n">opt_1</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">common_index</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-1014"><a href="#GAMCoach.generate_inter_options-1014"><span class="linenos">1014</span></a>                <span class="n">score_gain</span> <span class="o">-=</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">common_index</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-1015"><a href="#GAMCoach.generate_inter_options-1015"><span class="linenos">1015</span></a>
</span><span id="GAMCoach.generate_inter_options-1016"><a href="#GAMCoach.generate_inter_options-1016"><span class="linenos">1016</span></a>                <span class="n">inter_options</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="GAMCoach.generate_inter_options-1017"><a href="#GAMCoach.generate_inter_options-1017"><span class="linenos">1017</span></a>                    <span class="p">[[</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">score_gain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">[</span><span class="n">opt_1</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">opt_2</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="mi">0</span><span class="p">]</span>
</span><span id="GAMCoach.generate_inter_options-1018"><a href="#GAMCoach.generate_inter_options-1018"><span class="linenos">1018</span></a>                <span class="p">)</span>
</span><span id="GAMCoach.generate_inter_options-1019"><a href="#GAMCoach.generate_inter_options-1019"><span class="linenos">1019</span></a>
</span><span id="GAMCoach.generate_inter_options-1020"><a href="#GAMCoach.generate_inter_options-1020"><span class="linenos">1020</span></a>        <span class="k">return</span> <span class="n">inter_options</span>
</span></pre></div>


            <div class="docstring"><p>Generate all possible options for this interaction variable.</p>

<p>Interaction terms are interesting in this MILP. Each option counts as a
variable, but each variable only affects the score gain, not the distance.</p>

<p>Note that in EBM, the bin definitions for interaction terms can be different
from their definitions for individual continuous variables.</p>

<p>To model interaction terms, we can think it as a binary variable. The
value is determined by the multiplication of two main effect variables.
Each interaction variable describes a combination of two main effect
variables. Therefore, say continuous variable A has $x$ probable options,
and another continuous variable B has $y$ probable options, then we should
add $x \times y$ binary variables to offset their probable interaction
effects.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>cur_feature_id (int):</strong>  The id of this interaction effect.</li>
<li><strong>cur_feature_index_1 (int):</strong>  The index of the first main effect.</li>
<li><strong>cur_feature_index_2 (int):</strong>  The index of the second main effect.</li>
<li><strong>cur_feature_score (float):</strong>  The score for the current feature value.</li>
<li><strong>options (dict):</strong>  The current option list, feature_name ->
[<code>target</code>, <code>score_gain</code>, <code>distance</code>, <code>bin_id</code>].</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>List of option tuples (target, score_gain, distance, bin_index)</p>
</blockquote>
</div>


                            </div>
                            <div id="GAMCoach.create_milp" class="classattr">
                                        <input id="GAMCoach.create_milp-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">create_milp</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">cf_direction</span>,</span><span class="param">	<span class="n">needed_score_gain</span>,</span><span class="param">	<span class="n">features_to_vary</span>,</span><span class="param">	<span class="n">options</span>,</span><span class="param">	<span class="n">max_num_features_to_vary</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">muted_variables</span><span class="o">=</span><span class="p">[]</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GAMCoach.create_milp-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.create_milp"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.create_milp-1022"><a href="#GAMCoach.create_milp-1022"><span class="linenos">1022</span></a>    <span class="nd">@staticmethod</span>
</span><span id="GAMCoach.create_milp-1023"><a href="#GAMCoach.create_milp-1023"><span class="linenos">1023</span></a>    <span class="k">def</span> <span class="nf">create_milp</span><span class="p">(</span>
</span><span id="GAMCoach.create_milp-1024"><a href="#GAMCoach.create_milp-1024"><span class="linenos">1024</span></a>        <span class="n">cf_direction</span><span class="p">,</span>
</span><span id="GAMCoach.create_milp-1025"><a href="#GAMCoach.create_milp-1025"><span class="linenos">1025</span></a>        <span class="n">needed_score_gain</span><span class="p">,</span>
</span><span id="GAMCoach.create_milp-1026"><a href="#GAMCoach.create_milp-1026"><span class="linenos">1026</span></a>        <span class="n">features_to_vary</span><span class="p">,</span>
</span><span id="GAMCoach.create_milp-1027"><a href="#GAMCoach.create_milp-1027"><span class="linenos">1027</span></a>        <span class="n">options</span><span class="p">,</span>
</span><span id="GAMCoach.create_milp-1028"><a href="#GAMCoach.create_milp-1028"><span class="linenos">1028</span></a>        <span class="n">max_num_features_to_vary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="GAMCoach.create_milp-1029"><a href="#GAMCoach.create_milp-1029"><span class="linenos">1029</span></a>        <span class="n">muted_variables</span><span class="o">=</span><span class="p">[],</span>
</span><span id="GAMCoach.create_milp-1030"><a href="#GAMCoach.create_milp-1030"><span class="linenos">1030</span></a>    <span class="p">):</span>
</span><span id="GAMCoach.create_milp-1031"><a href="#GAMCoach.create_milp-1031"><span class="linenos">1031</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach.create_milp-1032"><a href="#GAMCoach.create_milp-1032"><span class="linenos">1032</span></a><span class="sd">        Create a MILP to find counterfactuals (CF) using PuLP.</span>
</span><span id="GAMCoach.create_milp-1033"><a href="#GAMCoach.create_milp-1033"><span class="linenos">1033</span></a>
</span><span id="GAMCoach.create_milp-1034"><a href="#GAMCoach.create_milp-1034"><span class="linenos">1034</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.create_milp-1035"><a href="#GAMCoach.create_milp-1035"><span class="linenos">1035</span></a><span class="sd">            cf_direction (int): Integer +1 if 0 =&gt; 1, -1 if 1 =&gt; 0 (classification),</span>
</span><span id="GAMCoach.create_milp-1036"><a href="#GAMCoach.create_milp-1036"><span class="linenos">1036</span></a><span class="sd">                +1 if we need to incrase the prediction, -1 if decrease (regression).</span>
</span><span id="GAMCoach.create_milp-1037"><a href="#GAMCoach.create_milp-1037"><span class="linenos">1037</span></a><span class="sd">            needed_score_gain (float): The score gain needed to achieve the CF goal.</span>
</span><span id="GAMCoach.create_milp-1038"><a href="#GAMCoach.create_milp-1038"><span class="linenos">1038</span></a><span class="sd">            features_to_vary (list[str]): Feature names of features that the</span>
</span><span id="GAMCoach.create_milp-1039"><a href="#GAMCoach.create_milp-1039"><span class="linenos">1039</span></a><span class="sd">                generated CF can change.</span>
</span><span id="GAMCoach.create_milp-1040"><a href="#GAMCoach.create_milp-1040"><span class="linenos">1040</span></a><span class="sd">            options (dict): Possible options for each variable. Each option is a</span>
</span><span id="GAMCoach.create_milp-1041"><a href="#GAMCoach.create_milp-1041"><span class="linenos">1041</span></a><span class="sd">                list [target, score_gain, distance, bin_index].</span>
</span><span id="GAMCoach.create_milp-1042"><a href="#GAMCoach.create_milp-1042"><span class="linenos">1042</span></a><span class="sd">            max_num_features_to_vary (int, optional): Max number of features that the</span>
</span><span id="GAMCoach.create_milp-1043"><a href="#GAMCoach.create_milp-1043"><span class="linenos">1043</span></a><span class="sd">                generated CF can change. If the value is `None`, the CFs can</span>
</span><span id="GAMCoach.create_milp-1044"><a href="#GAMCoach.create_milp-1044"><span class="linenos">1044</span></a><span class="sd">                change any number of features.</span>
</span><span id="GAMCoach.create_milp-1045"><a href="#GAMCoach.create_milp-1045"><span class="linenos">1045</span></a><span class="sd">            muted_variables (list[str], optional): Variables that this MILP should</span>
</span><span id="GAMCoach.create_milp-1046"><a href="#GAMCoach.create_milp-1046"><span class="linenos">1046</span></a><span class="sd">                not use. This is useful to mute optimal variables so we can explore</span>
</span><span id="GAMCoach.create_milp-1047"><a href="#GAMCoach.create_milp-1047"><span class="linenos">1047</span></a><span class="sd">                diverse solutions. This list should not include interaction variables.</span>
</span><span id="GAMCoach.create_milp-1048"><a href="#GAMCoach.create_milp-1048"><span class="linenos">1048</span></a>
</span><span id="GAMCoach.create_milp-1049"><a href="#GAMCoach.create_milp-1049"><span class="linenos">1049</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach.create_milp-1050"><a href="#GAMCoach.create_milp-1050"><span class="linenos">1050</span></a><span class="sd">            A tuple (`model`, `variables`), where `model` is a pulp.LpProblem</span>
</span><span id="GAMCoach.create_milp-1051"><a href="#GAMCoach.create_milp-1051"><span class="linenos">1051</span></a><span class="sd">            model that encodes the MILP problem, and `variables` is a dict of</span>
</span><span id="GAMCoach.create_milp-1052"><a href="#GAMCoach.create_milp-1052"><span class="linenos">1052</span></a><span class="sd">            variables used in the `model`: `feature_name` =&gt; [`variables`].</span>
</span><span id="GAMCoach.create_milp-1053"><a href="#GAMCoach.create_milp-1053"><span class="linenos">1053</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.create_milp-1054"><a href="#GAMCoach.create_milp-1054"><span class="linenos">1054</span></a>
</span><span id="GAMCoach.create_milp-1055"><a href="#GAMCoach.create_milp-1055"><span class="linenos">1055</span></a>        <span class="c1"># Create a model (minimizing the distance)</span>
</span><span id="GAMCoach.create_milp-1056"><a href="#GAMCoach.create_milp-1056"><span class="linenos">1056</span></a>        <span class="n">model</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpProblem</span><span class="p">(</span><span class="s2">&quot;ebmCounterfactual&quot;</span><span class="p">,</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpMinimize</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1057"><a href="#GAMCoach.create_milp-1057"><span class="linenos">1057</span></a>
</span><span id="GAMCoach.create_milp-1058"><a href="#GAMCoach.create_milp-1058"><span class="linenos">1058</span></a>        <span class="n">distance</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach.create_milp-1059"><a href="#GAMCoach.create_milp-1059"><span class="linenos">1059</span></a>        <span class="n">score_gain</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="GAMCoach.create_milp-1060"><a href="#GAMCoach.create_milp-1060"><span class="linenos">1060</span></a>
</span><span id="GAMCoach.create_milp-1061"><a href="#GAMCoach.create_milp-1061"><span class="linenos">1061</span></a>        <span class="n">muted_variables_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">muted_variables</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1062"><a href="#GAMCoach.create_milp-1062"><span class="linenos">1062</span></a>
</span><span id="GAMCoach.create_milp-1063"><a href="#GAMCoach.create_milp-1063"><span class="linenos">1063</span></a>        <span class="c1"># Create variables</span>
</span><span id="GAMCoach.create_milp-1064"><a href="#GAMCoach.create_milp-1064"><span class="linenos">1064</span></a>        <span class="n">variables</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach.create_milp-1065"><a href="#GAMCoach.create_milp-1065"><span class="linenos">1065</span></a>        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">features_to_vary</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1066"><a href="#GAMCoach.create_milp-1066"><span class="linenos">1066</span></a>            <span class="c1"># Each variable encodes an option (0: not use this option,</span>
</span><span id="GAMCoach.create_milp-1067"><a href="#GAMCoach.create_milp-1067"><span class="linenos">1067</span></a>            <span class="c1"># 1: use this option)</span>
</span><span id="GAMCoach.create_milp-1068"><a href="#GAMCoach.create_milp-1068"><span class="linenos">1068</span></a>            <span class="n">cur_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.create_milp-1069"><a href="#GAMCoach.create_milp-1069"><span class="linenos">1069</span></a>
</span><span id="GAMCoach.create_milp-1070"><a href="#GAMCoach.create_milp-1070"><span class="linenos">1070</span></a>            <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
</span><span id="GAMCoach.create_milp-1071"><a href="#GAMCoach.create_milp-1071"><span class="linenos">1071</span></a>                <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
</span><span id="GAMCoach.create_milp-1072"><a href="#GAMCoach.create_milp-1072"><span class="linenos">1072</span></a>
</span><span id="GAMCoach.create_milp-1073"><a href="#GAMCoach.create_milp-1073"><span class="linenos">1073</span></a>                <span class="c1"># Skip the muted variables</span>
</span><span id="GAMCoach.create_milp-1074"><a href="#GAMCoach.create_milp-1074"><span class="linenos">1074</span></a>                <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1075"><a href="#GAMCoach.create_milp-1075"><span class="linenos">1075</span></a>                    <span class="k">continue</span>
</span><span id="GAMCoach.create_milp-1076"><a href="#GAMCoach.create_milp-1076"><span class="linenos">1076</span></a>
</span><span id="GAMCoach.create_milp-1077"><a href="#GAMCoach.create_milp-1077"><span class="linenos">1077</span></a>                <span class="n">x</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upBound</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Binary&quot;</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1078"><a href="#GAMCoach.create_milp-1078"><span class="linenos">1078</span></a>                <span class="n">x</span><span class="o">.</span><span class="n">setInitialValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1079"><a href="#GAMCoach.create_milp-1079"><span class="linenos">1079</span></a>
</span><span id="GAMCoach.create_milp-1080"><a href="#GAMCoach.create_milp-1080"><span class="linenos">1080</span></a>                <span class="n">score_gain</span> <span class="o">+=</span> <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
</span><span id="GAMCoach.create_milp-1081"><a href="#GAMCoach.create_milp-1081"><span class="linenos">1081</span></a>                <span class="n">distance</span> <span class="o">+=</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
</span><span id="GAMCoach.create_milp-1082"><a href="#GAMCoach.create_milp-1082"><span class="linenos">1082</span></a>
</span><span id="GAMCoach.create_milp-1083"><a href="#GAMCoach.create_milp-1083"><span class="linenos">1083</span></a>                <span class="n">cur_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1084"><a href="#GAMCoach.create_milp-1084"><span class="linenos">1084</span></a>
</span><span id="GAMCoach.create_milp-1085"><a href="#GAMCoach.create_milp-1085"><span class="linenos">1085</span></a>            <span class="n">variables</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_variables</span>
</span><span id="GAMCoach.create_milp-1086"><a href="#GAMCoach.create_milp-1086"><span class="linenos">1086</span></a>
</span><span id="GAMCoach.create_milp-1087"><a href="#GAMCoach.create_milp-1087"><span class="linenos">1087</span></a>            <span class="c1"># A local constraint is that we can only at most selection one option from</span>
</span><span id="GAMCoach.create_milp-1088"><a href="#GAMCoach.create_milp-1088"><span class="linenos">1088</span></a>            <span class="c1"># one feature</span>
</span><span id="GAMCoach.create_milp-1089"><a href="#GAMCoach.create_milp-1089"><span class="linenos">1089</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">lpSum</span><span class="p">(</span><span class="n">cur_variables</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span>
</span><span id="GAMCoach.create_milp-1090"><a href="#GAMCoach.create_milp-1090"><span class="linenos">1090</span></a>
</span><span id="GAMCoach.create_milp-1091"><a href="#GAMCoach.create_milp-1091"><span class="linenos">1091</span></a>        <span class="c1"># Users can also set `max_num_features_to_vary` to control the total</span>
</span><span id="GAMCoach.create_milp-1092"><a href="#GAMCoach.create_milp-1092"><span class="linenos">1092</span></a>        <span class="c1"># number of features to vary</span>
</span><span id="GAMCoach.create_milp-1093"><a href="#GAMCoach.create_milp-1093"><span class="linenos">1093</span></a>        <span class="k">if</span> <span class="n">max_num_features_to_vary</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1094"><a href="#GAMCoach.create_milp-1094"><span class="linenos">1094</span></a>            <span class="n">main_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.create_milp-1095"><a href="#GAMCoach.create_milp-1095"><span class="linenos">1095</span></a>            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1096"><a href="#GAMCoach.create_milp-1096"><span class="linenos">1096</span></a>                <span class="n">main_variables</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">variables</span><span class="p">[</span><span class="n">f</span><span class="p">])</span>
</span><span id="GAMCoach.create_milp-1097"><a href="#GAMCoach.create_milp-1097"><span class="linenos">1097</span></a>
</span><span id="GAMCoach.create_milp-1098"><a href="#GAMCoach.create_milp-1098"><span class="linenos">1098</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">lpSum</span><span class="p">(</span><span class="n">main_variables</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">max_num_features_to_vary</span>
</span><span id="GAMCoach.create_milp-1099"><a href="#GAMCoach.create_milp-1099"><span class="linenos">1099</span></a>
</span><span id="GAMCoach.create_milp-1100"><a href="#GAMCoach.create_milp-1100"><span class="linenos">1100</span></a>        <span class="c1"># Create variables for interaction effects</span>
</span><span id="GAMCoach.create_milp-1101"><a href="#GAMCoach.create_milp-1101"><span class="linenos">1101</span></a>        <span class="k">for</span> <span class="n">opt_name</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1102"><a href="#GAMCoach.create_milp-1102"><span class="linenos">1102</span></a>            <span class="k">if</span> <span class="s2">&quot; x &quot;</span> <span class="ow">in</span> <span class="n">opt_name</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1103"><a href="#GAMCoach.create_milp-1103"><span class="linenos">1103</span></a>                <span class="n">f1_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+)\sx\s.+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">opt_name</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1104"><a href="#GAMCoach.create_milp-1104"><span class="linenos">1104</span></a>                <span class="n">f2_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+\sx\s(.+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">opt_name</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1105"><a href="#GAMCoach.create_milp-1105"><span class="linenos">1105</span></a>
</span><span id="GAMCoach.create_milp-1106"><a href="#GAMCoach.create_milp-1106"><span class="linenos">1106</span></a>                <span class="k">if</span> <span class="n">f1_name</span> <span class="ow">in</span> <span class="n">features_to_vary</span> <span class="ow">and</span> <span class="n">f2_name</span> <span class="ow">in</span> <span class="n">features_to_vary</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1107"><a href="#GAMCoach.create_milp-1107"><span class="linenos">1107</span></a>
</span><span id="GAMCoach.create_milp-1108"><a href="#GAMCoach.create_milp-1108"><span class="linenos">1108</span></a>                    <span class="c1"># We need to include this interaction effect</span>
</span><span id="GAMCoach.create_milp-1109"><a href="#GAMCoach.create_milp-1109"><span class="linenos">1109</span></a>                    <span class="n">cur_variables</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="GAMCoach.create_milp-1110"><a href="#GAMCoach.create_milp-1110"><span class="linenos">1110</span></a>
</span><span id="GAMCoach.create_milp-1111"><a href="#GAMCoach.create_milp-1111"><span class="linenos">1111</span></a>                    <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">opt_name</span><span class="p">]:</span>
</span><span id="GAMCoach.create_milp-1112"><a href="#GAMCoach.create_milp-1112"><span class="linenos">1112</span></a>                        <span class="n">z</span> <span class="o">=</span> <span class="n">pulp</span><span class="o">.</span><span class="n">LpVariable</span><span class="p">(</span>
</span><span id="GAMCoach.create_milp-1113"><a href="#GAMCoach.create_milp-1113"><span class="linenos">1113</span></a>                            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">,</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">opt_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span>
</span><span id="GAMCoach.create_milp-1114"><a href="#GAMCoach.create_milp-1114"><span class="linenos">1114</span></a>                            <span class="n">lowBound</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="GAMCoach.create_milp-1115"><a href="#GAMCoach.create_milp-1115"><span class="linenos">1115</span></a>                            <span class="n">upBound</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="GAMCoach.create_milp-1116"><a href="#GAMCoach.create_milp-1116"><span class="linenos">1116</span></a>                            <span class="n">cat</span><span class="o">=</span><span class="s2">&quot;Continuous&quot;</span><span class="p">,</span>
</span><span id="GAMCoach.create_milp-1117"><a href="#GAMCoach.create_milp-1117"><span class="linenos">1117</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach.create_milp-1118"><a href="#GAMCoach.create_milp-1118"><span class="linenos">1118</span></a>                        <span class="n">z</span><span class="o">.</span><span class="n">setInitialValue</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1119"><a href="#GAMCoach.create_milp-1119"><span class="linenos">1119</span></a>
</span><span id="GAMCoach.create_milp-1120"><a href="#GAMCoach.create_milp-1120"><span class="linenos">1120</span></a>                        <span class="c1"># Need to iterate through existing variables for f1 and f2 to find</span>
</span><span id="GAMCoach.create_milp-1121"><a href="#GAMCoach.create_milp-1121"><span class="linenos">1121</span></a>                        <span class="c1"># the corresponding variables</span>
</span><span id="GAMCoach.create_milp-1122"><a href="#GAMCoach.create_milp-1122"><span class="linenos">1122</span></a>                        <span class="n">x_f1</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach.create_milp-1123"><a href="#GAMCoach.create_milp-1123"><span class="linenos">1123</span></a>                        <span class="n">x_f2</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="GAMCoach.create_milp-1124"><a href="#GAMCoach.create_milp-1124"><span class="linenos">1124</span></a>
</span><span id="GAMCoach.create_milp-1125"><a href="#GAMCoach.create_milp-1125"><span class="linenos">1125</span></a>                        <span class="c1"># Skp if this interaction variable involves muted main variable</span>
</span><span id="GAMCoach.create_milp-1126"><a href="#GAMCoach.create_milp-1126"><span class="linenos">1126</span></a>                        <span class="n">x_f1_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f1_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
</span><span id="GAMCoach.create_milp-1127"><a href="#GAMCoach.create_milp-1127"><span class="linenos">1127</span></a>                        <span class="n">x_f2_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f2_name</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
</span><span id="GAMCoach.create_milp-1128"><a href="#GAMCoach.create_milp-1128"><span class="linenos">1128</span></a>
</span><span id="GAMCoach.create_milp-1129"><a href="#GAMCoach.create_milp-1129"><span class="linenos">1129</span></a>                        <span class="k">if</span> <span class="p">(</span>
</span><span id="GAMCoach.create_milp-1130"><a href="#GAMCoach.create_milp-1130"><span class="linenos">1130</span></a>                            <span class="n">x_f1_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span>
</span><span id="GAMCoach.create_milp-1131"><a href="#GAMCoach.create_milp-1131"><span class="linenos">1131</span></a>                            <span class="ow">or</span> <span class="n">x_f2_name</span> <span class="ow">in</span> <span class="n">muted_variables_set</span>
</span><span id="GAMCoach.create_milp-1132"><a href="#GAMCoach.create_milp-1132"><span class="linenos">1132</span></a>                        <span class="p">):</span>
</span><span id="GAMCoach.create_milp-1133"><a href="#GAMCoach.create_milp-1133"><span class="linenos">1133</span></a>                            <span class="k">continue</span>
</span><span id="GAMCoach.create_milp-1134"><a href="#GAMCoach.create_milp-1134"><span class="linenos">1134</span></a>
</span><span id="GAMCoach.create_milp-1135"><a href="#GAMCoach.create_milp-1135"><span class="linenos">1135</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">f1_name</span><span class="p">]:</span>
</span><span id="GAMCoach.create_milp-1136"><a href="#GAMCoach.create_milp-1136"><span class="linenos">1136</span></a>                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">x_f1_name</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1137"><a href="#GAMCoach.create_milp-1137"><span class="linenos">1137</span></a>                                <span class="n">x_f1</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="GAMCoach.create_milp-1138"><a href="#GAMCoach.create_milp-1138"><span class="linenos">1138</span></a>                                <span class="k">break</span>
</span><span id="GAMCoach.create_milp-1139"><a href="#GAMCoach.create_milp-1139"><span class="linenos">1139</span></a>
</span><span id="GAMCoach.create_milp-1140"><a href="#GAMCoach.create_milp-1140"><span class="linenos">1140</span></a>                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">variables</span><span class="p">[</span><span class="n">f2_name</span><span class="p">]:</span>
</span><span id="GAMCoach.create_milp-1141"><a href="#GAMCoach.create_milp-1141"><span class="linenos">1141</span></a>                            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">x_f2_name</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1142"><a href="#GAMCoach.create_milp-1142"><span class="linenos">1142</span></a>                                <span class="n">x_f2</span> <span class="o">=</span> <span class="n">x</span>
</span><span id="GAMCoach.create_milp-1143"><a href="#GAMCoach.create_milp-1143"><span class="linenos">1143</span></a>                                <span class="k">break</span>
</span><span id="GAMCoach.create_milp-1144"><a href="#GAMCoach.create_milp-1144"><span class="linenos">1144</span></a>
</span><span id="GAMCoach.create_milp-1145"><a href="#GAMCoach.create_milp-1145"><span class="linenos">1145</span></a>                        <span class="k">assert</span> <span class="n">x_f1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">x_f2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="GAMCoach.create_milp-1146"><a href="#GAMCoach.create_milp-1146"><span class="linenos">1146</span></a>
</span><span id="GAMCoach.create_milp-1147"><a href="#GAMCoach.create_milp-1147"><span class="linenos">1147</span></a>                        <span class="c1"># variable z is actually the product of x_f1 and x_f2</span>
</span><span id="GAMCoach.create_milp-1148"><a href="#GAMCoach.create_milp-1148"><span class="linenos">1148</span></a>                        <span class="c1"># We can linearize it by 3 constraints</span>
</span><span id="GAMCoach.create_milp-1149"><a href="#GAMCoach.create_milp-1149"><span class="linenos">1149</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">x_f1</span>
</span><span id="GAMCoach.create_milp-1150"><a href="#GAMCoach.create_milp-1150"><span class="linenos">1150</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="n">x_f2</span>
</span><span id="GAMCoach.create_milp-1151"><a href="#GAMCoach.create_milp-1151"><span class="linenos">1151</span></a>                        <span class="n">model</span> <span class="o">+=</span> <span class="n">z</span> <span class="o">&gt;=</span> <span class="n">x_f1</span> <span class="o">+</span> <span class="n">x_f2</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="GAMCoach.create_milp-1152"><a href="#GAMCoach.create_milp-1152"><span class="linenos">1152</span></a>
</span><span id="GAMCoach.create_milp-1153"><a href="#GAMCoach.create_milp-1153"><span class="linenos">1153</span></a>                        <span class="n">cur_variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
</span><span id="GAMCoach.create_milp-1154"><a href="#GAMCoach.create_milp-1154"><span class="linenos">1154</span></a>
</span><span id="GAMCoach.create_milp-1155"><a href="#GAMCoach.create_milp-1155"><span class="linenos">1155</span></a>                    <span class="n">variables</span><span class="p">[</span><span class="n">opt_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_variables</span>
</span><span id="GAMCoach.create_milp-1156"><a href="#GAMCoach.create_milp-1156"><span class="linenos">1156</span></a>
</span><span id="GAMCoach.create_milp-1157"><a href="#GAMCoach.create_milp-1157"><span class="linenos">1157</span></a>        <span class="c1"># Use constraint to express counterfactual</span>
</span><span id="GAMCoach.create_milp-1158"><a href="#GAMCoach.create_milp-1158"><span class="linenos">1158</span></a>        <span class="k">if</span> <span class="n">cf_direction</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1159"><a href="#GAMCoach.create_milp-1159"><span class="linenos">1159</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">score_gain</span> <span class="o">&gt;=</span> <span class="n">needed_score_gain</span>
</span><span id="GAMCoach.create_milp-1160"><a href="#GAMCoach.create_milp-1160"><span class="linenos">1160</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.create_milp-1161"><a href="#GAMCoach.create_milp-1161"><span class="linenos">1161</span></a>            <span class="n">model</span> <span class="o">+=</span> <span class="n">score_gain</span> <span class="o">&lt;=</span> <span class="n">needed_score_gain</span>
</span><span id="GAMCoach.create_milp-1162"><a href="#GAMCoach.create_milp-1162"><span class="linenos">1162</span></a>
</span><span id="GAMCoach.create_milp-1163"><a href="#GAMCoach.create_milp-1163"><span class="linenos">1163</span></a>        <span class="c1"># We want to minimize the distance</span>
</span><span id="GAMCoach.create_milp-1164"><a href="#GAMCoach.create_milp-1164"><span class="linenos">1164</span></a>        <span class="n">model</span> <span class="o">+=</span> <span class="n">distance</span>
</span><span id="GAMCoach.create_milp-1165"><a href="#GAMCoach.create_milp-1165"><span class="linenos">1165</span></a>
</span><span id="GAMCoach.create_milp-1166"><a href="#GAMCoach.create_milp-1166"><span class="linenos">1166</span></a>        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">variables</span>
</span></pre></div>


            <div class="docstring"><p>Create a MILP to find counterfactuals (CF) using PuLP.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>cf_direction (int):</strong>  Integer +1 if 0 =&gt; 1, -1 if 1 =&gt; 0 (classification),
+1 if we need to incrase the prediction, -1 if decrease (regression).</li>
<li><strong>needed_score_gain (float):</strong>  The score gain needed to achieve the CF goal.</li>
<li><strong>features_to_vary (list[str]):</strong>  Feature names of features that the
generated CF can change.</li>
<li><strong>options (dict):</strong>  Possible options for each variable. Each option is a
list [target, score_gain, distance, bin_index].</li>
<li><strong>max_num_features_to_vary (int, optional):</strong>  Max number of features that the
generated CF can change. If the value is <code>None</code>, the CFs can
change any number of features.</li>
<li><strong>muted_variables (list[str], optional):</strong>  Variables that this MILP should
not use. This is useful to mute optimal variables so we can explore
diverse solutions. This list should not include interaction variables.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A tuple (<code>model</code>, <code>variables</code>), where <code>model</code> is a pulp.LpProblem
  model that encodes the MILP problem, and <code>variables</code> is a dict of
  variables used in the <code>model</code>: <code>feature_name</code> =&gt; [<code>variables</code>].</p>
</blockquote>
</div>


                            </div>
                            <div id="GAMCoach.print_solution" class="classattr">
                                        <input id="GAMCoach.print_solution-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">print_solution</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">cur_example</span>, </span><span class="param"><span class="n">active_variables</span>, </span><span class="param"><span class="n">options</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GAMCoach.print_solution-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.print_solution"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.print_solution-1168"><a href="#GAMCoach.print_solution-1168"><span class="linenos">1168</span></a>    <span class="k">def</span> <span class="nf">print_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cur_example</span><span class="p">,</span> <span class="n">active_variables</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
</span><span id="GAMCoach.print_solution-1169"><a href="#GAMCoach.print_solution-1169"><span class="linenos">1169</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach.print_solution-1170"><a href="#GAMCoach.print_solution-1170"><span class="linenos">1170</span></a><span class="sd">        Print the optimal solution.</span>
</span><span id="GAMCoach.print_solution-1171"><a href="#GAMCoach.print_solution-1171"><span class="linenos">1171</span></a>
</span><span id="GAMCoach.print_solution-1172"><a href="#GAMCoach.print_solution-1172"><span class="linenos">1172</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.print_solution-1173"><a href="#GAMCoach.print_solution-1173"><span class="linenos">1173</span></a><span class="sd">            cur_example (np.ndarray): the original data point.</span>
</span><span id="GAMCoach.print_solution-1174"><a href="#GAMCoach.print_solution-1174"><span class="linenos">1174</span></a><span class="sd">            active_variables (list[variable]): binary variables with value 1.</span>
</span><span id="GAMCoach.print_solution-1175"><a href="#GAMCoach.print_solution-1175"><span class="linenos">1175</span></a><span class="sd">            options (dict): all the possible options for all features.</span>
</span><span id="GAMCoach.print_solution-1176"><a href="#GAMCoach.print_solution-1176"><span class="linenos">1176</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.print_solution-1177"><a href="#GAMCoach.print_solution-1177"><span class="linenos">1177</span></a>
</span><span id="GAMCoach.print_solution-1178"><a href="#GAMCoach.print_solution-1178"><span class="linenos">1178</span></a>        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">active_variables</span><span class="p">:</span>
</span><span id="GAMCoach.print_solution-1179"><a href="#GAMCoach.print_solution-1179"><span class="linenos">1179</span></a>            <span class="c1"># Skip interaction vars (included)</span>
</span><span id="GAMCoach.print_solution-1180"><a href="#GAMCoach.print_solution-1180"><span class="linenos">1180</span></a>            <span class="k">if</span> <span class="s2">&quot;_x_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
</span><span id="GAMCoach.print_solution-1181"><a href="#GAMCoach.print_solution-1181"><span class="linenos">1181</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+):\d+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="GAMCoach.print_solution-1182"><a href="#GAMCoach.print_solution-1182"><span class="linenos">1182</span></a>                <span class="n">bin_i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:(\d+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="GAMCoach.print_solution-1183"><a href="#GAMCoach.print_solution-1183"><span class="linenos">1183</span></a>
</span><span id="GAMCoach.print_solution-1184"><a href="#GAMCoach.print_solution-1184"><span class="linenos">1184</span></a>                <span class="c1"># Find the original value</span>
</span><span id="GAMCoach.print_solution-1185"><a href="#GAMCoach.print_solution-1185"><span class="linenos">1185</span></a>                <span class="n">org_value</span> <span class="o">=</span> <span class="n">cur_example</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)]</span>
</span><span id="GAMCoach.print_solution-1186"><a href="#GAMCoach.print_solution-1186"><span class="linenos">1186</span></a>
</span><span id="GAMCoach.print_solution-1187"><a href="#GAMCoach.print_solution-1187"><span class="linenos">1187</span></a>                <span class="c1"># Find the target bin</span>
</span><span id="GAMCoach.print_solution-1188"><a href="#GAMCoach.print_solution-1188"><span class="linenos">1188</span></a>                <span class="n">f_index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">f_name</span><span class="p">)</span>
</span><span id="GAMCoach.print_solution-1189"><a href="#GAMCoach.print_solution-1189"><span class="linenos">1189</span></a>                <span class="n">f_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">f_index</span><span class="p">]</span>
</span><span id="GAMCoach.print_solution-1190"><a href="#GAMCoach.print_solution-1190"><span class="linenos">1190</span></a>
</span><span id="GAMCoach.print_solution-1191"><a href="#GAMCoach.print_solution-1191"><span class="linenos">1191</span></a>                <span class="k">if</span> <span class="n">f_type</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="GAMCoach.print_solution-1192"><a href="#GAMCoach.print_solution-1192"><span class="linenos">1192</span></a>                    <span class="n">bin_starts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">f_index</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="GAMCoach.print_solution-1193"><a href="#GAMCoach.print_solution-1193"><span class="linenos">1193</span></a>
</span><span id="GAMCoach.print_solution-1194"><a href="#GAMCoach.print_solution-1194"><span class="linenos">1194</span></a>                    <span class="n">target_bin</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">,&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">bin_i</span><span class="p">])</span>
</span><span id="GAMCoach.print_solution-1195"><a href="#GAMCoach.print_solution-1195"><span class="linenos">1195</span></a>
</span><span id="GAMCoach.print_solution-1196"><a href="#GAMCoach.print_solution-1196"><span class="linenos">1196</span></a>                    <span class="k">if</span> <span class="n">bin_i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">):</span>
</span><span id="GAMCoach.print_solution-1197"><a href="#GAMCoach.print_solution-1197"><span class="linenos">1197</span></a>                        <span class="n">target_bin</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">bin_starts</span><span class="p">[</span><span class="n">bin_i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
</span><span id="GAMCoach.print_solution-1198"><a href="#GAMCoach.print_solution-1198"><span class="linenos">1198</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.print_solution-1199"><a href="#GAMCoach.print_solution-1199"><span class="linenos">1199</span></a>                        <span class="n">target_bin</span> <span class="o">+=</span> <span class="s2">&quot; inf)&quot;</span>
</span><span id="GAMCoach.print_solution-1200"><a href="#GAMCoach.print_solution-1200"><span class="linenos">1200</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.print_solution-1201"><a href="#GAMCoach.print_solution-1201"><span class="linenos">1201</span></a>                    <span class="n">target_bin</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
</span><span id="GAMCoach.print_solution-1202"><a href="#GAMCoach.print_solution-1202"><span class="linenos">1202</span></a>                    <span class="n">org_value</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">org_value</span><span class="p">)</span>
</span><span id="GAMCoach.print_solution-1203"><a href="#GAMCoach.print_solution-1203"><span class="linenos">1203</span></a>
</span><span id="GAMCoach.print_solution-1204"><a href="#GAMCoach.print_solution-1204"><span class="linenos">1204</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach.print_solution-1205"><a href="#GAMCoach.print_solution-1205"><span class="linenos">1205</span></a>                    <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_i</span><span class="p">:</span>
</span><span id="GAMCoach.print_solution-1206"><a href="#GAMCoach.print_solution-1206"><span class="linenos">1206</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="GAMCoach.print_solution-1207"><a href="#GAMCoach.print_solution-1207"><span class="linenos">1207</span></a>                            <span class="s2">&quot;Change &lt;</span><span class="si">{}</span><span class="s2">&gt; from </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="GAMCoach.print_solution-1208"><a href="#GAMCoach.print_solution-1208"><span class="linenos">1208</span></a>                                <span class="n">f_name</span><span class="p">,</span> <span class="n">org_value</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">target_bin</span>
</span><span id="GAMCoach.print_solution-1209"><a href="#GAMCoach.print_solution-1209"><span class="linenos">1209</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach.print_solution-1210"><a href="#GAMCoach.print_solution-1210"><span class="linenos">1210</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach.print_solution-1211"><a href="#GAMCoach.print_solution-1211"><span class="linenos">1211</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="GAMCoach.print_solution-1212"><a href="#GAMCoach.print_solution-1212"><span class="linenos">1212</span></a>                            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">* score gain: </span><span class="si">{:.4f}</span><span class="se">\n\t</span><span class="s2">* distance cost: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="GAMCoach.print_solution-1213"><a href="#GAMCoach.print_solution-1213"><span class="linenos">1213</span></a>                                <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">option</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span id="GAMCoach.print_solution-1214"><a href="#GAMCoach.print_solution-1214"><span class="linenos">1214</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach.print_solution-1215"><a href="#GAMCoach.print_solution-1215"><span class="linenos">1215</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach.print_solution-1216"><a href="#GAMCoach.print_solution-1216"><span class="linenos">1216</span></a>                        <span class="k">break</span>
</span><span id="GAMCoach.print_solution-1217"><a href="#GAMCoach.print_solution-1217"><span class="linenos">1217</span></a>
</span><span id="GAMCoach.print_solution-1218"><a href="#GAMCoach.print_solution-1218"><span class="linenos">1218</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="GAMCoach.print_solution-1219"><a href="#GAMCoach.print_solution-1219"><span class="linenos">1219</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(.+):.+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span id="GAMCoach.print_solution-1220"><a href="#GAMCoach.print_solution-1220"><span class="linenos">1220</span></a>                <span class="n">f_name</span> <span class="o">=</span> <span class="n">f_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_x_&quot;</span><span class="p">,</span> <span class="s2">&quot; x &quot;</span><span class="p">)</span>
</span><span id="GAMCoach.print_solution-1221"><a href="#GAMCoach.print_solution-1221"><span class="linenos">1221</span></a>                <span class="n">bin_0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:(\d+),\d+&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="GAMCoach.print_solution-1222"><a href="#GAMCoach.print_solution-1222"><span class="linenos">1222</span></a>                <span class="n">bin_1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;.+:\d+,(\d+)&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;\1&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
</span><span id="GAMCoach.print_solution-1223"><a href="#GAMCoach.print_solution-1223"><span class="linenos">1223</span></a>
</span><span id="GAMCoach.print_solution-1224"><a href="#GAMCoach.print_solution-1224"><span class="linenos">1224</span></a>                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">[</span><span class="n">f_name</span><span class="p">]:</span>
</span><span id="GAMCoach.print_solution-1225"><a href="#GAMCoach.print_solution-1225"><span class="linenos">1225</span></a>                    <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_0</span> <span class="ow">and</span> <span class="n">option</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">bin_1</span><span class="p">:</span>
</span><span id="GAMCoach.print_solution-1226"><a href="#GAMCoach.print_solution-1226"><span class="linenos">1226</span></a>                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Trigger interaction term: &lt;</span><span class="si">{}</span><span class="s2">&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f_name</span><span class="p">))</span>
</span><span id="GAMCoach.print_solution-1227"><a href="#GAMCoach.print_solution-1227"><span class="linenos">1227</span></a>                        <span class="nb">print</span><span class="p">(</span>
</span><span id="GAMCoach.print_solution-1228"><a href="#GAMCoach.print_solution-1228"><span class="linenos">1228</span></a>                            <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">* score gain: </span><span class="si">{:.4f}</span><span class="se">\n\t</span><span class="s2">* distance cost: </span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span><span id="GAMCoach.print_solution-1229"><a href="#GAMCoach.print_solution-1229"><span class="linenos">1229</span></a>                                <span class="n">option</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span>
</span><span id="GAMCoach.print_solution-1230"><a href="#GAMCoach.print_solution-1230"><span class="linenos">1230</span></a>                            <span class="p">)</span>
</span><span id="GAMCoach.print_solution-1231"><a href="#GAMCoach.print_solution-1231"><span class="linenos">1231</span></a>                        <span class="p">)</span>
</span><span id="GAMCoach.print_solution-1232"><a href="#GAMCoach.print_solution-1232"><span class="linenos">1232</span></a>                        <span class="k">break</span>
</span><span id="GAMCoach.print_solution-1233"><a href="#GAMCoach.print_solution-1233"><span class="linenos">1233</span></a>        <span class="nb">print</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Print the optimal solution.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>cur_example (np.ndarray):</strong>  the original data point.</li>
<li><strong>active_variables (list[variable]):</strong>  binary variables with value 1.</li>
<li><strong>options (dict):</strong>  all the possible options for all features.</li>
</ul>
</div>


                            </div>
                            <div id="GAMCoach.compute_mad" class="classattr">
                                        <input id="GAMCoach.compute_mad-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">compute_mad</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">xs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GAMCoach.compute_mad-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.compute_mad"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.compute_mad-1235"><a href="#GAMCoach.compute_mad-1235"><span class="linenos">1235</span></a>    <span class="nd">@staticmethod</span>
</span><span id="GAMCoach.compute_mad-1236"><a href="#GAMCoach.compute_mad-1236"><span class="linenos">1236</span></a>    <span class="k">def</span> <span class="nf">compute_mad</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="GAMCoach.compute_mad-1237"><a href="#GAMCoach.compute_mad-1237"><span class="linenos">1237</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach.compute_mad-1238"><a href="#GAMCoach.compute_mad-1238"><span class="linenos">1238</span></a><span class="sd">        Compute the median absolute deviation of a continuous feature.</span>
</span><span id="GAMCoach.compute_mad-1239"><a href="#GAMCoach.compute_mad-1239"><span class="linenos">1239</span></a>
</span><span id="GAMCoach.compute_mad-1240"><a href="#GAMCoach.compute_mad-1240"><span class="linenos">1240</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.compute_mad-1241"><a href="#GAMCoach.compute_mad-1241"><span class="linenos">1241</span></a><span class="sd">            xs (np.ndarray): A column of continuous values.</span>
</span><span id="GAMCoach.compute_mad-1242"><a href="#GAMCoach.compute_mad-1242"><span class="linenos">1242</span></a>
</span><span id="GAMCoach.compute_mad-1243"><a href="#GAMCoach.compute_mad-1243"><span class="linenos">1243</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach.compute_mad-1244"><a href="#GAMCoach.compute_mad-1244"><span class="linenos">1244</span></a><span class="sd">            float: MAD value of xs.</span>
</span><span id="GAMCoach.compute_mad-1245"><a href="#GAMCoach.compute_mad-1245"><span class="linenos">1245</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.compute_mad-1246"><a href="#GAMCoach.compute_mad-1246"><span class="linenos">1246</span></a>        <span class="n">xs_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">))</span>
</span><span id="GAMCoach.compute_mad-1247"><a href="#GAMCoach.compute_mad-1247"><span class="linenos">1247</span></a>        <span class="n">mad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xs</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">-</span> <span class="n">xs_median</span><span class="p">))</span>
</span><span id="GAMCoach.compute_mad-1248"><a href="#GAMCoach.compute_mad-1248"><span class="linenos">1248</span></a>        <span class="k">return</span> <span class="n">mad</span>
</span></pre></div>


            <div class="docstring"><p>Compute the median absolute deviation of a continuous feature.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>xs (np.ndarray):</strong>  A column of continuous values.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>float: MAD value of xs.</p>
</blockquote>
</div>


                            </div>
                            <div id="GAMCoach.compute_frequency_distance" class="classattr">
                                        <input id="GAMCoach.compute_frequency_distance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">compute_frequency_distance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">xs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GAMCoach.compute_frequency_distance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.compute_frequency_distance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.compute_frequency_distance-1250"><a href="#GAMCoach.compute_frequency_distance-1250"><span class="linenos">1250</span></a>    <span class="nd">@staticmethod</span>
</span><span id="GAMCoach.compute_frequency_distance-1251"><a href="#GAMCoach.compute_frequency_distance-1251"><span class="linenos">1251</span></a>    <span class="k">def</span> <span class="nf">compute_frequency_distance</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="GAMCoach.compute_frequency_distance-1252"><a href="#GAMCoach.compute_frequency_distance-1252"><span class="linenos">1252</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach.compute_frequency_distance-1253"><a href="#GAMCoach.compute_frequency_distance-1253"><span class="linenos">1253</span></a><span class="sd">        For categorical variables, we compute 1 - frequency as their distance. It implies</span>
</span><span id="GAMCoach.compute_frequency_distance-1254"><a href="#GAMCoach.compute_frequency_distance-1254"><span class="linenos">1254</span></a><span class="sd">        that switching to a frequent value takes less effort.</span>
</span><span id="GAMCoach.compute_frequency_distance-1255"><a href="#GAMCoach.compute_frequency_distance-1255"><span class="linenos">1255</span></a>
</span><span id="GAMCoach.compute_frequency_distance-1256"><a href="#GAMCoach.compute_frequency_distance-1256"><span class="linenos">1256</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.compute_frequency_distance-1257"><a href="#GAMCoach.compute_frequency_distance-1257"><span class="linenos">1257</span></a><span class="sd">            xs (np.ndarray): A column of categorical values.</span>
</span><span id="GAMCoach.compute_frequency_distance-1258"><a href="#GAMCoach.compute_frequency_distance-1258"><span class="linenos">1258</span></a>
</span><span id="GAMCoach.compute_frequency_distance-1259"><a href="#GAMCoach.compute_frequency_distance-1259"><span class="linenos">1259</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach.compute_frequency_distance-1260"><a href="#GAMCoach.compute_frequency_distance-1260"><span class="linenos">1260</span></a><span class="sd">            dict: category level -&gt; 1 - frequency.</span>
</span><span id="GAMCoach.compute_frequency_distance-1261"><a href="#GAMCoach.compute_frequency_distance-1261"><span class="linenos">1261</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.compute_frequency_distance-1262"><a href="#GAMCoach.compute_frequency_distance-1262"><span class="linenos">1262</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="GAMCoach.compute_frequency_distance-1263"><a href="#GAMCoach.compute_frequency_distance-1263"><span class="linenos">1263</span></a>
</span><span id="GAMCoach.compute_frequency_distance-1264"><a href="#GAMCoach.compute_frequency_distance-1264"><span class="linenos">1264</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach.compute_frequency_distance-1265"><a href="#GAMCoach.compute_frequency_distance-1265"><span class="linenos">1265</span></a>
</span><span id="GAMCoach.compute_frequency_distance-1266"><a href="#GAMCoach.compute_frequency_distance-1266"><span class="linenos">1266</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">counter</span><span class="p">:</span>
</span><span id="GAMCoach.compute_frequency_distance-1267"><a href="#GAMCoach.compute_frequency_distance-1267"><span class="linenos">1267</span></a>            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
</span><span id="GAMCoach.compute_frequency_distance-1268"><a href="#GAMCoach.compute_frequency_distance-1268"><span class="linenos">1268</span></a>
</span><span id="GAMCoach.compute_frequency_distance-1269"><a href="#GAMCoach.compute_frequency_distance-1269"><span class="linenos">1269</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>For categorical variables, we compute 1 - frequency as their distance. It implies
that switching to a frequent value takes less effort.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>xs (np.ndarray):</strong>  A column of categorical values.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>dict: category level -> 1 - frequency.</p>
</blockquote>
</div>


                            </div>
                            <div id="GAMCoach.compute_naive_cat_distance" class="classattr">
                                        <input id="GAMCoach.compute_naive_cat_distance-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@staticmethod</div>

        <span class="def">def</span>
        <span class="name">compute_naive_cat_distance</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">xs</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="GAMCoach.compute_naive_cat_distance-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#GAMCoach.compute_naive_cat_distance"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="GAMCoach.compute_naive_cat_distance-1271"><a href="#GAMCoach.compute_naive_cat_distance-1271"><span class="linenos">1271</span></a>    <span class="nd">@staticmethod</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1272"><a href="#GAMCoach.compute_naive_cat_distance-1272"><span class="linenos">1272</span></a>    <span class="k">def</span> <span class="nf">compute_naive_cat_distance</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1273"><a href="#GAMCoach.compute_naive_cat_distance-1273"><span class="linenos">1273</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1274"><a href="#GAMCoach.compute_naive_cat_distance-1274"><span class="linenos">1274</span></a><span class="sd">        Alternative to compute_frequency_distance() to compute distance for</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1275"><a href="#GAMCoach.compute_naive_cat_distance-1275"><span class="linenos">1275</span></a><span class="sd">        categorical variables. The distance 1 for different levels and 0 for</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1276"><a href="#GAMCoach.compute_naive_cat_distance-1276"><span class="linenos">1276</span></a><span class="sd">        the same levels. Here we give them all score 1, because same-level</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1277"><a href="#GAMCoach.compute_naive_cat_distance-1277"><span class="linenos">1277</span></a><span class="sd">        options will be filtered out when we create categorical options for the</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1278"><a href="#GAMCoach.compute_naive_cat_distance-1278"><span class="linenos">1278</span></a><span class="sd">        optimization program.</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1279"><a href="#GAMCoach.compute_naive_cat_distance-1279"><span class="linenos">1279</span></a>
</span><span id="GAMCoach.compute_naive_cat_distance-1280"><a href="#GAMCoach.compute_naive_cat_distance-1280"><span class="linenos">1280</span></a><span class="sd">        Args:</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1281"><a href="#GAMCoach.compute_naive_cat_distance-1281"><span class="linenos">1281</span></a><span class="sd">            xs (np.ndarray): A column of categorical values.</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1282"><a href="#GAMCoach.compute_naive_cat_distance-1282"><span class="linenos">1282</span></a>
</span><span id="GAMCoach.compute_naive_cat_distance-1283"><a href="#GAMCoach.compute_naive_cat_distance-1283"><span class="linenos">1283</span></a><span class="sd">        Returns:</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1284"><a href="#GAMCoach.compute_naive_cat_distance-1284"><span class="linenos">1284</span></a><span class="sd">            dict: category level -&gt; 1.</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1285"><a href="#GAMCoach.compute_naive_cat_distance-1285"><span class="linenos">1285</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1286"><a href="#GAMCoach.compute_naive_cat_distance-1286"><span class="linenos">1286</span></a>        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">xs</span><span class="p">)</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1287"><a href="#GAMCoach.compute_naive_cat_distance-1287"><span class="linenos">1287</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1288"><a href="#GAMCoach.compute_naive_cat_distance-1288"><span class="linenos">1288</span></a>
</span><span id="GAMCoach.compute_naive_cat_distance-1289"><a href="#GAMCoach.compute_naive_cat_distance-1289"><span class="linenos">1289</span></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">counter</span><span class="p">:</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1290"><a href="#GAMCoach.compute_naive_cat_distance-1290"><span class="linenos">1290</span></a>            <span class="n">results</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</span><span id="GAMCoach.compute_naive_cat_distance-1291"><a href="#GAMCoach.compute_naive_cat_distance-1291"><span class="linenos">1291</span></a>
</span><span id="GAMCoach.compute_naive_cat_distance-1292"><a href="#GAMCoach.compute_naive_cat_distance-1292"><span class="linenos">1292</span></a>        <span class="k">return</span> <span class="n">results</span>
</span></pre></div>


            <div class="docstring"><p>Alternative to compute_frequency_distance() to compute distance for
categorical variables. The distance 1 for different levels and 0 for
the same levels. Here we give them all score 1, because same-level
options will be filtered out when we create categorical options for the
optimization program.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>xs (np.ndarray):</strong>  A column of categorical values.</li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>dict: category level -> 1.</p>
</blockquote>
</div>


                            </div>
                </section>
                <section id="search_sorted_lower_index">
                            <input id="search_sorted_lower_index-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">search_sorted_lower_index</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">sorted_edges</span>, </span><span class="param"><span class="n">value</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="search_sorted_lower_index-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#search_sorted_lower_index"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="search_sorted_lower_index-1295"><a href="#search_sorted_lower_index-1295"><span class="linenos">1295</span></a><span class="k">def</span> <span class="nf">search_sorted_lower_index</span><span class="p">(</span><span class="n">sorted_edges</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
</span><span id="search_sorted_lower_index-1296"><a href="#search_sorted_lower_index-1296"><span class="linenos">1296</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Binary search to locate the correct bin for continuous features.&quot;&quot;&quot;</span>
</span><span id="search_sorted_lower_index-1297"><a href="#search_sorted_lower_index-1297"><span class="linenos">1297</span></a>    <span class="n">left</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="search_sorted_lower_index-1298"><a href="#search_sorted_lower_index-1298"><span class="linenos">1298</span></a>    <span class="n">right</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sorted_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span><span id="search_sorted_lower_index-1299"><a href="#search_sorted_lower_index-1299"><span class="linenos">1299</span></a>
</span><span id="search_sorted_lower_index-1300"><a href="#search_sorted_lower_index-1300"><span class="linenos">1300</span></a>    <span class="k">while</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="search_sorted_lower_index-1301"><a href="#search_sorted_lower_index-1301"><span class="linenos">1301</span></a>        <span class="n">i</span> <span class="o">=</span> <span class="n">left</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="search_sorted_lower_index-1302"><a href="#search_sorted_lower_index-1302"><span class="linenos">1302</span></a>
</span><span id="search_sorted_lower_index-1303"><a href="#search_sorted_lower_index-1303"><span class="linenos">1303</span></a>        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">sorted_edges</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="search_sorted_lower_index-1304"><a href="#search_sorted_lower_index-1304"><span class="linenos">1304</span></a>            <span class="n">left</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="search_sorted_lower_index-1305"><a href="#search_sorted_lower_index-1305"><span class="linenos">1305</span></a>        <span class="k">elif</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">sorted_edges</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
</span><span id="search_sorted_lower_index-1306"><a href="#search_sorted_lower_index-1306"><span class="linenos">1306</span></a>            <span class="n">right</span> <span class="o">=</span> <span class="n">i</span>
</span><span id="search_sorted_lower_index-1307"><a href="#search_sorted_lower_index-1307"><span class="linenos">1307</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="search_sorted_lower_index-1308"><a href="#search_sorted_lower_index-1308"><span class="linenos">1308</span></a>            <span class="k">return</span> <span class="n">i</span>
</span><span id="search_sorted_lower_index-1309"><a href="#search_sorted_lower_index-1309"><span class="linenos">1309</span></a>
</span><span id="search_sorted_lower_index-1310"><a href="#search_sorted_lower_index-1310"><span class="linenos">1310</span></a>    <span class="c1"># Handle out of bound issues</span>
</span><span id="search_sorted_lower_index-1311"><a href="#search_sorted_lower_index-1311"><span class="linenos">1311</span></a>    <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;=</span> <span class="n">sorted_edges</span><span class="p">[</span><span class="n">right</span><span class="p">]:</span>
</span><span id="search_sorted_lower_index-1312"><a href="#search_sorted_lower_index-1312"><span class="linenos">1312</span></a>        <span class="k">return</span> <span class="n">right</span>
</span><span id="search_sorted_lower_index-1313"><a href="#search_sorted_lower_index-1313"><span class="linenos">1313</span></a>    <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">sorted_edges</span><span class="p">[</span><span class="n">left</span><span class="p">]:</span>
</span><span id="search_sorted_lower_index-1314"><a href="#search_sorted_lower_index-1314"><span class="linenos">1314</span></a>        <span class="k">return</span> <span class="n">left</span>
</span><span id="search_sorted_lower_index-1315"><a href="#search_sorted_lower_index-1315"><span class="linenos">1315</span></a>
</span><span id="search_sorted_lower_index-1316"><a href="#search_sorted_lower_index-1316"><span class="linenos">1316</span></a>    <span class="k">return</span> <span class="n">right</span> <span class="o">-</span> <span class="mi">1</span>
</span></pre></div>


            <div class="docstring"><p>Binary search to locate the correct bin for continuous features.</p>
</div>


                </section>
                <section id="sigmoid">
                            <input id="sigmoid-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">sigmoid</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">x</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="sigmoid-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#sigmoid"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="sigmoid-1319"><a href="#sigmoid-1319"><span class="linenos">1319</span></a><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
</span><span id="sigmoid-1320"><a href="#sigmoid-1320"><span class="linenos">1320</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Sigmoid function.&quot;&quot;&quot;</span>
</span><span id="sigmoid-1321"><a href="#sigmoid-1321"><span class="linenos">1321</span></a>    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</span></pre></div>


            <div class="docstring"><p>Sigmoid function.</p>
</div>


                </section>
                <section id="get_model_data">
                            <input id="get_model_data-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_model_data</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">ebm</span>,</span><span class="param">	<span class="n">x_train</span>,</span><span class="param">	<span class="n">model_info</span>,</span><span class="param">	<span class="n">resort_categorical</span><span class="o">=</span><span class="kc">False</span>,</span><span class="param">	<span class="n">feature_info</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">feature_level_info</span><span class="o">=</span><span class="kc">None</span>,</span><span class="param">	<span class="n">feature_config</span><span class="o">=</span><span class="kc">None</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="get_model_data-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#get_model_data"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="get_model_data-1437"><a href="#get_model_data-1437"><span class="linenos">1437</span></a><span class="k">def</span> <span class="nf">get_model_data</span><span class="p">(</span>
</span><span id="get_model_data-1438"><a href="#get_model_data-1438"><span class="linenos">1438</span></a>    <span class="n">ebm</span><span class="p">,</span>
</span><span id="get_model_data-1439"><a href="#get_model_data-1439"><span class="linenos">1439</span></a>    <span class="n">x_train</span><span class="p">,</span>
</span><span id="get_model_data-1440"><a href="#get_model_data-1440"><span class="linenos">1440</span></a>    <span class="n">model_info</span><span class="p">,</span>
</span><span id="get_model_data-1441"><a href="#get_model_data-1441"><span class="linenos">1441</span></a>    <span class="n">resort_categorical</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="get_model_data-1442"><a href="#get_model_data-1442"><span class="linenos">1442</span></a>    <span class="n">feature_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="get_model_data-1443"><a href="#get_model_data-1443"><span class="linenos">1443</span></a>    <span class="n">feature_level_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="get_model_data-1444"><a href="#get_model_data-1444"><span class="linenos">1444</span></a>    <span class="n">feature_config</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="get_model_data-1445"><a href="#get_model_data-1445"><span class="linenos">1445</span></a><span class="p">):</span>
</span><span id="get_model_data-1446"><a href="#get_model_data-1446"><span class="linenos">1446</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="get_model_data-1447"><a href="#get_model_data-1447"><span class="linenos">1447</span></a><span class="sd">    Get the model data for GAM Coach.</span>
</span><span id="get_model_data-1448"><a href="#get_model_data-1448"><span class="linenos">1448</span></a><span class="sd">    Args:</span>
</span><span id="get_model_data-1449"><a href="#get_model_data-1449"><span class="linenos">1449</span></a><span class="sd">        ebm: Trained EBM model. ExplainableBoostingClassifier or</span>
</span><span id="get_model_data-1450"><a href="#get_model_data-1450"><span class="linenos">1450</span></a><span class="sd">            ExplainableBoostingRegressor object.</span>
</span><span id="get_model_data-1451"><a href="#get_model_data-1451"><span class="linenos">1451</span></a><span class="sd">        x_train: Training data. We use it to compute the mean absolute deviation</span>
</span><span id="get_model_data-1452"><a href="#get_model_data-1452"><span class="linenos">1452</span></a><span class="sd">            score for continuous features, and frequency scores for categorical</span>
</span><span id="get_model_data-1453"><a href="#get_model_data-1453"><span class="linenos">1453</span></a><span class="sd">            features.</span>
</span><span id="get_model_data-1454"><a href="#get_model_data-1454"><span class="linenos">1454</span></a><span class="sd">        model_info: Information about the model (class names, regression target</span>
</span><span id="get_model_data-1455"><a href="#get_model_data-1455"><span class="linenos">1455</span></a><span class="sd">            name). For classification, the order of classes matters. It should</span>
</span><span id="get_model_data-1456"><a href="#get_model_data-1456"><span class="linenos">1456</span></a><span class="sd">            be consistent with the class encoding index. For example, the first</span>
</span><span id="get_model_data-1457"><a href="#get_model_data-1457"><span class="linenos">1457</span></a><span class="sd">            element should be the name for class 0.</span>
</span><span id="get_model_data-1458"><a href="#get_model_data-1458"><span class="linenos">1458</span></a><span class="sd">            It has format:</span>
</span><span id="get_model_data-1459"><a href="#get_model_data-1459"><span class="linenos">1459</span></a><span class="sd">            `{&#39;classes&#39;: [&#39;loan rejection&#39;, &#39;loan approval&#39;]}` or</span>
</span><span id="get_model_data-1460"><a href="#get_model_data-1460"><span class="linenos">1460</span></a><span class="sd">            `{&#39;regressionName&#39;: &#39;interest rate&#39;}`</span>
</span><span id="get_model_data-1461"><a href="#get_model_data-1461"><span class="linenos">1461</span></a><span class="sd">        resort_categorical: Whether to sort the levels in categorical variable</span>
</span><span id="get_model_data-1462"><a href="#get_model_data-1462"><span class="linenos">1462</span></a><span class="sd">            by increasing order if all levels can be converted to numbers.</span>
</span><span id="get_model_data-1463"><a href="#get_model_data-1463"><span class="linenos">1463</span></a><span class="sd">        feature_info: You can provide a dictionary to give a separate display</span>
</span><span id="get_model_data-1464"><a href="#get_model_data-1464"><span class="linenos">1464</span></a><span class="sd">            name and optional description for each feature. By default, the</span>
</span><span id="get_model_data-1465"><a href="#get_model_data-1465"><span class="linenos">1465</span></a><span class="sd">            display name is the same as the feature name, and the description</span>
</span><span id="get_model_data-1466"><a href="#get_model_data-1466"><span class="linenos">1466</span></a><span class="sd">            is an emtpy string. `feature_info` can be partial (only including</span>
</span><span id="get_model_data-1467"><a href="#get_model_data-1467"><span class="linenos">1467</span></a><span class="sd">            some features). It has format:</span>
</span><span id="get_model_data-1468"><a href="#get_model_data-1468"><span class="linenos">1468</span></a><span class="sd">            `{&#39;feature_name&#39;: [&#39;display_name&#39;, &#39;description&#39;]}`</span>
</span><span id="get_model_data-1469"><a href="#get_model_data-1469"><span class="linenos">1469</span></a><span class="sd">        feature_level_info: You can provide a dictionary to give separate display</span>
</span><span id="get_model_data-1470"><a href="#get_model_data-1470"><span class="linenos">1470</span></a><span class="sd">            name and optional description for each level of categorical features.</span>
</span><span id="get_model_data-1471"><a href="#get_model_data-1471"><span class="linenos">1471</span></a><span class="sd">            By default, the display name is the same as the level name, and the</span>
</span><span id="get_model_data-1472"><a href="#get_model_data-1472"><span class="linenos">1472</span></a><span class="sd">            description is an empty string. `feature_info` can be partial</span>
</span><span id="get_model_data-1473"><a href="#get_model_data-1473"><span class="linenos">1473</span></a><span class="sd">            (e.g., only including some levels from some categorical features).</span>
</span><span id="get_model_data-1474"><a href="#get_model_data-1474"><span class="linenos">1474</span></a><span class="sd">            It has format:</span>
</span><span id="get_model_data-1475"><a href="#get_model_data-1475"><span class="linenos">1475</span></a><span class="sd">            `{&#39;feature_name&#39;: {level_id: [&#39;display_name&#39;, &#39;description&#39;]}}`</span>
</span><span id="get_model_data-1476"><a href="#get_model_data-1476"><span class="linenos">1476</span></a><span class="sd">        feature_config: You can provide a dictionary to configure the difficulty,</span>
</span><span id="get_model_data-1477"><a href="#get_model_data-1477"><span class="linenos">1477</span></a><span class="sd">            integer requirement, and acceptable range of individual features.</span>
</span><span id="get_model_data-1478"><a href="#get_model_data-1478"><span class="linenos">1478</span></a><span class="sd">            The difficulty is an integer between 1 and 6: 1 (very easy to change),</span>
</span><span id="get_model_data-1479"><a href="#get_model_data-1479"><span class="linenos">1479</span></a><span class="sd">            2 (easy), 3 (default), 4 (hard), 5 (very hard), 6 (impossible to change).</span>
</span><span id="get_model_data-1480"><a href="#get_model_data-1480"><span class="linenos">1480</span></a><span class="sd">            By default, difficulty is set to 3 for all features, requiresInt is</span>
</span><span id="get_model_data-1481"><a href="#get_model_data-1481"><span class="linenos">1481</span></a><span class="sd">            False for continuous variables, and acceptanceRange is None (search</span>
</span><span id="get_model_data-1482"><a href="#get_model_data-1482"><span class="linenos">1482</span></a><span class="sd">            all range).</span>
</span><span id="get_model_data-1483"><a href="#get_model_data-1483"><span class="linenos">1483</span></a><span class="sd">            The dictionary property has the following format:</span>
</span><span id="get_model_data-1484"><a href="#get_model_data-1484"><span class="linenos">1484</span></a><span class="sd">            `{&#39;difficulty&#39;: 3, &#39;requiresInt&#39;: True, &#39;acceptableRange&#39;: None}`</span>
</span><span id="get_model_data-1485"><a href="#get_model_data-1485"><span class="linenos">1485</span></a><span class="sd">    Returns:</span>
</span><span id="get_model_data-1486"><a href="#get_model_data-1486"><span class="linenos">1486</span></a><span class="sd">        A Python dictionary of model data</span>
</span><span id="get_model_data-1487"><a href="#get_model_data-1487"><span class="linenos">1487</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="get_model_data-1488"><a href="#get_model_data-1488"><span class="linenos">1488</span></a>    <span class="n">ROUND</span> <span class="o">=</span> <span class="mi">6</span>
</span><span id="get_model_data-1489"><a href="#get_model_data-1489"><span class="linenos">1489</span></a>
</span><span id="get_model_data-1490"><a href="#get_model_data-1490"><span class="linenos">1490</span></a>    <span class="c1"># Main model info on each feature</span>
</span><span id="get_model_data-1491"><a href="#get_model_data-1491"><span class="linenos">1491</span></a>    <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="get_model_data-1492"><a href="#get_model_data-1492"><span class="linenos">1492</span></a>
</span><span id="get_model_data-1493"><a href="#get_model_data-1493"><span class="linenos">1493</span></a>    <span class="c1"># Track the encoding of categorical feature levels</span>
</span><span id="get_model_data-1494"><a href="#get_model_data-1494"><span class="linenos">1494</span></a>    <span class="n">labelEncoder</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="get_model_data-1495"><a href="#get_model_data-1495"><span class="linenos">1495</span></a>
</span><span id="get_model_data-1496"><a href="#get_model_data-1496"><span class="linenos">1496</span></a>    <span class="c1"># Track the score range</span>
</span><span id="get_model_data-1497"><a href="#get_model_data-1497"><span class="linenos">1497</span></a>    <span class="n">score_range</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]</span>
</span><span id="get_model_data-1498"><a href="#get_model_data-1498"><span class="linenos">1498</span></a>
</span><span id="get_model_data-1499"><a href="#get_model_data-1499"><span class="linenos">1499</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">))):</span>
</span><span id="get_model_data-1500"><a href="#get_model_data-1500"><span class="linenos">1500</span></a>        <span class="n">cur_feature</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="get_model_data-1501"><a href="#get_model_data-1501"><span class="linenos">1501</span></a>        <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="get_model_data-1502"><a href="#get_model_data-1502"><span class="linenos">1502</span></a>        <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="get_model_data-1503"><a href="#get_model_data-1503"><span class="linenos">1503</span></a>        <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;importance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_importances_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="get_model_data-1504"><a href="#get_model_data-1504"><span class="linenos">1504</span></a>
</span><span id="get_model_data-1505"><a href="#get_model_data-1505"><span class="linenos">1505</span></a>        <span class="c1"># Handle interaction term differently from cont/cat</span>
</span><span id="get_model_data-1506"><a href="#get_model_data-1506"><span class="linenos">1506</span></a>        <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="get_model_data-1507"><a href="#get_model_data-1507"><span class="linenos">1507</span></a>            <span class="n">cur_id</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="get_model_data-1508"><a href="#get_model_data-1508"><span class="linenos">1508</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cur_id</span><span class="p">)</span>
</span><span id="get_model_data-1509"><a href="#get_model_data-1509"><span class="linenos">1509</span></a>
</span><span id="get_model_data-1510"><a href="#get_model_data-1510"><span class="linenos">1510</span></a>            <span class="c1"># Info for each individual feature</span>
</span><span id="get_model_data-1511"><a href="#get_model_data-1511"><span class="linenos">1511</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;name1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="get_model_data-1512"><a href="#get_model_data-1512"><span class="linenos">1512</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;name2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="get_model_data-1513"><a href="#get_model_data-1513"><span class="linenos">1513</span></a>
</span><span id="get_model_data-1514"><a href="#get_model_data-1514"><span class="linenos">1514</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="get_model_data-1515"><a href="#get_model_data-1515"><span class="linenos">1515</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="get_model_data-1516"><a href="#get_model_data-1516"><span class="linenos">1516</span></a>
</span><span id="get_model_data-1517"><a href="#get_model_data-1517"><span class="linenos">1517</span></a>            <span class="c1"># Skip the first item from both dimensions</span>
</span><span id="get_model_data-1518"><a href="#get_model_data-1518"><span class="linenos">1518</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ROUND</span><span class="p">)[</span>
</span><span id="get_model_data-1519"><a href="#get_model_data-1519"><span class="linenos">1519</span></a>                <span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="get_model_data-1520"><a href="#get_model_data-1520"><span class="linenos">1520</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1521"><a href="#get_model_data-1521"><span class="linenos">1521</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">term_standard_deviations_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ROUND</span><span class="p">)[</span>
</span><span id="get_model_data-1522"><a href="#get_model_data-1522"><span class="linenos">1522</span></a>                <span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="get_model_data-1523"><a href="#get_model_data-1523"><span class="linenos">1523</span></a>            <span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1524"><a href="#get_model_data-1524"><span class="linenos">1524</span></a>
</span><span id="get_model_data-1525"><a href="#get_model_data-1525"><span class="linenos">1525</span></a>            <span class="c1"># Get the bin label info</span>
</span><span id="get_model_data-1526"><a href="#get_model_data-1526"><span class="linenos">1526</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="get_model_data-1527"><a href="#get_model_data-1527"><span class="linenos">1527</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="get_model_data-1528"><a href="#get_model_data-1528"><span class="linenos">1528</span></a>
</span><span id="get_model_data-1529"><a href="#get_model_data-1529"><span class="linenos">1529</span></a>            <span class="c1"># Encode categorical levels as integers</span>
</span><span id="get_model_data-1530"><a href="#get_model_data-1530"><span class="linenos">1530</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="get_model_data-1531"><a href="#get_model_data-1531"><span class="linenos">1531</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="get_model_data-1532"><a href="#get_model_data-1532"><span class="linenos">1532</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="get_model_data-1533"><a href="#get_model_data-1533"><span class="linenos">1533</span></a>                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel1&quot;</span><span class="p">])</span>
</span><span id="get_model_data-1534"><a href="#get_model_data-1534"><span class="linenos">1534</span></a>                <span class="p">)</span>
</span><span id="get_model_data-1535"><a href="#get_model_data-1535"><span class="linenos">1535</span></a>
</span><span id="get_model_data-1536"><a href="#get_model_data-1536"><span class="linenos">1536</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type2&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="get_model_data-1537"><a href="#get_model_data-1537"><span class="linenos">1537</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="get_model_data-1538"><a href="#get_model_data-1538"><span class="linenos">1538</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="get_model_data-1539"><a href="#get_model_data-1539"><span class="linenos">1539</span></a>                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel2&quot;</span><span class="p">])</span>
</span><span id="get_model_data-1540"><a href="#get_model_data-1540"><span class="linenos">1540</span></a>                <span class="p">)</span>
</span><span id="get_model_data-1541"><a href="#get_model_data-1541"><span class="linenos">1541</span></a>
</span><span id="get_model_data-1542"><a href="#get_model_data-1542"><span class="linenos">1542</span></a>            <span class="c1"># Get density info</span>
</span><span id="get_model_data-1543"><a href="#get_model_data-1543"><span class="linenos">1543</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type1&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="get_model_data-1544"><a href="#get_model_data-1544"><span class="linenos">1544</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span><span id="get_model_data-1545"><a href="#get_model_data-1545"><span class="linenos">1545</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_edges</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="get_model_data-1546"><a href="#get_model_data-1546"><span class="linenos">1546</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="get_model_data-1547"><a href="#get_model_data-1547"><span class="linenos">1547</span></a>                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge1&quot;</span><span class="p">])</span>
</span><span id="get_model_data-1548"><a href="#get_model_data-1548"><span class="linenos">1548</span></a>                <span class="p">)</span>
</span><span id="get_model_data-1549"><a href="#get_model_data-1549"><span class="linenos">1549</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="get_model_data-1550"><a href="#get_model_data-1550"><span class="linenos">1550</span></a>                    <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_counts</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">ROUND</span>
</span><span id="get_model_data-1551"><a href="#get_model_data-1551"><span class="linenos">1551</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1552"><a href="#get_model_data-1552"><span class="linenos">1552</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="get_model_data-1553"><a href="#get_model_data-1553"><span class="linenos">1553</span></a>                <span class="c1"># Use KDE to draw density plots for cont features</span>
</span><span id="get_model_data-1554"><a href="#get_model_data-1554"><span class="linenos">1554</span></a>                <span class="n">edges</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">_get_kde_sample</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">cur_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
</span><span id="get_model_data-1555"><a href="#get_model_data-1555"><span class="linenos">1555</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1556"><a href="#get_model_data-1556"><span class="linenos">1556</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1557"><a href="#get_model_data-1557"><span class="linenos">1557</span></a>
</span><span id="get_model_data-1558"><a href="#get_model_data-1558"><span class="linenos">1558</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type2&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="get_model_data-1559"><a href="#get_model_data-1559"><span class="linenos">1559</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">pair_preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
</span><span id="get_model_data-1560"><a href="#get_model_data-1560"><span class="linenos">1560</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_edges</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span id="get_model_data-1561"><a href="#get_model_data-1561"><span class="linenos">1561</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="get_model_data-1562"><a href="#get_model_data-1562"><span class="linenos">1562</span></a>                    <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge2&quot;</span><span class="p">])</span>
</span><span id="get_model_data-1563"><a href="#get_model_data-1563"><span class="linenos">1563</span></a>                <span class="p">)</span>
</span><span id="get_model_data-1564"><a href="#get_model_data-1564"><span class="linenos">1564</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="get_model_data-1565"><a href="#get_model_data-1565"><span class="linenos">1565</span></a>                    <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_counts</span><span class="p">(</span><span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">ROUND</span>
</span><span id="get_model_data-1566"><a href="#get_model_data-1566"><span class="linenos">1566</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1567"><a href="#get_model_data-1567"><span class="linenos">1567</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="get_model_data-1568"><a href="#get_model_data-1568"><span class="linenos">1568</span></a>                <span class="c1"># Use KDE to draw density plots for cont features</span>
</span><span id="get_model_data-1569"><a href="#get_model_data-1569"><span class="linenos">1569</span></a>                <span class="n">edges</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">_get_kde_sample</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">cur_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
</span><span id="get_model_data-1570"><a href="#get_model_data-1570"><span class="linenos">1570</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1571"><a href="#get_model_data-1571"><span class="linenos">1571</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1572"><a href="#get_model_data-1572"><span class="linenos">1572</span></a>
</span><span id="get_model_data-1573"><a href="#get_model_data-1573"><span class="linenos">1573</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="get_model_data-1574"><a href="#get_model_data-1574"><span class="linenos">1574</span></a>            <span class="c1"># Skip the first item (reserved for missing value)</span>
</span><span id="get_model_data-1575"><a href="#get_model_data-1575"><span class="linenos">1575</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ROUND</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span>
</span><span id="get_model_data-1576"><a href="#get_model_data-1576"><span class="linenos">1576</span></a>                <span class="mi">1</span><span class="p">:</span>
</span><span id="get_model_data-1577"><a href="#get_model_data-1577"><span class="linenos">1577</span></a>            <span class="p">]</span>
</span><span id="get_model_data-1578"><a href="#get_model_data-1578"><span class="linenos">1578</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="get_model_data-1579"><a href="#get_model_data-1579"><span class="linenos">1579</span></a>                <span class="n">ebm</span><span class="o">.</span><span class="n">term_standard_deviations_</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ROUND</span>
</span><span id="get_model_data-1580"><a href="#get_model_data-1580"><span class="linenos">1580</span></a>            <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>
</span><span id="get_model_data-1581"><a href="#get_model_data-1581"><span class="linenos">1581</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span id="get_model_data-1582"><a href="#get_model_data-1582"><span class="linenos">1582</span></a>            <span class="n">cur_id</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_groups_</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="get_model_data-1583"><a href="#get_model_data-1583"><span class="linenos">1583</span></a>            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">col_bin_counts_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[</span>
</span><span id="get_model_data-1584"><a href="#get_model_data-1584"><span class="linenos">1584</span></a>                <span class="mi">1</span><span class="p">:</span>
</span><span id="get_model_data-1585"><a href="#get_model_data-1585"><span class="linenos">1585</span></a>            <span class="p">]</span>
</span><span id="get_model_data-1586"><a href="#get_model_data-1586"><span class="linenos">1586</span></a>
</span><span id="get_model_data-1587"><a href="#get_model_data-1587"><span class="linenos">1587</span></a>            <span class="c1"># Track the global score range</span>
</span><span id="get_model_data-1588"><a href="#get_model_data-1588"><span class="linenos">1588</span></a>            <span class="n">score_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
</span><span id="get_model_data-1589"><a href="#get_model_data-1589"><span class="linenos">1589</span></a>                <span class="n">score_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span><span id="get_model_data-1590"><a href="#get_model_data-1590"><span class="linenos">1590</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">ebm</span><span class="o">.</span><span class="n">term_standard_deviations_</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
</span><span id="get_model_data-1591"><a href="#get_model_data-1591"><span class="linenos">1591</span></a>            <span class="p">)</span>
</span><span id="get_model_data-1592"><a href="#get_model_data-1592"><span class="linenos">1592</span></a>            <span class="n">score_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
</span><span id="get_model_data-1593"><a href="#get_model_data-1593"><span class="linenos">1593</span></a>                <span class="n">score_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
</span><span id="get_model_data-1594"><a href="#get_model_data-1594"><span class="linenos">1594</span></a>                <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">additive_terms_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">ebm</span><span class="o">.</span><span class="n">term_standard_deviations_</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
</span><span id="get_model_data-1595"><a href="#get_model_data-1595"><span class="linenos">1595</span></a>            <span class="p">)</span>
</span><span id="get_model_data-1596"><a href="#get_model_data-1596"><span class="linenos">1596</span></a>
</span><span id="get_model_data-1597"><a href="#get_model_data-1597"><span class="linenos">1597</span></a>            <span class="c1"># Add the binning information for continuous features</span>
</span><span id="get_model_data-1598"><a href="#get_model_data-1598"><span class="linenos">1598</span></a>            <span class="k">if</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="get_model_data-1599"><a href="#get_model_data-1599"><span class="linenos">1599</span></a>                <span class="c1"># Add the bin information</span>
</span><span id="get_model_data-1600"><a href="#get_model_data-1600"><span class="linenos">1600</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binEdge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_id</span><span class="p">)</span>
</span><span id="get_model_data-1601"><a href="#get_model_data-1601"><span class="linenos">1601</span></a>
</span><span id="get_model_data-1602"><a href="#get_model_data-1602"><span class="linenos">1602</span></a>                <span class="c1"># Use KDE to draw density plots for cont features</span>
</span><span id="get_model_data-1603"><a href="#get_model_data-1603"><span class="linenos">1603</span></a>                <span class="n">edges</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">_get_kde_sample</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">cur_id</span><span class="p">])</span>
</span><span id="get_model_data-1604"><a href="#get_model_data-1604"><span class="linenos">1604</span></a>
</span><span id="get_model_data-1605"><a href="#get_model_data-1605"><span class="linenos">1605</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1606"><a href="#get_model_data-1606"><span class="linenos">1606</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1607"><a href="#get_model_data-1607"><span class="linenos">1607</span></a>
</span><span id="get_model_data-1608"><a href="#get_model_data-1608"><span class="linenos">1608</span></a>            <span class="k">elif</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">:</span>
</span><span id="get_model_data-1609"><a href="#get_model_data-1609"><span class="linenos">1609</span></a>                <span class="c1"># Get the level value mapping</span>
</span><span id="get_model_data-1610"><a href="#get_model_data-1610"><span class="linenos">1610</span></a>                <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">col_mapping_</span><span class="p">[</span><span class="n">cur_id</span><span class="p">]</span>
</span><span id="get_model_data-1611"><a href="#get_model_data-1611"><span class="linenos">1611</span></a>
</span><span id="get_model_data-1612"><a href="#get_model_data-1612"><span class="linenos">1612</span></a>                <span class="k">if</span> <span class="n">resort_categorical</span><span class="p">:</span>
</span><span id="get_model_data-1613"><a href="#get_model_data-1613"><span class="linenos">1613</span></a>                    <span class="n">level_str_to_int</span> <span class="o">=</span> <span class="n">_resort_categorical_level</span><span class="p">(</span><span class="n">level_str_to_int</span><span class="p">)</span>
</span><span id="get_model_data-1614"><a href="#get_model_data-1614"><span class="linenos">1614</span></a>
</span><span id="get_model_data-1615"><a href="#get_model_data-1615"><span class="linenos">1615</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="get_model_data-1616"><a href="#get_model_data-1616"><span class="linenos">1616</span></a>                    <span class="nb">map</span><span class="p">(</span>
</span><span id="get_model_data-1617"><a href="#get_model_data-1617"><span class="linenos">1617</span></a>                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
</span><span id="get_model_data-1618"><a href="#get_model_data-1618"><span class="linenos">1618</span></a>                        <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_bin_labels</span><span class="p">(</span><span class="n">cur_id</span><span class="p">),</span>
</span><span id="get_model_data-1619"><a href="#get_model_data-1619"><span class="linenos">1619</span></a>                    <span class="p">)</span>
</span><span id="get_model_data-1620"><a href="#get_model_data-1620"><span class="linenos">1620</span></a>                <span class="p">)</span>
</span><span id="get_model_data-1621"><a href="#get_model_data-1621"><span class="linenos">1621</span></a>
</span><span id="get_model_data-1622"><a href="#get_model_data-1622"><span class="linenos">1622</span></a>                <span class="c1"># Add the hist information</span>
</span><span id="get_model_data-1623"><a href="#get_model_data-1623"><span class="linenos">1623</span></a>                <span class="c1"># For categorical data, the edges are strings</span>
</span><span id="get_model_data-1624"><a href="#get_model_data-1624"><span class="linenos">1624</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="get_model_data-1625"><a href="#get_model_data-1625"><span class="linenos">1625</span></a>                    <span class="nb">map</span><span class="p">(</span>
</span><span id="get_model_data-1626"><a href="#get_model_data-1626"><span class="linenos">1626</span></a>                        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">level_str_to_int</span><span class="p">[</span><span class="n">x</span><span class="p">],</span>
</span><span id="get_model_data-1627"><a href="#get_model_data-1627"><span class="linenos">1627</span></a>                        <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_edges</span><span class="p">(</span><span class="n">cur_id</span><span class="p">),</span>
</span><span id="get_model_data-1628"><a href="#get_model_data-1628"><span class="linenos">1628</span></a>                    <span class="p">)</span>
</span><span id="get_model_data-1629"><a href="#get_model_data-1629"><span class="linenos">1629</span></a>                <span class="p">)</span>
</span><span id="get_model_data-1630"><a href="#get_model_data-1630"><span class="linenos">1630</span></a>
</span><span id="get_model_data-1631"><a href="#get_model_data-1631"><span class="linenos">1631</span></a>                <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
</span><span id="get_model_data-1632"><a href="#get_model_data-1632"><span class="linenos">1632</span></a>                    <span class="n">ebm</span><span class="o">.</span><span class="n">preprocessor_</span><span class="o">.</span><span class="n">_get_hist_counts</span><span class="p">(</span><span class="n">cur_id</span><span class="p">),</span> <span class="n">ROUND</span>
</span><span id="get_model_data-1633"><a href="#get_model_data-1633"><span class="linenos">1633</span></a>                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
</span><span id="get_model_data-1634"><a href="#get_model_data-1634"><span class="linenos">1634</span></a>
</span><span id="get_model_data-1635"><a href="#get_model_data-1635"><span class="linenos">1635</span></a>                <span class="k">if</span> <span class="n">resort_categorical</span><span class="p">:</span>
</span><span id="get_model_data-1636"><a href="#get_model_data-1636"><span class="linenos">1636</span></a>                    <span class="n">cur_bin_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="get_model_data-1637"><a href="#get_model_data-1637"><span class="linenos">1637</span></a>                        <span class="nb">zip</span><span class="p">(</span>
</span><span id="get_model_data-1638"><a href="#get_model_data-1638"><span class="linenos">1638</span></a>                            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel&quot;</span><span class="p">],</span>
</span><span id="get_model_data-1639"><a href="#get_model_data-1639"><span class="linenos">1639</span></a>                            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">],</span>
</span><span id="get_model_data-1640"><a href="#get_model_data-1640"><span class="linenos">1640</span></a>                            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">],</span>
</span><span id="get_model_data-1641"><a href="#get_model_data-1641"><span class="linenos">1641</span></a>                            <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span>
</span><span id="get_model_data-1642"><a href="#get_model_data-1642"><span class="linenos">1642</span></a>                        <span class="p">)</span>
</span><span id="get_model_data-1643"><a href="#get_model_data-1643"><span class="linenos">1643</span></a>                    <span class="p">)</span>
</span><span id="get_model_data-1644"><a href="#get_model_data-1644"><span class="linenos">1644</span></a>                    <span class="n">cur_bin_info</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cur_bin_info</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="get_model_data-1645"><a href="#get_model_data-1645"><span class="linenos">1645</span></a>
</span><span id="get_model_data-1646"><a href="#get_model_data-1646"><span class="linenos">1646</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;binLabel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_bin_info</span><span class="p">]</span>
</span><span id="get_model_data-1647"><a href="#get_model_data-1647"><span class="linenos">1647</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;additive&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_bin_info</span><span class="p">]</span>
</span><span id="get_model_data-1648"><a href="#get_model_data-1648"><span class="linenos">1648</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_bin_info</span><span class="p">]</span>
</span><span id="get_model_data-1649"><a href="#get_model_data-1649"><span class="linenos">1649</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_bin_info</span><span class="p">]</span>
</span><span id="get_model_data-1650"><a href="#get_model_data-1650"><span class="linenos">1650</span></a>
</span><span id="get_model_data-1651"><a href="#get_model_data-1651"><span class="linenos">1651</span></a>                    <span class="n">cur_hist_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="get_model_data-1652"><a href="#get_model_data-1652"><span class="linenos">1652</span></a>                        <span class="nb">zip</span><span class="p">(</span><span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge&quot;</span><span class="p">],</span> <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount&quot;</span><span class="p">])</span>
</span><span id="get_model_data-1653"><a href="#get_model_data-1653"><span class="linenos">1653</span></a>                    <span class="p">)</span>
</span><span id="get_model_data-1654"><a href="#get_model_data-1654"><span class="linenos">1654</span></a>                    <span class="n">cur_hist_info</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">cur_hist_info</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span id="get_model_data-1655"><a href="#get_model_data-1655"><span class="linenos">1655</span></a>
</span><span id="get_model_data-1656"><a href="#get_model_data-1656"><span class="linenos">1656</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histEdge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_hist_info</span><span class="p">]</span>
</span><span id="get_model_data-1657"><a href="#get_model_data-1657"><span class="linenos">1657</span></a>                    <span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;histCount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_hist_info</span><span class="p">]</span>
</span><span id="get_model_data-1658"><a href="#get_model_data-1658"><span class="linenos">1658</span></a>
</span><span id="get_model_data-1659"><a href="#get_model_data-1659"><span class="linenos">1659</span></a>                <span class="c1"># Add the label encoding information</span>
</span><span id="get_model_data-1660"><a href="#get_model_data-1660"><span class="linenos">1660</span></a>                <span class="n">labelEncoder</span><span class="p">[</span><span class="n">cur_feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="get_model_data-1661"><a href="#get_model_data-1661"><span class="linenos">1661</span></a>                    <span class="n">i</span><span class="p">:</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">level_str_to_int</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="get_model_data-1662"><a href="#get_model_data-1662"><span class="linenos">1662</span></a>                <span class="p">}</span>
</span><span id="get_model_data-1663"><a href="#get_model_data-1663"><span class="linenos">1663</span></a>
</span><span id="get_model_data-1664"><a href="#get_model_data-1664"><span class="linenos">1664</span></a>        <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_feature</span><span class="p">)</span>
</span><span id="get_model_data-1665"><a href="#get_model_data-1665"><span class="linenos">1665</span></a>
</span><span id="get_model_data-1666"><a href="#get_model_data-1666"><span class="linenos">1666</span></a>    <span class="n">score_range</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ROUND</span><span class="p">),</span> <span class="n">score_range</span><span class="p">))</span>
</span><span id="get_model_data-1667"><a href="#get_model_data-1667"><span class="linenos">1667</span></a>
</span><span id="get_model_data-1668"><a href="#get_model_data-1668"><span class="linenos">1668</span></a>    <span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="get_model_data-1669"><a href="#get_model_data-1669"><span class="linenos">1669</span></a>    <span class="n">feature_types</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="get_model_data-1670"><a href="#get_model_data-1670"><span class="linenos">1670</span></a>
</span><span id="get_model_data-1671"><a href="#get_model_data-1671"><span class="linenos">1671</span></a>    <span class="c1"># Sample data does not record interaction features</span>
</span><span id="get_model_data-1672"><a href="#get_model_data-1672"><span class="linenos">1672</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">)):</span>
</span><span id="get_model_data-1673"><a href="#get_model_data-1673"><span class="linenos">1673</span></a>        <span class="k">if</span> <span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;interaction&quot;</span><span class="p">:</span>
</span><span id="get_model_data-1674"><a href="#get_model_data-1674"><span class="linenos">1674</span></a>            <span class="n">feature_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="get_model_data-1675"><a href="#get_model_data-1675"><span class="linenos">1675</span></a>            <span class="n">feature_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
</span><span id="get_model_data-1676"><a href="#get_model_data-1676"><span class="linenos">1676</span></a>
</span><span id="get_model_data-1677"><a href="#get_model_data-1677"><span class="linenos">1677</span></a>    <span class="c1"># Compute the MAD scores and frequencies</span>
</span><span id="get_model_data-1678"><a href="#get_model_data-1678"><span class="linenos">1678</span></a>    <span class="n">ebm_cont_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="get_model_data-1679"><a href="#get_model_data-1679"><span class="linenos">1679</span></a>        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">))</span> <span class="k">if</span> <span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;continuous&quot;</span><span class="p">]</span>
</span><span id="get_model_data-1680"><a href="#get_model_data-1680"><span class="linenos">1680</span></a>    <span class="p">)</span>
</span><span id="get_model_data-1681"><a href="#get_model_data-1681"><span class="linenos">1681</span></a>
</span><span id="get_model_data-1682"><a href="#get_model_data-1682"><span class="linenos">1682</span></a>    <span class="n">contMads</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="get_model_data-1683"><a href="#get_model_data-1683"><span class="linenos">1683</span></a>
</span><span id="get_model_data-1684"><a href="#get_model_data-1684"><span class="linenos">1684</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cont_indexes</span><span class="p">:</span>
</span><span id="get_model_data-1685"><a href="#get_model_data-1685"><span class="linenos">1685</span></a>        <span class="n">contMads</span><span class="p">[</span><span class="n">ebm</span><span class="o">.</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_mad</span><span class="p">(</span><span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
</span><span id="get_model_data-1686"><a href="#get_model_data-1686"><span class="linenos">1686</span></a>
</span><span id="get_model_data-1687"><a href="#get_model_data-1687"><span class="linenos">1687</span></a>    <span class="n">ebm_cat_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
</span><span id="get_model_data-1688"><a href="#get_model_data-1688"><span class="linenos">1688</span></a>        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">feature_names</span><span class="p">))</span> <span class="k">if</span> <span class="n">feature_types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;categorical&quot;</span><span class="p">]</span>
</span><span id="get_model_data-1689"><a href="#get_model_data-1689"><span class="linenos">1689</span></a>    <span class="p">)</span>
</span><span id="get_model_data-1690"><a href="#get_model_data-1690"><span class="linenos">1690</span></a>
</span><span id="get_model_data-1691"><a href="#get_model_data-1691"><span class="linenos">1691</span></a>    <span class="n">catDistances</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="get_model_data-1692"><a href="#get_model_data-1692"><span class="linenos">1692</span></a>
</span><span id="get_model_data-1693"><a href="#get_model_data-1693"><span class="linenos">1693</span></a>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ebm_cat_indexes</span><span class="p">:</span>
</span><span id="get_model_data-1694"><a href="#get_model_data-1694"><span class="linenos">1694</span></a>        <span class="n">catDistances</span><span class="p">[</span><span class="n">feature_names</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">GAMCoach</span><span class="o">.</span><span class="n">compute_frequency_distance</span><span class="p">(</span>
</span><span id="get_model_data-1695"><a href="#get_model_data-1695"><span class="linenos">1695</span></a>            <span class="n">x_train</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
</span><span id="get_model_data-1696"><a href="#get_model_data-1696"><span class="linenos">1696</span></a>        <span class="p">)</span>
</span><span id="get_model_data-1697"><a href="#get_model_data-1697"><span class="linenos">1697</span></a>
</span><span id="get_model_data-1698"><a href="#get_model_data-1698"><span class="linenos">1698</span></a>    <span class="c1"># Initialize a feature description dictionary (provide more information about</span>
</span><span id="get_model_data-1699"><a href="#get_model_data-1699"><span class="linenos">1699</span></a>    <span class="c1"># each feature in the UI)</span>
</span><span id="get_model_data-1700"><a href="#get_model_data-1700"><span class="linenos">1700</span></a>    <span class="n">feature_descriptions</span> <span class="o">=</span> <span class="n">_init_feature_descriptions</span><span class="p">(</span><span class="n">ebm</span><span class="p">,</span> <span class="n">labelEncoder</span><span class="p">)</span>
</span><span id="get_model_data-1701"><a href="#get_model_data-1701"><span class="linenos">1701</span></a>
</span><span id="get_model_data-1702"><a href="#get_model_data-1702"><span class="linenos">1702</span></a>    <span class="c1"># Overwrite some entries in the default feature_descriptions</span>
</span><span id="get_model_data-1703"><a href="#get_model_data-1703"><span class="linenos">1703</span></a>    <span class="k">if</span> <span class="n">feature_info</span><span class="p">:</span>
</span><span id="get_model_data-1704"><a href="#get_model_data-1704"><span class="linenos">1704</span></a>        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_info</span><span class="p">:</span>
</span><span id="get_model_data-1705"><a href="#get_model_data-1705"><span class="linenos">1705</span></a>            <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s2">&quot;displayName&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="get_model_data-1706"><a href="#get_model_data-1706"><span class="linenos">1706</span></a>            <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_info</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="get_model_data-1707"><a href="#get_model_data-1707"><span class="linenos">1707</span></a>
</span><span id="get_model_data-1708"><a href="#get_model_data-1708"><span class="linenos">1708</span></a>    <span class="k">if</span> <span class="n">feature_level_info</span><span class="p">:</span>
</span><span id="get_model_data-1709"><a href="#get_model_data-1709"><span class="linenos">1709</span></a>        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_level_info</span><span class="p">:</span>
</span><span id="get_model_data-1710"><a href="#get_model_data-1710"><span class="linenos">1710</span></a>            <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">feature_level_info</span><span class="p">[</span><span class="n">feature</span><span class="p">]:</span>
</span><span id="get_model_data-1711"><a href="#get_model_data-1711"><span class="linenos">1711</span></a>                <span class="n">display_name</span> <span class="o">=</span> <span class="n">feature_level_info</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">level</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span id="get_model_data-1712"><a href="#get_model_data-1712"><span class="linenos">1712</span></a>                <span class="n">description</span> <span class="o">=</span> <span class="n">feature_level_info</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">level</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
</span><span id="get_model_data-1713"><a href="#get_model_data-1713"><span class="linenos">1713</span></a>                <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s2">&quot;levelDescription&quot;</span><span class="p">][</span><span class="n">level</span><span class="p">][</span>
</span><span id="get_model_data-1714"><a href="#get_model_data-1714"><span class="linenos">1714</span></a>                    <span class="s2">&quot;displayName&quot;</span>
</span><span id="get_model_data-1715"><a href="#get_model_data-1715"><span class="linenos">1715</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="n">display_name</span>
</span><span id="get_model_data-1716"><a href="#get_model_data-1716"><span class="linenos">1716</span></a>                <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="s2">&quot;levelDescription&quot;</span><span class="p">][</span><span class="n">level</span><span class="p">][</span>
</span><span id="get_model_data-1717"><a href="#get_model_data-1717"><span class="linenos">1717</span></a>                    <span class="s2">&quot;description&quot;</span>
</span><span id="get_model_data-1718"><a href="#get_model_data-1718"><span class="linenos">1718</span></a>                <span class="p">]</span> <span class="o">=</span> <span class="n">description</span>
</span><span id="get_model_data-1719"><a href="#get_model_data-1719"><span class="linenos">1719</span></a>
</span><span id="get_model_data-1720"><a href="#get_model_data-1720"><span class="linenos">1720</span></a>    <span class="c1"># Put descriptions under the &#39;features&#39; key</span>
</span><span id="get_model_data-1721"><a href="#get_model_data-1721"><span class="linenos">1721</span></a>    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
</span><span id="get_model_data-1722"><a href="#get_model_data-1722"><span class="linenos">1722</span></a>        <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">feature_descriptions</span><span class="p">:</span>
</span><span id="get_model_data-1723"><a href="#get_model_data-1723"><span class="linenos">1723</span></a>            <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_descriptions</span><span class="p">[</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>
</span><span id="get_model_data-1724"><a href="#get_model_data-1724"><span class="linenos">1724</span></a>
</span><span id="get_model_data-1725"><a href="#get_model_data-1725"><span class="linenos">1725</span></a>    <span class="c1"># Set the feature configurations</span>
</span><span id="get_model_data-1726"><a href="#get_model_data-1726"><span class="linenos">1726</span></a>    <span class="n">feature_configurations</span> <span class="o">=</span> <span class="n">_init_feature_configuration</span><span class="p">(</span><span class="n">ebm</span><span class="p">)</span>
</span><span id="get_model_data-1727"><a href="#get_model_data-1727"><span class="linenos">1727</span></a>
</span><span id="get_model_data-1728"><a href="#get_model_data-1728"><span class="linenos">1728</span></a>    <span class="k">if</span> <span class="n">feature_config</span><span class="p">:</span>
</span><span id="get_model_data-1729"><a href="#get_model_data-1729"><span class="linenos">1729</span></a>        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">feature_config</span><span class="p">:</span>
</span><span id="get_model_data-1730"><a href="#get_model_data-1730"><span class="linenos">1730</span></a>            <span class="n">cur_config</span> <span class="o">=</span> <span class="n">feature_config</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span>
</span><span id="get_model_data-1731"><a href="#get_model_data-1731"><span class="linenos">1731</span></a>            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span>
</span><span id="get_model_data-1732"><a href="#get_model_data-1732"><span class="linenos">1732</span></a>                <span class="s2">&quot;requiresInt&quot;</span><span class="p">,</span>
</span><span id="get_model_data-1733"><a href="#get_model_data-1733"><span class="linenos">1733</span></a>                <span class="s2">&quot;difficulty&quot;</span><span class="p">,</span>
</span><span id="get_model_data-1734"><a href="#get_model_data-1734"><span class="linenos">1734</span></a>                <span class="s2">&quot;acceptableRange&quot;</span><span class="p">,</span>
</span><span id="get_model_data-1735"><a href="#get_model_data-1735"><span class="linenos">1735</span></a>                <span class="s2">&quot;requiresIncreasing&quot;</span><span class="p">,</span>
</span><span id="get_model_data-1736"><a href="#get_model_data-1736"><span class="linenos">1736</span></a>                <span class="s2">&quot;requiresDecreasing&quot;</span><span class="p">,</span>
</span><span id="get_model_data-1737"><a href="#get_model_data-1737"><span class="linenos">1737</span></a>                <span class="s2">&quot;usesTransform&quot;</span><span class="p">,</span>
</span><span id="get_model_data-1738"><a href="#get_model_data-1738"><span class="linenos">1738</span></a>            <span class="p">]:</span>
</span><span id="get_model_data-1739"><a href="#get_model_data-1739"><span class="linenos">1739</span></a>                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cur_config</span><span class="p">:</span>
</span><span id="get_model_data-1740"><a href="#get_model_data-1740"><span class="linenos">1740</span></a>                    <span class="n">feature_configurations</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="get_model_data-1741"><a href="#get_model_data-1741"><span class="linenos">1741</span></a>
</span><span id="get_model_data-1742"><a href="#get_model_data-1742"><span class="linenos">1742</span></a>    <span class="c1"># Attach the configuration to the feature field</span>
</span><span id="get_model_data-1743"><a href="#get_model_data-1743"><span class="linenos">1743</span></a>    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
</span><span id="get_model_data-1744"><a href="#get_model_data-1744"><span class="linenos">1744</span></a>        <span class="k">if</span> <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">feature_configurations</span><span class="p">:</span>
</span><span id="get_model_data-1745"><a href="#get_model_data-1745"><span class="linenos">1745</span></a>            <span class="n">feature</span><span class="p">[</span><span class="s2">&quot;config&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature_configurations</span><span class="p">[</span><span class="n">feature</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span>
</span><span id="get_model_data-1746"><a href="#get_model_data-1746"><span class="linenos">1746</span></a>
</span><span id="get_model_data-1747"><a href="#get_model_data-1747"><span class="linenos">1747</span></a>    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="get_model_data-1748"><a href="#get_model_data-1748"><span class="linenos">1748</span></a>        <span class="s2">&quot;intercept&quot;</span><span class="p">:</span> <span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ebm</span><span class="p">,</span> <span class="s2">&quot;classes_&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">ebm</span><span class="o">.</span><span class="n">intercept_</span><span class="p">,</span>
</span><span id="get_model_data-1749"><a href="#get_model_data-1749"><span class="linenos">1749</span></a>        <span class="s2">&quot;isClassifier&quot;</span><span class="p">:</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ebm</span><span class="p">,</span> <span class="s2">&quot;classes_&quot;</span><span class="p">),</span>
</span><span id="get_model_data-1750"><a href="#get_model_data-1750"><span class="linenos">1750</span></a>        <span class="s2">&quot;modelInfo&quot;</span><span class="p">:</span> <span class="n">model_info</span><span class="p">,</span>
</span><span id="get_model_data-1751"><a href="#get_model_data-1751"><span class="linenos">1751</span></a>        <span class="s2">&quot;features&quot;</span><span class="p">:</span> <span class="n">features</span><span class="p">,</span>
</span><span id="get_model_data-1752"><a href="#get_model_data-1752"><span class="linenos">1752</span></a>        <span class="s2">&quot;labelEncoder&quot;</span><span class="p">:</span> <span class="n">labelEncoder</span><span class="p">,</span>
</span><span id="get_model_data-1753"><a href="#get_model_data-1753"><span class="linenos">1753</span></a>        <span class="s2">&quot;scoreRange&quot;</span><span class="p">:</span> <span class="n">score_range</span><span class="p">,</span>
</span><span id="get_model_data-1754"><a href="#get_model_data-1754"><span class="linenos">1754</span></a>        <span class="s2">&quot;featureNames&quot;</span><span class="p">:</span> <span class="n">feature_names</span><span class="p">,</span>
</span><span id="get_model_data-1755"><a href="#get_model_data-1755"><span class="linenos">1755</span></a>        <span class="s2">&quot;featureTypes&quot;</span><span class="p">:</span> <span class="n">feature_types</span><span class="p">,</span>
</span><span id="get_model_data-1756"><a href="#get_model_data-1756"><span class="linenos">1756</span></a>        <span class="s2">&quot;contMads&quot;</span><span class="p">:</span> <span class="n">contMads</span><span class="p">,</span>
</span><span id="get_model_data-1757"><a href="#get_model_data-1757"><span class="linenos">1757</span></a>        <span class="s2">&quot;catDistances&quot;</span><span class="p">:</span> <span class="n">catDistances</span><span class="p">,</span>
</span><span id="get_model_data-1758"><a href="#get_model_data-1758"><span class="linenos">1758</span></a>    <span class="p">}</span>
</span><span id="get_model_data-1759"><a href="#get_model_data-1759"><span class="linenos">1759</span></a>
</span><span id="get_model_data-1760"><a href="#get_model_data-1760"><span class="linenos">1760</span></a>    <span class="k">return</span> <span class="n">data</span>
</span></pre></div>


            <div class="docstring"><p>Get the model data for GAM Coach.</p>

<h6 id="args">Args</h6>

<ul>
<li><strong>ebm:</strong>  Trained EBM model. ExplainableBoostingClassifier or
ExplainableBoostingRegressor object.</li>
<li><strong>x_train:</strong>  Training data. We use it to compute the mean absolute deviation
score for continuous features, and frequency scores for categorical
features.</li>
<li><strong>model_info:</strong>  Information about the model (class names, regression target
name). For classification, the order of classes matters. It should
be consistent with the class encoding index. For example, the first
element should be the name for class 0.
It has format:
<code>{'classes': ['loan rejection', 'loan approval']}</code> or
<code>{'regressionName': 'interest rate'}</code></li>
<li><strong>resort_categorical:</strong>  Whether to sort the levels in categorical variable
by increasing order if all levels can be converted to numbers.</li>
<li><strong>feature_info:</strong>  You can provide a dictionary to give a separate display
name and optional description for each feature. By default, the
display name is the same as the feature name, and the description
is an emtpy string. <code>feature_info</code> can be partial (only including
some features). It has format:
<code>{'feature_name': ['display_name', 'description']}</code></li>
<li><strong>feature_level_info:</strong>  You can provide a dictionary to give separate display
name and optional description for each level of categorical features.
By default, the display name is the same as the level name, and the
description is an empty string. <code>feature_info</code> can be partial
(e.g., only including some levels from some categorical features).
It has format:
<code>{'feature_name': {level_id: ['display_name', 'description']}}</code></li>
<li><strong>feature_config:</strong>  You can provide a dictionary to configure the difficulty,
integer requirement, and acceptable range of individual features.
The difficulty is an integer between 1 and 6: 1 (very easy to change),
2 (easy), 3 (default), 4 (hard), 5 (very hard), 6 (impossible to change).
By default, difficulty is set to 3 for all features, requiresInt is
False for continuous variables, and acceptanceRange is None (search
all range).
The dictionary property has the following format:
<code>{'difficulty': 3, 'requiresInt': True, 'acceptableRange': None}</code></li>
</ul>

<h6 id="returns">Returns</h6>

<blockquote>
  <p>A Python dictionary of model data</p>
</blockquote>
</div>


                </section>
    </main>
<script>
    function escapeHTML(html) {
        return document.createElement('div').appendChild(document.createTextNode(html)).parentNode.innerHTML;
    }

    const originalContent = document.querySelector("main.pdoc");
    let currentContent = originalContent;

    function setContent(innerHTML) {
        let elem;
        if (innerHTML) {
            elem = document.createElement("main");
            elem.classList.add("pdoc");
            elem.innerHTML = innerHTML;
        } else {
            elem = originalContent;
        }
        if (currentContent !== elem) {
            currentContent.replaceWith(elem);
            currentContent = elem;
        }
    }

    function getSearchTerm() {
        return (new URL(window.location)).searchParams.get("search");
    }

    const searchBox = document.querySelector(".pdoc input[type=search]");
    searchBox.addEventListener("input", function () {
        let url = new URL(window.location);
        if (searchBox.value.trim()) {
            url.hash = "";
            url.searchParams.set("search", searchBox.value);
        } else {
            url.searchParams.delete("search");
        }
        history.replaceState("", "", url.toString());
        onInput();
    });
    window.addEventListener("popstate", onInput);


    let search, searchErr;

    async function initialize() {
        try {
            search = await new Promise((resolve, reject) => {
                const script = document.createElement("script");
                script.type = "text/javascript";
                script.async = true;
                script.onload = () => resolve(window.pdocSearch);
                script.onerror = (e) => reject(e);
                script.src = "../search.js";
                document.getElementsByTagName("head")[0].appendChild(script);
            });
        } catch (e) {
            console.error("Cannot fetch pdoc search index");
            searchErr = "Cannot fetch search index.";
        }
        onInput();

        document.querySelector("nav.pdoc").addEventListener("click", e => {
            if (e.target.hash) {
                searchBox.value = "";
                searchBox.dispatchEvent(new Event("input"));
            }
        });
    }

    function onInput() {
        setContent((() => {
            const term = getSearchTerm();
            if (!term) {
                return null
            }
            if (searchErr) {
                return `<h3>Error: ${searchErr}</h3>`
            }
            if (!search) {
                return "<h3>Searching...</h3>"
            }

            window.scrollTo({top: 0, left: 0, behavior: 'auto'});

            const results = search(term);

            let html;
            if (results.length === 0) {
                html = `No search results for '${escapeHTML(term)}'.`
            } else {
                html = `<h4>${results.length} search result${results.length > 1 ? "s" : ""} for '${escapeHTML(term)}'.</h4>`;
            }
            for (let result of results.slice(0, 10)) {
                let doc = result.doc;
                let url = `../${doc.modulename.replaceAll(".", "/")}.html`;
                if (doc.qualname) {
                    url += `#${doc.qualname}`;
                }

                let heading;
                switch (result.doc.type) {
                    case "function":
                        if (doc.fullname.endsWith(".__init__")) {
                            heading = `<span class="name">${doc.fullname.replace(/\.__init__$/, "")}</span>${doc.signature}`;
                        } else {
                            heading = `<span class="def">${doc.funcdef}</span> <span class="name">${doc.fullname}</span>${doc.signature}`;
                        }
                        break;
                    case "class":
                        heading = `<span class="def">class</span> <span class="name">${doc.fullname}</span>`;
                        if (doc.bases)
                            heading += `<wbr>(<span class="base">${doc.bases}</span>)`;
                        heading += `:`;
                        break;
                    case "variable":
                        heading = `<span class="name">${doc.fullname}</span>`;
                        if (doc.annotation)
                            heading += `<span class="annotation">${doc.annotation}</span>`;
                        if (doc.default_value)
                            heading += `<span class="default_value">${doc.default_value}</span>`;
                        break;
                    default:
                        heading = `<span class="name">${doc.fullname}</span>`;
                        break;
                }
                html += `
                        <section class="search-result">
                        <a href="${url}" class="attr ${doc.type}">${heading}</a>
                        <div class="docstring">${doc.doc}</div>
                        </section>
                    `;

            }
            return html;
        })());
    }

    if (getSearchTerm()) {
        initialize();
        searchBox.value = getSearchTerm();
        onInput();
    } else {
        searchBox.addEventListener("focus", initialize, {once: true});
    }

    searchBox.addEventListener("keydown", e => {
        if (["ArrowDown", "ArrowUp", "Enter"].includes(e.key)) {
            let focused = currentContent.querySelector(".search-result.focused");
            if (!focused) {
                currentContent.querySelector(".search-result").classList.add("focused");
            } else if (
                e.key === "ArrowDown"
                && focused.nextElementSibling
                && focused.nextElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.nextElementSibling.classList.add("focused");
                focused.nextElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "ArrowUp"
                && focused.previousElementSibling
                && focused.previousElementSibling.classList.contains("search-result")
            ) {
                focused.classList.remove("focused");
                focused.previousElementSibling.classList.add("focused");
                focused.previousElementSibling.scrollIntoView({
                    behavior: "smooth",
                    block: "nearest",
                    inline: "nearest"
                });
            } else if (
                e.key === "Enter"
            ) {
                focused.querySelector("a").click();
            }
        }
    });
</script></body>
</html>